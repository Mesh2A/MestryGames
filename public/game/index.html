<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <meta name="theme-color" content="#0b1020" />
    <title>MestRyLock</title>
    <link rel="icon" type="image/svg+xml" href="/icon.svg" />
    <link rel="icon" href="/favicon.ico" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet" />
    <script>
      (() => {
        try {
          let theme = "";
          let lastScreen = "";

          const uiRaw = localStorage.getItem("lockgame_ui_v1");
          const ui = uiRaw ? JSON.parse(uiRaw) : null;
          theme = ui && typeof ui.theme === "string" ? ui.theme : "";
          lastScreen = ui && typeof ui.lastScreen === "string" ? ui.lastScreen : "";

          const lastEmail = String(localStorage.getItem("lockgame_last_email_v1") || "").trim();
          if (lastEmail) {
            const stateRaw = localStorage.getItem(`lockgame_v1:${lastEmail}`);
            const state = stateRaw ? JSON.parse(stateRaw) : null;
            if (!theme && state && typeof state.theme === "string") theme = state.theme;
            if (!lastScreen && state && typeof state.lastScreen === "string") lastScreen = state.lastScreen;
          } else {
            const stateRaw = localStorage.getItem("lockgame_v1");
            const state = stateRaw ? JSON.parse(stateRaw) : null;
            if (!theme && state && typeof state.theme === "string") theme = state.theme;
            if (!lastScreen && state && typeof state.lastScreen === "string") lastScreen = state.lastScreen;
          }

          theme = "crimson";
          document.documentElement.dataset.theme = theme || "crimson";
          document.documentElement.dataset.booting = "1";
          if (lastScreen === "map" || lastScreen === "level") document.documentElement.dataset.bootScreen = lastScreen;
        } catch {}
        try {
          const host = String(location.hostname || "").toLowerCase();
          const dev = host === "localhost" || host === "127.0.0.1" || /(^|\?|&)debug=1(&|$)/.test(String(location.search || ""));
          if (!dev && window.console) {
            console.log = () => {};
            console.info = () => {};
            console.debug = () => {};
          }
        } catch {}
      })();
    </script>
    <style>
      :root {
        --bg-0: #04111f;
        --sea-0: #063c5a;
        --sea-1: #0a6d88;
        --sea-2: #26b6c6;
        --glass: rgba(255, 255, 255, 0.12);
        --glass-2: rgba(255, 255, 255, 0.2);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.7);
        --ok: #22c55e;
        --bad: #ef4444;
        --warn: #f59e0b;
        --shadow: rgba(0, 0, 0, 0.45);
        --shine: rgba(255, 255, 255, 0.22);
        --glow-a: rgba(34, 211, 238, 0.22);
        --glow-b: rgba(99, 102, 241, 0.22);
        --glow-c: rgba(236, 72, 153, 0.18);
        --ui-blur: 12px;
        --bg-grad-a: radial-gradient(1200px 720px at 18% 0%, rgba(34, 211, 238, 0.18), transparent 62%);
        --bg-grad-b: radial-gradient(1100px 760px at 84% 10%, rgba(99, 102, 241, 0.16), transparent 64%),
          radial-gradient(900px 620px at 52% 110%, rgba(236, 72, 153, 0.08), transparent 58%);
        --bg-grad-c: linear-gradient(180deg, #020316, #060922 45%, #020818);
        --btn-border: rgba(255, 255, 255, 0.22);
        --btn-bg: rgba(255, 255, 255, 0.11);
        --btn-hover-bg: rgba(255, 255, 255, 0.16);
        --btn-hover-border: rgba(255, 255, 255, 0.32);
        --btn-primary-grad: linear-gradient(135deg, rgba(34, 211, 238, 0.62), rgba(99, 102, 241, 0.22));
        --btn-primary-grad-hover: linear-gradient(135deg, rgba(34, 211, 238, 0.75), rgba(99, 102, 241, 0.28));
        --btn-primary-border: rgba(34, 211, 238, 0.75);
        --btn-primary-border-hover: rgba(34, 211, 238, 0.85);
        --panel-border: rgba(255, 255, 255, 0.16);
        --panel-bg: rgba(255, 255, 255, 0.07);
        --modal-bg: rgba(2, 8, 20, 0.72);
        --pattern-color: rgba(255, 255, 255, 0.09);
        --sea-opacity: 0.95;
        --slot-radius: 18px;
        --safe-top: env(safe-area-inset-top);
        --safe-right: env(safe-area-inset-right);
        --safe-bottom: env(safe-area-inset-bottom);
        --safe-left: env(safe-area-inset-left);
      }
      html[data-theme="royal"] {
        --bg-0: #050816;
        --sea-0: #101b48;
        --sea-1: #1a2a78;
        --sea-2: #3b82f6;
        --glass: rgba(255, 255, 255, 0.11);
        --glass-2: rgba(255, 255, 255, 0.2);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.7);
        --shadow: rgba(0, 0, 0, 0.48);
        --shine: rgba(255, 255, 255, 0.22);
        --glow-a: rgba(59, 130, 246, 0.22);
        --glow-b: rgba(139, 92, 246, 0.22);
        --glow-c: rgba(236, 72, 153, 0.18);
        --bg-grad-a: radial-gradient(1200px 720px at 18% 0%, rgba(59, 130, 246, 0.18), transparent 62%);
        --bg-grad-b: radial-gradient(1100px 760px at 82% 10%, rgba(139, 92, 246, 0.16), transparent 66%),
          radial-gradient(900px 640px at 56% 110%, rgba(236, 72, 153, 0.08), transparent 58%);
        --bg-grad-c: linear-gradient(180deg, #02030c, var(--bg-0) 50%, #02081a);
        --btn-border: rgba(255, 255, 255, 0.2);
        --btn-bg: rgba(255, 255, 255, 0.1);
        --btn-hover-bg: rgba(255, 255, 255, 0.15);
        --btn-hover-border: rgba(255, 255, 255, 0.3);
        --btn-primary-grad: linear-gradient(135deg, rgba(59, 130, 246, 0.68), rgba(139, 92, 246, 0.26));
        --btn-primary-grad-hover: linear-gradient(135deg, rgba(59, 130, 246, 0.82), rgba(139, 92, 246, 0.34));
        --btn-primary-border: rgba(59, 130, 246, 0.82);
        --btn-primary-border-hover: rgba(59, 130, 246, 0.92);
        --panel-border: rgba(255, 255, 255, 0.14);
        --panel-bg: rgba(255, 255, 255, 0.06);
        --modal-bg: rgba(2, 8, 20, 0.74);
        --pattern-color: rgba(255, 255, 255, 0.08);
        --sea-opacity: 0.92;
      }
      html[data-theme="cream"] {
        --bg-0: #f1e8d8;
        --glass: rgba(0, 0, 0, 0.06);
        --glass-2: rgba(0, 0, 0, 0.1);
        --text: rgba(18, 22, 26, 0.92);
        --muted: rgba(18, 22, 26, 0.62);
        --shadow: rgba(0, 0, 0, 0.22);
        --shine: rgba(255, 255, 255, 0.55);
        --glow-a: rgba(14, 165, 233, 0.14);
        --glow-b: rgba(99, 102, 241, 0.12);
        --glow-c: rgba(217, 119, 6, 0.12);
        --bg-grad-a: radial-gradient(1200px 720px at 18% 0%, rgba(14, 165, 233, 0.16), transparent 62%);
        --bg-grad-b: radial-gradient(1100px 760px at 82% 10%, rgba(99, 102, 241, 0.12), transparent 66%),
          radial-gradient(900px 640px at 56% 110%, rgba(217, 119, 6, 0.09), transparent 58%);
        --bg-grad-c: linear-gradient(180deg, #fff7ed, var(--bg-0) 60%, #efe6d6);
        --btn-border: rgba(0, 0, 0, 0.14);
        --btn-bg: rgba(255, 255, 255, 0.62);
        --btn-hover-bg: rgba(255, 255, 255, 0.78);
        --btn-hover-border: rgba(0, 0, 0, 0.18);
        --btn-primary-grad: linear-gradient(135deg, rgba(34, 211, 238, 0.72), rgba(99, 102, 241, 0.32));
        --btn-primary-grad-hover: linear-gradient(135deg, rgba(34, 211, 238, 0.84), rgba(99, 102, 241, 0.42));
        --btn-primary-border: rgba(34, 211, 238, 0.85);
        --btn-primary-border-hover: rgba(34, 211, 238, 0.95);
        --panel-border: rgba(0, 0, 0, 0.12);
        --panel-bg: rgba(255, 255, 255, 0.52);
        --modal-bg: rgba(255, 255, 255, 0.74);
        --pattern-color: rgba(0, 0, 0, 0.12);
        --sea-opacity: 0.55;
      }
      html[data-theme="crimson"] {
        --bg-0: #07070a;
        --sea-0: #200608;
        --sea-1: #5f0a12;
        --sea-2: #ef4444;
        --glass: rgba(255, 255, 255, 0.1);
        --glass-2: rgba(255, 255, 255, 0.16);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.68);
        --shadow: rgba(0, 0, 0, 0.52);
        --shine: rgba(255, 255, 255, 0.22);
        --glow-a: rgba(239, 68, 68, 0.26);
        --glow-b: rgba(244, 63, 94, 0.18);
        --glow-c: rgba(251, 113, 133, 0.12);
        --bg-grad-a: radial-gradient(1200px 720px at 18% 0%, rgba(239, 68, 68, 0.18), transparent 64%);
        --bg-grad-b: radial-gradient(1100px 760px at 84% 10%, rgba(244, 63, 94, 0.12), transparent 68%),
          radial-gradient(900px 620px at 52% 110%, rgba(251, 113, 133, 0.08), transparent 60%);
        --bg-grad-c: linear-gradient(180deg, #040405, var(--bg-0) 55%, #020203);
        --btn-border: rgba(255, 255, 255, 0.2);
        --btn-bg: rgba(255, 255, 255, 0.1);
        --btn-hover-bg: rgba(255, 255, 255, 0.15);
        --btn-hover-border: rgba(255, 255, 255, 0.3);
        --btn-primary-grad: linear-gradient(135deg, rgba(239, 68, 68, 0.7), rgba(0, 0, 0, 0));
        --btn-primary-grad-hover: linear-gradient(135deg, rgba(239, 68, 68, 0.82), rgba(0, 0, 0, 0));
        --btn-primary-border: rgba(239, 68, 68, 0.86);
        --btn-primary-border-hover: rgba(239, 68, 68, 0.96);
        --panel-border: rgba(255, 255, 255, 0.14);
        --panel-bg: rgba(255, 255, 255, 0.06);
        --modal-bg: rgba(8, 8, 10, 0.76);
        --pattern-color: rgba(255, 255, 255, 0.07);
        --sea-opacity: 0.9;
      }
      html[data-lock-shape="circle"] {
        --slot-radius: 999px;
      }
      html[data-lock-shape="square"] {
        --slot-radius: 10px;
      }
      html[data-reduce-motion="1"] {
        --sea-opacity: 0.6;
        --panel-bg: rgba(255, 255, 255, 0.04);
        --btn-bg: rgba(255, 255, 255, 0.08);
        --btn-hover-bg: rgba(255, 255, 255, 0.1);
        --pattern-color: rgba(255, 255, 255, 0.06);
        --ui-blur: 0px;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: "Cairo", "Inter", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans Arabic",
          "Noto Sans", "Helvetica Neue", sans-serif;
        font-weight: 600;
        color: var(--text);
        background: var(--bg-grad-a), var(--bg-grad-b), var(--bg-grad-c);
        overflow: hidden;
        text-rendering: optimizeLegibility;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      button,
      input,
      select,
      textarea {
        font: inherit;
      }
      html[data-mobile="0"] body::before {
        content: "";
        position: fixed;
        inset: 0;
        pointer-events: none;
        background: radial-gradient(900px 520px at 18% 8%, var(--glow-a), transparent 68%),
          radial-gradient(1100px 620px at 82% 12%, var(--glow-b), transparent 72%),
          repeating-linear-gradient(25deg, rgba(255, 255, 255, 0.03) 0 2px, rgba(255, 255, 255, 0) 2px 7px);
        opacity: 0.55;
        mix-blend-mode: overlay;
        transform: translate3d(0, 0, 0);
        animation: bgFloat 14s ease-in-out infinite alternate;
      }
      html[data-reduce-motion="1"][data-mobile="0"] body::before {
        animation: none;
      }
      html[data-theme="crimson"] body::after {
        content: "";
        position: fixed;
        inset: -10% -8% -10% -8%;
        pointer-events: none;
        background: radial-gradient(1500px 150px at 0% 55%, transparent 52%, rgba(239, 68, 68, 0.38) 54%, transparent 58%),
          radial-gradient(1700px 190px at 0% 70%, transparent 55%, rgba(239, 68, 68, 0.22) 57%, transparent 61%),
          radial-gradient(1200px 120px at 0% 40%, transparent 54%, rgba(244, 63, 94, 0.2) 56%, transparent 60%);
        opacity: 0.55;
        transform: rotate(-10deg) translateX(-8%);
        animation: crimsonSweep 8s ease-in-out infinite alternate;
        mix-blend-mode: screen;
      }
      html[data-reduce-motion="1"][data-theme="crimson"] body::after {
        animation: none;
        opacity: 0.32;
        transform: rotate(-10deg);
      }
      @keyframes crimsonSweep {
        from {
          transform: rotate(-10deg) translateX(-12%);
        }
        to {
          transform: rotate(-10deg) translateX(12%);
        }
      }
      @keyframes bgFloat {
        from {
          transform: translate3d(-1.2%, -0.6%, 0) scale(1.02);
          opacity: 0.5;
        }
        to {
          transform: translate3d(1.2%, 0.6%, 0) scale(1.04);
          opacity: 0.62;
        }
      }
      .app {
        height: 100%;
        display: grid;
        grid-template-rows: auto 1fr;
      }
      header {
        padding: calc(14px + var(--safe-top)) calc(16px + var(--safe-right)) 14px calc(16px + var(--safe-left));
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        position: sticky;
        top: 0;
        z-index: 12;
        border-bottom: 1px solid rgba(255, 255, 255, 0.12);
        background: linear-gradient(180deg, rgba(18, 24, 44, 0.94), rgba(12, 16, 30, 0.72));
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
      }
      header .brand {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      header h1 {
        margin: 0;
        font-size: clamp(16px, 2.2vw, 19px);
        letter-spacing: 0.2px;
      }
      @supports (-webkit-background-clip: text) {
        html[data-mobile="0"] header h1 {
          background: linear-gradient(90deg, rgba(255, 255, 255, 0.92), rgba(255, 255, 255, 0.78)),
            radial-gradient(220px 90px at 20% 30%, var(--glow-a), transparent 70%),
            radial-gradient(240px 100px at 80% 0%, var(--glow-b), transparent 72%);
          -webkit-background-clip: text;
          background-clip: text;
          color: transparent;
        }
      }
      header .sub {
        display: none;
        font-size: 12px;
        color: var(--muted);
      }
      header .actions {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .iconBtn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }
      .i {
        display: inline-block;
        vertical-align: middle;
        flex: 0 0 auto;
      }
      .playerBrand {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-direction: row;
      }
      #playerAvatar {
        order: 0;
      }
      #playerName {
        order: 1;
        direction: auto;
        unicode-bidi: plaintext;
      }
      #onlineCountBadge {
        order: 2;
      }
      .onlineDot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.22);
        background: rgba(148, 163, 184, 0.7);
        box-shadow: 0 0 0 3px rgba(148, 163, 184, 0.16);
        flex: 0 0 auto;
      }
      .onlineDot.on {
        background: rgba(34, 197, 94, 0.95);
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.16);
      }
      .onlineCount {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 30px;
        height: 22px;
        padding: 0 8px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(255, 255, 255, 0.06);
        color: rgba(255, 255, 255, 0.92);
        font-weight: 900;
        font-size: 12px;
        letter-spacing: 0.2px;
        flex: 0 0 auto;
        gap: 6px;
      }
      html[dir="rtl"] .onlineCount,
      body[dir="rtl"] .onlineCount {
        direction: rtl;
      }
      html[dir="ltr"] .onlineCount,
      body[dir="ltr"] .onlineCount {
        direction: ltr;
      }
      .onlineCountLabel {
        font-weight: 900;
        font-size: 11px;
        opacity: 0.86;
      }
      .playerAvatar {
        width: 34px;
        height: 34px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: rgba(255, 255, 255, 0.06);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        font-weight: 900;
        font-size: 13px;
        flex: 0 0 auto;
        cursor: pointer;
      }
      .playerAvatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      .playerName {
        font-weight: 900;
        font-size: clamp(12px, 2.4vw, 15px);
        letter-spacing: 0.2px;
        color: rgba(255, 255, 255, 0.95);
        max-width: clamp(140px, 22vw, 220px);
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        white-space: normal;
        overflow: hidden;
        line-height: 1.2;
      }
      @media (max-width: 900px) {
        .playerName {
          max-width: clamp(140px, 46vw, 220px);
        }
      }
      #tasksBtn {
        position: relative;
      }
      #tasksBtn.hasNotifyDot::after {
        content: "";
        position: absolute;
        top: 6px;
        right: 6px;
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: rgba(239, 68, 68, 0.95);
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.18);
      }
      html[dir="ltr"] #tasksBtn.hasNotifyDot::after {
        left: 6px;
        right: auto;
      }
      .profileWrap {
        display: grid;
        gap: 14px;
      }
      .profileTop {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-direction: row-reverse;
      }
      html[dir="ltr"] .profileTop {
        flex-direction: row;
      }
      .profileAvatar {
        width: 54px;
        height: 54px;
        border-radius: 18px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: rgba(255, 255, 255, 0.06);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        font-weight: 900;
        font-size: 16px;
        flex: 0 0 auto;
      }
      .profileAvatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      .profileMeta {
        display: grid;
        gap: 6px;
        flex: 1 1 auto;
        min-width: 0;
      }
      .profileNameRow {
        display: flex;
        align-items: baseline;
        gap: 8px;
        flex-direction: row-reverse;
      }
      html[dir="ltr"] .profileNameRow {
        flex-direction: row;
      }
      .profileName {
        font-weight: 900;
        letter-spacing: 0.2px;
        font-size: 16px;
        max-width: 360px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .profileFlag {
        font-size: 12px;
        line-height: 1;
        opacity: 0.95;
      }
      .profileLine {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        font-size: 12px;
        color: rgba(255, 255, 255, 0.86);
      }
      .profileK {
        opacity: 0.7;
      }
      .profileV {
        font-weight: 700;
      }
      .profileGrid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 8px;
      }
      .profileCard {
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.16);
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.09), rgba(255, 255, 255, 0.04));
        padding: 8px 10px;
        display: grid;
        gap: 4px;
        position: relative;
        overflow: hidden;
        box-shadow: 0 16px 50px rgba(0, 0, 0, 0.22), 0 0 0 1px rgba(255, 255, 255, 0.05) inset;
        user-select: none;
        cursor: default;
      }
      .profileCard > * {
        position: relative;
        z-index: 1;
      }
      .profileCard::before {
        content: "";
        position: absolute;
        inset: -2px;
        pointer-events: none;
        background: linear-gradient(115deg, transparent 0%, rgba(255, 255, 255, 0.14) 45%, transparent 75%);
        transform: translateX(-140%) rotate(18deg);
        opacity: 0.85;
        animation: cardShine 5200ms ease-in-out infinite;
      }
      html[data-reduce-motion="1"] .profileCard::before {
        animation: none;
        opacity: 0.35;
        transform: translateX(0) rotate(0deg);
      }
      .profileCard::after {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        background: radial-gradient(240px 120px at 18% 0%, rgba(255, 255, 255, 0.16), transparent 62%),
          radial-gradient(260px 140px at 88% 12%, rgba(34, 197, 94, 0.12), transparent 70%);
        opacity: 0.85;
      }
      .profileCard .k {
        font-size: 10px;
        color: rgba(255, 255, 255, 0.7);
      }
      .profileCard .v {
        font-size: 16px;
        font-weight: 900;
        letter-spacing: 0.2px;
        font-variant-numeric: tabular-nums;
      }
      .profileCard.wide {
        grid-column: 1 / -1;
      }
      .profileSplit {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 8px;
        font-size: 12px;
        color: rgba(255, 255, 255, 0.86);
      }
      @media (max-width: 520px) {
        .profileGrid {
          grid-template-columns: 1fr;
        }
        .profileCard .v {
          font-size: 16px;
        }
        .profileSplit {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
        .friendDetailsCard {
          top: calc(12px + var(--safe-top));
          max-height: calc(100dvh - 24px - var(--safe-bottom));
        }
      }
      .profileSplit .k {
        font-size: 10px;
        color: rgba(255, 255, 255, 0.7);
      }
      .profileSplit .v {
        font-weight: 900;
        font-size: 13px;
        font-variant-numeric: tabular-nums;
      }
      .profileDropBackdrop {
        position: fixed;
        inset: 0;
        z-index: 60;
        pointer-events: none;
        opacity: 0;
        transition: opacity 160ms ease;
      }
      .profileDropBackdrop.show {
        pointer-events: auto;
        opacity: 1;
        background: rgba(0, 0, 0, 0.28);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }
      .profileDrop {
        position: absolute;
        top: var(--pTop, 76px);
        left: var(--pLeft, 12px);
        width: min(560px, calc(100vw - 24px));
        max-height: calc(100dvh - var(--pTop, 76px) - 12px - var(--safe-bottom));
        overflow: auto;
        border-radius: 22px;
        border: 1px solid rgba(255, 255, 255, 0.16);
        background: linear-gradient(180deg, rgba(12, 16, 30, 0.92), rgba(12, 16, 30, 0.72));
        box-shadow: 0 24px 70px rgba(0, 0, 0, 0.5);
        transform: translateY(-14px);
        opacity: 0;
        transition: transform 180ms cubic-bezier(0.2, 0.9, 0.2, 1), opacity 160ms ease;
      }
      .profileDropBackdrop.show .profileDrop {
        transform: translateY(0);
        opacity: 1;
      }
      .profileDropHead {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        padding: 12px 14px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      .profileDropBody {
        padding: 14px;
      }
      @media (max-width: 520px) {
        header {
          padding: calc(12px + var(--safe-top)) calc(12px + var(--safe-right)) 12px calc(12px + var(--safe-left));
          flex-wrap: wrap;
          align-items: flex-start;
        }
        header .brand {
          width: 100%;
          justify-content: space-between;
        }
        header .actions {
          width: 100%;
          justify-content: flex-start;
          flex-wrap: wrap;
          gap: 8px;
          overflow: visible;
          padding-bottom: 0;
        }
        header .actions > * {
          flex: 0 0 auto;
        }
        header .actions .btn {
          padding: 8px 10px;
          font-size: 12px;
        }
        header .actions .badgeMini {
          padding: 7px 10px;
        }
      }
      .btn:disabled,
      .badgeMini:disabled {
        opacity: 0.55;
        cursor: not-allowed;
        filter: none !important;
        transform: none !important;
      }
      .badgeMini {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 999px;
        border: 1px solid var(--panel-border);
        background: var(--panel-bg);
        color: var(--muted);
        font-size: 12px;
        white-space: nowrap;
      }
      button.badgeMini {
        cursor: pointer;
        font: inherit;
      }
      button.badgeMini:hover {
        filter: brightness(1.06);
      }
      button.badgeMini:active {
        transform: translateY(1px);
      }
      #homeHeaderBtn {
        display: none;
      }
      body[data-screen="map"] #homeHeaderBtn {
        display: inline-flex;
      }
      .btn {
        border: 1px solid var(--btn-border);
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.14), rgba(255, 255, 255, 0.04)), var(--btn-bg);
        color: var(--text);
        padding: 10px 14px;
        border-radius: 12px;
        cursor: pointer;
        backdrop-filter: blur(var(--ui-blur));
        -webkit-backdrop-filter: blur(var(--ui-blur));
        box-shadow: 0 14px 42px rgba(0, 0, 0, 0.22), 0 0 0 1px rgba(255, 255, 255, 0.06) inset;
        transition: transform 140ms ease, background 140ms ease, border-color 140ms ease, box-shadow 140ms ease;
        user-select: none;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        position: relative;
        overflow: hidden;
        will-change: transform;
      }
      .btn:active {
        transform: translateY(1px);
      }
      .btn.twoLine {
        display: grid;
        place-items: center;
        gap: 2px;
        text-align: center;
        line-height: 1.2;
      }
      .btn.twoLine .tiny {
        font-size: 11px;
        opacity: 0.8;
      }
      .discordBtn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }
      .discordIcon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: rgba(255, 255, 255, 0.92);
      }
      html[data-reduce-motion="1"] .btn {
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
        box-shadow: none;
        transition: none;
      }
      .btn:hover {
        transform: translateY(-2px) scale(1.01);
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.18), rgba(255, 255, 255, 0.05)), var(--btn-hover-bg);
        border-color: var(--btn-hover-border);
        box-shadow: 0 18px 56px rgba(0, 0, 0, 0.28), 0 0 0 1px rgba(255, 255, 255, 0.08) inset;
        filter: saturate(1.08) brightness(1.03);
      }
      .btn:active {
        transform: translateY(0) scale(0.995);
      }
      .btn:focus-visible {
        outline: 2px solid var(--glow-a);
        outline-offset: 3px;
      }
      .btn.primary {
        background: var(--btn-primary-grad);
        border-color: var(--btn-primary-border);
        box-shadow: 0 16px 52px rgba(0, 0, 0, 0.24), 0 0 0 1px var(--glow-a) inset;
      }
      .btn.primary:hover {
        background: var(--btn-primary-grad-hover);
        border-color: var(--btn-primary-border-hover);
        box-shadow: 0 18px 58px rgba(0, 0, 0, 0.3), 0 0 0 1px var(--glow-a) inset;
      }
      .btn.zero {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.12);
        color: rgba(255, 255, 255, 0.8);
        box-shadow: 0 12px 34px rgba(0, 0, 0, 0.16);
      }
      .btn.zero:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.16);
      }
      html[data-mobile="0"] .btn::before {
        content: "";
        position: absolute;
        inset: -2px;
        background: radial-gradient(140px 80px at 30% 15%, var(--shine), transparent 65%),
          radial-gradient(160px 120px at 70% 0%, var(--glow-a), transparent 70%),
          linear-gradient(180deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0));
        opacity: 0.85;
        pointer-events: none;
        transform: translateZ(0);
      }
      html[data-mobile="0"] .btn::after {
        content: "";
        position: absolute;
        top: -60%;
        left: -80%;
        width: 60%;
        height: 220%;
        background: linear-gradient(115deg, transparent 0%, rgba(255, 255, 255, 0.35) 45%, transparent 75%);
        transform: translateX(-120%) rotate(18deg);
        opacity: 0;
        pointer-events: none;
        transition: transform 700ms ease, opacity 200ms ease;
      }
      html[data-mobile="0"] .btn:hover::after {
        opacity: 0.55;
        transform: translateX(320%) rotate(18deg);
      }
      html[data-mobile="0"] .btn.primary::before {
        background: radial-gradient(150px 90px at 28% 18%, var(--shine), transparent 62%),
          radial-gradient(220px 130px at 75% 0%, var(--glow-b), transparent 72%);
        opacity: 0.9;
      }
      html[data-mobile="0"] .btn.zero::before {
        background: radial-gradient(140px 80px at 30% 15%, rgba(255, 255, 255, 0.06), transparent 65%),
          radial-gradient(160px 120px at 70% 0%, rgba(255, 255, 255, 0.04), transparent 70%),
          linear-gradient(180deg, rgba(255, 255, 255, 0.04), rgba(255, 255, 255, 0));
        opacity: 0.55;
      }
      .btn.danger {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.75), rgba(190, 24, 93, 0.25));
        border-color: rgba(239, 68, 68, 0.75);
        color: rgba(255, 255, 255, 0.98);
      }
      .btn.danger:hover {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.86), rgba(190, 24, 93, 0.3));
        border-color: rgba(239, 68, 68, 0.9);
      }
      .btn.ghost {
        background: transparent;
      }
      main {
        position: relative;
        height: 100%;
        overflow: hidden;
      }
      .bgPattern {
        position: absolute;
        inset: 0;
        pointer-events: none;
        overflow: hidden;
        z-index: 1;
        opacity: 0.75;
      }
      html[data-reduce-motion="1"] .bgPattern {
        opacity: 0.35;
      }
      .bgPattern .bgItem {
        position: absolute;
        left: 0;
        top: 0;
        transform: translate(-50%, -50%);
        color: var(--pattern-color);
        font-weight: 800;
        white-space: nowrap;
        user-select: none;
        mix-blend-mode: soft-light;
        text-shadow: 0 18px 40px rgba(0, 0, 0, 0.55);
        filter: blur(0.2px);
      }
      html[data-theme="crimson"] .bgPattern .bgDot {
        position: absolute;
        left: 0;
        top: 0;
        transform: translate(-50%, -50%);
        border-radius: 999px;
        background: radial-gradient(circle at 35% 30%, rgba(255, 255, 255, 0.22), rgba(239, 68, 68, 0.7) 38%, rgba(239, 68, 68, 0) 68%);
        box-shadow: 0 0 16px rgba(239, 68, 68, 0.18);
        mix-blend-mode: screen;
        pointer-events: none;
      }
      .bgPattern .bgItem.word {
        letter-spacing: 1.2px;
      }
      html[data-mobile="1"] .bgPattern .bgItem {
        mix-blend-mode: normal;
        text-shadow: none;
        filter: none;
      }
      .screen {
        position: absolute;
        inset: 0;
        display: grid;
        padding: 20px;
        z-index: 2;
        opacity: 0;
        transform: translateY(12px) scale(0.992);
        filter: blur(6px);
        pointer-events: none;
        transition: opacity 260ms ease, transform 320ms cubic-bezier(0.2, 0.8, 0.2, 1), filter 260ms ease;
        will-change: opacity, transform;
      }
      html[data-mobile="1"] .screen {
        overflow-y: auto;
        overflow-x: hidden;
        overscroll-behavior: contain;
        -webkit-overflow-scrolling: touch;
        touch-action: pan-y;
        padding-bottom: calc(20px + var(--safe-bottom));
      }
      html[data-mobile="1"] #mapScreen {
        overflow: hidden;
        touch-action: none;
        padding-bottom: 20px;
      }
      html[data-reduce-motion="1"] .screen {
        transition: none;
        will-change: auto;
      }
      .screen.active {
        opacity: 1;
        transform: translateY(0) scale(1);
        filter: blur(0px);
        pointer-events: auto;
        z-index: 3;
      }
      html[data-booting="1"] .screen {
        opacity: 0 !important;
        transform: translateY(12px) scale(0.992) !important;
        filter: blur(6px) !important;
        pointer-events: none !important;
        transition: none !important;
      }
      html[data-booting="1"][data-boot-screen="map"] #mapScreen,
      html[data-booting="1"][data-boot-screen="level"] #levelScreen {
        opacity: 1 !important;
        transform: translateY(0) scale(1) !important;
        filter: blur(0px) !important;
        pointer-events: auto !important;
        z-index: 3 !important;
      }
      .home {
        place-items: center;
      }
      .homeStack {
        display: grid;
        place-items: center;
        gap: 14px;
        width: 100%;
        padding-bottom: calc(74px + var(--safe-bottom));
      }
      .panel.homeCard {
        width: min(320px, 92vw);
        min-height: 420px;
        box-shadow: 0 22px 70px rgba(0, 0, 0, 0.32);
      }
      html[data-daily-locked="1"] .panel.homeCard {
        min-height: 360px;
      }
      .homeCard .inner {
        height: 100%;
        display: grid;
        grid-template-rows: 1fr auto auto;
        gap: 12px;
      }
      .homeCard.panel .inner {
        padding: 22px 18px;
      }
      .homeCard .title {
        font-size: clamp(16px, 2.4vw, 22px);
        text-align: center;
        justify-self: center;
      }
      .homeTitleRow {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        direction: ltr;
      }
      .homeTitleLogo {
        width: 30px;
        height: 30px;
        display: block;
        color: #b00000;
        filter: drop-shadow(0 12px 26px rgba(0, 0, 0, 0.35));
        flex: 0 0 auto;
      }
      .homeCard .desc {
        margin: 0;
      }
      .homeButtons {
        display: grid;
        gap: 10px;
        align-content: end;
      }
      .homeButtons .btn {
        width: 100%;
        text-align: center;
        justify-content: center;
        white-space: normal;
        line-height: 1.35;
      }
      .homeFooterBar {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 12;
        border-top: 1px solid rgba(255, 255, 255, 0.12);
        background: linear-gradient(0deg, rgba(18, 24, 44, 0.94), rgba(12, 16, 30, 0.72));
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        padding: 12px calc(16px + var(--safe-right)) calc(12px + var(--safe-bottom)) calc(16px + var(--safe-left));
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        direction: ltr;
      }
      html[data-reduce-motion="1"] .homeFooterBar {
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
        box-shadow: none;
      }
      .homeFooterLinks {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }
      .homeFooterLink {
        appearance: none;
        border: 0;
        background: transparent;
        color: rgba(255, 255, 255, 0.86);
        font-weight: 900;
        font-size: 12px;
        padding: 8px 8px;
        border-radius: 12px;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        text-decoration: none;
      }
      .homeFooterLink::after {
        content: "";
        position: absolute;
        top: -40%;
        bottom: -40%;
        width: 90px;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.26), transparent);
        transform: translateX(-140%) skewX(-18deg);
        opacity: 0;
      }
      .homeFooterLink:hover {
        color: rgba(255, 255, 255, 0.98);
        text-shadow: 0 0 16px rgba(255, 255, 255, 0.18);
        background: rgba(255, 255, 255, 0.06);
      }
      .homeFooterLink:hover::after {
        opacity: 1;
        transform: translateX(240%) skewX(-18deg);
        transition: transform 520ms ease, opacity 240ms ease;
      }
      html[data-reduce-motion="1"] .homeFooterLink:hover::after {
        transition: none;
      }
      .homeFooterLink:focus-visible {
        outline: 2px solid rgba(255, 255, 255, 0.25);
        outline-offset: 2px;
      }
      .homeFooterCopy {
        font-size: 12px;
        opacity: 0.72;
        font-weight: 800;
        letter-spacing: 0.2px;
        user-select: none;
        white-space: nowrap;
      }
      .homeFooterBrand {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        direction: ltr;
      }
      .homeFooterLogo {
        width: 28px;
        height: 28px;
        display: block;
        color: #b00000;
        filter: drop-shadow(0 8px 18px rgba(0, 0, 0, 0.3));
      }
      .homeFooterBrandName {
        font-weight: 900;
        font-size: 15px;
        opacity: 0.92;
        letter-spacing: 0.3px;
      }
      .homeFooterBrandYear {
        font-size: 12px;
        opacity: 0.72;
        margin-inline-start: 8px;
      }
      @media (max-width: 520px) {
        .panel.homeCard {
          min-height: 450px;
        }
      }
      .panel {
        width: min(860px, 100%);
        border-radius: 22px;
        border: 1px solid var(--panel-border);
        background: var(--panel-bg);
        backdrop-filter: blur(var(--ui-blur));
        -webkit-backdrop-filter: blur(var(--ui-blur));
        box-shadow: 0 30px 90px rgba(0, 0, 0, 0.35);
        overflow: hidden;
        position: relative;
      }
      html[data-mobile="0"] .panel {
        background-image: radial-gradient(420px 240px at 18% 10%, var(--shine), transparent 62%),
          radial-gradient(520px 320px at 78% 0%, var(--glow-a), transparent 72%),
          radial-gradient(520px 320px at 92% 10%, var(--glow-b), transparent 72%),
          linear-gradient(180deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0));
      }
      html[data-reduce-motion="1"] .panel {
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
        box-shadow: none;
      }
      .panel .inner {
        padding: 28px;
      }
      .title {
        margin: 0 0 8px 0;
        font-size: clamp(22px, 3vw, 34px);
        letter-spacing: 0.2px;
        font-weight: 900;
        text-shadow: 0 1px 0 rgba(0, 0, 0, 0.18);
      }
      .desc {
        margin: 0 0 20px 0;
        color: var(--muted);
        line-height: 1.9;
        font-size: 14px;
      }
      .home .cta {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }
      .homeFooter {
        display: grid;
        place-items: center;
      }
      .c-ok {
        color: var(--ok);
        font-weight: 700;
      }
      .c-bad {
        color: var(--bad);
        font-weight: 700;
      }
      .c-warn {
        color: var(--warn);
        font-weight: 700;
      }
      .sea {
        display: none;
      }
      .map {
        grid-template-rows: auto 1fr;
        gap: 14px;
        padding-bottom: 26px;
      }
      .mapHeader {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .mapHeader .leftMeta {
        display: flex;
        gap: 10px;
        align-items: end;
        flex-wrap: wrap;
      }
      .mapTools {
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: flex-end;
        flex-wrap: wrap;
      }
      .miniInput {
        height: 38px;
        padding: 8px 12px;
        border-radius: 12px;
        border: 1px solid var(--panel-border);
        background: var(--panel-bg);
        color: var(--text);
        outline: none;
        width: 120px;
        font-size: 16px;
      }
      .miniInput:focus {
        border-color: rgba(255, 255, 255, 0.34);
        box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.06), 0 0 0 1px var(--glow-a) inset;
      }
      html[data-theme="cream"] .miniInput:focus {
        border-color: rgba(0, 0, 0, 0.2);
        box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.06), 0 0 0 1px var(--glow-a) inset;
      }
      .miniInput::placeholder {
        color: var(--muted);
      }
      .mapHeader .meta:last-child {
        text-align: left;
      }
      html[dir="ltr"] .mapHeader .meta:last-child {
        text-align: right;
      }
      .mapHeader .meta {
        display: grid;
        gap: 4px;
      }
      @media (max-width: 520px) {
        .mapHeader {
          flex-direction: column;
          align-items: stretch;
          gap: 12px;
        }
        .mapHeader .leftMeta {
          flex-direction: column;
          align-items: stretch;
          gap: 10px;
        }
        .mapTools {
          justify-content: flex-start;
          width: 100%;
          gap: 8px;
        }
        .miniInput {
          width: 100%;
        }
        .mapHeader .meta:last-child {
          text-align: right;
        }
        html[dir="ltr"] .mapHeader .meta:last-child {
          text-align: left;
        }
      }
      .mapHeader .meta .k {
        font-size: 12px;
        color: var(--muted);
      }
      .mapHeader .meta .v {
        font-size: 14px;
      }
      .mapWrap {
        position: relative;
        height: 100%;
        border-radius: 22px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        overflow: hidden;
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.04), rgba(255, 255, 255, 0.01));
        box-shadow: 0 30px 90px rgba(0, 0, 0, 0.35);
      }
      html[data-theme="cream"] .mapWrap {
        border-color: rgba(0, 0, 0, 0.12);
        background: linear-gradient(180deg, rgba(0, 0, 0, 0.025), rgba(0, 0, 0, 0.01));
      }
      .mapWrap .sea {
        opacity: 0.8;
      }
      .path {
        position: absolute;
        inset: 0;
        overflow: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
        padding: 26px 22px;
        -webkit-overflow-scrolling: touch;
        touch-action: none;
        cursor: default;
        outline: none;
        direction: ltr;
      }
      .path::-webkit-scrollbar {
        display: none;
      }
      .mapArrow {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 44px;
        height: 44px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.22);
        background: rgba(2, 8, 20, 0.45);
        color: rgba(255, 255, 255, 0.95);
        display: grid;
        place-items: center;
        cursor: pointer;
        z-index: 5;
        backdrop-filter: blur(var(--ui-blur));
        -webkit-backdrop-filter: blur(var(--ui-blur));
        user-select: none;
        font-size: 26px;
        line-height: 1;
        direction: ltr;
      }
      .mapArrow.left {
        left: 10px;
      }
      .mapArrow.right {
        right: 10px;
      }
      html[data-reduce-motion="1"] .mapArrow {
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
      }
      html[data-mobile="1"] .mapArrow {
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
        box-shadow: none;
        transition: none;
      }
      @media (max-width: 520px) {
        .mapArrow {
          width: 46px;
          height: 46px;
        }
      }
      .pathInner {
        height: 100%;
        display: flex;
        align-items: center;
        gap: 18px;
        padding-inline: 20px;
        width: max-content;
        min-width: 100%;
      }
      .stagePos {
        position: relative;
        flex: 0 0 auto;
      }
      .stage {
        width: 76px;
        height: 76px;
        border-radius: 18px;
        position: relative;
        border: 1px solid rgba(255, 255, 255, 0.22);
        background: radial-gradient(90px 70px at 30% 25%, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.1) 55%, rgba(255, 255, 255, 0.03) 100%),
          linear-gradient(180deg, var(--glow-a), var(--glow-b));
        backdrop-filter: blur(var(--ui-blur));
        -webkit-backdrop-filter: blur(var(--ui-blur));
        box-shadow: 0 18px 35px rgba(0, 0, 0, 0.28), inset 0 1px 0 rgba(255, 255, 255, 0.25);
        cursor: pointer;
        transition: transform 160ms ease, filter 160ms ease, opacity 160ms ease;
        display: grid;
        place-items: center;
        user-select: none;
        flex: 0 0 auto;
      }
      html[data-mobile="0"] .stage::before {
        content: "";
        position: absolute;
        inset: 1px;
        border-radius: 17px;
        background: radial-gradient(120px 90px at 28% 18%, var(--shine), transparent 60%),
          radial-gradient(180px 120px at 80% 0%, var(--glow-a), transparent 72%);
        opacity: 0.95;
        pointer-events: none;
      }
      html[data-reduce-motion="1"] .stage {
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
        box-shadow: none;
        transition: none;
      }
      html[data-mobile="1"] .stage {
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
        box-shadow: 0 10px 22px rgba(0, 0, 0, 0.22);
        transition: none;
      }
      html[data-mobile="1"] .stage::after {
        display: none;
      }
      .assistGrid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-top: 12px;
      }
      @media (max-width: 740px) {
        .assistGrid {
          grid-template-columns: 1fr;
        }
      }
      .assistCard {
        border-radius: 18px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(255, 255, 255, 0.06);
        padding: 14px;
        display: grid;
        gap: 10px;
      }
      html[data-mobile="0"] .assistCard {
        backdrop-filter: blur(var(--ui-blur));
        -webkit-backdrop-filter: blur(var(--ui-blur));
      }
      .assistCard .t {
        font-weight: 900;
        letter-spacing: 0.2px;
      }
      .assistCard .tiny {
        color: var(--muted);
      }
      html[data-theme="cream"] .stage {
        border-color: rgba(0, 0, 0, 0.16);
        background: radial-gradient(90px 70px at 30% 25%, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.55) 55%, rgba(255, 255, 255, 0.35) 100%);
        box-shadow: 0 16px 34px rgba(0, 0, 0, 0.16), inset 0 1px 0 rgba(255, 255, 255, 0.75);
      }
      .stage::after {
        content: "";
        position: absolute;
        inset: 10px;
        border-radius: 14px;
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.22), rgba(255, 255, 255, 0));
        opacity: 0.35;
        pointer-events: none;
      }
      html[data-theme="cream"] .stage::after {
        background: linear-gradient(145deg, rgba(0, 0, 0, 0.06), rgba(0, 0, 0, 0));
        opacity: 0.35;
      }
      .stage .n {
        font-weight: 700;
        font-size: 18px;
        letter-spacing: 0.6px;
        text-shadow: 0 6px 22px rgba(0, 0, 0, 0.45);
      }
      .stage .s {
        position: absolute;
        bottom: 6px;
        inset-inline: 0;
        text-align: center;
        font-size: 10px;
        font-weight: 900;
        letter-spacing: 1.4px;
        color: rgba(245, 158, 11, 0.92);
        text-shadow: 0 10px 22px rgba(0, 0, 0, 0.35);
        pointer-events: none;
      }
      html[data-theme="cream"] .stage .n {
        text-shadow: 0 10px 22px rgba(255, 255, 255, 0.6);
      }
      html[data-theme="cream"] .stage .s {
        color: rgba(217, 119, 6, 0.95);
        text-shadow: 0 10px 22px rgba(255, 255, 255, 0.55);
      }
      .stage.boss {
        border-color: rgba(99, 102, 241, 0.8);
        box-shadow: 0 18px 35px rgba(0, 0, 0, 0.28), 0 0 0 2px rgba(99, 102, 241, 0.14) inset;
      }
      html[data-theme="cream"] .stage.boss {
        border-color: rgba(99, 102, 241, 0.9);
        box-shadow: 0 16px 34px rgba(0, 0, 0, 0.16), 0 0 0 2px rgba(99, 102, 241, 0.18) inset;
      }
      .stage.locked {
        opacity: 0.32;
        filter: grayscale(0.55);
        cursor: not-allowed;
      }
      html[data-theme="cream"] .stage.locked {
        opacity: 0.42;
        filter: grayscale(0.25);
      }
      .stage.completed {
        border-color: rgba(34, 197, 94, 0.65);
        box-shadow: 0 18px 35px rgba(0, 0, 0, 0.28), 0 0 0 2px rgba(34, 197, 94, 0.12) inset;
      }
      html[data-theme="cream"] .stage.completed {
        border-color: rgba(16, 185, 129, 0.85);
        box-shadow: 0 16px 34px rgba(0, 0, 0, 0.16), 0 0 0 2px rgba(16, 185, 129, 0.14) inset;
      }
      .stage:hover:not(.locked) {
        transform: translateY(-3px);
      }
      .connector {
        width: 26px;
        height: 2px;
        background: rgba(255, 255, 255, 0.18);
        border-radius: 999px;
        flex: 0 0 auto;
      }
      html[data-theme="cream"] .connector {
        background: rgba(0, 0, 0, 0.16);
      }
      .level {
        place-items: center;
      }
      .level .panel {
        width: min(740px, 100%);
      }
      .level .panel .inner {
        max-height: calc(100dvh - 28px);
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
      .levelTop {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 14px;
        flex-wrap: wrap;
      }
      .levelTop .leftBadges,
      .levelTop .rightBadges {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.16);
        background: rgba(255, 255, 255, 0.08);
        color: var(--muted);
        font-size: 12px;
      }
      html[data-mobile="0"] .badge {
        background-image: radial-gradient(220px 120px at 30% 0%, var(--shine), transparent 70%),
          radial-gradient(260px 140px at 85% 0%, var(--glow-a), transparent 76%);
      }
      .lock {
        margin-top: 10px;
        display: grid;
        gap: 14px;
      }
      .slots {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        align-items: start;
      }
      .slots.shake {
        animation: slotsShake 420ms cubic-bezier(0.2, 0.9, 0.2, 1);
      }
      @keyframes slotsShake {
        0% {
          transform: translateX(0);
        }
        14% {
          transform: translateX(-10px);
        }
        30% {
          transform: translateX(8px);
        }
        46% {
          transform: translateX(-7px);
        }
        62% {
          transform: translateX(5px);
        }
        78% {
          transform: translateX(-3px);
        }
        100% {
          transform: translateX(0);
        }
      }
      html[data-reduce-motion="1"] .slots.shake {
        animation: none;
      }
      html[data-lock-shape="circle"] .slots,
      html[data-lock-shape="square"] .slots {
        grid-template-columns: repeat(3, 74px);
        justify-content: center;
      }
      .slotWrap {
        position: relative;
        display: grid;
        gap: 10px;
        justify-items: stretch;
      }
      .slot {
        position: relative;
        width: 100%;
        height: 74px;
        border-radius: var(--slot-radius);
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: linear-gradient(165deg, rgba(255, 255, 255, 0.11), rgba(255, 255, 255, 0.05));
        box-shadow: 0 16px 40px rgba(0, 0, 0, 0.25);
        backdrop-filter: blur(var(--ui-blur));
        -webkit-backdrop-filter: blur(var(--ui-blur));
        display: grid;
        place-items: center;
        transition: background 140ms ease, border-color 140ms ease, transform 140ms ease;
      }
      html[data-mobile="0"] .slot::before {
        content: "";
        position: absolute;
        inset: 1px;
        border-radius: calc(var(--slot-radius) - 1px);
        background: radial-gradient(120px 70px at 30% 20%, var(--shine), transparent 60%),
          radial-gradient(160px 100px at 80% 0%, var(--glow-a), transparent 72%),
          linear-gradient(180deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0));
        opacity: 0.9;
        pointer-events: none;
      }
      html[data-theme="cream"] .slot {
        border-color: rgba(0, 0, 0, 0.12);
        background: linear-gradient(165deg, rgba(255, 255, 255, 0.88), rgba(255, 255, 255, 0.56));
        box-shadow: 0 14px 34px rgba(0, 0, 0, 0.14);
      }
      html[data-mobile="1"] .slot {
        background: linear-gradient(165deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
      }
      html[data-reduce-motion="1"] .slot {
        box-shadow: none;
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
        transition: none;
      }
      .slot input {
        width: 100%;
        height: 100%;
        background: transparent;
        border: none;
        outline: none;
        color: var(--text);
        text-align: center;
        font-size: 30px;
        font-weight: 800;
        letter-spacing: 2px;
        caret-color: rgba(255, 255, 255, 0.85);
      }
      .slot.ok {
        background: rgba(34, 197, 94, 0.18);
        border-color: rgba(34, 197, 94, 0.55);
      }
      .slot.bad {
        background: rgba(239, 68, 68, 0.14);
        border-color: rgba(239, 68, 68, 0.55);
      }
      .slot.warn {
        background: rgba(245, 158, 11, 0.15);
        border-color: rgba(245, 158, 11, 0.58);
      }
      html[data-mobile="1"] .slot.warn {
        background: rgba(245, 158, 11, 0.32);
        border-color: rgba(245, 158, 11, 0.85);
      }
      .hint {
        position: absolute;
        top: -10px;
        left: 50%;
        transform: translate(-50%, -100%);
        padding: 8px 10px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: rgba(2, 8, 20, 0.72);
        color: rgba(255, 255, 255, 0.9);
        font-size: 12px;
        opacity: 0;
        pointer-events: none;
        box-shadow: 0 18px 40px rgba(0, 0, 0, 0.35);
        backdrop-filter: blur(var(--ui-blur));
        -webkit-backdrop-filter: blur(var(--ui-blur));
      }
      html[data-reduce-motion="1"] .hint {
        box-shadow: none;
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
      }
      .hint.show {
        animation: hintPop 1300ms ease forwards;
      }
      html[data-reduce-motion="1"] .hint.show {
        animation: none;
      }
      @keyframes hintPop {
        0% {
          opacity: 0;
          transform: translate(-50%, -90%);
        }
        14% {
          opacity: 1;
          transform: translate(-50%, -104%);
        }
        75% {
          opacity: 1;
          transform: translate(-50%, -110%);
        }
        100% {
          opacity: 0;
          transform: translate(-50%, -122%);
        }
      }
      .levelActions {
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        margin-top: 14px;
      }
      .levelActions .left,
      .levelActions .right {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      .msg {
        min-height: 22px;
        color: var(--muted);
        font-size: 13px;
        line-height: 1.7;
      }
      .history {
        margin-top: 10px;
        display: grid;
        gap: 8px;
        max-height: min(44dvh, 360px);
        overflow-y: auto;
        padding-inline-end: 4px;
        overscroll-behavior: contain;
        -webkit-overflow-scrolling: touch;
      }
      .historyItem {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 10px 12px;
        border-radius: 16px;
        border: 1px solid var(--panel-border);
        background: rgba(255, 255, 255, 0.05);
      }
      html[data-theme="cream"] .historyItem {
        background: rgba(0, 0, 0, 0.03);
      }
      .historyGuess {
        display: flex;
        gap: 6px;
        align-items: center;
        justify-content: flex-start;
        font-weight: 900;
        letter-spacing: 0.2px;
        font-variant-numeric: tabular-nums;
        direction: rtl;
      }
      .historyGuess .d {
        min-width: 12px;
        text-align: center;
      }
      .historyDots {
        display: flex;
        gap: 6px;
        flex: 0 0 auto;
      }
      .dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.25);
        background: rgba(255, 255, 255, 0.07);
      }
      .dot.ok {
        background: rgba(34, 197, 94, 0.75);
        border-color: rgba(34, 197, 94, 0.85);
      }
      .dot.bad {
        background: rgba(239, 68, 68, 0.68);
        border-color: rgba(239, 68, 68, 0.85);
      }
      .dot.warn {
        background: rgba(245, 158, 11, 0.72);
        border-color: rgba(245, 158, 11, 0.9);
      }
      .dot.mask {
        background: rgba(255, 255, 255, 0.12);
        border-color: rgba(255, 255, 255, 0.22);
      }
      html[data-mobile="1"] .dot.warn {
        background: rgba(245, 158, 11, 0.95);
        border-color: rgba(245, 158, 11, 1);
      }
      .coach {
        margin-top: 12px;
        padding: 12px 14px;
        border-radius: 16px;
        border: 1px solid var(--panel-border);
        background: rgba(255, 255, 255, 0.06);
        color: var(--text);
        line-height: 1.8;
        font-size: 13px;
      }
      html[data-theme="cream"] .coach {
        background: rgba(0, 0, 0, 0.03);
      }
      .shopRow {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 16px;
        border: 1px solid var(--panel-border);
        background: rgba(255, 255, 255, 0.05);
      }
      html[data-theme="cream"] .shopRow {
        background: rgba(0, 0, 0, 0.03);
      }
      .shopRow .t {
        font-weight: 800;
      }
      .shopRow.sectionTitle {
        justify-content: center;
      }
      .shopRow.sectionTitle .t {
        width: 100%;
        text-align: center;
        font-size: 16px;
      }
      .shopList {
        display: grid;
        gap: 10px;
        margin-top: 12px;
      }
      .statsGrid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 8px;
        margin-top: 12px;
      }
      .statCard {
        padding: 10px;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.16);
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.09), rgba(255, 255, 255, 0.04));
        box-shadow: 0 16px 50px rgba(0, 0, 0, 0.2), 0 0 0 1px rgba(255, 255, 255, 0.05) inset;
        position: relative;
        overflow: hidden;
        user-select: none;
        cursor: default;
      }
      .statCard > * {
        position: relative;
        z-index: 1;
      }
      html[data-theme="cream"] .statCard {
        background: linear-gradient(180deg, rgba(0, 0, 0, 0.03), rgba(0, 0, 0, 0.02));
      }
      .statCard::before {
        content: "";
        position: absolute;
        inset: -2px;
        pointer-events: none;
        background: linear-gradient(115deg, transparent 0%, rgba(255, 255, 255, 0.13) 45%, transparent 75%);
        transform: translateX(-140%) rotate(18deg);
        opacity: 0.8;
        animation: cardShine 5600ms ease-in-out infinite;
      }
      html[data-reduce-motion="1"] .statCard::before {
        animation: none;
        opacity: 0.32;
        transform: translateX(0) rotate(0deg);
      }
      .statCard::after {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        background: radial-gradient(240px 120px at 18% 0%, rgba(255, 255, 255, 0.14), transparent 62%),
          radial-gradient(260px 140px at 88% 12%, rgba(34, 197, 94, 0.1), transparent 70%);
        opacity: 0.82;
      }
      .statCard .k {
        font-size: 12px;
        color: var(--muted);
      }
      .statCard .v {
        font-size: 15px;
        font-weight: 900;
        margin-top: 6px;
        letter-spacing: 0.2px;
        font-variant-numeric: tabular-nums;
      }
      @keyframes cardShine {
        0% {
          transform: translateX(-140%) rotate(18deg);
        }
        55% {
          transform: translateX(320%) rotate(18deg);
        }
        100% {
          transform: translateX(320%) rotate(18deg);
        }
      }
      html[data-reduce-motion="1"] * {
        transition-duration: 1ms !important;
        animation-duration: 1ms !important;
        animation-iteration-count: 1 !important;
        scroll-behavior: auto !important;
      }
      .win {
        position: fixed;
        inset: 0;
        z-index: 1200;
        pointer-events: none;
        opacity: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 14px;
        transition: opacity 160ms ease;
      }
      .win.show {
        pointer-events: auto;
        opacity: 1;
      }
      .winBackdrop {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.46);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }
      .winPanel {
        position: relative;
        width: min(620px, calc(100vw - 24px));
        border-radius: 18px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(13, 18, 34, 0.92);
        padding: 14px 14px;
        color: rgba(255, 255, 255, 0.92);
        transform: scale(1.06);
        transition: transform 180ms ease;
        display: grid;
        gap: 10px;
        box-shadow: 0 18px 60px rgba(0, 0, 0, 0.35);
      }
      .win.show .winPanel {
        transform: scale(1);
      }
      .win.fx {
        overflow: hidden;
        box-shadow: 0 18px 60px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(34, 197, 94, 0.25) inset;
      }
      .win.fx .winPanel {
        overflow: hidden;
        box-shadow: 0 18px 60px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(34, 197, 94, 0.25) inset;
      }
      html[data-mobile="0"] .win.fx::before {
        content: "";
        position: absolute;
        inset: -2px;
        pointer-events: none;
        background: radial-gradient(220px 120px at 25% 20%, rgba(255, 255, 255, 0.28), transparent 64%),
          radial-gradient(260px 140px at 70% 0%, rgba(34, 197, 94, 0.28), transparent 70%),
          radial-gradient(260px 140px at 90% 20%, rgba(34, 211, 238, 0.18), transparent 72%);
        opacity: 0;
        animation: winGlow 1100ms ease-out 1;
      }
      html[data-mobile="0"] .win.fx::after {
        content: "";
        position: absolute;
        top: -70%;
        left: -90%;
        width: 70%;
        height: 240%;
        background: linear-gradient(115deg, transparent 0%, rgba(255, 255, 255, 0.55) 45%, transparent 75%);
        transform: translateX(-120%) rotate(18deg);
        opacity: 0;
        pointer-events: none;
        animation: winShine 900ms ease-out 1;
      }
      .winFxLayer {
        position: absolute;
        inset: 0;
        pointer-events: none;
        overflow: hidden;
      }
      .winSpark {
        position: absolute;
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: radial-gradient(circle at 35% 35%, rgba(255, 255, 255, 0.95), rgba(34, 197, 94, 0.85) 55%, rgba(34, 197, 94, 0) 70%);
        opacity: 0;
        transform: translate3d(0, 0, 0) scale(0.7);
        animation: winSpark 900ms ease-out 1;
        filter: drop-shadow(0 6px 14px rgba(34, 197, 94, 0.18));
      }
      @keyframes winGlow {
        0% {
          opacity: 0;
        }
        20% {
          opacity: 0.9;
        }
        100% {
          opacity: 0;
        }
      }
      @keyframes winShine {
        0% {
          opacity: 0;
          transform: translateX(-120%) rotate(18deg);
        }
        15% {
          opacity: 0.65;
        }
        100% {
          opacity: 0;
          transform: translateX(340%) rotate(18deg);
        }
      }
      @keyframes winSpark {
        0% {
          opacity: 0;
          transform: translate3d(0, 0, 0) scale(0.7);
        }
        25% {
          opacity: 0.9;
        }
        100% {
          opacity: 0;
          transform: translate3d(0, -18px, 0) scale(1.2);
        }
      }
      .modalBackdrop {
        position: fixed;
        inset: 0;
        display: grid;
        place-items: center;
        padding: calc(20px + var(--safe-top)) calc(20px + var(--safe-right)) calc(20px + var(--safe-bottom)) calc(20px + var(--safe-left));
        background: rgba(0, 0, 0, 0.55);
        backdrop-filter: blur(var(--ui-blur));
        -webkit-backdrop-filter: blur(var(--ui-blur));
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
        transition: opacity 220ms ease, visibility 0ms linear 220ms;
      }
      .modalBackdrop.show {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
        transition: opacity 220ms ease;
      }
      .modal {
        width: min(760px, 100%);
        border-radius: 22px;
        border: 1px solid var(--panel-border);
        background: var(--modal-bg);
        box-shadow: 0 30px 90px rgba(0, 0, 0, 0.55);
        overflow: hidden;
        opacity: 0;
        transform: translateY(10px) scale(0.985);
        transform-origin: var(--modal-origin, 50% 12%);
        max-height: 86vh;
        display: grid;
        grid-template-rows: auto 1fr;
        will-change: transform, opacity;
        transition: transform 280ms cubic-bezier(0.2, 0.9, 0.2, 1), opacity 220ms ease;
      }
      html[data-mobile="0"] .modal {
        background-image: radial-gradient(520px 280px at 18% 0%, var(--shine), transparent 64%),
          radial-gradient(620px 360px at 86% 0%, var(--glow-b), transparent 74%),
          linear-gradient(180deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0));
      }
      @media (max-width: 520px) {
        .modal {
          width: 100%;
          max-height: 92vh;
          border-radius: 18px;
        }
        .modalBody {
          padding: 14px;
        }
        .modalHead {
          padding: 14px;
        }
        .btn {
          min-height: 44px;
        }
      }
      .modalBackdrop.show .modal {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
      .modalBackdrop[data-mode="settings"] .modal,
      .modalBackdrop[data-mode="shop"] .modal {
        transform: translateY(-16px) scale(0.975);
      }
      .modalBackdrop[data-mode="name"] .modal {
        width: min(420px, 100%);
        transform: translateY(-8px) scale(0.985);
      }
      .modalHead {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        padding: 16px 18px;
        border-bottom: 1px solid var(--panel-border);
      }
      .modalHead .btn.ghost,
      .profileDropHead .btn.ghost {
        background: var(--btn-bg);
        border-color: var(--btn-border);
        color: var(--text);
      }
      #closeModalBtn,
      #profileDropClose {
        font-weight: 800;
      }
      .modalHead .h {
        font-weight: 800;
        letter-spacing: 0.2px;
      }
      .modalBody {
        padding: 18px;
        color: var(--text);
        line-height: 1.95;
        font-size: 14px;
        overflow: auto;
        overscroll-behavior: contain;
        -webkit-overflow-scrolling: touch;
        touch-action: pan-y;
      }
      .onlineWrap {
        display: grid;
        gap: 14px;
      }
      .onlineTabs {
        display: inline-flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }
      .onlineTab {
        -webkit-appearance: none;
        appearance: none;
        border: 1px solid rgba(255, 255, 255, 0.16);
        background: rgba(255, 255, 255, 0.05);
        color: rgba(255, 255, 255, 0.86);
        border-radius: 14px;
        padding: 9px 12px;
        font: inherit;
        font-weight: 900;
        font-size: 12px;
        cursor: pointer;
        user-select: none;
        position: relative;
        overflow: hidden;
      }
      .onlineTab.on {
        border-color: rgba(239, 68, 68, 0.42);
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.14);
      }
      .onlineRoomBox {
        border-radius: 18px;
        border: 1px solid rgba(255, 255, 255, 0.16);
        background: rgba(0, 0, 0, 0.16);
        padding: 14px;
        display: grid;
        gap: 10px;
      }
      .onlineRoomLabel {
        font-size: 12px;
        opacity: 0.82;
        font-weight: 800;
      }
      .onlineRoomHint {
        font-size: 12px;
        opacity: 0.78;
        line-height: 1.7;
      }
      .onlineCode {
        text-align: center;
        font-weight: 900;
        letter-spacing: 3px;
        font-size: 28px;
        padding: 10px 12px;
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.16);
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.1), rgba(0, 0, 0, 0.18));
      }
      .roomInput {
        width: 100%;
        padding: 12px 12px;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.16);
        background: rgba(255, 255, 255, 0.06);
        color: var(--text);
        font: inherit;
        font-weight: 900;
        letter-spacing: 2px;
        text-align: center;
        outline: none;
      }
      .roomInput:focus {
        border-color: rgba(34, 211, 238, 0.6);
        box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.18);
      }
      .onlinePacks {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
      }
      @media (max-width: 680px) {
        .onlinePacks {
          grid-template-columns: 1fr;
        }
      }
      .onlinePack {
        -webkit-appearance: none;
        appearance: none;
        border-radius: 18px;
        border: 1px solid var(--panel-border);
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.07), rgba(255, 255, 255, 0.03));
        padding: 14px;
        display: grid;
        gap: 12px;
        text-align: center;
        min-height: 140px;
        transition: transform 180ms ease, border-color 180ms ease, box-shadow 180ms ease;
        cursor: pointer;
        user-select: none;
        color: var(--text);
        font-family: inherit;
      }
      .onlinePack:hover {
        transform: translateY(-2px);
        border-color: rgba(255, 255, 255, 0.2);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
      }
      .onlinePack:active {
        transform: translateY(0px) scale(0.995);
      }
      .onlinePack .t {
        font-weight: 900;
        letter-spacing: 0.3px;
        font-size: 20px;
        color: var(--text);
      }
      .onlinePack .sub {
        color: var(--muted);
        font-size: 13px;
      }
      .onlinePack .price {
        font-weight: 900;
        font-size: 22px;
        letter-spacing: 0.2px;
        color: var(--text);
      }
      .onlinePack .cta {
        display: inline-flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        padding: 10px 12px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(255, 255, 255, 0.06);
        color: var(--text);
        font-weight: 800;
      }
      .coinChip {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.16);
        background: rgba(0, 0, 0, 0.18);
        color: rgba(255, 255, 255, 0.92);
        font-weight: 900;
        letter-spacing: 0.2px;
        white-space: nowrap;
      }
      html[data-theme="cream"] .coinChip {
        background: rgba(255, 255, 255, 0.75);
        border: 1px solid rgba(0, 0, 0, 0.08);
        color: rgba(18, 22, 26, 0.92);
      }
      .onlineEndRow {
        display: grid;
        grid-template-columns: 1fr 160px 1fr;
        gap: 12px;
        align-items: center;
      }
      @media (max-width: 680px) {
        .onlineEndRow {
          grid-template-columns: 1fr;
        }
      }
      .onlineEndCard {
        border-radius: 18px;
        border: 1px solid rgba(255, 255, 255, 0.16);
        background: rgba(0, 0, 0, 0.14);
        padding: 12px;
        display: grid;
        grid-template-columns: 54px 1fr;
        gap: 12px;
        align-items: center;
      }
      .onlineEndMeta {
        display: grid;
        gap: 4px;
        min-width: 0;
      }
      .onlineEndName {
        font-weight: 900;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .onlineEndTag {
        font-size: 12px;
        color: var(--muted);
      }
      .onlineEndBridge {
        display: grid;
        gap: 6px;
        justify-items: center;
      }
      .onlineEndLane {
        width: 160px;
        height: 32px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(255, 255, 255, 0.06);
        position: relative;
        overflow: hidden;
        --chip-w: 78px;
      }
      .onlineEndLane .coinChip {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: var(--chip-w);
      }
      .onlineEndLane.ltr .coinChip {
        left: 8px;
        animation: coinMoveLTR 900ms cubic-bezier(0.22, 1, 0.36, 1) forwards;
      }
      .onlineEndLane.rtl .coinChip {
        right: 8px;
        animation: coinMoveRTL 900ms cubic-bezier(0.22, 1, 0.36, 1) forwards;
      }
      @keyframes coinMoveLTR {
        0% {
          transform: translateY(-50%) translateX(0) scale(1);
          filter: saturate(1);
        }
        65% {
          transform: translateY(-50%) translateX(calc(160px - var(--chip-w) - 16px)) scale(1.08);
          filter: saturate(1.2);
        }
        100% {
          transform: translateY(-50%) translateX(calc(160px - var(--chip-w) - 16px)) scale(1);
          filter: saturate(1.2);
        }
      }
      @keyframes coinMoveRTL {
        0% {
          transform: translateY(-50%) translateX(0) scale(1);
          filter: saturate(1);
        }
        65% {
          transform: translateY(-50%) translateX(calc(-1 * (160px - var(--chip-w) - 16px))) scale(1.08);
          filter: saturate(1.2);
        }
        100% {
          transform: translateY(-50%) translateX(calc(-1 * (160px - var(--chip-w) - 16px))) scale(1);
          filter: saturate(1.2);
        }
      }
      .onlineWin {
        border-color: rgba(59, 130, 246, 0.55);
        background: rgba(59, 130, 246, 0.14);
      }
      .onlineLose {
        border-color: rgba(239, 68, 68, 0.5);
        background: rgba(239, 68, 68, 0.12);
      }
      .onlineMatchRow {
        display: grid;
        grid-template-columns: 1fr 40px 1fr;
        gap: 12px;
        align-items: center;
      }
      .onlineFoundCountdown {
        text-align: center;
        font-weight: 900;
        margin-top: 10px;
        margin-bottom: 10px;
        letter-spacing: 0.1px;
      }
      .onlineVs {
        text-align: center;
        color: var(--muted);
        font-weight: 900;
        letter-spacing: 0.2px;
      }
      .onlinePlayerCard {
        border-radius: 18px;
        border: 1px solid var(--panel-border);
        background: rgba(255, 255, 255, 0.05);
        padding: 12px;
        display: grid;
        grid-template-columns: 54px 1fr;
        gap: 12px;
        align-items: center;
        transition: border-color 180ms ease, box-shadow 180ms ease, background 180ms ease;
      }
      .onlinePlayerCard.turnActive {
        border-color: rgba(34, 197, 94, 0.7);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.22), 0 0 0 1px rgba(34, 197, 94, 0.35), 0 0 22px rgba(34, 197, 94, 0.22);
        background: rgba(34, 197, 94, 0.12);
      }
      .onlinePlayerCard.flash {
        animation: cardFlash 420ms ease-out 1;
      }
      @keyframes cardFlash {
        0% {
          box-shadow: 0 0 0 rgba(34, 197, 94, 0);
        }
        35% {
          box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.35), 0 0 26px rgba(34, 197, 94, 0.22);
        }
        100% {
          box-shadow: 0 0 0 rgba(34, 197, 94, 0);
        }
      }
      .onlineAvatar {
        width: 54px;
        height: 54px;
        border-radius: 16px;
        display: grid;
        place-items: center;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.14);
        overflow: hidden;
        position: relative;
      }
      .onlineAvatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      .onlineAvatar.active {
        outline: none;
      }
      .onlineMeta {
        display: grid;
        gap: 2px;
        min-width: 0;
      }
      .onlineName {
        font-weight: 900;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .onlineTiny {
        color: var(--muted);
        font-size: 12px;
      }
      .onlineBar {
        height: 10px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(255, 255, 255, 0.06);
        overflow: hidden;
      }
      .onlineBar > span {
        display: block;
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, rgba(34, 197, 94, 0.9), rgba(59, 130, 246, 0.9));
        transition: width 60ms linear;
      }
      .coinFxLayer {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 4000;
      }
      .flyCoin {
        position: fixed;
        width: 18px;
        height: 18px;
        display: grid;
        place-items: center;
        font-size: 16px;
        filter: drop-shadow(0 10px 16px rgba(0, 0, 0, 0.4));
        will-change: transform, opacity;
      }
      .slot input::placeholder {
        color: rgba(255, 255, 255, 0.42);
        font-weight: 900;
        font-style: italic;
        letter-spacing: 0.8px;
      }
      .maskM {
        font-weight: 900;
        font-style: italic;
        letter-spacing: 0.8px;
      }
      .modalList {
        margin: 10px 0 0 0;
        padding: 0 18px 0 0;
        display: grid;
        gap: 10px;
      }
      .modalList li {
        list-style: none;
        padding: 12px 12px;
        border-radius: 16px;
        border: 1px solid var(--panel-border);
        background: rgba(255, 255, 255, 0.06);
      }
      html[data-theme="cream"] .modalList li {
        background: rgba(0, 0, 0, 0.03);
      }
      .win .t {
        font-weight: 700;
      }
      .tiny {
        font-size: 12px;
        color: var(--muted);
      }
      .kbd {
        display: none;
      }
      .friendsPanel {
        position: fixed;
        top: calc(74px + var(--safe-top));
        left: 16px;
        right: auto;
        width: min(380px, calc(100vw - 24px));
        z-index: 999;
        transform: translateY(-140%);
        transition: transform 260ms ease;
        pointer-events: none;
      }
      html[dir="ltr"] .friendsPanel {
        right: 16px;
        left: auto;
      }
      .friendsPanel.open {
        transform: translateY(0);
        pointer-events: auto;
      }
      .friendDetailsBackdrop {
        position: fixed;
        inset: 0;
        z-index: 1000;
        pointer-events: none;
        opacity: 0;
        transition: opacity 160ms ease;
      }
      .friendDetailsBackdrop.show {
        pointer-events: auto;
        opacity: 1;
        background: rgba(0, 0, 0, 0.34);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }
      .friendDetailsCard {
        position: absolute;
        top: calc(74px + var(--safe-top));
        left: 50%;
        transform: translateX(-50%);
        width: min(560px, calc(100vw - 24px));
        max-height: calc(100dvh - 96px - var(--safe-bottom));
        overflow: auto;
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.16);
        background: rgba(13, 18, 34, 0.88);
        box-shadow: 0 18px 54px rgba(0, 0, 0, 0.38);
        padding: 10px;
      }
      .friendDetailsTop {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }
      .friendDetailsTitle {
        font-weight: 900;
        font-size: 14px;
        letter-spacing: 0.2px;
      }
      .friendDetailsClose {
        width: 34px;
        height: 34px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(255, 255, 255, 0.06);
        color: #fff;
        cursor: pointer;
      }
      .confirmMiniBackdrop {
        position: fixed;
        inset: 0;
        z-index: 1100;
        pointer-events: none;
        opacity: 0;
        transition: opacity 160ms ease;
      }
      .confirmMiniBackdrop.show {
        pointer-events: auto;
        opacity: 1;
        background: rgba(0, 0, 0, 0.38);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }
      .confirmMiniCard {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%) scale(1.06);
        width: min(360px, calc(100vw - 24px));
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(13, 18, 34, 0.92);
        padding: 12px;
        box-shadow: 0 16px 40px rgba(0, 0, 0, 0.35);
        transition: transform 180ms ease;
      }
      .confirmMiniBackdrop.show .confirmMiniCard {
        transform: translate(-50%, -50%) scale(1);
      }
      .confirmMiniQ {
        font-weight: 900;
        font-size: 13px;
      }
      .confirmMiniRow {
        display: flex;
        gap: 10px;
        margin-top: 12px;
      }
      .confirmMiniRow .btn {
        flex: 1;
      }
      .formMiniCard {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%) scale(1.06);
        width: min(420px, calc(100vw - 24px));
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(13, 18, 34, 0.92);
        padding: 12px;
        box-shadow: 0 16px 40px rgba(0, 0, 0, 0.35);
        transition: transform 180ms ease;
      }
      .confirmMiniBackdrop.show .formMiniCard {
        transform: translate(-50%, -50%) scale(1);
      }
      .formMiniHead {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }
      .formMiniClose {
        width: 34px;
        height: 34px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(255, 255, 255, 0.06);
        color: #fff;
        cursor: pointer;
      }
      .miniSelect {
        width: 100%;
      }
      .miniSelectWrap {
        position: relative;
        width: 100%;
      }
      .miniSelectBtn {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        user-select: none;
      }
      .miniSelectBtn::after {
        content: "";
        opacity: 0.8;
        font-weight: 900;
      }
      .miniSelectMenu {
        position: absolute;
        inset-inline: 0;
        top: calc(100% + 8px);
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(13, 18, 34, 0.98);
        box-shadow: 0 16px 40px rgba(0, 0, 0, 0.42);
        padding: 6px;
        display: none;
        gap: 6px;
        z-index: 1000;
        max-height: 240px;
        overflow: auto;
      }
      .miniSelectMenu.show {
        display: grid;
      }
      .miniSelectOption {
        width: 100%;
        text-align: right;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(255, 255, 255, 0.06);
        color: rgba(255, 255, 255, 0.92);
        padding: 10px 10px;
        cursor: pointer;
        font-weight: 900;
      }
      .miniSelectOption.active {
        border-color: rgba(34, 211, 238, 0.58);
        background: rgba(34, 211, 238, 0.12);
      }
      .miniTextarea {
        width: 100%;
        min-height: 110px;
        resize: vertical;
        margin-top: 10px;
      }
      .setupDigits {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 10px;
        padding: 8px 6px;
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(255, 255, 255, 0.04);
        cursor: text;
        user-select: none;
      }
      .setupDigits:focus-visible {
        outline: none;
        border-color: rgba(34, 211, 238, 0.6);
        box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.18);
      }
      .setupDot {
        width: 44px;
        height: 44px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.08), rgba(0, 0, 0, 0.14));
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 900;
        font-size: 20px;
        letter-spacing: 0.4px;
        color: rgba(255, 255, 255, 0.92);
        transition: transform 140ms ease, border-color 140ms ease, box-shadow 140ms ease;
      }
      .setupDot.filled {
        border-color: rgba(239, 68, 68, 0.42);
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.14);
        transform: translateY(-1px);
      }
      .setupHiddenInput {
        position: absolute;
        opacity: 0;
        pointer-events: none;
        left: -9999px;
        top: -9999px;
        width: 1px;
        height: 1px;
      }
      .setupStatusRow {
        display: flex;
        justify-content: center;
        gap: 12px;
        flex-wrap: wrap;
        margin-top: 12px;
        font-size: 13px;
        font-weight: 900;
      }
      .setupStatusTag {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(255, 255, 255, 0.04);
      }
      .setupStatusTag.ok {
        border-color: rgba(34, 211, 238, 0.34);
        box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.12);
      }
      .propsPickCard {
        width: min(560px, calc(100vw - 24px));
      }
      .propsCardsGrid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(92px, 1fr));
        gap: 12px;
        margin: 12px auto 0;
        max-width: 540px;
      }
      .propsCardBtn {
        border: 0;
        padding: 0;
        background: transparent;
        cursor: pointer;
        width: 100%;
      }
      .propsCardBtn:disabled {
        cursor: not-allowed;
        opacity: 0.7;
      }
      .propsCard {
        width: 100%;
        aspect-ratio: 5 / 7;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        box-shadow: 0 10px 26px rgba(0, 0, 0, 0.22);
        position: relative;
        transform-style: preserve-3d;
        transition: transform 220ms ease, border-color 160ms ease;
      }
      .propsCardBtn:hover .propsCard {
        border-color: rgba(239, 68, 68, 0.4);
      }
      .propsCard.flipped {
        transform: rotateY(180deg);
      }
      .propsFace {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 10px;
        backface-visibility: hidden;
        -webkit-backface-visibility: hidden;
        border-radius: 14px;
        overflow: hidden;
      }
      .propsFace::before {
        content: "";
        position: absolute;
        inset: 0;
        background-image: url("cards/cards.png");
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        opacity: 0.95;
      }
      .propsFace::after {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at 50% 35%, rgba(255, 255, 255, 0.08), rgba(0, 0, 0, 0.22));
        opacity: 1;
      }
      .propsFace.back {
        transform: rotateY(0deg);
        gap: 10px;
      }
      .propsFace.front {
        transform: rotateY(180deg);
        text-align: center;
        font-weight: 900;
        font-size: 12.5px;
        line-height: 1.5;
        color: rgba(255, 255, 255, 0.92);
      }
      .propsText {
        position: relative;
        z-index: 2;
        padding: 8px 10px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(0, 0, 0, 0.34);
        box-shadow: 0 10px 22px rgba(0, 0, 0, 0.2);
        max-width: 100%;
      }
      .propsLogo {
        width: 26px;
        height: 26px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: rgba(255, 255, 255, 0.08);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: 1000;
        letter-spacing: 0.4px;
        position: relative;
        z-index: 2;
      }
      .propsHudRow {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-top: 10px;
        padding: 10px;
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(255, 255, 255, 0.04);
      }
      .propsHudCard {
        flex: 1;
        min-height: 56px;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background-image: url("cards/cards.png");
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 10px;
        font-weight: 900;
        font-size: 13px;
        text-align: center;
        position: relative;
        overflow: hidden;
      }
      .propsHudCard::after {
        content: "";
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.36);
      }
      .propsHudCard {
        color: rgba(255, 255, 255, 0.92);
      }
      .propsHudCard > * {
        position: relative;
        z-index: 1;
      }
      .setupCheck {
        width: 18px;
        height: 18px;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: rgba(34, 211, 238, 0.18);
        color: rgba(255, 255, 255, 0.92);
        font-size: 12px;
        line-height: 1;
      }
      .legalBody {
        margin-top: 10px;
        font-size: 12px;
        line-height: 1.7;
        opacity: 0.92;
        max-height: min(52vh, 360px);
        overflow: auto;
        padding-inline-end: 6px;
      }
      .chatPanel {
        position: fixed;
        top: calc(74px + var(--safe-top));
        left: 16px;
        right: auto;
        width: min(760px, calc(100vw - 24px));
        z-index: 999;
        transform: translateY(-140%);
        transition: transform 260ms ease;
        pointer-events: none;
      }
      html[dir="ltr"] .chatPanel {
        right: 16px;
        left: auto;
      }
      .chatPanel.open {
        transform: translateY(0);
        pointer-events: auto;
      }
      .friendsCard {
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(13, 18, 34, 0.82);
        backdrop-filter: blur(12px);
        padding: 12px;
        box-shadow: 0 16px 40px rgba(0, 0, 0, 0.35);
        max-height: calc(100dvh - 96px - var(--safe-bottom));
        overflow: auto;
        overscroll-behavior: contain;
        -webkit-overflow-scrolling: touch;
      }
      .chatCard {
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(13, 18, 34, 0.82);
        backdrop-filter: blur(12px);
        padding: 12px;
        box-shadow: 0 16px 40px rgba(0, 0, 0, 0.35);
        max-height: min(660px, calc(100dvh - 96px - var(--safe-bottom)));
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }
      .chatTop {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }
      .chatTitle {
        font-weight: 800;
        font-size: 14px;
        letter-spacing: 0.2px;
      }
      .chatLayout {
        margin-top: 10px;
        display: grid;
        grid-template-columns: minmax(210px, 250px) 1fr;
        gap: 10px;
        min-height: 300px;
        height: min(560px, calc(100dvh - 220px - var(--safe-bottom)));
      }
      .chatLeft {
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(255, 255, 255, 0.04);
        padding: 10px;
        display: grid;
        grid-template-rows: auto 1fr;
        gap: 10px;
        overflow: hidden;
      }
      .chatFriendsList {
        display: grid;
        gap: 8px;
        overflow: auto;
        padding: 10px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: linear-gradient(180deg, rgba(0, 0, 0, 0.22), rgba(0, 0, 0, 0.12));
        align-content: start;
      }
      .chatFriendRow {
        width: 100%;
        padding: 18px 20px;
        min-height: 88px;
        border-radius: 14px;
        border: 1px solid var(--btn-border);
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.14), rgba(255, 255, 255, 0.04)), var(--btn-bg);
        color: var(--text);
        cursor: pointer;
        backdrop-filter: blur(var(--ui-blur));
        -webkit-backdrop-filter: blur(var(--ui-blur));
        box-shadow: 0 14px 42px rgba(0, 0, 0, 0.22), 0 0 0 1px rgba(255, 255, 255, 0.06) inset;
        transition: transform 140ms ease, background 140ms ease, border-color 140ms ease, box-shadow 140ms ease, filter 140ms ease;
        user-select: none;
        position: relative;
        overflow: hidden;
      }
      .chatFriendRow:hover {
        transform: translateY(-1px);
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.18), rgba(255, 255, 255, 0.05)), var(--btn-hover-bg);
        border-color: var(--btn-hover-border);
        box-shadow: 0 18px 56px rgba(0, 0, 0, 0.28), 0 0 0 1px rgba(255, 255, 255, 0.08) inset;
        filter: saturate(1.08) brightness(1.03);
      }
      .chatFriendRow:active {
        transform: translateY(0px) scale(0.995);
      }
      .chatFriendRow:focus-visible {
        outline: 2px solid var(--glow-a);
        outline-offset: 3px;
      }
      .chatFriendRow.active {
        border-color: var(--btn-primary-border);
        background: var(--btn-primary-grad);
        box-shadow: 0 18px 58px rgba(0, 0, 0, 0.3), 0 0 0 1px var(--glow-a) inset;
      }
      html[data-mobile="0"] .chatFriendRow::before {
        content: "";
        position: absolute;
        inset: -2px;
        background: radial-gradient(140px 80px at 30% 15%, var(--shine), transparent 65%),
          radial-gradient(160px 120px at 70% 0%, var(--glow-a), transparent 70%),
          linear-gradient(180deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0));
        opacity: 0.75;
        pointer-events: none;
        transform: translateZ(0);
      }
      html[data-mobile="0"] .chatFriendRow::after {
        content: "";
        position: absolute;
        top: -60%;
        left: -80%;
        width: 60%;
        height: 220%;
        background: linear-gradient(115deg, transparent 0%, rgba(255, 255, 255, 0.35) 45%, transparent 75%);
        transform: translateX(-120%) rotate(18deg);
        opacity: 0;
        pointer-events: none;
        transition: transform 700ms ease, opacity 200ms ease;
      }
      html[data-mobile="0"] .chatFriendRow:hover::after {
        opacity: 0.55;
        transform: translateX(320%) rotate(18deg);
      }
      .chatRight {
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(255, 255, 255, 0.04);
        padding: 10px;
        display: grid;
        grid-template-rows: auto 1fr auto;
        gap: 10px;
        overflow: hidden;
      }
      .chatHeader {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 10px;
      }
      .chatPeerName {
        font-weight: 800;
      }
      .chatMessages {
        overflow: auto;
        padding: 6px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(0, 0, 0, 0.14);
      }
      .chatMsgRow {
        display: flex;
        margin: 6px 0;
      }
      .chatMsgRow.me {
        justify-content: flex-start;
      }
      html[dir="ltr"] .chatMsgRow.me {
        justify-content: flex-end;
      }
      .chatMsgRow.them {
        justify-content: flex-end;
      }
      html[dir="ltr"] .chatMsgRow.them {
        justify-content: flex-start;
      }
      .chatBubble {
        display: inline-flex;
        flex-direction: column;
        gap: 4px;
        width: fit-content;
        max-width: 84%;
        padding: 6px 10px;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(37, 99, 235, 0.1);
        white-space: pre-wrap;
        word-break: break-word;
        line-height: 1.5;
      }
      .chatBubble.me {
        border-color: rgba(37, 99, 235, 0.65);
        background: rgba(37, 99, 235, 0.22);
      }
      .chatMetaLine {
        font-size: 9px;
        opacity: 0.72;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .chatStatus {
        font-size: 9px;
        opacity: 0.72;
      }
      #chatBtn {
        position: relative;
      }
      #chatBtn.hasNotifyDot::after {
        content: "";
        position: absolute;
        top: 6px;
        right: 6px;
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: rgba(239, 68, 68, 0.95);
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.18);
      }
      html[dir="ltr"] #chatBtn.hasNotifyDot::after {
        left: 6px;
        right: auto;
      }
      .friendLine {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-direction: row-reverse;
      }
      html[dir="ltr"] .friendLine {
        flex-direction: row;
      }
      .avatarMini {
        width: 30px;
        height: 30px;
        border-radius: 9px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: rgba(255, 255, 255, 0.06);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        flex: 0 0 auto;
        font-weight: 800;
        font-size: 12px;
      }
      .avatarMini img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      .friendText {
        min-width: 0;
        flex: 1 1 auto;
      }
      .friendNameRow {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        min-width: 0;
        width: 100%;
      }
      .friendNameText {
        min-width: 0;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        white-space: normal;
        font-weight: 900;
        letter-spacing: 0.1px;
        line-height: 1.2;
      }
      .chatComposer {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .chatComposer .miniInput {
        flex: 1 1 auto;
      }
      .avatarSquare {
        width: 60px;
        height: 60px;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: rgba(255, 255, 255, 0.06);
        display: grid;
        place-items: center;
        font-weight: 900;
        letter-spacing: 0.4px;
        overflow: hidden;
      }
      .avatarSquare img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      @media (max-width: 520px) {
        .avatarSquare {
          width: 56px;
          height: 56px;
        }
      }
      .friendsTop {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }
      .friendsTitle {
        font-weight: 800;
        font-size: 14px;
        letter-spacing: 0.2px;
      }
      .friendsClose {
        width: 34px;
        height: 34px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(255, 255, 255, 0.06);
        color: #fff;
        cursor: pointer;
      }
      .friendsMe {
        margin-top: 10px;
        display: grid;
        gap: 2px;
      }
      .friendsMeRow {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }
      .friendsMeRight {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }
      .friendsMeLeft {
        margin-inline-start: auto;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .friendsPhotoBtn {
        min-height: 32px;
        padding: 6px 9px;
        font-size: 12px;
        border-radius: 12px;
      }
      .friendsMe .k {
        opacity: 0.78;
        font-size: 12px;
      }
      .friendsMe .v {
        font-weight: 700;
      }
      .friendsAddRow {
        margin-top: 10px;
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .friendsTabs {
        margin-top: 10px;
        display: flex;
        gap: 6px;
        padding: 6px;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.16);
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.03));
        backdrop-filter: blur(var(--ui-blur));
        -webkit-backdrop-filter: blur(var(--ui-blur));
      }
      .friendsTab {
        flex: 1 1 auto;
        padding: 8px 10px;
        border-radius: 12px;
        border: 1px solid var(--btn-border);
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.14), rgba(255, 255, 255, 0.04)), var(--btn-bg);
        color: var(--text);
        cursor: pointer;
        font-weight: 800;
        font-size: 12px;
        transition: transform 140ms ease, filter 140ms ease, border-color 140ms ease, background 140ms ease;
        position: relative;
        overflow: hidden;
      }
      .friendsTab:hover {
        transform: translateY(-1px);
        filter: brightness(1.05);
        border-color: var(--btn-hover-border);
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.18), rgba(255, 255, 255, 0.05)), var(--btn-hover-bg);
      }
      .friendsTab:active {
        transform: translateY(0px) scale(0.99);
      }
      .friendsTab.active {
        border-color: var(--btn-primary-border);
        background: var(--btn-primary-grad);
      }
      html[data-mobile="0"] .friendsTab::after {
        content: "";
        position: absolute;
        top: -60%;
        left: -80%;
        width: 60%;
        height: 220%;
        background: linear-gradient(115deg, transparent 0%, rgba(255, 255, 255, 0.32) 45%, transparent 75%);
        transform: translateX(-120%) rotate(18deg);
        opacity: 0;
        pointer-events: none;
        transition: transform 700ms ease, opacity 200ms ease;
      }
      html[data-mobile="0"] .friendsTab:hover::after {
        opacity: 0.5;
        transform: translateX(320%) rotate(18deg);
      }
      .friendsList {
        margin-top: 10px;
        display: grid;
        gap: 8px;
        max-height: 320px;
        overflow: auto;
        padding: 10px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: linear-gradient(180deg, rgba(0, 0, 0, 0.22), rgba(0, 0, 0, 0.12));
        align-content: start;
      }
      .emptyCard {
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(255, 255, 255, 0.05);
        padding: 12px;
        display: grid;
        gap: 10px;
      }
      .emptyCard .t {
        font-weight: 900;
      }
      .emptyCard .tiny {
        margin-top: -4px;
      }
      .emptyCard .ctaRow {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }
      .skRow {
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(255, 255, 255, 0.04);
        padding: 10px;
        overflow: hidden;
        position: relative;
      }
      .skRow::before {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(115deg, transparent 0%, rgba(255, 255, 255, 0.12) 45%, transparent 75%);
        transform: translateX(-120%) rotate(18deg);
        animation: shimmer 1200ms ease-in-out infinite;
        opacity: 0.8;
      }
      html[data-reduce-motion="1"] .skRow::before {
        animation: none;
        opacity: 0.35;
      }
      .skLine {
        height: 10px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.09);
      }
      .skLine.lg {
        height: 12px;
        width: 66%;
      }
      .skLine.sm {
        margin-top: 8px;
        width: 48%;
        opacity: 0.75;
      }
      @keyframes shimmer {
        0% {
          transform: translateX(-140%) rotate(18deg);
        }
        100% {
          transform: translateX(320%) rotate(18deg);
        }
      }
      .giftRow {
        text-align: right;
        width: 100%;
        padding: 10px 10px;
        border-radius: 14px;
        border: 1px solid var(--btn-border);
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.14), rgba(255, 255, 255, 0.04)), var(--btn-bg);
        color: var(--text);
        backdrop-filter: blur(var(--ui-blur));
        -webkit-backdrop-filter: blur(var(--ui-blur));
        box-shadow: 0 14px 42px rgba(0, 0, 0, 0.22), 0 0 0 1px rgba(255, 255, 255, 0.06) inset;
        position: relative;
        overflow: hidden;
      }
      .friendRow {
        text-align: right;
        width: 100%;
        padding: 18px 20px;
        min-height: 88px;
        border-radius: 14px;
        border: 1px solid var(--btn-border);
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.14), rgba(255, 255, 255, 0.04)), var(--btn-bg);
        color: var(--text);
        cursor: pointer;
        backdrop-filter: blur(var(--ui-blur));
        -webkit-backdrop-filter: blur(var(--ui-blur));
        box-shadow: 0 14px 42px rgba(0, 0, 0, 0.22), 0 0 0 1px rgba(255, 255, 255, 0.06) inset;
        transition: transform 140ms ease, background 140ms ease, border-color 140ms ease, box-shadow 140ms ease, filter 140ms ease;
        user-select: none;
        position: relative;
        overflow: hidden;
      }
      .friendRow:hover {
        transform: translateY(-1px);
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.18), rgba(255, 255, 255, 0.05)), var(--btn-hover-bg);
        border-color: var(--btn-hover-border);
        box-shadow: 0 18px 56px rgba(0, 0, 0, 0.28), 0 0 0 1px rgba(255, 255, 255, 0.08) inset;
        filter: saturate(1.08) brightness(1.03);
      }
      .friendRow:active {
        transform: translateY(0px) scale(0.995);
      }
      .friendRow:focus-visible {
        outline: 2px solid var(--glow-a);
        outline-offset: 3px;
      }
      .friendRow.active {
        border-color: var(--btn-primary-border);
        background: var(--btn-primary-grad);
        box-shadow: 0 18px 58px rgba(0, 0, 0, 0.3), 0 0 0 1px var(--glow-a) inset;
      }
      .friendMeta {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        align-items: center;
        flex-direction: row-reverse;
      }
      html[dir="ltr"] .friendMeta {
        flex-direction: row;
      }
      .friendMeta .name {
        font-weight: 900;
        letter-spacing: 0.1px;
        font-size: 14px;
        min-width: 0;
        flex: 1 1 auto;
        text-shadow: 0 1px 0 rgba(0, 0, 0, 0.18);
      }
      .friendMeta .id {
        opacity: 0.85;
        font-size: 12px;
        font-weight: 800;
        letter-spacing: 0.6px;
        flex: 0 0 auto;
      }
      html[data-mobile="0"] .friendRow::before,
      html[data-mobile="0"] .giftRow::before {
        content: "";
        position: absolute;
        inset: -2px;
        background: radial-gradient(140px 80px at 30% 15%, var(--shine), transparent 65%),
          radial-gradient(160px 120px at 70% 0%, var(--glow-a), transparent 70%),
          linear-gradient(180deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0));
        opacity: 0.75;
        pointer-events: none;
        transform: translateZ(0);
      }
      html[data-mobile="0"] .friendRow::after,
      html[data-mobile="0"] .giftRow::after {
        content: "";
        position: absolute;
        top: -60%;
        left: -80%;
        width: 60%;
        height: 220%;
        background: linear-gradient(115deg, transparent 0%, rgba(255, 255, 255, 0.35) 45%, transparent 75%);
        transform: translateX(-120%) rotate(18deg);
        opacity: 0;
        pointer-events: none;
        transition: transform 700ms ease, opacity 200ms ease;
      }
      html[data-mobile="0"] .friendRow:hover::after,
      html[data-mobile="0"] .giftRow:hover::after {
        opacity: 0.55;
        transform: translateX(320%) rotate(18deg);
      }
      .idLine {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .idWithCopy {
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      .copyBtn {
        width: 28px;
        height: 28px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(255, 255, 255, 0.06);
        color: #fff;
        cursor: pointer;
        display: grid;
        place-items: center;
        padding: 0;
        font: inherit;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
      }
      .copyBtn:hover {
        filter: brightness(1.08);
      }
      .copyBtn:active {
        transform: translateY(1px);
      }
      .copyBtnInline {
        width: 26px;
        height: 26px;
        border-radius: 11px;
        font-size: 12px;
      }
      .friendsMeLeft .avatarSquare,
      .friendsFriendAvatar {
        cursor: pointer;
      }
      .avatarViewer {
        position: fixed;
        inset: 0;
        z-index: 1300;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 16px;
      }
      .avatarViewer.open {
        display: flex;
      }
      .avatarViewerBackdrop {
        position: absolute;
        inset: 0;
        background: rgba(2, 8, 20, 0.72);
        backdrop-filter: blur(8px);
      }
      .avatarViewerCard {
        position: relative;
        z-index: 1;
        border-radius: 18px;
        border: 1px solid rgba(255, 255, 255, 0.16);
        background: rgba(13, 18, 34, 0.86);
        padding: 12px;
        box-shadow: 0 16px 40px rgba(0, 0, 0, 0.35);
      }
      .avatarViewerClose {
        position: absolute;
        top: 10px;
        left: 10px;
        width: 34px;
        height: 34px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(255, 255, 255, 0.06);
        color: #fff;
        cursor: pointer;
      }
      html[dir="ltr"] .avatarViewerClose {
        left: auto;
        right: 10px;
      }
      .avatarViewerBox {
        width: min(360px, calc(100vw - 72px));
        height: min(360px, calc(100vw - 72px));
        border-radius: 18px;
      }
      .friendsActions {
        margin-top: 10px;
        display: grid;
        gap: 8px;
        padding-top: 10px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
      }
      .friendsActionRow {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: flex-end;
      }
      .friendsActionRow .btn {
        min-height: 32px;
        padding: 7px 9px;
        font-size: 12px;
        border-radius: 11px;
      }
      .friendsFriendAvatar {
        margin-inline-start: auto;
      }
      .friendsTiny {
        font-size: 12px;
        opacity: 0.76;
        line-height: 1.5;
      }
      .presenceLine {
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      .presenceDot {
        width: 9px;
        height: 9px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.22);
        background: rgba(239, 68, 68, 0.85);
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.16);
      }
      .presenceDot.on {
        background: rgba(34, 197, 94, 0.9);
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.16);
      }
      .toastHost {
        position: fixed;
        top: 70px;
        left: 16px;
        right: auto;
        z-index: 1100;
        display: grid;
        gap: 10px;
        pointer-events: none;
        width: min(420px, calc(100vw - 24px));
      }
      html[dir="ltr"] .toastHost {
        right: 16px;
        left: auto;
      }
      .toastCard {
        pointer-events: auto;
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(13, 18, 34, 0.86);
        backdrop-filter: blur(12px);
        padding: 12px;
        box-shadow: 0 16px 40px rgba(0, 0, 0, 0.35);
        transform: translateY(-10px);
        opacity: 0;
        transition: opacity 220ms ease, transform 220ms ease;
      }
      .toastCard.show {
        transform: translateY(0);
        opacity: 1;
      }
      .toastTitle {
        font-weight: 800;
        font-size: 13px;
      }
      .toastBody {
        margin-top: 6px;
        font-size: 12px;
        opacity: 0.85;
        line-height: 1.5;
      }
      .toastActions {
        margin-top: 10px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      @media (max-width: 520px) {
        header {
          padding: calc(12px + var(--safe-top)) calc(12px + var(--safe-right)) 10px calc(12px + var(--safe-left));
          flex-wrap: wrap;
          align-items: flex-start;
        }
        header .brand {
          width: 100%;
          justify-content: space-between;
        }
        header .actions {
          width: 100%;
          justify-content: flex-start;
          flex-wrap: nowrap;
          gap: 10px;
          overflow-x: auto;
          overflow-y: hidden;
          -webkit-overflow-scrolling: touch;
          padding-bottom: 2px;
          scrollbar-width: none;
          -ms-overflow-style: none;
        }
        header .actions::-webkit-scrollbar {
          width: 0;
          height: 0;
        }
        header .actions > * {
          flex: 0 0 auto;
        }
        header .sub {
          display: none;
        }
        .slots {
          grid-template-columns: repeat(3, 1fr);
        }
        .friendsPanel {
          top: 66px;
          left: 12px;
          right: 12px;
          width: auto;
        }
        html[dir="ltr"] .friendsPanel {
          left: 12px;
          right: 12px;
          width: auto;
        }
        .chatPanel {
          top: 66px;
          left: 12px;
          right: 12px;
          width: auto;
        }
        html[dir="ltr"] .chatPanel {
          left: 12px;
          right: 12px;
          width: auto;
        }
        .friendsCard {
          max-height: calc(100dvh - 86px - var(--safe-bottom));
        }
        .chatCard {
          max-height: calc(100dvh - 86px - var(--safe-bottom));
        }
        .chatLayout {
          grid-template-columns: 1fr;
          height: min(520px, calc(100dvh - 220px - var(--safe-bottom)));
        }
        .friendsAddRow {
          flex-wrap: wrap;
        }
        .toastHost {
          top: 64px;
          left: 12px;
          right: 12px;
          width: auto;
        }
        html[dir="ltr"] .toastHost {
          left: 12px;
          right: 12px;
          width: auto;
        }
      }
      @media (min-width: 521px) and (max-width: 900px) {
        header {
          padding: calc(12px + var(--safe-top)) calc(12px + var(--safe-right)) 12px calc(12px + var(--safe-left));
          flex-wrap: wrap;
          align-items: flex-start;
        }
        header .brand {
          width: 100%;
          justify-content: space-between;
        }
        header .actions {
          width: 100%;
          justify-content: flex-start;
          flex-wrap: nowrap;
          gap: 10px;
          overflow-x: auto;
          overflow-y: hidden;
          -webkit-overflow-scrolling: touch;
          padding-bottom: 2px;
          scrollbar-width: none;
          -ms-overflow-style: none;
        }
        header .actions::-webkit-scrollbar {
          width: 0;
          height: 0;
        }
        header .actions > * {
          flex: 0 0 auto;
        }
        header .actions .btn {
          padding: 8px 12px;
          font-size: 12px;
        }
        header .actions .badgeMini {
          padding: 7px 10px;
        }
        .screen {
          padding: 16px;
        }
        .panel .inner {
          padding: 22px;
        }
        .stage {
          width: 70px;
          height: 70px;
        }
        .pathInner {
          min-width: 100%;
        }
        .friendsPanel {
          top: calc(70px + var(--safe-top));
        }
      }

      @media (min-width: 901px) {
        .pathInner {
          min-width: max(100%, 980px);
        }
      }
    </style>
  </head>
  <body data-screen="home">
    <svg aria-hidden="true" width="0" height="0" style="position:absolute; width:0; height:0; overflow:hidden">
      <symbol id="i-coin" viewBox="0 0 24 24">
        <path
          fill="currentColor"
          d="M12 2c-4.97 0-9 1.79-9 4v12c0 2.21 4.03 4 9 4s9-1.79 9-4V6c0-2.21-4.03-4-9-4Zm0 2c4.09 0 7 .99 7 2s-2.91 2-7 2-7-.99-7-2 2.91-2 7-2Zm0 16c-4.09 0-7-.99-7-2v-2.06C6.67 17.16 9.1 18 12 18s5.33-.84 7-2.06V18c0 1.01-2.91 2-7 2Zm0-6c-4.09 0-7-.99-7-2V9.94C6.67 11.16 9.1 12 12 12s5.33-.84 7-2.06V12c0 1.01-2.91 2-7 2Z"
        />
      </symbol>
      <symbol id="i-chat" viewBox="0 0 24 24">
        <path
          fill="currentColor"
          d="M4 4h16v11a3 3 0 0 1-3 3H9l-4.6 3.45A1 1 0 0 1 3 20.65V7a3 3 0 0 1 1-2.24A3 3 0 0 1 4 4Zm3 6h10v2H7v-2Zm0-4h10v2H7V6Z"
        />
      </symbol>
      <symbol id="i-users" viewBox="0 0 24 24">
        <path
          fill="currentColor"
          d="M7.5 12a4 4 0 1 1 4-4 4 4 0 0 1-4 4Zm9 1a3.5 3.5 0 1 0-3.5-3.5A3.5 3.5 0 0 0 16.5 13ZM2.5 20a5 5 0 0 1 5-5h0a5 5 0 0 1 5 5v1h-10v-1Zm12.1 1a6.5 6.5 0 0 0-.4-2.2A4.5 4.5 0 0 1 21.5 20v1h-6.9Z"
        />
      </symbol>
      <symbol id="i-tasks" viewBox="0 0 24 24">
        <path
          fill="currentColor"
          d="M9 11H7V9h2v2Zm0 4H7v-2h2v2Zm0 4H7v-2h2v2Zm13-8H11V9h11v2Zm0 4H11v-2h11v2Zm0 4H11v-2h11v2ZM5 4h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2Z"
        />
      </symbol>
      <symbol id="i-home" viewBox="0 0 24 24">
        <path fill="currentColor" d="M12 3 3 10v11h6v-7h6v7h6V10l-9-7Z" />
      </symbol>
    </svg>

    <div class="app">
      <header>
        <div class="brand">
          <div id="playerBrand" class="playerBrand">
            <div id="playerAvatar" class="playerAvatar">P</div>
            <div id="playerName" class="playerName"></div>
            <div id="onlineCountBadge" class="onlineCount" title="  " aria-label="  ">
              <span id="playerOnlineDot" class="onlineDot on" aria-hidden="true"></span>
              <span id="onlineCountLabel" class="onlineCountLabel"></span>
              <span id="onlineCountText">0</span>
            </div>
          </div>
        </div>
        <div class="actions">
          <button id="coinsBadge" class="badgeMini iconBtn" type="button">
            <svg class="i" width="16" height="16" aria-hidden="true"><use href="#i-coin"></use></svg>
            <span id="coinsText">0</span>
          </button>
          <button id="tasksBtn" class="btn ghost iconBtn" type="button">
            <svg class="i" width="16" height="16" aria-hidden="true"><use href="#i-tasks"></use></svg>
            <span></span>
          </button>
          <button id="chatBtn" class="btn ghost iconBtn" type="button">
            <svg class="i" width="16" height="16" aria-hidden="true"><use href="#i-chat"></use></svg>
            <span></span>
          </button>
          <button id="friendsBtn" class="btn ghost iconBtn" type="button">
            <svg class="i" width="16" height="16" aria-hidden="true"><use href="#i-users"></use></svg>
            <span></span>
          </button>
          <button id="homeHeaderBtn" class="btn ghost iconBtn" type="button">
            <svg class="i" width="16" height="16" aria-hidden="true"><use href="#i-home"></use></svg>
            <span></span>
          </button>
        </div>
      </header>
      <div id="profileDropBackdrop" class="profileDropBackdrop" aria-hidden="true">
        <div id="profileDrop" class="profileDrop" role="dialog" aria-label="Profile">
          <div class="profileDropHead">
            <div id="profileDropTitle" class="h"></div>
            <button id="profileDropClose" class="btn ghost" type="button"></button>
          </div>
          <div class="profileDropBody">
            <div class="profileWrap">
              <div class="profileTop">
                <div id="profileAvatar" class="profileAvatar">P</div>
                <div class="profileMeta">
                  <div class="profileNameRow">
                    <div id="profileName" class="profileName"></div>
                    <div id="profileFlag" class="profileFlag" aria-hidden="true"></div>
                  </div>
                  <div class="profileLine"><span class="profileK">ID</span> <span id="profileId" class="profileV"></span></div>
                  <div class="profileLine"><span class="profileK"></span> <span id="profileEmail" class="profileV"></span></div>
                  <div class="profileLine"><span class="profileK">LV</span> <span id="profileLevel" class="profileV">1</span></div>
                  <div class="profileLine"><span class="profileK"> </span> <span id="profileCreatedAt" class="profileV"></span></div>
                  <div class="profileLine"><span class="profileK">  </span> <span id="profileCoinsEarned" class="profileV">0</span></div>
                </div>
              </div>
              <div class="profileGrid">
                <div class="profileCard">
                  <div class="k"> </div>
                  <div id="profileCoinsNow" class="v">0</div>
                </div>
                <div class="profileCard">
                  <div class="k"></div>
                  <div id="profileSolved" class="v">0</div>
                </div>
                <div class="profileCard">
                  <div class="k"></div>
                  <div id="profileWins" class="v">0</div>
                </div>
                <div class="profileCard">
                  <div class="k"> </div>
                  <div id="profileWinStreak" class="v">0</div>
                </div>
                <div class="profileCard">
                  <div class="k"> </div>
                  <div id="profileAvg" class="v">0</div>
                </div>
                <div class="profileCard">
                  <div class="k"> </div>
                  <div id="profileBest" class="v">0</div>
                </div>
                <div class="profileCard">
                  <div class="k">  </div>
                  <div id="profileWinBest" class="v">0</div>
                </div>
                <div class="profileCard">
                  <div class="k"></div>
                  <div id="profileAch" class="v">0</div>
                </div>
                <div class="profileCard">
                  <div class="k">  </div>
                  <div id="profileStreak" class="v">0</div>
                </div>
                <div class="profileCard wide">
                  <div class="k">  </div>
                  <div class="profileSplit">
                    <div><div class="k"></div><div id="profileWinsNormal" class="v">0</div></div>
                    <div><div class="k"></div><div id="profileWinsTimed" class="v">0</div></div>
                    <div><div class="k"></div><div id="profileWinsLimited" class="v">0</div></div>
                    <div><div class="k"></div><div id="profileWinsDaily" class="v">0</div></div>
                    <div><div class="k"></div><div id="profileWinsOnline" class="v">0</div></div>
                  </div>
                </div>
                <div class="profileCard wide">
                  <div class="k">  </div>
                  <div class="profileSplit">
                    <div><div class="k"></div><div id="profileWinsOnlineEasy" class="v">0</div></div>
                    <div><div class="k"></div><div id="profileWinsOnlineMedium" class="v">0</div></div>
                    <div><div class="k"></div><div id="profileWinsOnlineHard" class="v">0</div></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <main>
        <div id="bgPattern" class="bgPattern" aria-hidden="true"></div>

        <section id="homeScreen" class="screen home active">
          <div class="homeStack">
            <div class="panel homeCard">
              <div class="inner">
                <h2 class="title homeTitleRow">
                  <svg class="homeTitleLogo" viewBox="0 0 600 420" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                    <path fill="currentColor" d="M40 380V60h100l60 120 60-120h100v320H280V190l-80 120-80-120v190H40z" />
                    <path fill="currentColor" d="M400 60h80v240h120v80H400V60z" />
                  </svg>
                  <span id="homeTitle">MestRyLock</span>
                </h2>
                <div class="homeButtons">
                  <button id="onlineBtn" class="btn twoLine" type="button" disabled>
                    <span id="onlineBtnK"> </span>
                    <span id="onlineBtnSub" class="tiny">   45</span>
                  </button>
                  <button id="startBtn" class="btn primary" type="button"></button>
                  <button id="dailyBtn" class="btn" type="button"> </button>
                  <button id="howBtn" class="btn" type="button"> </button>
                  <button id="settingsBtn" class="btn" type="button"></button>
                  <button id="logoutBtn" class="btn danger" type="button" style="display:none"> </button>
                  <button id="discordBtn" class="btn ghost discordBtn" type="button" style="display:none">
                    <span class="discordIcon" aria-hidden="true">
                      <svg viewBox="0 0 24 24" width="18" height="18" xmlns="http://www.w3.org/2000/svg">
                        <path
                          fill="currentColor"
                          d="M20.3 4.8a16.6 16.6 0 0 0-4.1-1.3c-.2.3-.4.7-.6 1.1a15.7 15.7 0 0 0-4.6 0c-.2-.4-.4-.8-.6-1.1-1.4.2-2.8.6-4.1 1.3C.9 8.1.3 11.2.5 14.2c1.5 1.1 3.2 1.9 5 2.4.4-.6.7-1.2 1-1.8-.5-.2-1.1-.5-1.6-.8.1-.1.3-.2.4-.3 3.1 1.4 6.5 1.4 9.6 0 .1.1.3.2.4.3-.5.3-1 .6-1.6.8.3.6.6 1.2 1 1.8 1.8-.5 3.5-1.3 5-2.4.2-3-.4-6.1-1.9-9.4ZM8.3 13.3c-.6 0-1.1-.6-1.1-1.3 0-.7.5-1.3 1.1-1.3.6 0 1.1.6 1.1 1.3 0 .7-.5 1.3-1.1 1.3Zm7.4 0c-.6 0-1.1-.6-1.1-1.3 0-.7.5-1.3 1.1-1.3.6 0 1.1.6 1.1 1.3 0 .7-.5 1.3-1.1 1.3Z"
                        />
                      </svg>
                    </span>
                    <span id="discordBtnK">Discord</span>
                  </button>
                </div>
              </div>
            </div>
            <div id="homeFooterBar" class="homeFooterBar" aria-label="Footer">
              <div class="homeFooterBrand">
                <svg class="homeFooterLogo" viewBox="0 0 600 420" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                  <path
                    fill="currentColor"
                    d="M40 380V60h100l60 120 60-120h100v320H280V190l-80 120-80-120v190H40z"
                  />
                  <path fill="currentColor" d="M400 60h80v240h120v80H400V60z" />
                </svg>
                <div class="homeFooterCopy">
                  <span class="homeFooterBrandName">MestRy</span>
                  <span class="homeFooterBrandYear"> 2026</span>
                </div>
              </div>
              <div class="homeFooterLinks">
                <button id="homeFeedbackBtn" class="homeFooterLink" type="button">Feedback</button>
                <button id="homePolicyBtn" class="homeFooterLink" type="button"></button>
                <button id="homePrivacyBtn" class="homeFooterLink" type="button"></button>
              </div>
            </div>
          </div>
        </section>

        <section id="mapScreen" class="screen map">
          <div class="mapHeader">
            <div class="leftMeta">
              <div class="meta">
                <div id="progressK" class="k"></div>
                <div class="v"><span id="progressText"></span></div>
              </div>
              <div class="mapTools">
                <input id="stageSearch" class="miniInput" inputmode="numeric" autocomplete="off" placeholder=" " />
                <button id="goStageBtn" class="btn" type="button"></button>
                <button id="dailyBtn2" class="btn" type="button"> </button>
              </div>
            </div>
            <div class="meta">
              <div id="helpK" class="k"></div>
              <div id="helpText" class="v tiny"> /   </div>
            </div>
          </div>
          <div class="mapWrap">
            <div id="path" class="path" tabindex="0">
              <div id="pathInner" class="pathInner"></div>
            </div>
            <button id="mapPrevBtn" class="mapArrow left" type="button" aria-label="Prev"></button>
            <button id="mapNextBtn" class="mapArrow right" type="button" aria-label="Next"></button>
          </div>
        </section>

        <section id="levelScreen" class="screen level">
          <div class="panel">
            <div class="inner">
              <div class="levelTop">
                <div class="leftBadges">
                  <div class="badge"><span id="levelLabel"></span> <span id="levelNum"></span></div>
                  <div class="badge"><span id="attemptsLabel">:</span> <span id="attemptsNum">0</span></div>
                </div>
                <div class="rightBadges">
                  <div id="modeBadge" class="badge"></div>
                  <div id="timerBadge" class="badge" style="display:none"></div>
                </div>
              </div>
              <div id="onlineHud" class="onlineWrap" style="display:none">
                <div class="onlineMatchRow">
                  <div class="onlinePlayerCard">
                    <div id="onlineMeAvatar" class="onlineAvatar">P</div>
                    <div class="onlineMeta">
                      <div id="onlineMeName" class="onlineName"></div>
                      <div id="onlineMeSub" class="onlineTiny"></div>
                    </div>
                  </div>
                  <div class="onlineVs">VS</div>
                  <div class="onlinePlayerCard">
                    <div id="onlineOppAvatar" class="onlineAvatar">?</div>
                    <div class="onlineMeta">
                      <div id="onlineOppName" class="onlineName"></div>
                      <div id="onlineOppSub" class="onlineTiny"></div>
                    </div>
                  </div>
                </div>
                <div id="onlineTurnText" class="onlineTiny"></div>
                <div class="onlineBar"><span id="onlineTurnBar"></span></div>
                <div id="onlineOppLast" class="onlineTiny" style="text-align:right"></div>
                <div id="onlinePropsHud" class="propsHudRow" style="display:none">
                  <div id="onlinePropsCard" class="propsHudCard"></div>
                  <button id="onlinePropsUseBtn" class="btn primary" type="button"></button>
                </div>
              </div>

              <div class="lock">
                <div class="slots" id="slots"></div>

                <div class="levelActions">
                  <div class="left">
                    <button id="checkBtn" class="btn primary" type="button"></button>
                    <button id="assistBtn" class="btn" type="button"></button>
                    <button id="clearBtn" class="btn" type="button"></button>
                    <button id="retryBtn" class="btn" type="button"> </button>
                  </div>
                  <div class="right">
                    <button id="backToMapBtn" class="btn ghost" type="button"> </button>
                  </div>
                </div>
                <div id="msg" class="msg"></div>
                <div id="history" class="history"></div>
                <div id="coach" class="coach" style="display:none"></div>

                <div id="winBox" class="win">
                  <div class="winBackdrop" aria-hidden="true"></div>
                  <div class="winPanel">
                    <div id="winFxLayer" class="winFxLayer" aria-hidden="true"></div>
                    <div id="winTitle" class="t">!  .</div>
                    <div id="winSub" class="tiny">    .</div>
                    <div style="display:flex; gap:10px; flex-wrap:wrap">
                      <button id="nextBtn" class="btn primary" type="button"></button>
                      <button id="mapBtn2" class="btn" type="button"></button>
                      <button id="shareBtn" class="btn" type="button"></button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <div id="modalBackdrop" class="modalBackdrop" aria-hidden="true">
          <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
            <div class="modalHead">
              <div id="modalTitle" class="h"> </div>
              <button id="closeModalBtn" class="btn ghost" type="button"></button>
            </div>
            <div class="modalBody">
              <div id="howToContent">
                <div id="howLine1">         .</div>
                <ul class="modalList">
                  <li><span id="howOk" class="c-ok">  </span> <span id="howOk2">  .</span></li>
                  <li><span id="howBad" class="c-bad">  </span> <span id="howBad2">  .</span></li>
                  <li><span id="howWarn" class="c-warn">    </span> <span id="howWarn2">  .</span></li>
                </ul>
                <div id="howHintNote" style="margin-top:12px" class="tiny">      .</div>
              </div>
              <div id="assistContent" style="display:none">
                <div id="assistIntro" class="tiny"></div>
                <div class="assistGrid">
                  <div class="assistCard">
                    <div>
                      <div id="assistHintK" class="t"></div>
                      <div id="assistHintSub" class="tiny"></div>
                    </div>
                    <button id="hintBtn" class="btn" type="button"> (1)</button>
                  </div>
                  <div class="assistCard">
                    <div>
                      <div id="assistReveal1K" class="t"></div>
                      <div id="assistReveal1Sub" class="tiny"></div>
                    </div>
                    <button id="levelFeatReveal1Btn" class="btn" type="button">   (0)</button>
                  </div>
                  <div class="assistCard">
                    <div>
                      <div id="assistReveal2K" class="t"></div>
                      <div id="assistReveal2Sub" class="tiny"></div>
                    </div>
                    <button id="levelFeatReveal2Btn" class="btn" type="button">  (0)</button>
                  </div>
                </div>
              </div>
              <div id="onlineContent" style="display:none"></div>
              <div id="settingsContent" style="display:none">
                <div id="settingsDesc" class="tiny">    .</div>
                <div class="shopList">
                  <div class="shopRow">
                    <div>
                      <div class="t"> </div>
                      <div id="nameChangeSub" class="tiny">  </div>
                    </div>
                    <button id="changeNameBtn" class="btn primary" type="button"></button>
                  </div>
                  <div class="shopRow">
                    <div>
                      <div id="settingsCoinsK" class="t"></div>
                      <div class="tiny"><span id="settingsCoinsV">0</span></div>
                    </div>
                    <div>
                      <div id="settingsHintsK" class="t"></div>
                      <div class="tiny"><span id="hintTokensV">0</span></div>
                    </div>
                  </div>
                  <div class="shopRow">
                    <div>
                      <div id="syncK" class="t"> </div>
                      <div id="syncSub" class="tiny">  .</div>
                    </div>
                    <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end">
                      <button id="exportBtn" class="btn" type="button" disabled> </button>
                      <button id="importBtn" class="btn primary" type="button" disabled></button>
                    </div>
                  </div>
                  <div class="shopRow">
                    <div class="t" id="settingsThemeK"> </div>
                    <button id="themeBtn" class="btn primary" type="button"> : </button>
                  </div>
                  <div class="shopRow">
                    <div class="t" id="settingsLangK"></div>
                    <button id="langBtn" class="btn" type="button">English</button>
                  </div>
                  <div class="shopRow">
                    <div class="t" id="settingsMotionK"></div>
                    <button id="motionBtn" class="btn" type="button"> : </button>
                  </div>
                  <div class="shopRow">
                    <div class="t" id="settingsSoundK"></div>
                    <button id="soundBtn" class="btn" type="button">: </button>
                  </div>
                  <div class="shopRow">
                    <div class="t" id="settingsHapticsK"></div>
                    <button id="hapticsBtn" class="btn" type="button">: </button>
                  </div>
                  <div class="shopRow">
                    <div class="t" id="settingsShapeK"> </div>
                    <button id="shapeBtn" class="btn" type="button"></button>
                  </div>
                  <div class="shopRow">
                    <div class="t" id="settingsModeK"> </div>
                    <button id="modeBtn" class="btn" type="button"></button>
                  </div>
                  <div class="shopRow">
                    <div class="t" id="settingsVersionK"></div>
                    <div id="settingsVersionV" class="tiny" dir="ltr" style="user-select:text"></div>
                  </div>
                </div>
              </div>
              <div id="missionsContent" style="display:none">
                <div>
                  <div id="dailyRewardTitle" class="t"> </div>
                  <div class="shopRow" style="margin-top:10px">
                    <div>
                      <div id="dailyRewardSub" class="tiny">: 0 </div>
                      <div id="dailyRewardStatus" class="tiny" style="margin-top:4px"></div>
                    </div>
                    <button id="claimDailyRewardBtn" class="btn primary" type="button"></button>
                  </div>
                </div>
                <div>
                  <div id="missionsTitle" class="t"> </div>
                  <div id="missionsList" class="shopList"></div>
                </div>
                <div style="margin-top:12px">
                  <div id="achTitle" class="t"></div>
                  <div id="achList" class="shopList"></div>
                </div>
              </div>
              <div id="nameContent" style="display:none">
                <div class="tiny">   (2-18 ).</div>
                <div style="margin-top:12px; display:grid; gap:10px">
                  <div class="shopRow">
                    <div>
                      <div class="t"> </div>
                      <div id="nameCurrent" class="tiny"></div>
                    </div>
                    <div>
                      <div class="t"></div>
                      <div id="nameStatus" class="tiny"></div>
                    </div>
                  </div>
                  <input id="nameInput" class="miniInput" autocomplete="off" placeholder="  " />
                  <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end">
                    <button id="nameCancelBtn" class="btn" type="button"></button>
                    <button id="nameSaveBtn" class="btn primary" type="button"></button>
                  </div>
                </div>
              </div>
              <div id="shopContent" style="display:none">
                <div id="shopDesc" class="tiny">  (Apple Pay)    .</div>
                <div class="shopList">
                  <div class="shopRow">
                    <div>
                      <div id="coinPacksTitle" class="t"> </div>
                      <div id="coinPacksSub" class="tiny">  </div>
                    </div>
                  </div>
                  <div class="shopRow">
                    <div>
                      <div id="pack099K" class="t">0.99 .</div>
                      <div class="tiny"><span id="pack099Sub">+12 </span></div>
                    </div>
                    <button id="buyPack099Btn" class="btn primary" type="button">Apple Pay</button>
                  </div>
                  <div class="shopRow">
                    <div>
                      <div id="pack299K" class="t">2.99 .</div>
                      <div class="tiny"><span id="pack299Sub">+45 </span></div>
                    </div>
                    <button id="buyPack299Btn" class="btn primary" type="button">Apple Pay</button>
                  </div>
                  <div class="shopRow">
                    <div>
                      <div id="pack499K" class="t">4.99 .</div>
                      <div class="tiny"><span id="pack499Sub">+80 </span></div>
                    </div>
                    <button id="buyPack499Btn" class="btn primary" type="button">Apple Pay</button>
                  </div>
                  <div class="shopRow">
                    <div>
                      <div id="pack999K" class="t">9.99 .</div>
                      <div class="tiny"><span id="pack999Sub">+170 </span></div>
                    </div>
                    <button id="buyPack999Btn" class="btn primary" type="button">Apple Pay</button>
                  </div>
                  <div class="shopRow">
                    <div>
                      <div id="pack1999K" class="t">19.99 .</div>
                      <div class="tiny"><span id="pack1999Sub">+400 </span></div>
                    </div>
                    <button id="buyPack1999Btn" class="btn primary" type="button">Apple Pay</button>
                  </div>
                  <div class="shopRow">
                    <div>
                      <div class="t"> </div>
                      <div class="tiny">4.99 .</div>
                    </div>
                    <button id="buyNameChangeBtn" class="btn primary" type="button">Apple Pay</button>
                  </div>
                </div>
                <div class="shopList" style="margin-top:14px">
                  <div class="shopRow sectionTitle">
                    <div>
                      <div id="featuresTitle" class="t"></div>
                    </div>
                  </div>
                  <div class="shopRow">
                    <div>
                      <div id="shopHint1K" class="t"> </div>
                      <div class="tiny"><span id="shopHint1Owned">0</span></div>
                    </div>
                    <button id="buyHintTokenBtn" class="btn" type="button"> (4)</button>
                  </div>
                  <div class="shopRow">
                    <div>
                      <div id="shopHint10K" class="t"> </div>
                      <div id="shopHint10Sub" class="tiny">10  ()</div>
                    </div>
                    <button id="buyHintPack10Btn" class="btn" type="button"> (39)</button>
                  </div>
                  <div class="shopRow">
                    <div>
                      <div id="shopHint25K" class="t"> </div>
                      <div id="shopHint25Sub" class="tiny">25  ( )</div>
                    </div>
                    <button id="buyHintPack25Btn" class="btn" type="button"> (89)</button>
                  </div>
                  <div class="shopRow">
                    <div>
                      <div id="featReveal1K" class="t">  </div>
                      <div class="tiny"><span id="featReveal1Owned">0</span></div>
                    </div>
                    <button id="buyUseReveal1Btn" class="btn" type="button"> (12)</button>
                  </div>
                  <div class="shopRow">
                    <div>
                      <div id="featReveal2K" class="t"> </div>
                      <div class="tiny"><span id="featReveal2Owned">0</span></div>
                    </div>
                    <button id="buyUseReveal2Btn" class="btn" type="button"> (20)</button>
                  </div>
                  <div class="shopRow">
                    <div>
                      <div id="shopCircleK" class="t"> </div>
                      <div id="shopCircleSub" class="tiny">   </div>
                    </div>
                    <button id="buyCircleBtn" class="btn" type="button"> (60)</button>
                  </div>
                  <div class="shopRow">
                    <div>
                      <div id="shopSquareK" class="t"> </div>
                      <div id="shopSquareSub" class="tiny">   </div>
                    </div>
                    <button id="buySquareBtn" class="btn" type="button"> (60)</button>
                  </div>
                </div>
              </div>
              <div id="mathContent" style="display:none">
                <div id="mathEq" class="t" style="text-align:center">0 + 0 = </div>
                <div id="mathNote" class="tiny" style="margin-top:10px; text-align:center">    .</div>
                <div style="display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; margin-top:14px">
                  <input id="mathAnswer" class="miniInput" inputmode="numeric" autocomplete="off" placeholder="" />
                  <button id="mathYesBtn" class="btn primary" type="button"></button>
                  <button id="mathCancelBtn" class="btn" type="button"></button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <div id="friendsPanel" class="friendsPanel" aria-hidden="true">
      <div class="friendsCard">
        <div class="friendsTop">
          <div class="friendsTitle"></div>
          <button id="friendsCloseBtn" class="friendsClose" type="button" aria-label="Close"></button>
        </div>
        <div class="friendsMe">
          <div class="k"></div>
          <div class="friendsMeRow">
            <div class="friendsMeRight">
              <div id="friendsMeName" class="v"></div>
            </div>
            <div class="friendsMeLeft">
              <label class="btn ghost friendsPhotoBtn">
                 
                <input id="friendsPhotoInput" type="file" accept="image/*" style="display:none" />
              </label>
              <div id="friendsMeAvatar" class="avatarSquare" aria-hidden="true"></div>
            </div>
          </div>
          <div class="k idLine">
            ID: <span id="friendsMeId" class="v"></span>
            <button id="friendsMeCopyIdBtn" class="copyBtn copyBtnInline" type="button" aria-label=" ID"></button>
          </div>
        </div>
        <div class="friendsTabs" role="tablist" aria-label="Friends Tabs">
          <button id="friendsTabFriendsBtn" class="friendsTab active" type="button" data-tab="friends"></button>
          <button id="friendsTabGiftsBtn" class="friendsTab" type="button" data-tab="gifts"></button>
          <button id="friendsTabAddBtn" class="friendsTab" type="button" data-tab="add"></button>
        </div>
        <div id="friendsMsg" class="friendsTiny"></div>
        <div id="friendsTabFriends" style="margin-top:10px">
          <div style="display:flex; align-items:baseline; justify-content:space-between; gap:10px">
            <div class="friendsTiny" style="opacity:.9; display:flex; align-items:center; gap:10px">
              <span></span>
              <span id="friendsOnlineBadge" class="presenceLine" title="  " aria-label="  ">
                <span class="presenceDot on" aria-hidden="true"></span>
                <span class="friendsTiny" style="opacity:.95"> <span id="friendsOnlineCountText">0</span></span>
              </span>
            </div>
            <div id="friendsCount" class="friendsTiny"></div>
          </div>
          <input id="friendsSearchInput" class="miniInput" autocomplete="off" placeholder="" style="margin-top:10px; width:100%" />
          <div id="friendsList" class="friendsList"></div>
          <div id="friendsActions" class="friendsActions" style="display:none"></div>
        </div>
        <div id="friendsTabGifts" style="display:none; margin-top:10px">
          <div class="friendsTiny" style="opacity:.9"> </div>
          <div id="friendsGiftsList" class="friendsList"></div>
        </div>
        <div id="friendsTabAdd" style="display:none; margin-top:10px">
          <div class="friendsAddRow" style="margin-top:0">
            <input id="friendIdInput" class="miniInput" autocomplete="off" placeholder=" ID " />
            <button id="friendAddBtn" class="btn primary" type="button"></button>
          </div>
          <div class="friendsTiny" style="margin-top:10px"> ID  .</div>
        </div>
      </div>
    </div>

    <div id="friendDetailsBackdrop" class="friendDetailsBackdrop" aria-hidden="true">
      <div class="friendDetailsCard" role="dialog" aria-modal="true">
        <div class="friendDetailsTop">
          <div id="friendDetailsTitle" class="friendDetailsTitle"> </div>
          <button id="friendDetailsClose" class="friendDetailsClose" type="button" aria-label="Close"></button>
        </div>
        <div id="friendDetailsBody" style="margin-top:12px"></div>
      </div>
    </div>

    <div id="friendRemoveBlockBackdrop" class="confirmMiniBackdrop" aria-hidden="true">
      <div class="confirmMiniCard" role="dialog" aria-modal="true">
        <div id="friendRemoveBlockQ" class="confirmMiniQ">      </div>
        <div class="confirmMiniRow">
          <button id="friendConfirmRemoveBtn" class="btn danger" type="button"> </button>
          <button id="friendConfirmBlockBtn" class="btn" type="button"> </button>
        </div>
      </div>
    </div>

    <div id="reportBackdrop" class="confirmMiniBackdrop" aria-hidden="true">
      <div class="formMiniCard" role="dialog" aria-modal="true">
        <div class="formMiniHead">
          <div id="reportTitle" class="confirmMiniQ"></div>
          <button id="reportCloseBtn" class="formMiniClose" type="button" aria-label="Close"></button>
        </div>
        <div id="reportTypeWrap" class="miniSelectWrap" aria-label=" ">
          <button id="reportTypeBtn" class="miniInput miniSelect miniSelectBtn" type="button"></button>
          <div id="reportTypeMenu" class="miniSelectMenu" aria-hidden="true"></div>
          <input id="reportTypeValue" type="hidden" value="" />
        </div>
        <textarea id="reportText" class="miniTextarea" placeholder="  ..." maxlength="1200"></textarea>
        <div class="confirmMiniRow">
          <button id="reportSendBtn" class="btn danger" type="button"> </button>
          <button id="reportCancelBtn" class="btn" type="button"></button>
        </div>
      </div>
    </div>

    <div id="feedbackBackdrop" class="confirmMiniBackdrop" aria-hidden="true">
      <div class="formMiniCard" role="dialog" aria-modal="true">
        <div class="formMiniHead">
          <div id="feedbackTitle" class="confirmMiniQ">Feedback</div>
          <button id="feedbackCloseBtn" class="formMiniClose" type="button" aria-label="Close"></button>
        </div>
        <textarea id="feedbackText" class="miniTextarea" placeholder="   ..." maxlength="2000"></textarea>
        <div class="confirmMiniRow">
          <button id="feedbackSendBtn" class="btn primary" type="button"></button>
          <button id="feedbackCancelBtn" class="btn" type="button"></button>
        </div>
      </div>
    </div>

    <div id="policyBackdrop" class="confirmMiniBackdrop" aria-hidden="true">
      <div class="formMiniCard" role="dialog" aria-modal="true">
        <div class="formMiniHead">
          <div id="policyTitle" class="confirmMiniQ"></div>
          <button id="policyCloseBtn" class="formMiniClose" type="button" aria-label="Close"></button>
        </div>
        <div id="policyBody" class="legalBody"></div>
      </div>
    </div>

    <div id="privacyBackdrop" class="confirmMiniBackdrop" aria-hidden="true">
      <div class="formMiniCard" role="dialog" aria-modal="true">
        <div class="formMiniHead">
          <div id="privacyTitle" class="confirmMiniQ"></div>
          <button id="privacyCloseBtn" class="formMiniClose" type="button" aria-label="Close"></button>
        </div>
        <div id="privacyBody" class="legalBody"></div>
      </div>
    </div>

    <div id="onlineSetupBackdrop" class="confirmMiniBackdrop" aria-hidden="true">
      <div class="formMiniCard" role="dialog" aria-modal="true">
        <div class="formMiniHead">
          <div id="onlineSetupTitle" class="confirmMiniQ"> </div>
          <button id="onlineSetupCloseBtn" class="formMiniClose" type="button" aria-label="Close"></button>
        </div>
        <div id="onlineSetupHint" class="tiny" style="margin-top:8px; opacity:.9"></div>
        <div id="onlineSetupDigits" class="setupDigits" role="button" tabindex="0" aria-label="Set digits"></div>
        <input id="onlineSetupInput" class="miniInput setupHiddenInput" inputmode="numeric" autocomplete="off" placeholder="" />
        <div id="onlineSetupStatus" class="setupStatusRow"></div>
        <div class="confirmMiniRow">
          <button id="onlineSetupReadyBtn" class="btn primary" type="button"></button>
          <button id="onlineSetupForfeitBtn" class="btn danger" type="button"></button>
        </div>
      </div>
    </div>

    <div id="onlinePropsBackdrop" class="confirmMiniBackdrop" aria-hidden="true">
      <div class="formMiniCard propsPickCard" role="dialog" aria-modal="true">
        <div class="formMiniHead">
          <div class="confirmMiniQ"> </div>
          <button id="onlinePropsCloseBtn" class="formMiniClose" type="button" aria-label="Close"></button>
        </div>
        <div id="onlinePropsHint" class="tiny" style="margin-top:8px; opacity:.9">   .</div>
        <div id="onlinePropsCards" class="propsCardsGrid"></div>
        <div id="onlinePropsStatus" class="tiny" style="margin-top:10px; opacity:.9"></div>
      </div>
    </div>

    <div id="onlineWithdrawBackdrop" class="confirmMiniBackdrop" aria-hidden="true">
      <div class="confirmMiniCard" role="dialog" aria-modal="true">
        <div class="confirmMiniQ">  </div>
        <div class="confirmMiniRow">
          <button id="onlineWithdrawYesBtn" class="btn danger" type="button"></button>
          <button id="onlineWithdrawNoBtn" class="btn" type="button"></button>
        </div>
      </div>
    </div>

    <div id="toastHost" class="toastHost" aria-hidden="true"></div>
    <div id="avatarViewer" class="avatarViewer" aria-hidden="true">
      <div id="avatarViewerBackdrop" class="avatarViewerBackdrop"></div>
      <div class="avatarViewerCard" role="dialog" aria-modal="true">
        <button id="avatarViewerClose" class="avatarViewerClose" type="button" aria-label="Close"></button>
        <div id="avatarViewerBox" class="avatarSquare avatarViewerBox" aria-hidden="true"></div>
      </div>
    </div>
    <div id="chatPanel" class="chatPanel" aria-hidden="true">
      <div class="chatCard">
        <div class="chatTop">
          <div class="chatTitle"></div>
          <button id="chatCloseBtn" class="friendsClose" type="button" aria-label="Close"></button>
        </div>
        <div class="chatLayout">
          <div class="chatLeft">
            <input id="chatSearchInput" class="miniInput" autocomplete="off" placeholder="" style="width:100%" />
            <div id="chatFriendsList" class="chatFriendsList"></div>
          </div>
          <div class="chatRight">
            <div class="chatHeader">
              <div id="chatPeerName" class="chatPeerName"> </div>
              <div id="chatPeerMeta" class="friendsTiny"></div>
            </div>
            <div id="chatMessages" class="chatMessages">
              <div class="friendsTiny">:    .</div>
            </div>
            <div class="chatComposer">
              <input id="chatInput" class="miniInput" autocomplete="off" placeholder=" ..." disabled />
              <button id="chatSendBtn" class="btn primary" type="button" disabled></button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const STORAGE_KEY = "lockgame_v1";
      const UI_KEY = "lockgame_ui_v1";
      const TOTAL_LEVELS = 1000;
      let storageKey = STORAGE_KEY;
      const cloud = { enabled: false, email: "", name: "", firstName: "", debounceId: null, mute: false, lastPutAt: 0 };

      function readUiPrefs() {
        try {
          const raw = localStorage.getItem(UI_KEY);
          const parsed = raw ? JSON.parse(raw) : null;
          return parsed && typeof parsed === "object" ? parsed : {};
        } catch {
          return {};
        }
      }

      function writeUiPrefs(patch) {
        try {
          const prev = readUiPrefs();
          const next = { ...(prev && typeof prev === "object" ? prev : {}), ...(patch && typeof patch === "object" ? patch : {}) };
          localStorage.setItem(UI_KEY, JSON.stringify(next));
        } catch {}
      }

      const fx = { ctx: null };

      function canSound() {
        return !!(app && app.state && app.state.soundOn);
      }

      function canHaptics() {
        return !!(app && app.state && app.state.hapticsOn);
      }

      function vibrate(pattern) {
        if (!canHaptics()) return;
        try {
          if (navigator && typeof navigator.vibrate === "function") navigator.vibrate(pattern);
        } catch {}
      }

      function getAudioCtx() {
        if (fx.ctx) return fx.ctx;
        const AC = window.AudioContext || window.webkitAudioContext;
        if (!AC) return null;
        try {
          fx.ctx = new AC();
          return fx.ctx;
        } catch {
          return null;
        }
      }

      function beep(freq, ms, gain) {
        if (!canSound()) return;
        const ctx = getAudioCtx();
        if (!ctx) return;
        try {
          const t0 = ctx.currentTime;
          const osc = ctx.createOscillator();
          const g = ctx.createGain();
          osc.type = "sine";
          osc.frequency.setValueAtTime(freq, t0);
          g.gain.setValueAtTime(0.0001, t0);
          g.gain.exponentialRampToValueAtTime(Math.max(0.0001, gain), t0 + 0.01);
          g.gain.exponentialRampToValueAtTime(0.0001, t0 + Math.max(0.02, ms / 1000));
          osc.connect(g);
          g.connect(ctx.destination);
          osc.start(t0);
          osc.stop(t0 + Math.max(0.03, ms / 1000) + 0.02);
        } catch {}
      }

      function playClickSound() {
        beep(620, 40, 0.03);
      }

      function playErrorSound() {
        beep(210, 80, 0.045);
      }

      function playWinSound() {
        beep(740, 60, 0.04);
        window.setTimeout(() => beep(980, 80, 0.045), 70);
      }

      function triggerWinFx() {
        if (!el || !el.winBox || !el.winFxLayer) return;
        const reduce = document.documentElement && document.documentElement.getAttribute("data-reduce-motion") === "1";
        el.winBox.classList.remove("fx");
        if (!el.winBox.classList.contains("show")) return;
        el.winBox.classList.add("fx");
        if (reduce) return;
        el.winFxLayer.innerHTML = "";
        const sparks = 14;
        for (let i = 0; i < sparks; i++) {
          const s = document.createElement("span");
          s.className = "winSpark";
          const left = 12 + Math.random() * 76;
          const top = 18 + Math.random() * 54;
          const delay = Math.floor(Math.random() * 180);
          s.style.left = `${left}%`;
          s.style.top = `${top}%`;
          s.style.animationDelay = `${delay}ms`;
          el.winFxLayer.appendChild(s);
        }
        window.setTimeout(() => {
          try {
            if (el.winFxLayer) el.winFxLayer.innerHTML = "";
            if (el.winBox) el.winBox.classList.remove("fx");
          } catch {}
        }, 1300);
      }

      function clamp(n, a, b) {
        return Math.min(b, Math.max(a, n));
      }

      function codeLengthForLevel(level) {
        return clamp(3 + Math.floor((level - 1) / 200), 3, 6);
      }

      function defaultState() {
        return {
          unlocked: 1,
          completed: [],
          hintsUsed: [],
          theme: "crimson",
          lang: "ar",
          coins: 0,
          coinsEarnedTotal: 0,
          coinsPeak: 0,
          hintTokens: 0,
          displayName: "",
          photo: "",
          nameChange: { freeUsed: false, credits: 0 },
          items: { reveal1: 0, reveal2: 0 },
          processedSessions: [],
          dailyReward: { lastClaimAt: 0 },
          missions: { resetAt: 0, solved: 0, noHint: 0, boss: 0, claimed: {} },
          stars: {},
          daily: { completed: [], hintsUsed: [], stars: {} },
          dailyChallenge: { id: 1, availableAt: 0, lastCompletedAt: 0 },
          freeHints: {},
          dailyFreeHints: {},
          stats: {
            wins: 0,
            attempts: 0,
            streakNoHint: 0,
            bestNoHint: 0,
            winStreak: 0,
            bestWinStreak: 0,
            winsNormal: 0,
            winsTimed: 0,
            winsLimited: 0,
            winsDaily: 0,
            winsOnline: 0,
            winsOnlineEasy: 0,
            winsOnlineMedium: 0,
            winsOnlineHard: 0,
          },
          achievements: [],
          reduceMotion: false,
          soundOn: true,
          hapticsOn: true,
          lockShape: "round",
          mode: "normal",
          paidHintType: "reveal",
          unlocks: { circle: false, square: false },
          lastScreen: "home",
          lastStage: null,
          seenCoach: [],
          createdAt: 0,
          lastWriteAt: 0,
          lastSeenAt: 0,
        };
      }

      function normalizeState(raw) {
        const base = defaultState();
        const s = raw && typeof raw === "object" ? raw : {};

        base.unlocked = typeof s.unlocked === "number" ? clamp(s.unlocked, 1, TOTAL_LEVELS) : 1;
        base.completed = Array.isArray(s.completed) ? s.completed.filter((n) => Number.isInteger(n) && n >= 1 && n <= TOTAL_LEVELS) : [];
        base.hintsUsed = Array.isArray(s.hintsUsed) ? s.hintsUsed.filter((n) => Number.isInteger(n) && n >= 1 && n <= TOTAL_LEVELS) : [];
        base.theme =
          s.theme === "cream" || s.theme === "royal" || s.theme === "ocean" || s.theme === "crimson"
            ? s.theme
            : s.theme === "dark"
            ? "crimson"
            : "crimson";
        base.lang = s.lang === "en" ? "en" : "ar";
        base.lastScreen = s.lastScreen === "map" || s.lastScreen === "level" ? s.lastScreen : "home";
        base.soundOn = typeof s.soundOn === "boolean" ? s.soundOn : true;
        base.hapticsOn = typeof s.hapticsOn === "boolean" ? s.hapticsOn : true;
        if (
          s.lastStage &&
          typeof s.lastStage === "object" &&
          ("kind" in s.lastStage || "id" in s.lastStage) &&
          (s.lastStage.kind === "level" || s.lastStage.kind === "daily") &&
          typeof s.lastStage.id === "number" &&
          Number.isFinite(s.lastStage.id)
        ) {
          const id = Math.max(1, Math.floor(s.lastStage.id));
          base.lastStage = { kind: s.lastStage.kind, id };
        } else {
          base.lastStage = null;
        }

        base.coins = typeof s.coins === "number" && Number.isFinite(s.coins) ? Math.max(0, Math.floor(s.coins)) : 0;
        base.coinsEarnedTotal =
          typeof s.coinsEarnedTotal === "number" && Number.isFinite(s.coinsEarnedTotal) ? Math.max(0, Math.floor(s.coinsEarnedTotal)) : 0;
        base.coinsPeak = typeof s.coinsPeak === "number" && Number.isFinite(s.coinsPeak) ? Math.max(0, Math.floor(s.coinsPeak)) : 0;
        base.hintTokens = typeof s.hintTokens === "number" && Number.isFinite(s.hintTokens) ? Math.max(0, Math.floor(s.hintTokens)) : 0;
        base.displayName = typeof s.displayName === "string" ? String(s.displayName).replace(/\s+/g, " ").trim().slice(0, 18) : "";
        base.photo =
          typeof s.photo === "string" && /^data:image\/(png|jpeg|webp);base64,/i.test(s.photo) && s.photo.length < 150000 ? s.photo : "";
        base.nameChange = s.nameChange && typeof s.nameChange === "object" ? s.nameChange : base.nameChange;
        base.nameChange.freeUsed = !!base.nameChange.freeUsed;
        base.nameChange.credits =
          typeof base.nameChange.credits === "number"
            ? Math.max(0, Math.floor(base.nameChange.credits))
            : typeof base.nameChange.credits === "string"
              ? Math.max(0, Math.floor(parseInt(base.nameChange.credits, 10) || 0))
              : 0;
        base.items = s.items && typeof s.items === "object" ? s.items : base.items;
        base.items.reveal1 = typeof base.items.reveal1 === "number" && Number.isFinite(base.items.reveal1) ? Math.max(0, Math.floor(base.items.reveal1)) : 0;
        base.items.reveal2 = typeof base.items.reveal2 === "number" && Number.isFinite(base.items.reveal2) ? Math.max(0, Math.floor(base.items.reveal2)) : 0;
        if (typeof base.items.math === "number" && Number.isFinite(base.items.math)) base.items.reveal2 += Math.max(0, Math.floor(base.items.math));
        delete base.items.math;
        base.processedSessions = Array.isArray(s.processedSessions) ? s.processedSessions.filter((x) => typeof x === "string").slice(-50) : [];
        base.dailyReward = s.dailyReward && typeof s.dailyReward === "object" ? s.dailyReward : base.dailyReward;
        const lastClaimAtRaw =
          base.dailyReward && typeof base.dailyReward === "object" && "lastClaimAt" in base.dailyReward ? base.dailyReward.lastClaimAt : 0;
        const lastClaimAt =
          typeof lastClaimAtRaw === "number" && Number.isFinite(lastClaimAtRaw)
            ? Math.max(0, Math.floor(lastClaimAtRaw))
            : (() => {
                const ymd =
                  base.dailyReward && typeof base.dailyReward === "object" && "claimedYmd" in base.dailyReward ? base.dailyReward.claimedYmd : "";
                const y = typeof ymd === "string" ? ymd : "";
                const ms = y ? Date.parse(`${y}T00:00:00Z`) : 0;
                return Number.isFinite(ms) ? ms : 0;
              })();
        base.dailyReward = { lastClaimAt };
        base.missions = s.missions && typeof s.missions === "object" ? s.missions : base.missions;
        base.missions.resetAt =
          typeof base.missions.resetAt === "number" && Number.isFinite(base.missions.resetAt) ? Math.max(0, Math.floor(base.missions.resetAt)) : 0;
        base.missions.solved =
          typeof base.missions.solved === "number" && Number.isFinite(base.missions.solved) ? Math.max(0, Math.floor(base.missions.solved)) : 0;
        base.missions.noHint =
          typeof base.missions.noHint === "number" && Number.isFinite(base.missions.noHint) ? Math.max(0, Math.floor(base.missions.noHint)) : 0;
        base.missions.boss =
          typeof base.missions.boss === "number" && Number.isFinite(base.missions.boss) ? Math.max(0, Math.floor(base.missions.boss)) : 0;
        base.missions.claimed =
          base.missions.claimed && typeof base.missions.claimed === "object" ? base.missions.claimed : {};
        for (const k of Object.keys(base.missions.claimed)) {
          const v = base.missions.claimed[k];
          if (typeof v !== "number" || !Number.isFinite(v) || v <= 0) delete base.missions.claimed[k];
          else base.missions.claimed[k] = Math.floor(v);
        }
        base.stars = s.stars && typeof s.stars === "object" ? s.stars : {};

        base.daily = s.daily && typeof s.daily === "object" ? s.daily : base.daily;
        if (!Array.isArray(base.daily.completed)) base.daily.completed = [];
        if (!Array.isArray(base.daily.hintsUsed)) base.daily.hintsUsed = [];
        if (!base.daily.stars || typeof base.daily.stars !== "object") base.daily.stars = {};

        base.dailyChallenge = s.dailyChallenge && typeof s.dailyChallenge === "object" ? s.dailyChallenge : base.dailyChallenge;
        base.dailyChallenge.id =
          typeof base.dailyChallenge.id === "number" && Number.isFinite(base.dailyChallenge.id) ? Math.max(1, Math.floor(base.dailyChallenge.id)) : 1;
        base.dailyChallenge.availableAt =
          typeof base.dailyChallenge.availableAt === "number" && Number.isFinite(base.dailyChallenge.availableAt)
            ? Math.max(0, Math.floor(base.dailyChallenge.availableAt))
            : 0;
        base.dailyChallenge.lastCompletedAt =
          typeof base.dailyChallenge.lastCompletedAt === "number" && Number.isFinite(base.dailyChallenge.lastCompletedAt)
            ? Math.max(0, Math.floor(base.dailyChallenge.lastCompletedAt))
            : 0;

        base.stats = s.stats && typeof s.stats === "object" ? s.stats : base.stats;
        base.stats.wins = typeof base.stats.wins === "number" ? Math.max(0, Math.floor(base.stats.wins)) : 0;
        base.stats.attempts = typeof base.stats.attempts === "number" ? Math.max(0, Math.floor(base.stats.attempts)) : 0;
        base.stats.streakNoHint = typeof base.stats.streakNoHint === "number" ? Math.max(0, Math.floor(base.stats.streakNoHint)) : 0;
        base.stats.bestNoHint = typeof base.stats.bestNoHint === "number" ? Math.max(0, Math.floor(base.stats.bestNoHint)) : 0;
        base.stats.winStreak = typeof base.stats.winStreak === "number" ? Math.max(0, Math.floor(base.stats.winStreak)) : 0;
        base.stats.bestWinStreak = typeof base.stats.bestWinStreak === "number" ? Math.max(0, Math.floor(base.stats.bestWinStreak)) : 0;
        base.stats.winsNormal = typeof base.stats.winsNormal === "number" ? Math.max(0, Math.floor(base.stats.winsNormal)) : 0;
        base.stats.winsTimed = typeof base.stats.winsTimed === "number" ? Math.max(0, Math.floor(base.stats.winsTimed)) : 0;
        base.stats.winsLimited = typeof base.stats.winsLimited === "number" ? Math.max(0, Math.floor(base.stats.winsLimited)) : 0;
        base.stats.winsDaily = typeof base.stats.winsDaily === "number" ? Math.max(0, Math.floor(base.stats.winsDaily)) : 0;
        base.stats.winsOnline = typeof base.stats.winsOnline === "number" ? Math.max(0, Math.floor(base.stats.winsOnline)) : 0;
        base.stats.winsOnlineEasy = typeof base.stats.winsOnlineEasy === "number" ? Math.max(0, Math.floor(base.stats.winsOnlineEasy)) : 0;
        base.stats.winsOnlineMedium = typeof base.stats.winsOnlineMedium === "number" ? Math.max(0, Math.floor(base.stats.winsOnlineMedium)) : 0;
        base.stats.winsOnlineHard = typeof base.stats.winsOnlineHard === "number" ? Math.max(0, Math.floor(base.stats.winsOnlineHard)) : 0;
        const winModesSum =
          base.stats.winsNormal + base.stats.winsTimed + base.stats.winsLimited + base.stats.winsDaily + base.stats.winsOnline;
        if (base.stats.wins > 0 && winModesSum === 0) base.stats.winsNormal = base.stats.wins;
        const winOnlineSum = base.stats.winsOnlineEasy + base.stats.winsOnlineMedium + base.stats.winsOnlineHard;
        if (base.stats.winsOnline > 0 && winOnlineSum === 0) base.stats.winsOnlineEasy = base.stats.winsOnline;

        base.achievements = Array.isArray(s.achievements) ? s.achievements.filter((x) => typeof x === "string") : [];

        base.reduceMotion = !!s.reduceMotion;
        base.lockShape = s.lockShape === "circle" || s.lockShape === "square" ? s.lockShape : "round";
        base.mode = s.mode === "timed" || s.mode === "limited" ? s.mode : "normal";
        base.paidHintType = s.paidHintType === "count" || s.paidHintType === "eliminate" ? s.paidHintType : "reveal";

        base.unlocks = s.unlocks && typeof s.unlocks === "object" ? s.unlocks : base.unlocks;
        base.unlocks.circle = !!base.unlocks.circle;
        base.unlocks.square = !!base.unlocks.square;

        base.freeHints = s.freeHints && typeof s.freeHints === "object" ? s.freeHints : {};
        base.dailyFreeHints = s.dailyFreeHints && typeof s.dailyFreeHints === "object" ? s.dailyFreeHints : {};

        base.seenCoach = Array.isArray(s.seenCoach) ? s.seenCoach.filter((x) => typeof x === "string") : [];
        base.lastWriteAt = typeof s.lastWriteAt === "number" && Number.isFinite(s.lastWriteAt) ? Math.max(0, Math.floor(s.lastWriteAt)) : 0;
        base.lastSeenAt = typeof s.lastSeenAt === "number" && Number.isFinite(s.lastSeenAt) ? Math.max(0, Math.floor(s.lastSeenAt)) : 0;
        base.createdAt =
          typeof s.createdAt === "number" && Number.isFinite(s.createdAt)
            ? Math.max(0, Math.floor(s.createdAt))
            : typeof s.createdAt === "string"
              ? Math.max(0, Math.floor(Date.parse(s.createdAt) || 0))
              : 0;

        base.completed.sort((a, b) => a - b);
        base.hintsUsed.sort((a, b) => a - b);
        base.daily.completed.sort();
        base.daily.hintsUsed.sort();

        if (!Object.keys(base.freeHints).length && base.hintsUsed.length) {
          for (const n of base.hintsUsed) base.freeHints[`level:${n}`] = 1;
        }
        if (!Object.keys(base.dailyFreeHints).length && base.daily.hintsUsed.length) {
          for (const id of base.daily.hintsUsed) base.dailyFreeHints[`daily:${id}`] = 1;
        }

        return base;
      }

      function safeParseState(raw) {
        try {
          if (!raw) return null;
          const parsed = JSON.parse(raw);
          return normalizeState(parsed);
        } catch {
          return null;
        }
      }

      function isDefaultishState(s) {
        if (!s || typeof s !== "object") return true;
        const unlocked = typeof s.unlocked === "number" ? s.unlocked : 1;
        const completedLen = Array.isArray(s.completed) ? s.completed.length : 0;
        const coins = typeof s.coins === "number" ? s.coins : 0;
        const hintTokens = typeof s.hintTokens === "number" ? s.hintTokens : 0;
        const items = s.items && typeof s.items === "object" ? s.items : { reveal1: 0, reveal2: 0 };
        const r1 = typeof items.reveal1 === "number" ? items.reveal1 : 0;
        const r2 = typeof items.reveal2 === "number" ? items.reveal2 : 0;
        const wins = s.stats && typeof s.stats === "object" && typeof s.stats.wins === "number" ? s.stats.wins : 0;
        return unlocked <= 1 && completedLen === 0 && coins === 0 && hintTokens === 0 && r1 === 0 && r2 === 0 && wins === 0;
      }

      function scoreState(s) {
        const completedLen = Array.isArray(s.completed) ? s.completed.length : 0;
        const unlocked = typeof s.unlocked === "number" ? s.unlocked : 1;
        const coins = typeof s.coins === "number" ? s.coins : 0;
        const hintTokens = typeof s.hintTokens === "number" ? s.hintTokens : 0;
        const items = s.items && typeof s.items === "object" ? s.items : { reveal1: 0, reveal2: 0 };
        const r1 = typeof items.reveal1 === "number" ? items.reveal1 : 0;
        const r2 = typeof items.reveal2 === "number" ? items.reveal2 : 0;
        const wins = s.stats && typeof s.stats === "object" && typeof s.stats.wins === "number" ? s.stats.wins : 0;
        return completedLen * 1000000 + unlocked * 1000 + wins * 100 + (coins + hintTokens * 2 + r1 * 4 + r2 * 6);
      }

      function loadState() {
        try {
          const raw = localStorage.getItem(storageKey);
          const parsed = safeParseState(raw);
          if (parsed) return parsed;
        } catch {
        }

        try {
          let best = null;
          for (let i = 0; i < localStorage.length; i++) {
            const k = localStorage.key(i);
            if (!k || k === storageKey) continue;
            if (!k.startsWith(STORAGE_KEY)) continue;
            const raw = localStorage.getItem(k);
            const s = safeParseState(raw);
            if (!s) continue;
            if (!best) {
              best = s;
              continue;
            }
            const aTs = best.lastWriteAt || 0;
            const bTs = s.lastWriteAt || 0;
            if (bTs > aTs) {
              best = s;
              continue;
            }
            if (bTs === aTs && scoreState(s) > scoreState(best)) {
              best = s;
            }
          }
          if (best) {
            localStorage.setItem(storageKey, JSON.stringify(best));
            return best;
          }
        } catch {}

        return defaultState();
      }

      function saveState(state) {
        state.lastWriteAt = Date.now();
        localStorage.setItem(storageKey, JSON.stringify(state));
        queueCloudSave();
      }

      function saveStateSilent(state) {
        localStorage.setItem(storageKey, JSON.stringify(state));
      }

      function firstNameFromDisplayName(name) {
        const s = String(name || "").trim();
        if (!s) return "";
        const parts = s.split(/\s+/).filter(Boolean);
        return parts[0] || "";
      }

      async function fetchSessionUser() {
        try {
          const r = await fetch("/api/auth/session", { method: "GET", credentials: "include", cache: "no-store" });
          const data = await r.json().catch(() => null);
          const email = data && data.user && typeof data.user.email === "string" ? data.user.email : "";
          if (!email) return null;
          const name = data && data.user && typeof data.user.name === "string" ? data.user.name : "";
          return { email, name: String(name || "").trim() };
        } catch {
          return null;
        }
      }

      function setTextIfChanged(elm, next) {
        if (!elm) return;
        const v = String(next == null ? "" : next);
        if (elm.textContent !== v) elm.textContent = v;
      }

      function updateUserCenter() {
        const displayName = app && app.state ? String(app.state.displayName || "").trim() : "";
        const name = displayName || (app && app.state && app.state.lang === "en" ? "Player" : "");
        if (el.playerName) el.playerName.textContent = name;
        if (el.playerOnlineDot) el.playerOnlineDot.classList.toggle("on", !!cloud.enabled);
        if (el.onlineCountText && !cloud.enabled) el.onlineCountText.textContent = "";
        if (el.playerAvatar) {
          const letter = String(name || "P")
            .trim()
            .slice(0, 1)
            .toUpperCase();
          const photo = app && app.state && typeof app.state.photo === "string" ? app.state.photo : "";
          setAvatarSquare(el.playerAvatar, photo, letter || "P");
        }
      }

      function flagEmojiFromRegion(region) {
        const code = String(region || "")
          .trim()
          .toUpperCase();
        if (!/^[A-Z]{2}$/.test(code)) return "";
        const a = code.charCodeAt(0) - 65 + 127462;
        const b = code.charCodeAt(1) - 65 + 127462;
        return String.fromCodePoint(a, b);
      }

      function guessRegionCode() {
        const lang = (navigator.languages && navigator.languages[0]) || navigator.language || "";
        const m = String(lang).match(/-([A-Za-z]{2})\b/);
        return m ? String(m[1]).toUpperCase() : "";
      }

      const geoCountry = { code: "", at: 0, pending: false };
      const GEO_COUNTRY_KEY = "lockgame_country_v1";

      function readCachedCountryCode() {
        try {
          const raw = localStorage.getItem(GEO_COUNTRY_KEY);
          if (!raw) return "";
          const p = JSON.parse(raw);
          const code = p && typeof p.code === "string" ? p.code.trim().toUpperCase() : "";
          const at = p && typeof p.at === "number" && Number.isFinite(p.at) ? p.at : 0;
          if (!/^[A-Z]{2}$/.test(code)) return "";
          if (!at || Date.now() - at > 1000 * 60 * 60 * 24 * 14) return "";
          geoCountry.code = code;
          geoCountry.at = at;
          return code;
        } catch {
          return "";
        }
      }

      function writeCachedCountryCode(code) {
        const c = String(code || "")
          .trim()
          .toUpperCase();
        if (!/^[A-Z]{2}$/.test(c)) return;
        geoCountry.code = c;
        geoCountry.at = Date.now();
        try {
          localStorage.setItem(GEO_COUNTRY_KEY, JSON.stringify({ code: c, at: geoCountry.at }));
        } catch {
        }
      }

      function getCountryCode() {
        if (geoCountry.code) return geoCountry.code;
        const cached = readCachedCountryCode();
        if (cached) return cached;
        return guessRegionCode();
      }

      async function ensureCountryCode() {
        if (geoCountry.code || geoCountry.pending) return;
        if (readCachedCountryCode()) return;
        geoCountry.pending = true;
        try {
          const ctl = typeof AbortController !== "undefined" ? new AbortController() : null;
          const t = ctl ? setTimeout(() => ctl.abort(), 2500) : null;
          const r = await fetch("https://ipapi.co/json/", { method: "GET", signal: ctl ? ctl.signal : undefined });
          if (t) clearTimeout(t);
          const data = await r.json().catch(() => null);
          const code = data && typeof data.country_code === "string" ? data.country_code.trim().toUpperCase() : "";
          if (r.ok && /^[A-Z]{2}$/.test(code)) writeCachedCountryCode(code);
        } catch {
        } finally {
          geoCountry.pending = false;
        }
      }

      function formatProfileDate(ms) {
        const t = Number(ms || 0);
        if (!Number.isFinite(t) || t <= 0) return "";
        try {
          const locale = app.state.lang === "en" ? "en-GB" : "ar-SA";
          return new Date(t).toLocaleDateString(locale, { year: "numeric", month: "short", day: "2-digit" });
        } catch {
          return new Date(t).toLocaleDateString();
        }
      }

      function updateProfileUI() {
        const isVisible = el.profileDropBackdrop && el.profileDropBackdrop.classList.contains("show");
        if (!isVisible) return;
        const displayName = app && app.state ? String(app.state.displayName || "").trim() : "";
        const name = displayName || (app && app.state && app.state.lang === "en" ? "Player" : "");
        if (el.profileName) el.profileName.textContent = name;
        if (el.profileFlag) el.profileFlag.textContent = flagEmojiFromRegion(getCountryCode());
        if (el.profileAvatar) {
          const letter = String(name || "P")
            .trim()
            .slice(0, 1)
            .toUpperCase();
          const photo = app && app.state && typeof app.state.photo === "string" ? app.state.photo : "";
          setAvatarSquare(el.profileAvatar, photo, letter || "P");
        }

        const meId = friendsState.me && typeof friendsState.me.id === "string" ? friendsState.me.id : "";
        if (el.profileId) el.profileId.textContent = meId || "";
        const meEmail = friendsState.me && typeof friendsState.me.email === "string" ? friendsState.me.email : "";
        if (el.profileEmail) el.profileEmail.textContent = meEmail || "";
        const meLevel = friendsState.me && typeof friendsState.me.level === "number" ? Math.max(1, Math.floor(friendsState.me.level)) : 1;
        if (el.profileLevel) el.profileLevel.textContent = String(meLevel);

        const createdAtMs = (() => {
          if (friendsState.me && typeof friendsState.me.createdAt === "string") {
            const ms = Date.parse(friendsState.me.createdAt);
            if (Number.isFinite(ms) && ms > 0) return ms;
          }
          return app && app.state && typeof app.state.createdAt === "number" ? app.state.createdAt : 0;
        })();
        if (el.profileCreatedAt) el.profileCreatedAt.textContent = formatProfileDate(createdAtMs);

        const earned = typeof app.state.coinsEarnedTotal === "number" ? Math.max(0, Math.floor(app.state.coinsEarnedTotal)) : 0;
        if (el.profileCoinsEarned) el.profileCoinsEarned.textContent = String(earned);
        if (el.profileCoinsNow) el.profileCoinsNow.textContent = String(app.state.coins || 0);

        const wins = app.state.stats && typeof app.state.stats.wins === "number" ? app.state.stats.wins : 0;
        const attempts = app.state.stats && typeof app.state.stats.attempts === "number" ? app.state.stats.attempts : 0;
        const avg = wins ? (attempts / wins).toFixed(1) : "0";
        if (el.profileSolved) el.profileSolved.textContent = String(app.state.completed.length);
        if (el.profileWins) el.profileWins.textContent = String(wins || 0);
        if (el.profileWinStreak)
          el.profileWinStreak.textContent = String(app.state.stats && typeof app.state.stats.winStreak === "number" ? app.state.stats.winStreak : 0);
        if (el.profileAvg) el.profileAvg.textContent = String(avg);
        if (el.profileBest) el.profileBest.textContent = String(app.state.stats && app.state.stats.bestNoHint ? app.state.stats.bestNoHint : 0);
        if (el.profileWinBest)
          el.profileWinBest.textContent = String(app.state.stats && typeof app.state.stats.bestWinStreak === "number" ? app.state.stats.bestWinStreak : 0);
        if (el.profileStreak) el.profileStreak.textContent = String(app.state.stats && app.state.stats.streakNoHint ? app.state.stats.streakNoHint : 0);
        if (el.profileAch) el.profileAch.textContent = String(Array.isArray(app.state.achievements) ? app.state.achievements.length : 0);
        if (el.profileWinsNormal)
          el.profileWinsNormal.textContent = String(app.state.stats && typeof app.state.stats.winsNormal === "number" ? app.state.stats.winsNormal : 0);
        if (el.profileWinsTimed)
          el.profileWinsTimed.textContent = String(app.state.stats && typeof app.state.stats.winsTimed === "number" ? app.state.stats.winsTimed : 0);
        if (el.profileWinsLimited)
          el.profileWinsLimited.textContent = String(app.state.stats && typeof app.state.stats.winsLimited === "number" ? app.state.stats.winsLimited : 0);
        if (el.profileWinsDaily)
          el.profileWinsDaily.textContent = String(app.state.stats && typeof app.state.stats.winsDaily === "number" ? app.state.stats.winsDaily : 0);
        if (el.profileWinsOnline)
          el.profileWinsOnline.textContent = String(app.state.stats && typeof app.state.stats.winsOnline === "number" ? app.state.stats.winsOnline : 0);
        if (el.profileWinsOnlineEasy)
          el.profileWinsOnlineEasy.textContent = String(
            app.state.stats && typeof app.state.stats.winsOnlineEasy === "number" ? app.state.stats.winsOnlineEasy : 0
          );
        if (el.profileWinsOnlineMedium)
          el.profileWinsOnlineMedium.textContent = String(
            app.state.stats && typeof app.state.stats.winsOnlineMedium === "number" ? app.state.stats.winsOnlineMedium : 0
          );
        if (el.profileWinsOnlineHard)
          el.profileWinsOnlineHard.textContent = String(
            app.state.stats && typeof app.state.stats.winsOnlineHard === "number" ? app.state.stats.winsOnlineHard : 0
          );
      }

      function setStorageKeyForEmail(email) {
        storageKey = email ? `${STORAGE_KEY}:${email}` : STORAGE_KEY;
      }

      async function cloudGet() {
        if (!cloud.enabled) return null;
        try {
          const r = await fetch("/api/game-state", { method: "GET", cache: "no-store", credentials: "include" });
          const data = await r.json().catch(() => null);
          if (!r.ok) return null;
          if (!data || !data.state || typeof data.state !== "object") return null;
          return normalizeState(data.state);
        } catch {
          return null;
        }
      }

      async function cloudPut(state) {
        if (!cloud.enabled) return false;
        try {
          const r = await fetch("/api/game-state", {
            method: "POST",
            credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ state }),
          });
          return r.ok;
        } catch {
          return false;
        }
      }

      function queueCloudSave() {
        if (!cloud.enabled || cloud.mute) return;
        clearTimeout(cloud.debounceId);
        cloud.debounceId = setTimeout(() => {
          const now = Date.now();
          const last = typeof cloud.lastPutAt === "number" && Number.isFinite(cloud.lastPutAt) ? cloud.lastPutAt : 0;
          const since = now - last;
          if (since < 3000) {
            cloud.debounceId = setTimeout(() => {
              cloud.lastPutAt = Date.now();
              cloudPut(app.state).catch(() => {});
            }, Math.max(0, 3050 - since));
            return;
          }
          cloud.lastPutAt = now;
          cloudPut(app.state).catch(() => {});
        }, 1200);
      }

      function flushCloudNow() {
        if (!cloud.enabled || cloud.mute) return;
        cloud.lastPutAt = Date.now();
        try {
          const payload = JSON.stringify({ state: app.state });
          if (navigator.sendBeacon) {
            const blob = new Blob([payload], { type: "application/json" });
            navigator.sendBeacon("/api/game-state", blob);
            return;
          }
        } catch {}
        cloudPut(app.state).catch(() => {});
      }

      function toB64Unicode(str) {
        const encoded = encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (_, p1) => String.fromCharCode(parseInt(p1, 16)));
        return btoa(encoded);
      }

      function fromB64Unicode(b64) {
        const bin = atob(String(b64 || ""));
        let pct = "";
        for (let i = 0; i < bin.length; i++) pct += "%" + bin.charCodeAt(i).toString(16).padStart(2, "0");
        return decodeURIComponent(pct);
      }

      function exportTransferCode() {
        return toB64Unicode(JSON.stringify({ v: 1, state: app.state }));
      }

      function importTransferCode(code) {
        try {
          const raw = fromB64Unicode(code);
          const data = JSON.parse(raw);
          if (!data || typeof data !== "object" || data.v !== 1 || !data.state) return false;
          app.state = normalizeState(data.state);
          saveState(app.state);
          applyTheme(app.state.theme || "crimson");
          updateCoinsUI();
          updateSettingsUI();
          updateShopUI();
          renderMap();
          buildBgPattern();
          return true;
        } catch {
          return false;
        }
      }

      function generateAnswer(level) {
        const len = codeLengthForLevel(level);
        if (level === 1 && len === 3) return "432";
        let seed = level * 1103515245 + 12345;
        const digits = [];
        const used = new Set();
        while (digits.length < len) {
          seed = (seed * 1664525 + 1013904223) >>> 0;
          const d = seed % 10;
          if (used.has(d)) continue;
          used.add(d);
          digits.push(String(d));
        }
        return digits.join("");
      }

      function evaluateGuess(guess, answer) {
        const g = guess.split("");
        const a = answer.split("");
        const len = answer.length;
        const result = Array(len).fill("bad");
        const remaining = {};

        for (let i = 0; i < len; i++) {
          if (g[i] === a[i]) {
            result[i] = "ok";
          } else {
            remaining[a[i]] = (remaining[a[i]] || 0) + 1;
          }
        }

        for (let i = 0; i < len; i++) {
          if (result[i] === "ok") continue;
          const d = g[i];
          if (remaining[d] > 0) {
            result[i] = "warn";
            remaining[d] -= 1;
          }
        }

        return result;
      }

      function isDigitsN(s, n) {
        return new RegExp(`^[0-9]{${n}}$`).test(s);
      }

      const el = {
        coinsBadge: document.getElementById("coinsBadge"),
        coinsText: document.getElementById("coinsText"),
        settingsBtn: document.getElementById("settingsBtn"),
        tasksBtn: document.getElementById("tasksBtn"),
        chatBtn: document.getElementById("chatBtn"),
        homeHeaderBtn: document.getElementById("homeHeaderBtn"),
        brandTitle: document.getElementById("brandTitle"),
        brandSub: document.getElementById("brandSub"),
        playerBrand: document.getElementById("playerBrand"),
        playerName: document.getElementById("playerName"),
        playerOnlineDot: document.getElementById("playerOnlineDot"),
        onlineCountBadge: document.getElementById("onlineCountBadge"),
        onlineCountLabel: document.getElementById("onlineCountLabel"),
        onlineCountText: document.getElementById("onlineCountText"),
        playerAvatar: document.getElementById("playerAvatar"),
        home: document.getElementById("homeScreen"),
        map: document.getElementById("mapScreen"),
        level: document.getElementById("levelScreen"),
        bgPattern: document.getElementById("bgPattern"),
        path: document.getElementById("path"),
        modal: document.querySelector(".modal"),
        homeTitle: document.getElementById("homeTitle"),
        homeDesc: document.getElementById("homeDesc"),
        onlineBtn: document.getElementById("onlineBtn"),
        onlineBtnK: document.getElementById("onlineBtnK"),
        onlineBtnSub: document.getElementById("onlineBtnSub"),
        startBtn: document.getElementById("startBtn"),
        dailyBtn: document.getElementById("dailyBtn"),
        howBtn: document.getElementById("howBtn"),
        logoutBtn: document.getElementById("logoutBtn"),
        discordBtn: document.getElementById("discordBtn"),
        discordBtnK: document.getElementById("discordBtnK"),
        homeFooterBar: document.getElementById("homeFooterBar"),
        homeFeedbackBtn: document.getElementById("homeFeedbackBtn"),
        homePolicyBtn: document.getElementById("homePolicyBtn"),
        homePrivacyBtn: document.getElementById("homePrivacyBtn"),
        progressK: document.getElementById("progressK"),
        helpK: document.getElementById("helpK"),
        helpText: document.getElementById("helpText"),
        stageSearch: document.getElementById("stageSearch"),
        goStageBtn: document.getElementById("goStageBtn"),
        dailyBtn2: document.getElementById("dailyBtn2"),
        modalBackdrop: document.getElementById("modalBackdrop"),
        modalTitle: document.getElementById("modalTitle"),
        closeModalBtn: document.getElementById("closeModalBtn"),
        howToContent: document.getElementById("howToContent"),
        assistContent: document.getElementById("assistContent"),
        onlineContent: document.getElementById("onlineContent"),
        assistIntro: document.getElementById("assistIntro"),
        assistHintK: document.getElementById("assistHintK"),
        assistHintSub: document.getElementById("assistHintSub"),
        assistReveal1K: document.getElementById("assistReveal1K"),
        assistReveal1Sub: document.getElementById("assistReveal1Sub"),
        assistReveal2K: document.getElementById("assistReveal2K"),
        assistReveal2Sub: document.getElementById("assistReveal2Sub"),
        howLine1: document.getElementById("howLine1"),
        howOk: document.getElementById("howOk"),
        howOk2: document.getElementById("howOk2"),
        howBad: document.getElementById("howBad"),
        howBad2: document.getElementById("howBad2"),
        howWarn: document.getElementById("howWarn"),
        howWarn2: document.getElementById("howWarn2"),
        howHintNote: document.getElementById("howHintNote"),
        reportBackdrop: document.getElementById("reportBackdrop"),
        reportTitle: document.getElementById("reportTitle"),
        reportCloseBtn: document.getElementById("reportCloseBtn"),
        reportTypeWrap: document.getElementById("reportTypeWrap"),
        reportTypeBtn: document.getElementById("reportTypeBtn"),
        reportTypeMenu: document.getElementById("reportTypeMenu"),
        reportTypeValue: document.getElementById("reportTypeValue"),
        reportText: document.getElementById("reportText"),
        reportSendBtn: document.getElementById("reportSendBtn"),
        reportCancelBtn: document.getElementById("reportCancelBtn"),
        feedbackBackdrop: document.getElementById("feedbackBackdrop"),
        feedbackTitle: document.getElementById("feedbackTitle"),
        feedbackCloseBtn: document.getElementById("feedbackCloseBtn"),
        feedbackText: document.getElementById("feedbackText"),
        feedbackSendBtn: document.getElementById("feedbackSendBtn"),
        feedbackCancelBtn: document.getElementById("feedbackCancelBtn"),
        policyBackdrop: document.getElementById("policyBackdrop"),
        policyTitle: document.getElementById("policyTitle"),
        policyCloseBtn: document.getElementById("policyCloseBtn"),
        policyBody: document.getElementById("policyBody"),
        privacyBackdrop: document.getElementById("privacyBackdrop"),
        privacyTitle: document.getElementById("privacyTitle"),
        privacyCloseBtn: document.getElementById("privacyCloseBtn"),
        privacyBody: document.getElementById("privacyBody"),
        onlineSetupBackdrop: document.getElementById("onlineSetupBackdrop"),
        onlineSetupTitle: document.getElementById("onlineSetupTitle"),
        onlineSetupHint: document.getElementById("onlineSetupHint"),
        onlineSetupDigits: document.getElementById("onlineSetupDigits"),
        onlineSetupInput: document.getElementById("onlineSetupInput"),
        onlineSetupStatus: document.getElementById("onlineSetupStatus"),
        onlineSetupCloseBtn: document.getElementById("onlineSetupCloseBtn"),
        onlineSetupReadyBtn: document.getElementById("onlineSetupReadyBtn"),
        onlineSetupForfeitBtn: document.getElementById("onlineSetupForfeitBtn"),
        onlinePropsBackdrop: document.getElementById("onlinePropsBackdrop"),
        onlinePropsCloseBtn: document.getElementById("onlinePropsCloseBtn"),
        onlinePropsHint: document.getElementById("onlinePropsHint"),
        onlinePropsCards: document.getElementById("onlinePropsCards"),
        onlinePropsStatus: document.getElementById("onlinePropsStatus"),
        settingsContent: document.getElementById("settingsContent"),
        missionsContent: document.getElementById("missionsContent"),
        profileDropBackdrop: document.getElementById("profileDropBackdrop"),
        profileDrop: document.getElementById("profileDrop"),
        profileDropTitle: document.getElementById("profileDropTitle"),
        profileDropClose: document.getElementById("profileDropClose"),
        settingsDesc: document.getElementById("settingsDesc"),
        nameChangeSub: document.getElementById("nameChangeSub"),
        changeNameBtn: document.getElementById("changeNameBtn"),
        nameContent: document.getElementById("nameContent"),
        nameCurrent: document.getElementById("nameCurrent"),
        nameStatus: document.getElementById("nameStatus"),
        nameInput: document.getElementById("nameInput"),
        nameSaveBtn: document.getElementById("nameSaveBtn"),
        nameCancelBtn: document.getElementById("nameCancelBtn"),
        settingsCoinsK: document.getElementById("settingsCoinsK"),
        settingsCoinsV: document.getElementById("settingsCoinsV"),
        settingsHintsK: document.getElementById("settingsHintsK"),
        hintTokensV: document.getElementById("hintTokensV"),
        syncK: document.getElementById("syncK"),
        syncSub: document.getElementById("syncSub"),
        exportBtn: document.getElementById("exportBtn"),
        importBtn: document.getElementById("importBtn"),
        settingsThemeK: document.getElementById("settingsThemeK"),
        themeBtn: document.getElementById("themeBtn"),
        settingsLangK: document.getElementById("settingsLangK"),
        langBtn: document.getElementById("langBtn"),
        settingsMotionK: document.getElementById("settingsMotionK"),
        motionBtn: document.getElementById("motionBtn"),
        settingsSoundK: document.getElementById("settingsSoundK"),
        soundBtn: document.getElementById("soundBtn"),
        settingsHapticsK: document.getElementById("settingsHapticsK"),
        hapticsBtn: document.getElementById("hapticsBtn"),
        settingsShapeK: document.getElementById("settingsShapeK"),
        shapeBtn: document.getElementById("shapeBtn"),
        settingsModeK: document.getElementById("settingsModeK"),
        modeBtn: document.getElementById("modeBtn"),
        settingsVersionK: document.getElementById("settingsVersionK"),
        settingsVersionV: document.getElementById("settingsVersionV"),
        shopContent: document.getElementById("shopContent"),
        mathContent: document.getElementById("mathContent"),
        mathEq: document.getElementById("mathEq"),
        mathNote: document.getElementById("mathNote"),
        mathAnswer: document.getElementById("mathAnswer"),
        mathYesBtn: document.getElementById("mathYesBtn"),
        mathCancelBtn: document.getElementById("mathCancelBtn"),
        shopDesc: document.getElementById("shopDesc"),
        coinPacksTitle: document.getElementById("coinPacksTitle"),
        coinPacksSub: document.getElementById("coinPacksSub"),
        pack099K: document.getElementById("pack099K"),
        pack099Sub: document.getElementById("pack099Sub"),
        buyPack099Btn: document.getElementById("buyPack099Btn"),
        pack299K: document.getElementById("pack299K"),
        pack299Sub: document.getElementById("pack299Sub"),
        buyPack299Btn: document.getElementById("buyPack299Btn"),
        pack499K: document.getElementById("pack499K"),
        pack499Sub: document.getElementById("pack499Sub"),
        buyPack499Btn: document.getElementById("buyPack499Btn"),
        pack999K: document.getElementById("pack999K"),
        pack999Sub: document.getElementById("pack999Sub"),
        buyPack999Btn: document.getElementById("buyPack999Btn"),
        pack1999K: document.getElementById("pack1999K"),
        pack1999Sub: document.getElementById("pack1999Sub"),
        buyPack1999Btn: document.getElementById("buyPack1999Btn"),
        buyNameChangeBtn: document.getElementById("buyNameChangeBtn"),
        featuresTitle: document.getElementById("featuresTitle"),
        featuresSub: document.getElementById("featuresSub"),
        featReveal1K: document.getElementById("featReveal1K"),
        featReveal1Owned: document.getElementById("featReveal1Owned"),
        buyUseReveal1Btn: document.getElementById("buyUseReveal1Btn"),
        featReveal2K: document.getElementById("featReveal2K"),
        featReveal2Owned: document.getElementById("featReveal2Owned"),
        buyUseReveal2Btn: document.getElementById("buyUseReveal2Btn"),
        shopHint1K: document.getElementById("shopHint1K"),
        shopHint1Owned: document.getElementById("shopHint1Owned"),
        buyHintTokenBtn: document.getElementById("buyHintTokenBtn"),
        shopHint10K: document.getElementById("shopHint10K"),
        shopHint10Sub: document.getElementById("shopHint10Sub"),
        buyHintPack10Btn: document.getElementById("buyHintPack10Btn"),
        shopHint25K: document.getElementById("shopHint25K"),
        shopHint25Sub: document.getElementById("shopHint25Sub"),
        buyHintPack25Btn: document.getElementById("buyHintPack25Btn"),
        shopCircleK: document.getElementById("shopCircleK"),
        shopCircleSub: document.getElementById("shopCircleSub"),
        buyCircleBtn: document.getElementById("buyCircleBtn"),
        shopSquareK: document.getElementById("shopSquareK"),
        shopSquareSub: document.getElementById("shopSquareSub"),
        buySquareBtn: document.getElementById("buySquareBtn"),
        statSolvedK: document.getElementById("statSolvedK"),
        statSolvedV: document.getElementById("statSolvedV"),
        statAvgK: document.getElementById("statAvgK"),
        statAvgV: document.getElementById("statAvgV"),
        statStreakK: document.getElementById("statStreakK"),
        statStreakV: document.getElementById("statStreakV"),
        statBestK: document.getElementById("statBestK"),
        statBestV: document.getElementById("statBestV"),
        dailyRewardTitle: document.getElementById("dailyRewardTitle"),
        dailyRewardSub: document.getElementById("dailyRewardSub"),
        dailyRewardStatus: document.getElementById("dailyRewardStatus"),
        claimDailyRewardBtn: document.getElementById("claimDailyRewardBtn"),
        missionsTitle: document.getElementById("missionsTitle"),
        missionsList: document.getElementById("missionsList"),
        achTitle: document.getElementById("achTitle"),
        achList: document.getElementById("achList"),
        profileAvatar: document.getElementById("profileAvatar"),
        profileName: document.getElementById("profileName"),
        profileFlag: document.getElementById("profileFlag"),
        profileId: document.getElementById("profileId"),
        profileEmail: document.getElementById("profileEmail"),
        profileLevel: document.getElementById("profileLevel"),
        profileCreatedAt: document.getElementById("profileCreatedAt"),
        profileCoinsEarned: document.getElementById("profileCoinsEarned"),
        profileCoinsNow: document.getElementById("profileCoinsNow"),
        profileSolved: document.getElementById("profileSolved"),
        profileWins: document.getElementById("profileWins"),
        profileWinStreak: document.getElementById("profileWinStreak"),
        profileAvg: document.getElementById("profileAvg"),
        profileBest: document.getElementById("profileBest"),
        profileWinBest: document.getElementById("profileWinBest"),
        profileStreak: document.getElementById("profileStreak"),
        profileAch: document.getElementById("profileAch"),
        profileWinsNormal: document.getElementById("profileWinsNormal"),
        profileWinsTimed: document.getElementById("profileWinsTimed"),
        profileWinsLimited: document.getElementById("profileWinsLimited"),
        profileWinsDaily: document.getElementById("profileWinsDaily"),
        profileWinsOnline: document.getElementById("profileWinsOnline"),
        profileWinsOnlineEasy: document.getElementById("profileWinsOnlineEasy"),
        profileWinsOnlineMedium: document.getElementById("profileWinsOnlineMedium"),
        profileWinsOnlineHard: document.getElementById("profileWinsOnlineHard"),
        friendDetailsBackdrop: document.getElementById("friendDetailsBackdrop"),
        friendDetailsClose: document.getElementById("friendDetailsClose"),
        friendDetailsTitle: document.getElementById("friendDetailsTitle"),
        friendDetailsBody: document.getElementById("friendDetailsBody"),
        friendRemoveBlockBackdrop: document.getElementById("friendRemoveBlockBackdrop"),
        friendConfirmRemoveBtn: document.getElementById("friendConfirmRemoveBtn"),
        friendConfirmBlockBtn: document.getElementById("friendConfirmBlockBtn"),
        onlineWithdrawBackdrop: document.getElementById("onlineWithdrawBackdrop"),
        onlineWithdrawYesBtn: document.getElementById("onlineWithdrawYesBtn"),
        onlineWithdrawNoBtn: document.getElementById("onlineWithdrawNoBtn"),
        progressText: document.getElementById("progressText"),
        pathInner: document.getElementById("pathInner"),
        mapPrevBtn: document.getElementById("mapPrevBtn"),
        mapNextBtn: document.getElementById("mapNextBtn"),
        levelLabel: document.getElementById("levelLabel"),
        levelNum: document.getElementById("levelNum"),
        attemptsLabel: document.getElementById("attemptsLabel"),
        attemptsNum: document.getElementById("attemptsNum"),
        modeBadge: document.getElementById("modeBadge"),
        timerBadge: document.getElementById("timerBadge"),
        onlineHud: document.getElementById("onlineHud"),
        onlineMeAvatar: document.getElementById("onlineMeAvatar"),
        onlineMeName: document.getElementById("onlineMeName"),
        onlineMeSub: document.getElementById("onlineMeSub"),
        onlineOppAvatar: document.getElementById("onlineOppAvatar"),
        onlineOppName: document.getElementById("onlineOppName"),
        onlineOppSub: document.getElementById("onlineOppSub"),
        onlineTurnText: document.getElementById("onlineTurnText"),
        onlineTurnBar: document.getElementById("onlineTurnBar"),
        onlineOppLast: document.getElementById("onlineOppLast"),
        onlinePropsHud: document.getElementById("onlinePropsHud"),
        onlinePropsCard: document.getElementById("onlinePropsCard"),
        onlinePropsUseBtn: document.getElementById("onlinePropsUseBtn"),
        msg: document.getElementById("msg"),
        checkBtn: document.getElementById("checkBtn"),
        hintBtn: document.getElementById("hintBtn"),
        levelFeatReveal1Btn: document.getElementById("levelFeatReveal1Btn"),
        levelFeatReveal2Btn: document.getElementById("levelFeatReveal2Btn"),
        assistBtn: document.getElementById("assistBtn"),
        clearBtn: document.getElementById("clearBtn"),
        retryBtn: document.getElementById("retryBtn"),
        backToMapBtn: document.getElementById("backToMapBtn"),
        history: document.getElementById("history"),
        coach: document.getElementById("coach"),
        winBox: document.getElementById("winBox"),
        winTitle: document.getElementById("winTitle"),
        winSub: document.getElementById("winSub"),
        winFxLayer: document.getElementById("winFxLayer"),
        nextBtn: document.getElementById("nextBtn"),
        mapBtn2: document.getElementById("mapBtn2"),
        shareBtn: document.getElementById("shareBtn"),
        slots: document.getElementById("slots"),
      };

      const app = {
        state: defaultState(),
        stage: { kind: "level", id: 1 },
        attempts: 0,
        inputs: [],
        hints: [],
        history: [],
        session: { over: false, timerId: null, timeLeft: 0, attemptLimit: 0, usedPaidHint: false, usedAnyHint: false, autoClearId: null },
        mapCenter: null,
      };
      (function () {
        const ua = navigator.userAgent || "";
        const mobile = /iPhone|iPad|iPod|Android/i.test(ua) || Math.min(window.innerWidth || 0, window.innerHeight || 0) < 820;
        document.documentElement.dataset.mobile = mobile ? "1" : "0";
      })();

      let lastFocusedEl = null;
      let modalMode = "howto";
      let lastDragAt = 0;
      document.addEventListener("gesturestart", (e) => e.preventDefault());
      document.addEventListener("gesturechange", (e) => e.preventDefault());
      document.addEventListener("gestureend", (e) => e.preventDefault());

      const I18N = {
        ar: {
          docTitle: "MestRyLock",
          brandTitle: "MestRyLock",
          brandSub: "     ",
          settingsBtn: "",
          tasksBtn: "",
          chatBtn: "",
          homeHeaderBtn: "",
          homeTitle: "MestRyLock",
          missionsModalTitle: "",
          profileModalTitle: "",
          onlineBtn: " ",
          onlineBtnSub: "   45",
          onlineModeNormal: " ",
          onlineModeCustom: " ",
          onlineModeProps: " ",
          onlineSelectHintNormal: " .",
          onlineSelectHintCustom: "       .",
          onlineSelectHintProps: "       .",
          onlineDiffEasy: "",
          onlineDiffMedium: "",
          onlineDiffHard: "",
          onlineDiffEasySub: "3 ",
          onlineDiffMediumSub: "4 ",
          onlineDiffHardSub: "5 ",
          onlineCtaTapToStart: " ",
          onlineSearchingForOpp: "   ",
          onlineTurnMe: " ",
          onlineTurnThem: " ",
          onlineTurnSetup: " ",
          onlineTurnCards: " ",
          onlineTurnEnded: " ",
          onlineSetupTitle: " ",
          onlineSetupHint: " {n}  ( ).",
          onlineSetupPlaceholder: ": {n} ",
          onlineSetupReadyBtn: "",
          onlineSetupCancelReadyBtn: " ",
          onlineSetupReadyDone: "",
          onlineSetupMeReady: " ",
          onlineSetupMeNotReady: "  ",
          onlineSetupOppReady: " ",
          onlineSetupOppNotReady: " ",
          onlineSetupBadSecret: " {n}  .",
          onlineSetupFailed: " .",
          onlineSetupForfeitBtn: "",
          onlineSolutionLabel: " :",
          onlineBackBtn: "",
          startBtn: "",
          howBtn: " ",
          logoutBtn: " ",
          discordBtn: "Discord",
          footerFeedback: "Feedback",
          footerPolicy: "",
          footerPrivacy: "",
          feedbackTitle: "Feedback",
          feedbackPlaceholder: "   ...",
          feedbackSendBtn: "",
          reportTitle: "",
          reportTypeLabel: " ",
          reportPlaceholder: "  ...",
          reportSendBtn: " ",
          reportCancelBtn: "",
          policyTitle: "",
          privacyTitle: "",
          policyBodyHtml: `<div style="font-weight:900; margin-bottom:6px"> </div><div>             .</div><div style="margin-top:8px; opacity:.9">    (/)   .</div>`,
          privacyBodyHtml: `<div style="font-weight:900; margin-bottom:6px"> </div><div>      ( )  .</div><div style="margin-top:8px; opacity:.9">        .      .</div>`,
          assistBtn: "",
          assistTitle: "",
          assistIntro: " 3  .    .",
          assistHintK: "",
          assistHintSub: "      (   ).",
          assistReveal1Sub: "      .",
          assistReveal2Sub: "       .",
          progressK: "",
          helpK: "",
          helpText: "     ",
          levelLabel: "",
          attemptsLabel: ":",
          checkBtn: "",
          clearBtn: "",
          backToMapBtn: " ",
          winTitle: "!  .",
          winSub: "    .",
          nextBtn: "",
          nextEnded: " ",
          mapBtn2: "",
          closeModalBtn: "",
          howTitle: " ",
          settingsTitle: "",
          howLine1: "         .",
          howOk: "  ",
          howOk2: "  .",
          howBad: "  ",
          howBad2: "  .",
          howWarn: "    ",
          howWarn2: "  .",
          howHintNote: "      .",
          settingsDesc: "    .",
          syncK: " ",
          syncSub: "  .",
          exportBtn: " ",
          importBtn: "",
          importPrompt: "   :",
          importBad: "  .",
          imported: "  ",
          themeBtn: ({ theme }) =>
            theme === "cream"
              ? " : "
              : theme === "royal"
              ? " : "
              : theme === "crimson"
              ? " : "
              : " : ",
          langBtn: ({ lang }) => (lang === "en" ? "" : "English"),
          progressText: ({ completed, unlocked, total }) => `${completed}     ${unlocked} / ${total}`,
          stageAria: ({ i }) => ` ${i}`,
          hintBtn: ({ left }) => ` (${left})`,
          enterDigits: ({ len }) => ` ${len}  .`,
          hintUsed: "   .",
          hintMsg: ({ digit }) => `:      ${digit}`,
          mathTitle: " ",
          mathNote: "    .",
          mathEnterDigit: "   0  9.",
          mathPlaceholder: "",
          mathYesBtn: "",
          mathCancelBtn: "",
          mathWrongUsed: ".   .",
          mathCorrect: ({ digit }) => `      ${digit}`,
          hintBubble: "   ",
          patternWord: " ",
          dailyBtn: " ",
          dailyLocked: ({ hms }) => `  ( ${hms})`,
          dailyLockedPay: ({ hms }) => ` : ${hms} |  (3)`,
          dailyPayConfirm: "    3 ",
          goStageBtn: "",
          stageSearchPlaceholder: " ",
          retryBtn: " ",
          shareBtn: "",
          copied: " .",
          notEnoughCoins: "  .",
          noHintTokens: "  .     .",
          bought: " .",
          timeUp: " .  .",
          attemptsOver: " .  .",
          hintFailed: "  .   .",
          makeGuessFirst: "  .",
          digitsPresent: ({ count }) => `  : ${count}`,
          digitNotInLock: ({ digit }) => ` ${digit}    .`,
          modeNormal: "",
          modeTimed: "",
          modeLimited: "",
          modeDaily: "",
          modeBadge: ({ mode }) => (mode === "timed" ? "" : mode === "limited" ? "" : mode === "daily" ? "" : ""),
          timerBadge: ({ s }) => ` ${s}s`,
          settingsCoinsK: "",
          settingsHintsK: "",
          settingsThemeK: " ",
          settingsLangK: "",
          settingsMotionK: "",
          motionBtn: ({ on }) => (on ? " : " : " : "),
          settingsSoundK: "",
          soundBtn: ({ on }) => (on ? ": " : ": "),
          settingsHapticsK: "",
          hapticsBtn: ({ on }) => (on ? ": " : ": "),
          settingsShapeK: " ",
          onlineCountTitle: "   ",
          onlineCountLabel: "",
          shapeRound: "",
          shapeCircle: "",
          shapeSquare: "",
          locked: "",
          settingsModeK: " ",
          settingsVersionK: "",
          modeBtn: ({ mode }) => (mode === "timed" ? "" : mode === "limited" ? "" : ""),
          settingsHintTypeK: "  ",
          paidHintReveal: "  ",
          paidHintEliminate: " ",
          paidHintCount: "  ",
          paidHintBtn: ({ type }) => (type === "eliminate" ? " " : type === "count" ? "  " : "  "),
          shopTitle: "",
          shopSub: "   ",
          shopDesc: "       .",
          shopHint1K: " ",
          buyHintTokenBtn: "  (4)",
          shopHint10K: " ",
          shopHint10Sub: "10  ()",
          buyHintPack10Btn: " (39)",
          shopHint25K: " ",
          shopHint25Sub: "25  ( )",
          buyHintPack25Btn: " (89)",
          shopCircleK: " ",
          shopCircleSub: "   ",
          buyCircleBtn: ({ owned }) => (owned ? "" : " (60)"),
          shopSquareK: " ",
          shopSquareSub: "   ",
          buySquareBtn: ({ owned }) => (owned ? "" : " (60)"),
          shopModalTitle: "",
          coinPacksTitle: " ",
          coinPacksSub: "  ",
          featuresTitle: "",
          featReveal1K: "  ",
          featReveal2K: " ",
          inLevelFeatureBtn: ({ name, n }) => `${name} (${n})`,
          ownedN: ({ n }) => `: ${n}`,
          buyWithCoins: ({ cost }) => ` (${cost})`,
          useOwned: ({ n }) => ` (${n})`,
          applePayBtn: "Apple Pay",
          paymentNotReady: "   .",
          paymentLoginRequired: "    .",
          paymentRedirecting: "  ",
          paymentFailed: "    .",
          paymentApplied: ({ coins }) => `  ${coins} .`,
          statSolvedK: "",
          statAvgK: " ",
          statStreakK: "  ",
          statBestK: " ",
          dailyRewardTitle: " ",
          dailyRewardSub: " 24  (+2)",
          dailyRewardReady: ({ coins }) => `  +${coins}`,
          dailyRewardNext: ({ hms }) => `  ${hms}`,
          dailyRewardClaimed: " .",
          dailyRewardBtn: "",
          missionsTitle: " ",
          missionSolvedTitle: " ",
          missionSolvedDesc: ({ a, b }) => `${a} / ${b}`,
          missionNoHintTitle: " ",
          missionNoHintDesc: ({ a, b }) => `${a} / ${b}`,
          missionBossTitle: " ",
          missionBossDesc: ({ a, b }) => `${a} / ${b}`,
          missionClaim: ({ coins }) => ` +${coins}`,
          missionClaimed: "",
          achTitle: "",
          shareText: ({ title, attempts, stars }) => `${title} | : ${attempts} | : ${stars}`,
        },
        en: {
          docTitle: "Unlock Locks",
          brandTitle: "Unlock Locks",
          brandSub: "Modern design  unlock and climb",
          settingsBtn: "Settings",
          tasksBtn: "Tasks",
          chatBtn: "Chat",
          homeHeaderBtn: "Home",
          homeTitle: "MestRyLock",
          missionsModalTitle: "Tasks",
          profileModalTitle: "Profile",
          onlineBtn: "Online challenge",
          onlineBtnSub: "Unlocks at level 45",
          onlineModeNormal: "Normal play",
          onlineModeCustom: "Custom play",
          onlineModeProps: "Props play",
          onlineSelectHintNormal: "Choose difficulty.",
          onlineSelectHintCustom: "Choose difficulty, then set your code before start.",
          onlineSelectHintProps: "Choose difficulty, then pick one card before start.",
          onlineDiffEasy: "Easy",
          onlineDiffMedium: "Medium",
          onlineDiffHard: "Hard",
          onlineDiffEasySub: "3 digits",
          onlineDiffMediumSub: "4 digits",
          onlineDiffHardSub: "5 digits",
          onlineCtaTapToStart: "Tap to start",
          onlineSearchingForOpp: "Searching for an opponent",
          onlineTurnMe: "Your turn",
          onlineTurnThem: "Opponent's turn",
          onlineTurnSetup: "Setting up",
          onlineTurnCards: "Picking card",
          onlineTurnEnded: "Match ended",
          onlineSetupTitle: "Set your code",
          onlineSetupHint: "Enter {n} digits (repeats allowed).",
          onlineSetupPlaceholder: "Example: {n} digits",
          onlineSetupReadyBtn: "Ready",
          onlineSetupCancelReadyBtn: "Cancel ready",
          onlineSetupReadyDone: "Ready",
          onlineSetupMeReady: "You are ready",
          onlineSetupMeNotReady: "Not ready",
          onlineSetupOppReady: "Opponent ready",
          onlineSetupOppNotReady: "Waiting for opponent",
          onlineSetupBadSecret: "Enter exactly {n} digits.",
          onlineSetupFailed: "Failed to send.",
          onlineSetupForfeitBtn: "Forfeit",
          onlineSolutionLabel: "Solution:",
          onlineBackBtn: "Back",
          startBtn: "Start",
          howBtn: "How to play",
          logoutBtn: "Logout",
          discordBtn: "Discord",
          footerFeedback: "Feedback",
          footerPolicy: "Policy",
          footerPrivacy: "Privacy",
          feedbackTitle: "Feedback",
          feedbackPlaceholder: "Write your feedback or suggestion",
          feedbackSendBtn: "Send",
          reportTitle: "Report",
          reportTypeLabel: "Report type",
          reportPlaceholder: "Write the report",
          reportSendBtn: "Send report",
          reportCancelBtn: "Cancel",
          policyTitle: "Policy",
          privacyTitle: "Privacy",
          policyBodyHtml: `<div style="font-weight:900; margin-bottom:6px">Usage policy</div><div>By using the game, you agree not to abuse, cheat, or harm other players experience.</div><div style="margin-top:8px; opacity:.9">Actions may be taken for repeated violations.</div>`,
          privacyBodyHtml: `<div style="font-weight:900; margin-bottom:6px">Privacy policy</div><div>We use basic data to operate your account and sync your progress (like email) and to improve the experience.</div><div style="margin-top:8px; opacity:.9">Feedback and reports may be sent to support for review. Do not include sensitive information.</div>`,
          assistBtn: "Help",
          assistTitle: "Help",
          assistIntro: "These are 3 assists for this level. Tap an assist to use it.",
          assistHintK: "Hint",
          assistHintSub: "Reveals a digit that exists in the code (once per level).",
          assistReveal1Sub: "Reveals the position of one digit.",
          assistReveal2Sub: "Quick math to reveal a digit if correct.",
          progressK: "Progress",
          helpK: "Help",
          helpText: "Use arrows or search to navigate levels",
          levelLabel: "Level",
          attemptsLabel: "Attempts:",
          checkBtn: "Check",
          clearBtn: "Clear",
          backToMapBtn: "Back to map",
          winTitle: "Great! Unlocked.",
          winSub: "Next level unlocked automatically.",
          nextBtn: "Next",
          nextEnded: "No more levels",
          mapBtn2: "Map",
          closeModalBtn: "Close",
          howTitle: "How to play",
          settingsTitle: "Settings",
          howLine1: "Each level has a lock. Guess its code.",
          howOk: "If correct",
          howOk2: "it turns green.",
          howBad: "If wrong",
          howBad2: "it turns red.",
          howWarn: "If right digit, wrong spot",
          howWarn2: "it turns yellow.",
          howHintNote: "You only get one hint per level.",
          settingsDesc: "Choose a screen color for comfort.",
          syncK: "Transfer data",
          syncSub: "Unavailable for now.",
          exportBtn: "Copy code",
          importBtn: "Import",
          importPrompt: "Paste the transfer code here:",
          importBad: "Invalid code.",
          imported: "Imported ",
          themeBtn: ({ theme }) =>
            theme === "cream"
              ? "Screen: Cream"
              : theme === "royal"
              ? "Screen: Royal"
              : theme === "crimson"
              ? "Screen: Crimson"
              : "Screen: Ocean",
          langBtn: ({ lang }) => (lang === "en" ? "" : "English"),
          progressText: ({ completed, unlocked, total }) => `${completed} completed  unlocked up to ${unlocked} / ${total}`,
          stageAria: ({ i }) => `Level ${i}`,
          hintBtn: ({ left }) => `Hint (${left})`,
          enterDigits: ({ len }) => `Enter ${len} digits first.`,
          hintUsed: "You already used this level's hint.",
          hintMsg: ({ digit }) => `Hint: A digit in the lock is ${digit}`,
          mathTitle: "Math puzzle",
          mathNote: "Wrong answer consumes the puzzle.",
          mathEnterDigit: "Enter a digit (0-9).",
          mathPlaceholder: "Answer",
          mathYesBtn: "Yes",
          mathCancelBtn: "Cancel",
          mathWrongUsed: "Wrong. Puzzle consumed.",
          mathCorrect: ({ digit }) => `Correct  A digit in the lock is ${digit}`,
          hintBubble: "Right digit, wrong spot",
          patternWord: "UNLOCK",
          dailyBtn: "Daily",
          dailyLocked: ({ hms }) => `Daily (in ${hms})`,
          dailyLockedPay: ({ hms }) => `Daily: ${hms} | Unlock (3)`,
          dailyPayConfirm: "Unlock daily now for 3 coins?",
          goStageBtn: "Go",
          stageSearchPlaceholder: "Stage #",
          retryBtn: "Retry",
          shareBtn: "Share",
          copied: "Copied.",
          notEnoughCoins: "Not enough coins.",
          noHintTokens: "No hints available. Open the shop from the coin badge.",
          bought: "Purchased.",
          timeUp: "Time is up. Retry.",
          attemptsOver: "No attempts left. Retry.",
          hintFailed: "Hint failed. Try again.",
          makeGuessFirst: "Make a guess first.",
          digitsPresent: ({ count }) => `Digits present: ${count}`,
          digitNotInLock: ({ digit }) => `Digit ${digit} is not in the lock.`,
          modeNormal: "Normal",
          modeTimed: "Timed",
          modeLimited: "Limited",
          modeDaily: "Daily",
          modeBadge: ({ mode }) => (mode === "timed" ? "Timed" : mode === "limited" ? "Limited" : mode === "daily" ? "Daily" : "Normal"),
          timerBadge: ({ s }) => ` ${s}s`,
          settingsCoinsK: "Coins",
          settingsHintsK: "Hints",
          settingsThemeK: "Screen",
          settingsLangK: "Language",
          settingsMotionK: "Motion",
          motionBtn: ({ on }) => (on ? "Reduce motion: Yes" : "Reduce motion: No"),
          settingsSoundK: "Sound",
          soundBtn: ({ on }) => (on ? "Sound: On" : "Sound: Off"),
          settingsHapticsK: "Haptics",
          hapticsBtn: ({ on }) => (on ? "Haptics: On" : "Haptics: Off"),
          settingsShapeK: "Lock shape",
          onlineCountTitle: "Players online now",
          onlineCountLabel: "Online",
          shapeRound: "Rounded",
          shapeCircle: "Circle",
          shapeSquare: "Square",
          locked: "Locked",
          settingsModeK: "Mode",
          settingsVersionK: "Version",
          modeBtn: ({ mode }) => (mode === "timed" ? "Timed" : mode === "limited" ? "Limited" : "Normal"),
          settingsHintTypeK: "Paid hint type",
          paidHintReveal: "Reveal position",
          paidHintEliminate: "Eliminate digit",
          paidHintCount: "Correct digits count",
          paidHintBtn: ({ type }) => (type === "eliminate" ? "Eliminate digit" : type === "count" ? "Correct digits count" : "Reveal position"),
          shopTitle: "Shop",
          shopSub: "Buy hints and features with coins",
          shopDesc: "Top up coins and buy features to unlock faster.",
          shopHint1K: "Single hint",
          buyHintTokenBtn: "Buy hint (4)",
          shopHint10K: "Hint bundle",
          shopHint10Sub: "10 hints (save)",
          buyHintPack10Btn: "Buy (39)",
          shopHint25K: "Big bundle",
          shopHint25Sub: "25 hints (save more)",
          buyHintPack25Btn: "Buy (89)",
          shopCircleK: "Circle shape",
          shopCircleSub: "Unlock circle lock shape",
          buyCircleBtn: ({ owned }) => (owned ? "Owned" : "Unlock (60)"),
          shopSquareK: "Square shape",
          shopSquareSub: "Unlock square lock shape",
          buySquareBtn: ({ owned }) => (owned ? "Owned" : "Unlock (60)"),
          shopModalTitle: "Shop",
          shopDesc: "Top up coins and buy features to unlock faster.",
          coinPacksTitle: "Coin packs",
          coinPacksSub: "Prices in SAR",
          featuresTitle: "Features",
          featReveal1K: "Reveal position",
          featReveal2K: "Math puzzle",
          inLevelFeatureBtn: ({ name, n }) => `${name} (${n})`,
          ownedN: ({ n }) => `Owned: ${n}`,
          buyWithCoins: ({ cost }) => `Buy (${cost})`,
          useOwned: ({ n }) => `Use (${n})`,
          applePayBtn: "Apple Pay",
          paymentNotReady: "Payments are not configured yet.",
          paymentLoginRequired: "Please sign in to complete the purchase.",
          paymentRedirecting: "Opening payment",
          paymentFailed: "Payment failed or not completed.",
          paymentApplied: ({ coins }) => `Added ${coins} coins.`,
          statSolvedK: "Solved",
          statAvgK: "Avg attempts",
          statStreakK: "No-hint streak",
          statBestK: "Best streak",
          dailyRewardTitle: "Daily reward",
          dailyRewardSub: "Every 24 hours (+2)",
          dailyRewardReady: ({ coins }) => `Ready  +${coins}`,
          dailyRewardNext: ({ hms }) => `Back in ${hms}`,
          dailyRewardClaimed: "Claimed.",
          dailyRewardBtn: "Claim",
          missionsTitle: "Daily missions",
          missionSolvedTitle: "Solve levels",
          missionSolvedDesc: ({ a, b }) => `${a} / ${b}`,
          missionNoHintTitle: "No hints",
          missionNoHintDesc: ({ a, b }) => `${a} / ${b}`,
          missionBossTitle: "Boss level",
          missionBossDesc: ({ a, b }) => `${a} / ${b}`,
          missionClaim: ({ coins }) => `Claim +${coins}`,
          missionClaimed: "Claimed",
          achTitle: "Achievements",
          shareText: ({ title, attempts, stars }) => `${title} | Attempts: ${attempts} | Stars: ${stars}`,
        },
      };

      function normalizeLang(lang) {
        return lang === "en" ? "en" : "ar";
      }

      function currentLang() {
        return normalizeLang(app.state.lang);
      }

      function t(key, vars = {}) {
        const dict = I18N[currentLang()];
        const v = dict[key];
        return typeof v === "function" ? v(vars) : v;
      }

      function reportTypeOptionsFor(lang) {
        return lang === "en"
          ? [
              { value: "Cheating", label: "Cheating" },
              { value: "Harassment", label: "Harassment" },
              { value: "Spam", label: "Spam" },
              { value: "Exploit", label: "Exploit" },
              { value: "Other", label: "Other" },
            ]
          : [
              { value: "", label: "" },
              { value: " / ", label: " / " },
              { value: "", label: "" },
              { value: " ", label: " " },
              { value: "", label: "" },
            ];
      }

      function syncReportTypeUI() {
        if (!el.reportTypeBtn || !el.reportTypeMenu || !el.reportTypeValue) return;
        const val = String(el.reportTypeValue.value || "").trim();
        const opts = reportTypeOptionsFor(currentLang());
        const cur = opts.find((o) => o.value === val) || opts[0];
        if (cur) el.reportTypeBtn.textContent = cur.label;
        const nodes = el.reportTypeMenu.querySelectorAll("[data-value]");
        nodes.forEach((n) => {
          const b = n;
          const v = String(b.getAttribute("data-value") || "");
          if (v === val) b.classList.add("active");
          else b.classList.remove("active");
        });
      }

      function setReportTypeOptions(lang) {
        if (!el.reportTypeMenu || !el.reportTypeValue) return;
        const opts = reportTypeOptionsFor(lang);
        el.reportTypeMenu.innerHTML = opts.map((o) => `<button type="button" class="miniSelectOption" data-value="${o.value}">${o.label}</button>`).join("");
        const val = String(el.reportTypeValue.value || "").trim();
        if (!val) el.reportTypeValue.value = opts[0] ? opts[0].value : "";
        syncReportTypeUI();
      }

      function closeReportTypeMenu() {
        if (!el.reportTypeMenu) return;
        el.reportTypeMenu.classList.remove("show");
        el.reportTypeMenu.setAttribute("aria-hidden", "true");
      }

      function toggleReportTypeMenu() {
        if (!el.reportTypeMenu) return;
        const next = !el.reportTypeMenu.classList.contains("show");
        if (!next) {
          closeReportTypeMenu();
          return;
        }
        el.reportTypeMenu.classList.add("show");
        el.reportTypeMenu.setAttribute("aria-hidden", "false");
      }

      function applyLanguage(lang) {
        const next = normalizeLang(lang);
        app.state.lang = next;
        saveState(app.state);
        document.documentElement.lang = next;
        document.documentElement.dir = next === "en" ? "ltr" : "rtl";

        document.title = t("docTitle");
        if (el.brandTitle) el.brandTitle.textContent = t("brandTitle");
        if (el.brandSub) el.brandSub.textContent = t("brandSub");
        if (el.settingsBtn) el.settingsBtn.textContent = t("settingsBtn");
        if (el.tasksBtn) el.tasksBtn.textContent = t("tasksBtn");
        if (el.chatBtn) el.chatBtn.textContent = t("chatBtn");
        if (el.homeHeaderBtn) el.homeHeaderBtn.textContent = t("homeHeaderBtn");
        if (el.homeTitle) el.homeTitle.textContent = t("homeTitle");
        if (el.homeDesc) el.homeDesc.textContent = t("homeDesc");
        if (el.onlineBtnK) el.onlineBtnK.textContent = t("onlineBtn");
        if (el.onlineBtnSub) el.onlineBtnSub.textContent = t("onlineBtnSub");
        if (el.startBtn) el.startBtn.textContent = t("startBtn");
        if (el.dailyBtn) el.dailyBtn.textContent = t("dailyBtn");
        if (el.howBtn) el.howBtn.textContent = t("howBtn");
        if (el.logoutBtn) el.logoutBtn.textContent = t("logoutBtn");
        if (el.discordBtnK) el.discordBtnK.textContent = t("discordBtn");
        if (el.homeFeedbackBtn) el.homeFeedbackBtn.textContent = t("footerFeedback");
        if (el.homePolicyBtn) el.homePolicyBtn.textContent = t("footerPolicy");
        if (el.homePrivacyBtn) el.homePrivacyBtn.textContent = t("footerPrivacy");
        if (el.feedbackTitle) el.feedbackTitle.textContent = t("feedbackTitle");
        if (el.feedbackText) el.feedbackText.placeholder = t("feedbackPlaceholder");
        if (el.feedbackSendBtn) el.feedbackSendBtn.textContent = t("feedbackSendBtn");
        if (el.reportTitle) el.reportTitle.textContent = t("reportTitle");
        if (el.reportTypeBtn) el.reportTypeBtn.setAttribute("aria-label", t("reportTypeLabel"));
        setReportTypeOptions(next);
        if (el.reportText) el.reportText.placeholder = t("reportPlaceholder");
        if (el.reportSendBtn) el.reportSendBtn.textContent = t("reportSendBtn");
        if (el.reportCancelBtn) el.reportCancelBtn.textContent = t("reportCancelBtn");
        if (el.policyTitle) el.policyTitle.textContent = t("policyTitle");
        if (el.privacyTitle) el.privacyTitle.textContent = t("privacyTitle");
        if (el.policyBody) el.policyBody.innerHTML = t("policyBodyHtml");
        if (el.privacyBody) el.privacyBody.innerHTML = t("privacyBodyHtml");
        if (el.assistBtn) el.assistBtn.textContent = t("assistBtn");
        if (el.progressK) el.progressK.textContent = t("progressK");
        if (el.helpK) el.helpK.textContent = t("helpK");
        if (el.helpText) el.helpText.textContent = t("helpText");
        if (el.goStageBtn) el.goStageBtn.textContent = t("goStageBtn");
        if (el.stageSearch) el.stageSearch.placeholder = t("stageSearchPlaceholder");
        if (el.dailyBtn2) el.dailyBtn2.textContent = t("dailyBtn");
        if (el.levelLabel) el.levelLabel.textContent = t("levelLabel");
        if (el.attemptsLabel) el.attemptsLabel.textContent = t("attemptsLabel");
        if (el.checkBtn) el.checkBtn.textContent = t("checkBtn");
        if (el.clearBtn) el.clearBtn.textContent = t("clearBtn");
        if (el.retryBtn) el.retryBtn.textContent = t("retryBtn");
        if (el.backToMapBtn) el.backToMapBtn.textContent = t("backToMapBtn");
        if (el.winTitle) el.winTitle.textContent = t("winTitle");
        if (el.winSub) el.winSub.textContent = t("winSub");
        if (el.nextBtn) el.nextBtn.textContent = t("nextBtn");
        if (el.mapBtn2) el.mapBtn2.textContent = t("mapBtn2");
        if (el.shareBtn) el.shareBtn.textContent = t("shareBtn");
        if (el.closeModalBtn) el.closeModalBtn.textContent = t("closeModalBtn");
        if (el.profileDropTitle) el.profileDropTitle.textContent = t("profileModalTitle");
        if (el.profileDropClose) el.profileDropClose.textContent = t("closeModalBtn");
        if (el.howLine1) el.howLine1.textContent = t("howLine1");
        if (el.howOk) el.howOk.textContent = t("howOk");
        if (el.howOk2) el.howOk2.textContent = t("howOk2");
        if (el.howBad) el.howBad.textContent = t("howBad");
        if (el.howBad2) el.howBad2.textContent = t("howBad2");
        if (el.howWarn) el.howWarn.textContent = t("howWarn");
        if (el.howWarn2) el.howWarn2.textContent = t("howWarn2");
        if (el.howHintNote) el.howHintNote.textContent = t("howHintNote");
        if (el.assistIntro) el.assistIntro.textContent = t("assistIntro");
        if (el.assistHintK) el.assistHintK.textContent = t("assistHintK");
        if (el.assistHintSub) el.assistHintSub.textContent = t("assistHintSub");
        if (el.assistReveal1K) el.assistReveal1K.textContent = t("featReveal1K");
        if (el.assistReveal1Sub) el.assistReveal1Sub.textContent = t("assistReveal1Sub");
        if (el.assistReveal2K) el.assistReveal2K.textContent = t("featReveal2K");
        if (el.assistReveal2Sub) el.assistReveal2Sub.textContent = t("assistReveal2Sub");
        if (el.settingsDesc) el.settingsDesc.textContent = t("settingsDesc");
        if (el.settingsCoinsK) el.settingsCoinsK.textContent = t("settingsCoinsK");
        if (el.settingsHintsK) el.settingsHintsK.textContent = t("settingsHintsK");
        if (el.syncK) el.syncK.textContent = t("syncK");
        if (el.syncSub) el.syncSub.textContent = t("syncSub");
        if (el.exportBtn) el.exportBtn.textContent = t("exportBtn");
        if (el.importBtn) el.importBtn.textContent = t("importBtn");
        if (el.settingsThemeK) el.settingsThemeK.textContent = t("settingsThemeK");
        if (el.settingsLangK) el.settingsLangK.textContent = t("settingsLangK");
        if (el.settingsMotionK) el.settingsMotionK.textContent = t("settingsMotionK");
        if (el.settingsSoundK) el.settingsSoundK.textContent = t("settingsSoundK");
        if (el.settingsHapticsK) el.settingsHapticsK.textContent = t("settingsHapticsK");
        if (el.settingsShapeK) el.settingsShapeK.textContent = t("settingsShapeK");
        if (el.settingsModeK) el.settingsModeK.textContent = t("settingsModeK");
        if (el.settingsVersionK) el.settingsVersionK.textContent = t("settingsVersionK");
        if (el.onlineCountLabel) el.onlineCountLabel.textContent = t("onlineCountLabel");
        if (el.onlineCountBadge) {
          el.onlineCountBadge.title = t("onlineCountTitle");
          el.onlineCountBadge.setAttribute("aria-label", t("onlineCountTitle"));
        }
        if (el.shopDesc) el.shopDesc.textContent = t("shopDesc");
        if (el.coinPacksTitle) el.coinPacksTitle.textContent = t("coinPacksTitle");
        if (el.coinPacksSub) el.coinPacksSub.textContent = t("coinPacksSub");
        if (el.featuresTitle) el.featuresTitle.textContent = t("featuresTitle");
        if (el.featuresSub) el.featuresSub.textContent = t("featuresSub");
        if (el.featReveal1K) el.featReveal1K.textContent = t("featReveal1K");
        if (el.featReveal2K) el.featReveal2K.textContent = t("featReveal2K");
        if (el.shopCircleK) el.shopCircleK.textContent = t("shopCircleK");
        if (el.shopCircleSub) el.shopCircleSub.textContent = t("shopCircleSub");
        if (el.shopSquareK) el.shopSquareK.textContent = t("shopSquareK");
        if (el.shopSquareSub) el.shopSquareSub.textContent = t("shopSquareSub");
        if (el.statSolvedK) el.statSolvedK.textContent = t("statSolvedK");
        if (el.statAvgK) el.statAvgK.textContent = t("statAvgK");
        if (el.statStreakK) el.statStreakK.textContent = t("statStreakK");
        if (el.statBestK) el.statBestK.textContent = t("statBestK");
        if (el.achTitle) el.achTitle.textContent = t("achTitle");
        updateThemeBtn();
        if (el.langBtn) el.langBtn.textContent = t("langBtn", { lang: next });
        updateSettingsUI();
        updateShopUI();

        renderMap();
        buildBgPattern();
        if (el.level.classList.contains("active")) {
          const left = Math.max(0, freeHintLimit() - freeHintUsedCount());
          el.hintBtn.textContent = t("hintBtn", { left });
        }
        if (el.winBox.classList.contains("show") && app.stage.kind === "level" && app.stage.id >= TOTAL_LEVELS) {
          el.nextBtn.disabled = true;
          el.nextBtn.textContent = t("nextEnded");
        }
      }

      function normalizeTheme(theme) {
        const t = String(theme || "").toLowerCase();
        if (t === "dark") return "crimson";
        if (t === "ocean" || t === "royal" || t === "cream" || t === "crimson") return t;
        return "crimson";
      }

      function applyTheme(theme) {
        const next = normalizeTheme(theme);
        document.documentElement.dataset.theme = next;
        const meta = document.querySelector('meta[name="theme-color"]');
        if (meta)
          meta.setAttribute(
            "content",
            next === "cream" ? "#fff8ed" : next === "royal" ? "#050816" : next === "crimson" ? "#07070a" : "#04111f"
          );
        writeUiPrefs({ theme: next });
      }

      function currentTheme() {
        return normalizeTheme(document.documentElement.dataset.theme || "crimson");
      }

      function updateThemeBtn() {
        if (!el.themeBtn) return;
        el.themeBtn.textContent = t("themeBtn", { theme: currentTheme() });
      }

      function focusMapPath() {
        if (!el.path) return;
        try {
          el.path.focus({ preventScroll: true });
        } catch {
          el.path.focus();
        }
      }

      function randFloat(a, b) {
        return a + Math.random() * (b - a);
      }

      function randInt(a, b) {
        return Math.floor(randFloat(a, b + 1));
      }

      function pick(arr) {
        return arr[Math.floor(Math.random() * arr.length)];
      }

      function randomDigits(minLen, maxLen) {
        const len = randInt(minLen, maxLen);
        let s = "";
        for (let i = 0; i < len; i++) s += String(randInt(0, 9));
        return s;
      }

      function buildBgPattern() {
        const root = el.bgPattern;
        if (!root) return;
        root.innerHTML = "";

        const w = Math.max(1, window.innerWidth || 1);
        const h = Math.max(1, window.innerHeight || 1);
        const isMobile = document.documentElement.dataset.mobile === "1";
        const m = document.documentElement.dataset.reduceMotion === "1";
        const theme = currentTheme();
        const count = isMobile
          ? m
            ? clamp(Math.round((w * h) / 52000), 12, 34)
            : clamp(Math.round((w * h) / 42000), 18, 48)
          : m
          ? clamp(Math.round((w * h) / 42000), 20, 60)
          : clamp(Math.round((w * h) / 21000), 40, 120);

        const locks = ["", ""];
        const words = [t("patternWord")];

        const frag = document.createDocumentFragment();

        for (let i = 0; i < count; i++) {
          const r = Math.random();
          const span = document.createElement("span");
          span.className = "bgItem";

          if (r < 0.28) {
            span.textContent = pick(words);
            span.classList.add("word");
            span.style.fontSize = `${randInt(14, 22)}px`;
            span.style.opacity = String(randFloat(0.22, 0.5));
            span.style.transform = `translate(-50%, -50%) rotate(${randInt(-25, 25)}deg)`;
          } else if (r < 0.58) {
            span.textContent = pick(locks);
            span.style.fontSize = `${randInt(18, 34)}px`;
            span.style.opacity = String(randFloat(0.18, 0.42));
            span.style.transform = `translate(-50%, -50%) rotate(${randInt(-18, 18)}deg)`;
          } else {
            span.textContent = Math.random() < 0.55 ? randomDigits(1, 1) : randomDigits(2, 6);
            span.style.fontSize = `${randInt(16, 30)}px`;
            span.style.opacity = String(randFloat(0.2, 0.55));
            span.style.transform = `translate(-50%, -50%) rotate(${randInt(-32, 32)}deg)`;
          }

          span.style.left = `${randFloat(4, 96)}%`;
          span.style.top = `${randFloat(5, 95)}%`;
          frag.appendChild(span);
        }

        if (theme === "crimson") {
          const dotCount = isMobile
            ? m
              ? clamp(Math.round((w * h) / 140000), 8, 16)
              : clamp(Math.round((w * h) / 110000), 12, 22)
            : m
            ? clamp(Math.round((w * h) / 120000), 12, 26)
            : clamp(Math.round((w * h) / 90000), 18, 42);
          for (let i = 0; i < dotCount; i++) {
            const dot = document.createElement("span");
            dot.className = "bgDot";
            const s = randInt(4, isMobile ? 9 : 12);
            dot.style.width = `${s}px`;
            dot.style.height = `${s}px`;
            dot.style.opacity = String(randFloat(0.18, 0.7));
            dot.style.left = `${randFloat(3, 97)}%`;
            dot.style.top = `${randFloat(4, 96)}%`;
            frag.appendChild(dot);
          }
        }

        root.appendChild(frag);
      }

      function setScreen(name) {
        document.body.dataset.screen = name;
      }

      function show(screen) {
        el.home.classList.remove("active");
        el.map.classList.remove("active");
        el.level.classList.remove("active");
        screen.classList.add("active");
        let name = "home";
        if (screen === el.map) name = "map";
        else if (screen === el.level) name = "level";
        setScreen(name);
        let uiStage = null;
        if (app && app.state) {
          app.state.lastScreen = name;
          if (name === "level" && app.stage && typeof app.stage === "object") {
            const kind = app.stage.kind === "daily" ? "daily" : "level";
            const id = typeof app.stage.id === "number" && Number.isFinite(app.stage.id) ? Math.max(1, Math.floor(app.stage.id)) : 1;
            app.state.lastStage = { kind, id };
            uiStage = { kind, id };
          } else {
            app.state.lastStage = null;
          }
          saveStateSilent(app.state);
        }
        writeUiPrefs({ lastScreen: name, lastStage: uiStage });
      }

      function renderProgress() {
        const completedCount = app.state.completed.length;
        el.progressText.textContent = t("progressText", { completed: completedCount, unlocked: app.state.unlocked, total: TOTAL_LEVELS });
      }

      function stageOffset(i) {
        const wave = Math.sin(i * 0.7) * 28;
        const drift = Math.sin(i * 0.18) * 10;
        return wave + drift;
      }

      function mapBuildStep() {
        const token = app.mapBuildToken;
        if (!token) return;
        if (token !== app.mapBuildToken) return;
        if (!el.pathInner) return;

        const mobile = document.documentElement.dataset.mobile === "1";
        const batchSize = mobile ? 18 : 80;
        const target = clamp(Math.floor(app.mapBuildTarget || 0), 1, TOTAL_LEVELS);
        let i = clamp(Math.floor(app.mapBuildIndex || 1), 1, TOTAL_LEVELS);
        if (i > target) {
          app.mapBuildInProgress = false;
          return;
        }

        app.mapBuildInProgress = true;
        const frag = document.createDocumentFragment();
        const end = Math.min(target, i + batchSize - 1);

        for (; i <= end; i++) {
          const level = i;
          if (i !== 1) {
            const conn = document.createElement("div");
            conn.className = "connector";
            frag.appendChild(conn);
          }
          const pos = document.createElement("div");
          pos.className = "stagePos";
          pos.style.transform = `translateY(${stageOffset(level)}px)`;

          const b = document.createElement("button");
          b.type = "button";
          b.className = "stage";
          b.id = `stageBtn-${level}`;
          b.dataset.level = String(level);
          const unlocked = level <= app.state.unlocked;
          const completed = app.state.completed.includes(level);
          const boss = isBossLevel(level);
          if (!unlocked) b.classList.add("locked");
          if (completed) b.classList.add("completed");
          if (boss) b.classList.add("boss");
          b.setAttribute("aria-label", t("stageAria", { i: level }));
          const stars = getStarsForLevel(level);
          const starText = stars ? "".repeat(stars) : "";
          b.innerHTML = `<div class="n">${level}</div>${stars ? `<div class="s">${starText}</div>` : ""}`;
          b.addEventListener("click", () => {
            if (Date.now() - lastDragAt < 260) return;
            if (!unlocked) return;
            openStage({ kind: "level", id: level });
          });
          pos.appendChild(b);
          frag.appendChild(pos);
        }

        el.pathInner.appendChild(frag);
        app.mapBuildIndex = end + 1;
        app.mapBuiltUpTo = end;
        if (app.mapBuildIndex <= app.mapBuildTarget) requestAnimationFrame(mapBuildStep);
        else app.mapBuildInProgress = false;
      }

      function ensureMapBuiltTo(level) {
        const mobile = document.documentElement.dataset.mobile === "1";
        const extra = mobile ? 50 : 0;
        const want = clamp(Math.floor(level + extra), 1, TOTAL_LEVELS);
        app.mapBuildTarget = Math.max(app.mapBuildTarget || 0, want);
        if (!app.mapBuildToken) app.mapBuildToken = 1;
        if (!app.mapBuildInProgress) requestAnimationFrame(mapBuildStep);
      }

      function renderMap() {
        renderProgress();
        el.pathInner.innerHTML = "";
        const mobile = document.documentElement.dataset.mobile === "1";
        app.mapBuildToken = (app.mapBuildToken || 0) + 1;
        app.mapBuildIndex = 1;
        app.mapBuiltUpTo = 0;
        app.mapBuildInProgress = false;
        app.mapBuildTarget = mobile ? Math.min(TOTAL_LEVELS, 160) : TOTAL_LEVELS;
        requestAnimationFrame(mapBuildStep);
      }

      function normalizeInput(input) {
        const v = (input.value || "").replace(/[^\d]/g, "");
        input.value = v.slice(0, 1);
      }

      function wireInputs() {
        function distributeDigits(startIdx, digits) {
          const ds = String(digits || "").replace(/[^\d]/g, "");
          if (!ds) return;
          for (let i = 0; i < ds.length; i++) {
            const input = app.inputs[startIdx + i];
            if (!input) break;
            if (input.disabled) continue;
            input.value = ds[i];
          }
          const last = Math.min(app.inputs.length - 1, startIdx + ds.length - 1);
          if (app.inputs[last]) app.inputs[last].focus();
        }

        app.inputs.forEach((input, idx) => {
          input.addEventListener("input", () => {
            if (app.session && app.session.autoClearId) {
              clearTimeout(app.session.autoClearId);
              app.session.autoClearId = null;
            }
            const raw = (input.value || "").replace(/[^\d]/g, "");
            if (raw.length > 1) {
              distributeDigits(idx, raw);
            } else {
              input.value = raw.slice(0, 1);
              if (input.value && idx < app.inputs.length - 1) app.inputs[idx + 1].focus();
            }
          });
          input.addEventListener("paste", (e) => {
            if (app.session && app.session.autoClearId) {
              clearTimeout(app.session.autoClearId);
              app.session.autoClearId = null;
            }
            const text = (e.clipboardData && e.clipboardData.getData("text")) || "";
            const digits = String(text).replace(/[^\d]/g, "");
            if (!digits) return;
            distributeDigits(idx, digits);
            e.preventDefault();
          });
          input.addEventListener("keydown", (e) => {
            if (e.key === "Backspace" && !input.value && idx > 0) app.inputs[idx - 1].focus();
            if (e.key === "Enter") check();
          });
        });
      }

      function clearSlots() {
        if (app.session && app.session.autoClearId) {
          clearTimeout(app.session.autoClearId);
          app.session.autoClearId = null;
        }
        app.inputs.forEach((input) => {
          if (input.dataset.locked === "1") return;
          input.value = "";
        });
        app.inputs.forEach((input) => {
          if (input.dataset.locked === "1") return;
          input.disabled = false;
        });
        app.inputs.forEach((input) => {
          const slot = input.parentElement;
          if (input.dataset.locked === "1") {
            slot.classList.remove("bad", "warn");
            slot.classList.add("ok");
            return;
          }
          slot.classList.remove("ok", "bad", "warn");
        });
        app.hints.forEach((h) => h.classList.remove("show"));
        el.msg.textContent = "";
        el.winBox.classList.remove("show", "fx", "onlineWin", "onlineLose");
        if (el.winFxLayer) el.winFxLayer.innerHTML = "";
        if (el.history) el.history.innerHTML = "";
        if (el.coach) el.coach.style.display = "none";
        if (document.documentElement.dataset.mobile !== "1" && app.inputs[0]) app.inputs[0].focus();
      }

      function clearGuessOnly() {
        app.inputs.forEach((input) => {
          if (input.dataset.locked === "1") return;
          input.value = "";
        });
        app.inputs.forEach((input) => {
          if (input.dataset.locked === "1") return;
          input.disabled = false;
          const slot = input.parentElement;
          slot.classList.remove("ok", "bad", "warn");
        });
        app.hints.forEach((h) => h.classList.remove("show"));
      }

      function formatHMS(ms) {
        const s = Math.max(0, Math.floor(ms / 1000));
        const h = Math.floor(s / 3600);
        const m = Math.floor((s % 3600) / 60);
        const ss = s % 60;
        return `${String(h).padStart(2, "0")}:${String(m).padStart(2, "0")}:${String(ss).padStart(2, "0")}`;
      }

      function dailyCooldownMs() {
        return 24 * 60 * 60 * 1000;
      }

      function dailyAvailableInMs() {
        const now = Date.now();
        return Math.max(0, (app.state.dailyChallenge && app.state.dailyChallenge.availableAt ? app.state.dailyChallenge.availableAt : 0) - now);
      }

      function canStartDaily() {
        return dailyAvailableInMs() === 0;
      }

      function updateDailyUI() {
        const ms = dailyAvailableInMs();
        const locked = ms > 0;
        const label = locked ? t("dailyLockedPay", { hms: formatHMS(ms) }) : t("dailyBtn");
        document.documentElement.dataset.dailyLocked = locked ? "1" : "0";
        if (el.dailyBtn) {
          el.dailyBtn.textContent = label;
          el.dailyBtn.disabled = false;
        }
        if (el.dailyBtn2) {
          el.dailyBtn2.textContent = label;
          el.dailyBtn2.disabled = false;
        }
      }

      function stageKey(stage) {
        if (!stage || typeof stage !== "object") return "level:1";
        if (stage.kind === "daily") return `daily:${stage.id}`;
        if (stage.kind === "online") return `online:${stage.matchId || "0"}`;
        return `level:${stage.id}`;
      }

      function dailyCodeLength(key) {
        const s = String(key);
        let h = 2166136261;
        for (let i = 0; i < s.length; i++) {
          h ^= s.charCodeAt(i);
          h = Math.imul(h, 16777619) >>> 0;
        }
        return clamp(4 + (h % 3), 3, 6);
      }

      function codeLengthForStage(stage) {
        if (stage.kind === "online") return clamp(Math.floor(stage.codeLen || 3), 3, 6);
        if (stage.kind === "daily") return dailyCodeLength(stage.id);
        return codeLengthForLevel(stage.id);
      }

      function generateAnswerForStage(stage) {
        if (stage.kind === "online") return "";
        if (stage.kind === "daily") {
          const len = codeLengthForStage(stage);
          let seed = 2166136261;
          const key = String(stage.id);
          for (let i = 0; i < key.length; i++) {
            seed ^= key.charCodeAt(i);
            seed = Math.imul(seed, 16777619) >>> 0;
          }
          const digits = [];
          const used = new Set();
          while (digits.length < len) {
            seed = (seed * 1664525 + 1013904223) >>> 0;
            const d = seed % 10;
            if (used.has(d)) continue;
            used.add(d);
            digits.push(String(d));
          }
          return digits.join("");
        }
        return generateAnswer(stage.id);
      }

      function isBossLevel(level) {
        return level % 50 === 0;
      }

      function freeHintLimit() {
        return 1;
      }

      function freeHintUsedCount(stage = app.stage) {
        const key = stageKey(stage);
        if (stage.kind === "daily") {
          const m = app.state.dailyFreeHints || {};
          if (typeof m[key] === "number") return Math.max(0, Math.floor(m[key]));
          return app.state.daily.hintsUsed.includes(stage.id) ? 1 : 0;
        }
        const m = app.state.freeHints || {};
        if (typeof m[key] === "number") return Math.max(0, Math.floor(m[key]));
        return app.state.hintsUsed.includes(stage.id) ? 1 : 0;
      }

      function hasUsedFreeHint(stage = app.stage) {
        return freeHintUsedCount(stage) >= freeHintLimit();
      }

      function markFreeHintUsed(stage = app.stage) {
        const key = stageKey(stage);
        const next = freeHintUsedCount(stage) + 1;
        if (stage.kind === "daily") {
          app.state.dailyFreeHints = app.state.dailyFreeHints || {};
          app.state.dailyFreeHints[key] = next;
          if (!app.state.daily.hintsUsed.includes(stage.id)) {
            app.state.daily.hintsUsed.push(stage.id);
            app.state.daily.hintsUsed.sort();
          }
        } else {
          app.state.freeHints = app.state.freeHints || {};
          app.state.freeHints[key] = next;
          if (!app.state.hintsUsed.includes(stage.id)) {
            app.state.hintsUsed.push(stage.id);
            app.state.hintsUsed.sort((a, b) => a - b);
          }
        }
        saveState(app.state);
      }

      function getStarsForLevel(level) {
        const v = app.state.stars && app.state.stars[level];
        const n = typeof v === "number" ? v : parseInt(v, 10);
        return Number.isFinite(n) ? clamp(n, 0, 3) : 0;
      }

      function setStarsForLevel(level, stars) {
        const next = clamp(stars, 0, 3);
        const cur = getStarsForLevel(level);
        if (next <= cur) return;
        app.state.stars[level] = next;
        saveState(app.state);
      }

      function getDailyStars(key) {
        const v = app.state.daily.stars && app.state.daily.stars[key];
        const n = typeof v === "number" ? v : parseInt(v, 10);
        return Number.isFinite(n) ? clamp(n, 0, 3) : 0;
      }

      function setDailyStars(key, stars) {
        const next = clamp(stars, 0, 3);
        const cur = getDailyStars(key);
        if (next <= cur) return;
        app.state.daily.stars[key] = next;
        saveState(app.state);
      }

      function setCoinsTotal(nextCoins, earnedDelta, silent) {
        const prev = typeof app.state.coins === "number" && Number.isFinite(app.state.coins) ? Math.max(0, Math.floor(app.state.coins)) : 0;
        const next = Math.max(0, Math.floor(nextCoins || 0));
        const peakPrev =
          typeof app.state.coinsPeak === "number" && Number.isFinite(app.state.coinsPeak) ? Math.max(0, Math.floor(app.state.coinsPeak)) : 0;
        const earnedPrev =
          typeof app.state.coinsEarnedTotal === "number" && Number.isFinite(app.state.coinsEarnedTotal)
            ? Math.max(0, Math.floor(app.state.coinsEarnedTotal))
            : 0;
        const delta = Math.max(0, next - prev);
        const add =
          typeof earnedDelta === "number" && Number.isFinite(earnedDelta) ? Math.max(0, Math.floor(earnedDelta)) : delta;
        app.state.coins = next;
        app.state.coinsPeak = Math.max(peakPrev, next);
        app.state.coinsEarnedTotal = earnedPrev + (delta ? add : 0);
        if (silent) saveStateSilent(app.state);
        else saveState(app.state);
        updateCoinsUI();
        updateSettingsUI();
      }

      function awardCoins(amount) {
        const n = Math.max(0, Math.floor(amount || 0));
        if (!n) return;
        setCoinsTotal((app.state.coins || 0) + n, n, false);
      }

      function ymdNow() {
        const d = new Date();
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        return `${y}-${m}-${day}`;
      }

      function initDailyReward() {
        app.state.dailyReward =
          app.state.dailyReward && typeof app.state.dailyReward === "object"
            ? app.state.dailyReward
            : { lastClaimAt: 0 };
        const last =
          app.state.dailyReward && typeof app.state.dailyReward === "object" && "lastClaimAt" in app.state.dailyReward
            ? app.state.dailyReward.lastClaimAt
            : 0;
        const n = typeof last === "number" && Number.isFinite(last) ? Math.max(0, Math.floor(last)) : 0;
        app.state.dailyReward = { lastClaimAt: n };
      }

      function dailyRewardAmount() {
        return 2;
      }

      function dailyRewardRemainingMs() {
        initDailyReward();
        const last = app.state.dailyReward.lastClaimAt || 0;
        return Math.max(0, dailyCooldownMs() - (Date.now() - last));
      }

      function canClaimDailyReward() {
        return dailyRewardRemainingMs() === 0;
      }

      function claimDailyReward() {
        initDailyReward();
        const ms = dailyRewardRemainingMs();
        if (ms > 0) {
          el.msg.textContent = t("dailyRewardNext", { hms: formatHMS(ms) });
          updateSettingsUI();
          return;
        }
        const coins = dailyRewardAmount();
        app.state.dailyReward.lastClaimAt = Date.now();
        saveState(app.state);
        awardCoins(coins);
        el.msg.textContent = t("dailyRewardReady", { coins });
        updateSettingsUI();
      }

      function initMissions() {
        app.state.missions =
          app.state.missions && typeof app.state.missions === "object"
            ? app.state.missions
            : { resetAt: 0, solved: 0, noHint: 0, boss: 0, claimed: {} };
        const now = Date.now();
        const resetAt = typeof app.state.missions.resetAt === "number" && Number.isFinite(app.state.missions.resetAt) ? app.state.missions.resetAt : 0;
        if (resetAt && now >= resetAt) {
          app.state.missions = { resetAt: 0, solved: 0, noHint: 0, boss: 0, claimed: {} };
          saveState(app.state);
        }
      }

      function missionDefs() {
        return [
          { id: "solved", title: () => t("missionSolvedTitle"), desc: (a, b) => t("missionSolvedDesc", { a, b }), target: 4, reward: 2 },
          { id: "noHint", title: () => t("missionNoHintTitle"), desc: (a, b) => t("missionNoHintDesc", { a, b }), target: 1, reward: 2 },
          { id: "boss", title: () => t("missionBossTitle"), desc: (a, b) => t("missionBossDesc", { a, b }), target: 1, reward: 3 },
        ];
      }

      function missionProgress(id) {
        initMissions();
        if (id === "solved") return app.state.missions.solved || 0;
        if (id === "noHint") return app.state.missions.noHint || 0;
        if (id === "boss") return app.state.missions.boss || 0;
        return 0;
      }

      function missionClaimed(id) {
        initMissions();
        return !!(app.state.missions.claimed && app.state.missions.claimed[id]);
      }

      function recordMissionWin(stage, usedHint) {
        initMissions();
        app.state.missions.solved = (app.state.missions.solved || 0) + 1;
        if (!usedHint) app.state.missions.noHint = (app.state.missions.noHint || 0) + 1;
        if (stage && stage.kind === "level" && isBossLevel(stage.id)) app.state.missions.boss = (app.state.missions.boss || 0) + 1;
        saveState(app.state);
      }

      function claimMission(id) {
        initMissions();
        const def = missionDefs().find((m) => m.id === id);
        if (!def) return;
        const a = missionProgress(id);
        const done = a >= def.target;
        if (!done) return;
        if (missionClaimed(id)) return;
        app.state.missions.claimed = app.state.missions.claimed && typeof app.state.missions.claimed === "object" ? app.state.missions.claimed : {};
        app.state.missions.claimed[id] = Date.now();
        app.state.missions.resetAt = Date.now() + 24 * 60 * 60 * 1000;
        saveState(app.state);
        awardCoins(def.reward);
        updateSettingsUI();
      }

      function renderMissions() {
        if (!el.missionsList) return;
        initMissions();
        el.missionsList.innerHTML = "";
        const frag = document.createDocumentFragment();
        for (const def of missionDefs()) {
          const a = missionProgress(def.id);
          const b = def.target;
          const done = a >= b;
          const claimed = missionClaimed(def.id);
          const row = document.createElement("div");
          row.className = "shopRow";
          const btnLabel = claimed ? t("missionClaimed") : t("missionClaim", { coins: def.reward });
          const disabled = claimed || !done;
          row.innerHTML = `<div><div class="t">${def.title()}</div><div class="tiny">${def.desc(a, b)}</div></div><button class="btn ${done && !claimed ? "primary" : ""}" type="button" data-mission="${def.id}" ${disabled ? "disabled" : ""}>${btnLabel}</button>`;
          frag.appendChild(row);
        }
        el.missionsList.appendChild(frag);
      }

      function spendCoins(amount) {
        const n = Math.max(0, Math.floor(amount || 0));
        if ((app.state.coins || 0) < n) return false;
        app.state.coins -= n;
        saveState(app.state);
        updateCoinsUI();
        updateSettingsUI();
        return true;
      }

      function updateCoinsUI() {
        if (el.coinsText) el.coinsText.textContent = String(app.state.coins || 0);
      }

      function applyReduceMotion() {
        document.documentElement.dataset.reduceMotion = app.state.reduceMotion ? "1" : "0";
      }

      function applyLockShape() {
        const shape = app.state.lockShape || "round";
        document.documentElement.dataset.lockShape = shape;
      }

      function cycleMode() {
        const cur = app.state.mode || "normal";
        const next = cur === "normal" ? "timed" : cur === "timed" ? "limited" : "normal";
        app.state.mode = next;
        saveState(app.state);
        updateSettingsUI();
      }

      function cycleShape() {
        const cur = app.state.lockShape || "round";
        const unlockedCircle = !!(app.state.unlocks && app.state.unlocks.circle);
        const unlockedSquare = !!(app.state.unlocks && app.state.unlocks.square);
        const options = ["round", unlockedCircle ? "circle" : null, unlockedSquare ? "square" : null].filter(Boolean);
        const idx = Math.max(0, options.indexOf(cur));
        const next = options[(idx + 1) % options.length];
        app.state.lockShape = next;
        saveState(app.state);
        applyLockShape();
        updateSettingsUI();
      }

      function toggleMotion() {
        app.state.reduceMotion = !app.state.reduceMotion;
        saveState(app.state);
        applyReduceMotion();
        updateSettingsUI();
      }

      function toggleSound() {
        app.state.soundOn = !app.state.soundOn;
        saveState(app.state);
        updateSettingsUI();
      }

      function toggleHaptics() {
        app.state.hapticsOn = !app.state.hapticsOn;
        saveState(app.state);
        updateSettingsUI();
      }

      const versionState = {
        fetched: false,
        fetching: false,
        commitSha: "",
        commitRef: "",
        environment: "",
        region: "",
      };

      const onlineFeature = {
        fetched: false,
        fetching: false,
        enabled: true,
        lastFetchAt: 0,
        pollId: 0,
      };

      function shortSha(sha) {
        const s = String(sha || "").trim();
        return s ? s.slice(0, 7) : "";
      }

      function renderVersionValue() {
        if (!el.settingsVersionV) return;
        const sha = shortSha(versionState.commitSha);
        if (!sha) {
          el.settingsVersionV.textContent = versionState.fetching ? "" : "";
          return;
        }
        const ref = String(versionState.commitRef || "").trim();
        const env = String(versionState.environment || "").trim();
        const region = String(versionState.region || "").trim();
        const tail = [ref ? `(${ref})` : "", env, region].filter(Boolean).join("  ");
        el.settingsVersionV.textContent = tail ? `${sha} ${tail}` : sha;
      }

      async function fetchVersionOnce() {
        if (versionState.fetching || versionState.fetched) return;
        versionState.fetching = true;
        renderVersionValue();
        try {
          const r = await fetch("/api/version", { method: "GET", cache: "no-store" });
          if (!r.ok) return;
          const d = await r.json();
          versionState.commitSha = d && typeof d.commitSha === "string" ? d.commitSha : "";
          versionState.commitRef = d && typeof d.commitRef === "string" ? d.commitRef : "";
          versionState.environment = d && typeof d.environment === "string" ? d.environment : "";
          versionState.region = d && typeof d.region === "string" ? d.region : "";
          versionState.fetched = true;
        } catch {
        } finally {
          versionState.fetching = false;
          renderVersionValue();
        }
      }

      async function fetchOnlineEnabledOnce(force) {
        const now = Date.now();
        if (!force && onlineFeature.fetching) return;
        if (!force && onlineFeature.fetched && now - onlineFeature.lastFetchAt < 12_000) return;
        onlineFeature.fetching = true;
        onlineFeature.lastFetchAt = now;
        try {
          const r = await fetch("/api/online/enabled", { method: "GET", cache: "no-store" });
          const d = await r.json().catch(() => null);
          if (d && typeof d.onlineEnabled === "boolean") {
            onlineFeature.enabled = !!d.onlineEnabled;
            onlineFeature.fetched = true;
          }
        } catch {
        } finally {
          onlineFeature.fetching = false;
          updateOnlineBtnUI();
        }
      }

      function onlineUnlocked() {
        return !!(cloud && cloud.enabled);
      }

      function updateOnlineBtnUI() {
        if (!el.onlineBtn) return;
        const unlocked = onlineUnlocked() && !!onlineFeature.enabled;
        el.onlineBtn.disabled = !unlocked;
        el.onlineBtn.classList.toggle("primary", unlocked);
        el.onlineBtn.classList.toggle("zero", !unlocked);
      }

      function updateSettingsUI() {
        updateOnlineBtnUI();
        if (el.settingsCoinsV) el.settingsCoinsV.textContent = String(app.state.coins || 0);
        if (el.hintTokensV) el.hintTokensV.textContent = String(app.state.hintTokens || 0);
        if (el.nameChangeSub || el.changeNameBtn) {
          if (!cloud.enabled) {
            if (el.nameChangeSub) el.nameChangeSub.textContent = "   .";
            if (el.changeNameBtn) el.changeNameBtn.disabled = true;
          } else {
            app.state.nameChange = app.state.nameChange && typeof app.state.nameChange === "object" ? app.state.nameChange : { freeUsed: false, credits: 0 };
            const freeUsed = !!app.state.nameChange.freeUsed;
            const credits = typeof app.state.nameChange.credits === "number" ? Math.max(0, Math.floor(app.state.nameChange.credits)) : 0;
            if (el.nameChangeSub) {
              if (!freeUsed) el.nameChangeSub.textContent = "  ";
              else if (credits > 0) el.nameChangeSub.textContent = ` (${credits})`;
              else el.nameChangeSub.textContent = "  (4.99 .)";
            }
            if (el.changeNameBtn) el.changeNameBtn.disabled = false;
          }
        }

        if (el.motionBtn) el.motionBtn.textContent = t("motionBtn", { on: !!app.state.reduceMotion });
        if (el.soundBtn) el.soundBtn.textContent = t("soundBtn", { on: !!app.state.soundOn });
        if (el.hapticsBtn) el.hapticsBtn.textContent = t("hapticsBtn", { on: !!app.state.hapticsOn });
        if (el.modeBtn) el.modeBtn.textContent = t("modeBtn", { mode: app.state.mode || "normal" });
        renderVersionValue();
        fetchVersionOnce().catch(() => {});
        fetchOnlineEnabledOnce(false).catch(() => {});

        const shape = app.state.lockShape || "round";
        if (el.shapeBtn) {
          if (shape === "circle") el.shapeBtn.textContent = t("shapeCircle");
          else if (shape === "square") el.shapeBtn.textContent = t("shapeSquare");
          else el.shapeBtn.textContent = t("shapeRound");
        }

        if (el.buyCircleBtn) el.buyCircleBtn.textContent = t("buyCircleBtn", { owned: !!(app.state.unlocks && app.state.unlocks.circle) });
        if (el.buySquareBtn) el.buySquareBtn.textContent = t("buySquareBtn", { owned: !!(app.state.unlocks && app.state.unlocks.square) });

        const wins = app.state.stats && app.state.stats.wins ? app.state.stats.wins : 0;
        const attempts = app.state.stats && app.state.stats.attempts ? app.state.stats.attempts : 0;
        const avg = wins ? (attempts / wins).toFixed(1) : "0";
        const streak = app.state.stats && app.state.stats.streakNoHint ? app.state.stats.streakNoHint : 0;
        const best = app.state.stats && app.state.stats.bestNoHint ? app.state.stats.bestNoHint : 0;

        if (el.statSolvedV) el.statSolvedV.textContent = String(app.state.completed.length);
        if (el.statAvgV) el.statAvgV.textContent = String(avg);
        if (el.statStreakV) el.statStreakV.textContent = String(streak);
        if (el.statBestV) el.statBestV.textContent = String(best);

        if (el.dailyRewardTitle) el.dailyRewardTitle.textContent = t("dailyRewardTitle");
        initDailyReward();
        const coins = dailyRewardAmount();
        const ms = dailyRewardRemainingMs();
        const ready = ms === 0;
        if (el.dailyRewardSub) el.dailyRewardSub.textContent = t("dailyRewardSub");
        if (el.dailyRewardStatus) el.dailyRewardStatus.textContent = ready ? t("dailyRewardReady", { coins }) : t("dailyRewardNext", { hms: formatHMS(ms) });
        if (el.claimDailyRewardBtn) {
          el.claimDailyRewardBtn.textContent = t("dailyRewardBtn");
          el.claimDailyRewardBtn.disabled = !ready;
        }

        if (el.missionsTitle) el.missionsTitle.textContent = t("missionsTitle");
        renderMissions();

        renderAchievements();
        updateTasksBadge();
        updateProfileUI();
      }

      function updateShopUI() {
        if (el.shopDesc) el.shopDesc.textContent = t("shopDesc");
        if (el.coinPacksTitle) el.coinPacksTitle.textContent = t("coinPacksTitle");
        if (el.coinPacksSub) el.coinPacksSub.textContent = t("coinPacksSub");
        if (el.featuresTitle) el.featuresTitle.textContent = t("featuresTitle");
        if (el.featReveal1K) el.featReveal1K.textContent = t("featReveal1K");
        if (el.featReveal2K) el.featReveal2K.textContent = t("featReveal2K");
        if (el.shopHint1K) el.shopHint1K.textContent = t("shopHint1K");
        if (el.shopHint10K) el.shopHint10K.textContent = t("shopHint10K");
        if (el.shopHint10Sub) el.shopHint10Sub.textContent = t("shopHint10Sub");
        if (el.shopHint25K) el.shopHint25K.textContent = t("shopHint25K");
        if (el.shopHint25Sub) el.shopHint25Sub.textContent = t("shopHint25Sub");
        if (el.buyPack099Btn) el.buyPack099Btn.textContent = t("applePayBtn");
        if (el.buyPack299Btn) el.buyPack299Btn.textContent = t("applePayBtn");
        if (el.buyPack499Btn) el.buyPack499Btn.textContent = t("applePayBtn");
        if (el.buyPack999Btn) el.buyPack999Btn.textContent = t("applePayBtn");
        if (el.buyPack1999Btn) el.buyPack1999Btn.textContent = t("applePayBtn");
        if (el.buyNameChangeBtn) el.buyNameChangeBtn.textContent = t("applePayBtn");

        const inLevel = el.level && el.level.classList.contains("active") && app.stage && !app.session.over;
        const n1 = app.state.items && app.state.items.reveal1 ? app.state.items.reveal1 : 0;
        const n2 = app.state.items && app.state.items.reveal2 ? app.state.items.reveal2 : 0;
        if (el.featReveal1Owned) el.featReveal1Owned.textContent = t("ownedN", { n: n1 });
        if (el.featReveal2Owned) el.featReveal2Owned.textContent = t("ownedN", { n: n2 });
        if (el.shopHint1Owned) el.shopHint1Owned.textContent = t("ownedN", { n: app.state.hintTokens || 0 });

        if (el.buyHintTokenBtn) el.buyHintTokenBtn.textContent = t("buyHintTokenBtn");
        if (el.buyHintPack10Btn) el.buyHintPack10Btn.textContent = t("buyHintPack10Btn");
        if (el.buyHintPack25Btn) el.buyHintPack25Btn.textContent = t("buyHintPack25Btn");
        if (el.buyUseReveal1Btn) el.buyUseReveal1Btn.textContent = t("buyWithCoins", { cost: 12 });
        if (el.buyUseReveal2Btn) el.buyUseReveal2Btn.textContent = t("buyWithCoins", { cost: 20 });

        updateSettingsUI();
        updateLevelFeaturesUI();
      }

      function updateLevelFeaturesUI() {
        if (app.stage && app.stage.kind === "online") {
          if (el.hintBtn) el.hintBtn.disabled = true;
          if (el.levelFeatReveal1Btn) el.levelFeatReveal1Btn.disabled = true;
          if (el.levelFeatReveal2Btn) el.levelFeatReveal2Btn.disabled = true;
          return;
        }
        ensureItems();
        const hintPaid = Math.max(0, Math.floor(app.state.hintTokens || 0));
        const hintFree = Math.max(0, freeHintLimit() - freeHintUsedCount(app.stage));
        const hintLeft = hintFree + hintPaid;
        const n1 = Math.max(0, Math.floor(app.state.items.reveal1 || 0));
        const n2 = Math.max(0, Math.floor(app.state.items.reveal2 || 0));
        if (el.hintBtn) {
          el.hintBtn.textContent = t("hintBtn", { left: hintLeft });
          el.hintBtn.classList.toggle("primary", hintLeft > 0);
          el.hintBtn.classList.toggle("zero", hintLeft <= 0);
          el.hintBtn.disabled = app.session && app.session.over;
        }
        if (el.levelFeatReveal1Btn) el.levelFeatReveal1Btn.textContent = t("inLevelFeatureBtn", { name: t("featReveal1K"), n: n1 });
        if (el.levelFeatReveal2Btn) el.levelFeatReveal2Btn.textContent = t("inLevelFeatureBtn", { name: t("featReveal2K"), n: n2 });
        if (el.levelFeatReveal1Btn) {
          el.levelFeatReveal1Btn.classList.toggle("primary", n1 > 0);
          el.levelFeatReveal1Btn.classList.toggle("zero", n1 <= 0);
          el.levelFeatReveal1Btn.disabled = app.session && app.session.over;
        }
        if (el.levelFeatReveal2Btn) {
          el.levelFeatReveal2Btn.classList.toggle("primary", n2 > 0);
          el.levelFeatReveal2Btn.classList.toggle("zero", n2 <= 0);
          el.levelFeatReveal2Btn.disabled = app.session && app.session.over;
        }
      }

      const ACHS = [
        {
          id: "solve_10",
          reward: 12,
          title: { ar: " 10 ", en: "Solve 10 levels" },
          desc: { ar: " 10 ", en: "Complete 10 levels" },
          ok: () => app.state.completed.length >= 10,
        },
        {
          id: "nohint_10",
          reward: 15,
          title: { ar: "10  ", en: "10 no-hint" },
          desc: { ar: " 10    ", en: "Solve 10 levels without hints" },
          ok: () => (app.state.stats && app.state.stats.bestNoHint ? app.state.stats.bestNoHint : 0) >= 10,
        },
        {
          id: "boss_1",
          reward: 14,
          title: { ar: " ", en: "Boss lock" },
          desc: { ar: "   50", en: "Unlock level 50" },
          ok: () => app.state.completed.includes(50),
        },
        {
          id: "daily_3",
          reward: 10,
          title: { ar: "3  ", en: "3 daily challenges" },
          desc: { ar: " 3  ", en: "Complete 3 daily challenges" },
          ok: () => (app.state.daily.completed || []).length >= 3,
        },
      ];

      function isAchieved(id) {
        return app.state.achievements.includes(id);
      }

      function completeAchievement(id, reward) {
        if (isAchieved(id)) return;
        app.state.achievements.push(id);
        app.state.achievements.sort();
        saveState(app.state);
        awardCoins(reward);
      }

      function renderAchievements() {
        if (!el.achList) return;
        el.achList.innerHTML = "";
        const frag = document.createDocumentFragment();
        for (const a of ACHS) {
          const row = document.createElement("div");
          row.className = "shopRow";
          const title = currentLang() === "en" ? a.title.en : a.title.ar;
          const desc = currentLang() === "en" ? a.desc.en : a.desc.ar;
          const done = isAchieved(a.id) || a.ok();
          row.innerHTML = `<div><div class="t">${done ? " " : ""}${title}</div><div class="tiny">${desc}</div></div><div class="tiny">+${a.reward}</div>`;
          frag.appendChild(row);
          if (!isAchieved(a.id) && a.ok()) completeAchievement(a.id, a.reward);
        }
        el.achList.appendChild(frag);
      }

      function computeStars(attempts, usedHint) {
        if (!usedHint && attempts <= 2) return 3;
        if (attempts <= 4) return 2;
        return 1;
      }

      function renderHistory() {
        if (!el.history) return;
        el.history.innerHTML = "";
        const frag = document.createDocumentFragment();
        const items = app.history.slice(-80).reverse();
        for (const item of items) {
          const row = document.createElement("div");
          row.className = "historyItem";
          const dots = item.result.map((s) => `<span class="dot ${s}"></span>`).join("");
          const digits = String(item.guess || "")
            .split("")
            .map((d) => `<span class="d">${d}</span>`)
            .join("");
          row.innerHTML = `<div class="historyGuess" dir="rtl">${digits}</div><div class="historyDots">${dots}</div>`;
          frag.appendChild(row);
        }
        el.history.appendChild(frag);
      }

      function coachTextForStage(stage) {
        if (stage.kind !== "level") return "";
        const n = stage.id;
        if (app.state.seenCoach.includes(String(n))) return "";
        const ar = [
          "       .",
          "          .",
          "      .",
          "        .",
          "      .",
        ];
        const en = [
          "Fill each slot then press Check.",
          "Change one digit per attempt to learn faster.",
          "Yellow means the digit exists but is in the wrong position.",
          "Use a hint if stuck you can buy hints in Settings.",
          "Fewer attempts = more stars.",
        ];
        const idx = clamp(n - 1, 0, 4);
        return currentLang() === "en" ? en[idx] : ar[idx];
      }

      function showCoach(stage) {
        if (!el.coach) return;
        const text = coachTextForStage(stage);
        if (!text) {
          el.coach.style.display = "none";
          return;
        }
        el.coach.textContent = text;
        el.coach.style.display = "";
        app.state.seenCoach.push(String(stage.id));
        app.state.seenCoach = Array.from(new Set(app.state.seenCoach)).slice(-80);
        saveState(app.state);
      }

      function resetSession() {
        if (app.session.timerId) clearInterval(app.session.timerId);
        if (app.session.autoClearId) clearTimeout(app.session.autoClearId);
        app.session = {
          over: false,
          timerId: null,
          timeLeft: 0,
          attemptLimit: 0,
          usedPaidHint: false,
          usedAnyHint: false,
          autoClearId: null,
          shownHintDigits: [],
        };
        if (el.timerBadge) el.timerBadge.style.display = "none";
      }

      function startTimer(seconds) {
        resetSession();
        app.session.timeLeft = seconds;
        if (el.timerBadge) {
          el.timerBadge.style.display = "";
          el.timerBadge.textContent = t("timerBadge", { s: app.session.timeLeft });
        }
        app.session.timerId = setInterval(() => {
          if (app.session.over) return;
          app.session.timeLeft -= 1;
          if (el.timerBadge) el.timerBadge.textContent = t("timerBadge", { s: Math.max(0, app.session.timeLeft) });
          if (app.session.timeLeft <= 0) {
            app.session.over = true;
            if (el.msg) el.msg.textContent = t("timeUp");
            if (app.state && app.state.stats) {
              app.state.stats.winStreak = 0;
              saveState(app.state);
            }
          }
        }, 1000);
      }

      function setModeUI(stage) {
        if (stage.kind === "online") {
          if (!el.modeBadge) return;
          el.modeBadge.textContent = `  ${codeLengthForStage(stage)} `;
          return;
        }
        const mode = stage.kind === "daily" ? "daily" : app.state.mode || "normal";
        if (!el.modeBadge) return;
        if (mode === "limited" && app.session.attemptLimit) {
          el.modeBadge.textContent = `${t("modeBadge", { mode })} (${app.session.attemptLimit})`;
          return;
        }
        el.modeBadge.textContent = t("modeBadge", { mode });
      }

      function renderSlotsForStage(stage) {
        const len = codeLengthForStage(stage);
        el.slots.style.gridTemplateColumns = `repeat(${len}, 1fr)`;
        el.slots.innerHTML = "";
        app.inputs = [];
        app.hints = [];
        app.history = [];

        for (let i = 0; i < len; i++) {
          const wrap = document.createElement("div");
          wrap.className = "slotWrap";

          const hint = document.createElement("div");
          hint.className = "hint";
          hint.textContent = t("hintBubble");

          const slot = document.createElement("div");
          slot.className = "slot";

          const input = document.createElement("input");
          input.inputMode = "numeric";
          input.autocomplete = "off";
          input.maxLength = 1;

          slot.appendChild(input);
          wrap.appendChild(hint);
          wrap.appendChild(slot);
          el.slots.appendChild(wrap);

          app.inputs.push(input);
          app.hints.push(hint);
        }

        wireInputs();
      }

      function openStage(stage) {
        app.stage = stage;
        app.attempts = 0;
        el.attemptsNum.textContent = "0";
        if (stage.kind === "online") {
          el.levelNum.textContent = stage.mode === "easy" ? "" : stage.mode === "medium" ? "" : "";
          if (el.levelLabel) el.levelLabel.textContent = t("onlineBtn");
        } else {
          el.levelNum.textContent = stage.kind === "daily" ? stage.id : String(stage.id);
          if (el.levelLabel) el.levelLabel.textContent = stage.kind === "daily" ? t("dailyBtn") : t("levelLabel");
        }
        renderSlotsForStage(stage);
        clearSlots();
        resetSession();
        if (el.winBox) el.winBox.classList.remove("show", "onlineWin", "onlineLose");
        if (el.winSub) el.winSub.textContent = "";
        el.checkBtn.disabled = false;
        if (el.backToMapBtn) el.backToMapBtn.disabled = false;
        app.session.usedAnyHint = false;
        app.session.usedPaidHint = false;
        updateLevelFeaturesUI();
        if (el.onlineHud) el.onlineHud.style.display = stage.kind === "online" ? "" : "none";
        if (el.backToMapBtn) el.backToMapBtn.textContent = stage.kind === "online" ? "" : t("backToMapBtn");
        if (el.assistBtn) el.assistBtn.style.display = stage.kind === "online" ? "none" : "";
        if (el.retryBtn) el.retryBtn.style.display = stage.kind === "online" ? "none" : "";

        if (stage.kind === "level") {
          const mode = app.state.mode || "normal";
          const len = codeLengthForStage(stage);
          if (mode === "timed") startTimer(clamp(50 + len * 8, 45, 110));
          else if (mode === "limited") app.session.attemptLimit = len + 2;
        }
        setModeUI(stage);

        showCoach(stage);
        show(el.level);
      }

      function setHint(i) {
        const h = app.hints[i];
        h.classList.remove("show");
        void h.offsetWidth;
        h.classList.add("show");
      }

      function check() {
        if (app.session.over) return;
        const guess = app.inputs.map((x) => x.value).join("");
        const len = codeLengthForStage(app.stage);
        if (!isDigitsN(guess, len)) {
          el.msg.textContent = t("enterDigits", { len });
          return;
        }
        if (app.stage.kind === "online") {
          onlineSubmitGuess(guess);
          return;
        }
        const answer = generateAnswerForStage(app.stage);
        const result = evaluateGuess(guess, answer);

        app.attempts += 1;
        el.attemptsNum.textContent = String(app.attempts);
        el.msg.textContent = "";
        app.history.push({ guess, result });
        renderHistory();

        for (let i = 0; i < result.length; i++) {
          const slot = app.inputs[i].parentElement;
          slot.classList.remove("ok", "bad", "warn");
          slot.classList.add(result[i]);
          if (result[i] === "warn") setHint(i);
        }

        const solved = result.every((s) => s === "ok");
        if (!solved) {
          if (el.slots) {
            el.slots.classList.remove("shake");
            void el.slots.offsetWidth;
            el.slots.classList.add("shake");
            setTimeout(() => el.slots && el.slots.classList.remove("shake"), 480);
          }
          if (app.stage.kind !== "daily" && (app.state.mode || "normal") === "limited" && app.session.attemptLimit) {
            if (app.attempts >= app.session.attemptLimit) {
              app.session.over = true;
              el.msg.textContent = t("attemptsOver");
              if (app.state && app.state.stats) {
                app.state.stats.winStreak = 0;
                saveState(app.state);
              }
            }
          }
          if (!app.session.over) {
            if (app.session.autoClearId) clearTimeout(app.session.autoClearId);
            app.session.autoClearId = setTimeout(() => {
              if (!app.session || app.session.over) return;
              clearGuessOnly();
            }, 2500);
          }
          return;
        }

        app.session.over = true;
        if (app.session.timerId) clearInterval(app.session.timerId);

        const usedHint = !!app.session.usedAnyHint || hasUsedFreeHint(app.stage);
        const stars = computeStars(app.attempts, usedHint);

        recordMissionWin(app.stage, usedHint);

        if (app.stage.kind === "daily") {
          if (!app.state.daily.completed.includes(app.stage.id)) {
            app.state.daily.completed.push(app.stage.id);
            app.state.daily.completed.sort();
          }
          setDailyStars(app.stage.id, stars);
          app.state.stats.wins += 1;
          app.state.stats.winsDaily += 1;
          app.state.stats.attempts += app.attempts;
          app.state.stats.winStreak += 1;
          app.state.stats.bestWinStreak = Math.max(app.state.stats.bestWinStreak, app.state.stats.winStreak);
          if (!usedHint) {
            app.state.stats.streakNoHint += 1;
            app.state.stats.bestNoHint = Math.max(app.state.stats.bestNoHint, app.state.stats.streakNoHint);
          } else {
            app.state.stats.streakNoHint = 0;
          }
          const now = Date.now();
          if (!app.state.dailyChallenge) app.state.dailyChallenge = { id: 1, availableAt: 0, lastCompletedAt: 0 };
          app.state.dailyChallenge.lastCompletedAt = now;
          app.state.dailyChallenge.availableAt = now + dailyCooldownMs();
          app.state.dailyChallenge.id = Math.max(1, Math.floor((app.state.dailyChallenge.id || 1) + 1));
          saveState(app.state);
          awardCoins(5);
          updateDailyUI();
        } else {
          const level = app.stage.id;
          if (!app.state.completed.includes(level)) {
            app.state.completed.push(level);
            app.state.completed.sort((a, b) => a - b);
          }
          setStarsForLevel(level, stars);
          if (app.state.unlocked < level + 1) app.state.unlocked = clamp(level + 1, 1, TOTAL_LEVELS);

          app.state.stats.wins += 1;
          const mode = app.state.mode || "normal";
          if (mode === "timed") app.state.stats.winsTimed += 1;
          else if (mode === "limited") app.state.stats.winsLimited += 1;
          else app.state.stats.winsNormal += 1;
          app.state.stats.attempts += app.attempts;
          app.state.stats.winStreak += 1;
          app.state.stats.bestWinStreak = Math.max(app.state.stats.bestWinStreak, app.state.stats.winStreak);
          if (!usedHint) {
            app.state.stats.streakNoHint += 1;
            app.state.stats.bestNoHint = Math.max(app.state.stats.bestNoHint, app.state.stats.streakNoHint);
          } else {
            app.state.stats.streakNoHint = 0;
          }

          saveState(app.state);
          const bossBonus = isBossLevel(level) ? 2 : 0;
          awardCoins(2 + stars + bossBonus);
        }

        renderMap();
        updateSettingsUI();

        el.winBox.classList.add("show");
        playWinSound();
        vibrate([0, 14, 24, 14]);
        triggerWinFx();
        el.msg.textContent = "";

        if (app.stage.kind !== "daily" && app.stage.id >= TOTAL_LEVELS) {
          el.nextBtn.disabled = true;
          el.nextBtn.textContent = t("nextEnded");
        } else {
          el.nextBtn.disabled = false;
          el.nextBtn.textContent = t("nextBtn");
        }
      }

      function openModal(mode) {
        modalMode = mode;
        lastFocusedEl = document.activeElement;
        el.modalBackdrop.dataset.mode = mode;
        if (el.modal) el.modal.classList.toggle("compact", mode === "settings" || mode === "missions" || mode === "math" || mode === "name");
        if (el.modalTitle) {
          el.modalTitle.textContent =
            mode === "settings"
              ? t("settingsTitle")
              : mode === "missions"
              ? t("missionsModalTitle")
              : mode === "shop"
              ? t("shopModalTitle")
              : mode === "math"
              ? t("mathTitle")
              : mode === "assist"
              ? t("assistTitle")
              : mode === "online"
              ? t("onlineBtn")
              : mode === "name"
              ? " "
              : t("howTitle");
        }
        if (el.howToContent) el.howToContent.style.display = mode === "howto" ? "" : "none";
        if (el.assistContent) el.assistContent.style.display = mode === "assist" ? "" : "none";
        if (el.onlineContent) el.onlineContent.style.display = mode === "online" ? "" : "none";
        if (el.settingsContent) el.settingsContent.style.display = mode === "settings" ? "" : "none";
        if (el.missionsContent) el.missionsContent.style.display = mode === "missions" ? "" : "none";
        if (el.nameContent) el.nameContent.style.display = mode === "name" ? "" : "none";
        if (el.shopContent) el.shopContent.style.display = mode === "shop" ? "" : "none";
        if (el.mathContent) el.mathContent.style.display = mode === "math" ? "" : "none";
        updateThemeBtn();
        if (mode === "settings") updateSettingsUI();
        if (mode === "missions") updateSettingsUI();
        if (mode === "shop") updateShopUI();
        if (mode === "assist") {
          updateLevelFeaturesUI();
          updateHintBtnLabel();
        }
        el.modalBackdrop.classList.add("show");
        el.modalBackdrop.setAttribute("aria-hidden", "false");
        el.closeModalBtn.focus();

        if (mode === "settings" && el.modal && el.settingsBtn) {
          requestAnimationFrame(() => {
            const br = el.settingsBtn.getBoundingClientRect();
            const mr = el.modal.getBoundingClientRect();
            const ox = clamp(br.left + br.width * 0.6 - mr.left, 10, mr.width - 10);
            const oy = clamp(br.bottom - mr.top, 10, mr.height - 10);
            el.modal.style.setProperty("--modal-origin", `${ox}px ${oy}px`);
          });
        } else if (mode === "missions" && el.modal && el.tasksBtn) {
          requestAnimationFrame(() => {
            const br = el.tasksBtn.getBoundingClientRect();
            const mr = el.modal.getBoundingClientRect();
            const ox = clamp(br.left + br.width * 0.6 - mr.left, 10, mr.width - 10);
            const oy = clamp(br.bottom - mr.top, 10, mr.height - 10);
            el.modal.style.setProperty("--modal-origin", `${ox}px ${oy}px`);
          });
        } else if (mode === "assist" && el.modal && el.assistBtn) {
          requestAnimationFrame(() => {
            const br = el.assistBtn.getBoundingClientRect();
            const mr = el.modal.getBoundingClientRect();
            const ox = clamp(br.left + br.width * 0.5 - mr.left, 10, mr.width - 10);
            const oy = clamp(br.bottom - mr.top, 10, mr.height - 10);
            el.modal.style.setProperty("--modal-origin", `${ox}px ${oy}px`);
          });
        } else if (el.modal) {
          el.modal.style.removeProperty("--modal-origin");
        }
      }
      function openHowTo() {
        openModal("howto");
      }

      function openSettings() {
        openModal("settings");
      }

      function openMissions() {
        openModal("missions");
      }

      function openProfile() {
        if (!el.profileDropBackdrop || !el.profileDrop) return;
        const open = el.profileDropBackdrop.classList.contains("show");
        if (open) {
          closeProfileDrop();
          return;
        }
        openProfileDrop();
      }

      function updateProfileDropPosition() {
        if (!el.profileDrop || !el.playerAvatar) return;
        const br = el.playerAvatar.getBoundingClientRect();
        const top = Math.max(8, Math.floor(br.bottom + 10));
        const desiredW = Math.min(560, Math.max(300, window.innerWidth - 24));
        const left = clamp(Math.floor(br.right - desiredW), 12, Math.max(12, window.innerWidth - desiredW - 12));
        el.profileDrop.style.setProperty("--pTop", `${top}px`);
        el.profileDrop.style.setProperty("--pLeft", `${left}px`);
      }

      function openProfileDrop() {
        if (!el.profileDropBackdrop || !el.profileDrop) return;
        updateProfileDropPosition();
        el.profileDropBackdrop.classList.add("show");
        el.profileDropBackdrop.setAttribute("aria-hidden", "false");
        ensureCountryCode().then(() => updateProfileUI()).catch(() => updateProfileUI());
        ensureMeLoaded()
          .then((me) => {
            if (me && typeof me.createdAt === "string") {
              const ms = Date.parse(me.createdAt);
              if (!app.state.createdAt && Number.isFinite(ms) && ms > 0) {
                app.state.createdAt = ms;
                saveStateSilent(app.state);
              }
            }
            updateProfileUI();
          })
          .catch(() => updateProfileUI());
        if (el.profileDropClose) el.profileDropClose.focus();
      }

      function closeProfileDrop() {
        if (!el.profileDropBackdrop) return;
        el.profileDropBackdrop.classList.remove("show");
        el.profileDropBackdrop.setAttribute("aria-hidden", "true");
      }

      function closeHowTo() {
        const closingOnline = modalMode === "online";
        const queueId = closingOnline ? onlineState.queueId : "";
        if (closingOnline) {
          stopOnlineQueuePolling();
          stopOnlineCoinsSync();
          stopOnlineAutoReturn();
          stopOnlinePreEnter();
          stopOnlineHiddenForfeitTimer();
          onlineState.queueId = "";
          onlineState.open = false;
          if (queueId) {
            friendsJson("/api/online/queue/cancel", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ id: queueId }),
            }).then((r) => {
              if (r && r.ok && r.data && r.data.refunded) {
                if (typeof r.data.coins === "number") setCoinsTotal(r.data.coins, 0, true);
              }
            });
          }
        }
        el.modalBackdrop.classList.remove("show");
        el.modalBackdrop.setAttribute("aria-hidden", "true");
        delete el.modalBackdrop.dataset.mode;
        if (el.modal) el.modal.classList.remove("compact");
        if (app.session && app.session.mathPuzzle) delete app.session.mathPuzzle;
        if (lastFocusedEl && typeof lastFocusedEl.focus === "function") lastFocusedEl.focus();
      }

      function goMap() {
        renderMap();
        show(el.map);
        requestAnimationFrame(() => {
          if (el.path) el.path.scrollLeft = 0;
          setTimeout(() => {
            if (el.path) el.path.scrollLeft = 0;
          }, 250);
          focusMapPath();
        });
      }

      function goHome() {
        closeHowTo();
        show(el.home);
      }

      function enableMapControls() {
        if (!el.path) return;

        function scrollMapBy(dir) {
          const behavior = "smooth";
          const view = el.path.getBoundingClientRect();
          const cx = view.left + view.width / 2;
          const btns = el.path.querySelectorAll("button.stage");
          let bestLevel = 1;
          let bestDist = Infinity;
          for (const b of btns) {
            const r = b.getBoundingClientRect();
            const d = Math.abs(r.left + r.width / 2 - cx);
            if (d < bestDist) {
              bestDist = d;
              const n = parseInt(b.dataset.level || "1", 10);
              if (Number.isFinite(n)) bestLevel = n;
            }
          }
          const target = clamp(bestLevel + dir * 2, 1, TOTAL_LEVELS);
          goToStageNumber(target, behavior);
        }

        if (el.mapPrevBtn) el.mapPrevBtn.addEventListener("click", () => scrollMapBy(-1));
        if (el.mapNextBtn) el.mapNextBtn.addEventListener("click", () => scrollMapBy(1));

        el.path.addEventListener(
          "wheel",
          (e) => {
            if (el.map.classList.contains("active")) e.preventDefault();
          },
          { passive: false }
        );
        el.path.addEventListener(
          "touchmove",
          (e) => {
            if (el.map.classList.contains("active")) e.preventDefault();
          },
          { passive: false }
        );

        el.path.addEventListener("keydown", (e) => {
          if (!el.map.classList.contains("active")) return;
          if (el.modalBackdrop.classList.contains("show")) return;
          if (e.key === "ArrowLeft" || e.key === "ArrowUp") {
            scrollMapBy(-1);
            e.preventDefault();
          } else if (e.key === "ArrowRight" || e.key === "ArrowDown") {
            scrollMapBy(1);
            e.preventDefault();
          }
        });
      }

      function freeHintDigit(stage) {
        const answer = generateAnswerForStage(stage);
        let seed = 2166136261;
        const k = stageKey(stage);
        for (let i = 0; i < k.length; i++) {
          seed ^= k.charCodeAt(i);
          seed = Math.imul(seed, 16777619) >>> 0;
        }
        const idx = seed % answer.length;
        return answer[idx];
      }

      function paidHintDigit(stage) {
        const answer = generateAnswerForStage(stage).split("");
        const shown = app.session && Array.isArray(app.session.shownHintDigits) ? app.session.shownHintDigits : [];
        for (const d of answer) {
          if (!shown.includes(d)) {
            shown.push(d);
            if (app.session) app.session.shownHintDigits = shown;
            return d;
          }
        }
        const d = answer[Math.floor(Math.random() * Math.max(1, answer.length))] || "0";
        shown.push(d);
        if (app.session) app.session.shownHintDigits = shown;
        return d;
      }

      function spendHintToken() {
        const cur = app.state.hintTokens || 0;
        if (cur <= 0) return false;
        app.state.hintTokens = cur - 1;
        saveState(app.state);
        updateSettingsUI();
        updateHintBtnLabel();
        updateLevelFeaturesUI();
        return true;
      }

      function updateHintBtnLabel() {
        const hintPaid = Math.max(0, Math.floor(app.state.hintTokens || 0));
        const hintFree = Math.max(0, freeHintLimit() - freeHintUsedCount(app.stage));
        const hintLeft = hintFree + hintPaid;
        el.hintBtn.textContent = t("hintBtn", { left: hintLeft });
        el.hintBtn.classList.toggle("primary", hintLeft > 0);
        el.hintBtn.classList.toggle("zero", hintLeft <= 0);
      }

      function paidHintReveal(stage) {
        const answer = generateAnswerForStage(stage).split("");
        const candidates = [];
        for (let i = 0; i < answer.length; i++) {
          const input = app.inputs[i];
          if (!input) continue;
          if (input.disabled) continue;
          candidates.push(i);
        }
        if (!candidates.length) return false;
        const idx = candidates[Math.floor(Math.random() * candidates.length)];
        const input = app.inputs[idx];
        input.value = answer[idx];
        input.disabled = true;
        input.dataset.locked = "1";
        const slot = input.parentElement;
        slot.classList.remove("bad", "warn");
        slot.classList.add("ok");
        return true;
      }

      function paidHintEliminate(stage) {
        const answer = generateAnswerForStage(stage);
        const used = new Set(answer.split(""));
        let d = String(randInt(0, 9));
        let tries = 0;
        while (used.has(d) && tries < 30) {
          d = String(randInt(0, 9));
          tries += 1;
        }
        if (used.has(d)) return false;
        el.msg.textContent = t("digitNotInLock", { digit: d });
        return true;
      }

      function paidHintCount(stage) {
        if (!app.history.length) {
          el.msg.textContent = t("makeGuessFirst");
          return true;
        }
        const answer = generateAnswerForStage(stage);
        const last = app.history[app.history.length - 1];
        let count = 0;
        for (const ch of last.guess) if (answer.includes(ch)) count += 1;
        el.msg.textContent = t("digitsPresent", { count });
        return true;
      }

      function useHint() {
        if (app.session.over) return;
        if (!hasUsedFreeHint(app.stage)) {
          const digit = freeHintDigit(app.stage);
          markFreeHintUsed(app.stage);
          app.session.usedAnyHint = true;
          updateHintBtnLabel();
          el.msg.textContent = t("hintMsg", { digit });
          return;
        }

        if (!spendHintToken()) {
          openShop();
          return;
        }

        app.session.usedAnyHint = true;
        app.session.usedPaidHint = true;
        const digit = paidHintDigit(app.stage);
        el.msg.textContent = t("hintMsg", { digit });
        updateHintBtnLabel();
      }

      function shareResult() {
        const stars =
          app.stage.kind === "daily" ? getDailyStars(app.stage.id) : app.stage.kind === "level" ? getStarsForLevel(app.stage.id) : 0;
        const title = app.stage.kind === "daily" ? `${t("dailyBtn")} ${app.stage.id}` : `${t("levelLabel")} ${app.stage.id}`;
        const text = t("shareText", { title, attempts: app.attempts, stars });
        const done = () => (el.msg.textContent = t("copied"));
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(text).then(done, done);
        } else {
          window.prompt("Copy", text);
          done();
        }
      }

      async function signOutFromGame() {
        try {
          flushCloudNow();
          const r = await fetch("/api/auth/csrf");
          const data = await r.json().catch(() => ({}));
          const csrfToken = data && typeof data.csrfToken === "string" ? data.csrfToken : "";
          if (!csrfToken) {
            if (window.top) window.top.location.href = "/";
            else window.location.href = "/";
            return;
          }
          const form = document.createElement("form");
          form.method = "POST";
          form.action = "/api/auth/signout";
          form.target = "_top";
          const csrf = document.createElement("input");
          csrf.type = "hidden";
          csrf.name = "csrfToken";
          csrf.value = csrfToken;
          const cb = document.createElement("input");
          cb.type = "hidden";
          cb.name = "callbackUrl";
          cb.value = "/";
          form.appendChild(csrf);
          form.appendChild(cb);
          document.body.appendChild(form);
          form.submit();
        } catch {
          if (window.top) window.top.location.href = "/";
          else window.location.href = "/";
        }
      }

      function openDaily() {
        updateDailyUI();
        if (!canStartDaily()) {
          const ok = window.confirm(t("dailyPayConfirm"));
          if (!ok) {
            el.msg.textContent = t("dailyLocked", { hms: formatHMS(dailyAvailableInMs()) });
            return;
          }
          if (!spendCoins(3)) {
            el.msg.textContent = t("notEnoughCoins");
            return;
          }
          if (!app.state.dailyChallenge) app.state.dailyChallenge = { id: 1, availableAt: 0, lastCompletedAt: 0 };
          app.state.dailyChallenge.availableAt = 0;
          saveState(app.state);
        }
        if (!app.state.dailyChallenge) app.state.dailyChallenge = { id: 1, availableAt: 0, lastCompletedAt: 0 };
        openStage({ kind: "daily", id: app.state.dailyChallenge.id });
      }

      function goToStageNumber(n, behaviorOverride) {
        const num = clamp(Math.floor(n || 0), 1, TOTAL_LEVELS);
        const behavior = behaviorOverride || "smooth";
        ensureMapBuiltTo(num);
        let tries = 0;
        function tryScroll() {
          const btn = document.getElementById(`stageBtn-${num}`);
          if (btn) {
            if (el.path && num <= 2) {
              el.path.scrollTo({ left: 0, behavior });
            } else if (el.path && num >= TOTAL_LEVELS - 1) {
              el.path.scrollTo({ left: el.path.scrollWidth, behavior });
            } else {
              btn.scrollIntoView({ behavior, inline: "center", block: "nearest" });
            }
            focusMapPath();
            return;
          }
          tries += 1;
          ensureMapBuiltTo(num);
          if (tries > 220) return;
          requestAnimationFrame(tryScroll);
        }
        tryScroll();
      }

      function buyHintToken() {
        if (!spendCoins(4)) {
          el.msg.textContent = t("notEnoughCoins");
          return;
        }
        app.state.hintTokens = (app.state.hintTokens || 0) + 1;
        saveState(app.state);
        updateSettingsUI();
        updateShopUI();
        updateLevelFeaturesUI();
        el.msg.textContent = t("bought");
      }

      function buyHintPack(amount, cost) {
        if (!spendCoins(cost)) {
          el.msg.textContent = t("notEnoughCoins");
          return;
        }
        app.state.hintTokens = (app.state.hintTokens || 0) + amount;
        saveState(app.state);
        updateSettingsUI();
        updateShopUI();
        updateLevelFeaturesUI();
        el.msg.textContent = t("bought");
      }

      function buyCircle() {
        if (app.state.unlocks && app.state.unlocks.circle) return;
        if (!spendCoins(60)) {
          el.msg.textContent = t("notEnoughCoins");
          return;
        }
        app.state.unlocks.circle = true;
        saveState(app.state);
        updateSettingsUI();
        el.msg.textContent = t("bought");
      }

      function buySquare() {
        if (app.state.unlocks && app.state.unlocks.square) return;
        if (!spendCoins(60)) {
          el.msg.textContent = t("notEnoughCoins");
          return;
        }
        app.state.unlocks.square = true;
        saveState(app.state);
        updateSettingsUI();
        el.msg.textContent = t("bought");
      }

      function openShop() {
        openModal("shop");
      }

      function formatNameStatus(freeUsed, credits) {
        if (!freeUsed) return "  ";
        if (credits > 0) return ` (${credits})`;
        return " ";
      }

      async function openNameModal() {
        if (!cloud.enabled) {
          enqueueToast({ title: " ", body: "  .", autoMs: 2400 });
          return;
        }
        try {
          const info = await friendsJson("/api/profile/name", { method: "GET" });
          if (!info.ok || !info.data) {
            enqueueToast({ title: "", body: "    .", autoMs: 2400 });
            return;
          }
          const current = info.data && typeof info.data.displayName === "string" ? info.data.displayName.trim() : "";
          const freeUsed = !!(info.data && info.data.freeUsed);
          const credits = Math.max(0, Math.floor((info.data && typeof info.data.credits === "number" ? info.data.credits : 0) || 0));

          if (freeUsed && credits <= 0) {
            enqueueToast({ title: "    ", body: "", autoMs: 2400 });
            return;
          }

          if (el.nameCurrent) el.nameCurrent.textContent = current || "";
          if (el.nameStatus) el.nameStatus.textContent = formatNameStatus(freeUsed, credits);
          if (el.nameInput) el.nameInput.value = current || "";
          openModal("name");
          setTimeout(() => {
            if (el.nameInput && typeof el.nameInput.focus === "function") el.nameInput.focus();
          }, 0);
        } catch {
          enqueueToast({ title: "", body: "    .", autoMs: 2400 });
        }
      }

      async function saveNameFromModal() {
        if (!cloud.enabled) {
          enqueueToast({ title: " ", body: "  .", autoMs: 2400 });
          return;
        }
        const next = el.nameInput ? String(el.nameInput.value || "").trim() : "";
        if (!next) return;
        if (el.nameSaveBtn) el.nameSaveBtn.disabled = true;
        try {
          const r = await friendsJson("/api/profile/name", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ displayName: next }),
          });
          if (!r.ok) {
            if (r.status === 402) {
              closeHowTo();
              enqueueToast({ title: "    ", body: "", autoMs: 2400 });
              return;
            }
            enqueueToast({ title: "", body: (r.data && r.data.error) || "  .", autoMs: 2400 });
            return;
          }

          const newName = r.data && typeof r.data.displayName === "string" ? r.data.displayName.trim() : next;
          app.state.displayName = newName;
          app.state.nameChange = app.state.nameChange && typeof app.state.nameChange === "object" ? app.state.nameChange : { freeUsed: false, credits: 0 };
          if (r.data && typeof r.data.freeUsed === "boolean") app.state.nameChange.freeUsed = r.data.freeUsed;
          if (r.data && typeof r.data.credits === "number") app.state.nameChange.credits = Math.max(0, Math.floor(r.data.credits));
          saveState(app.state);
          updateUserCenter();
          updateSettingsUI();
          closeHowTo();
          enqueueToast({ title: "  ", body: ` : "${newName}"`, autoMs: 2600 });
        } catch {
          enqueueToast({ title: "", body: "  .", autoMs: 2400 });
        } finally {
          if (el.nameSaveBtn) el.nameSaveBtn.disabled = false;
        }
      }

      function ensureItems() {
        if (!app.state.items || typeof app.state.items !== "object") app.state.items = { reveal1: 0, reveal2: 0 };
        if (!Number.isFinite(app.state.items.reveal1)) app.state.items.reveal1 = 0;
        if (!Number.isFinite(app.state.items.reveal2)) app.state.items.reveal2 = 0;
        if (Number.isFinite(app.state.items.math)) {
          app.state.items.reveal2 += Math.max(0, Math.floor(app.state.items.math));
          delete app.state.items.math;
        }
      }

      async function startCheckout(packId) {
        el.msg.textContent = t("paymentRedirecting");
        try {
          const res = await fetch("/api/create-checkout-session", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ packId }),
          });
          const data = await res.json().catch(() => ({}));
          if (res.status === 401) {
            el.msg.textContent = t("paymentLoginRequired");
            return;
          }
          if (!res.ok || !data || !data.url) {
            el.msg.textContent = t("paymentNotReady");
            return;
          }
          window.location.href = data.url;
        } catch {
          el.msg.textContent = t("paymentNotReady");
        }
      }

      async function consumeCheckoutReturn() {
        const url = new URL(window.location.href);
        const status = url.searchParams.get("checkout");
        const sessionId = url.searchParams.get("session_id");
        if (!status) return;

        url.searchParams.delete("checkout");
        url.searchParams.delete("session_id");
        window.history.replaceState({}, document.title, url.toString());

        if (status !== "success" || !sessionId) {
          el.msg.textContent = t("paymentFailed");
          return;
        }

        if (app.state.processedSessions && app.state.processedSessions.includes(sessionId)) {
          return;
        }

        try {
          const res = await fetch(`/api/confirm-session?session_id=${encodeURIComponent(sessionId)}`, { method: "GET" });
          const data = await res.json().catch(() => ({}));
          if (res.status === 401) {
            el.msg.textContent = t("paymentLoginRequired");
            return;
          }
          if (!res.ok || !data || typeof data.coinsAdded !== "number") {
            el.msg.textContent = t("paymentFailed");
            return;
          }
          app.state.processedSessions = Array.isArray(app.state.processedSessions) ? app.state.processedSessions : [];
          app.state.processedSessions.push(sessionId);
          app.state.processedSessions = app.state.processedSessions.slice(-50);
          const totalCoins = typeof data.totalCoins === "number" && Number.isFinite(data.totalCoins) ? Math.max(0, Math.floor(data.totalCoins)) : null;
          if (data && typeof data.totalNameChangeCredits === "number" && Number.isFinite(data.totalNameChangeCredits)) {
            app.state.nameChange = app.state.nameChange && typeof app.state.nameChange === "object" ? app.state.nameChange : { freeUsed: false, credits: 0 };
            app.state.nameChange.credits = Math.max(0, Math.floor(data.totalNameChangeCredits));
          }
          const added = Math.max(0, Math.floor(data.coinsAdded));
          const nameAdded = Math.max(0, Math.floor(typeof data.nameChangeCreditsAdded === "number" ? data.nameChangeCreditsAdded : 0));
          if (totalCoins !== null) setCoinsTotal(totalCoins, added, true);
          saveState(app.state);
          if (added) {
            if (totalCoins === null) awardCoins(added);
            el.msg.textContent = t("paymentApplied", { coins: added });
          } else if (nameAdded) {
            el.msg.textContent = "   .";
          }
          updateShopUI();
        } catch {
          el.msg.textContent = t("paymentFailed");
        }
      }

      function applyRevealOneNow() {
        const ok = paidHintReveal(app.stage);
        if (!ok) return false;
        app.session.usedAnyHint = true;
        app.session.usedPaidHint = true;
        return true;
      }

      function applyRevealTwoNow() {
        const ok1 = paidHintReveal(app.stage);
        const ok2 = paidHintReveal(app.stage);
        const ok = ok1 || ok2;
        if (!ok) return false;
        app.session.usedAnyHint = true;
        app.session.usedPaidHint = true;
        return true;
      }

      function useOrBuyFeature(id) {
        ensureItems();
        const cost = id === "reveal2" ? 20 : 12;
        if (!spendCoins(cost)) {
          el.msg.textContent = t("notEnoughCoins");
          return;
        }

        if (id === "reveal2") app.state.items.reveal2 += 1;
        else app.state.items.reveal1 += 1;
        saveState(app.state);
        el.msg.textContent = t("bought");

        updateShopUI();
        updateLevelFeaturesUI();
      }

      function mathSeedFromString(s) {
        let h = 2166136261;
        for (let i = 0; i < s.length; i++) {
          h ^= s.charCodeAt(i);
          h = Math.imul(h, 16777619) >>> 0;
        }
        return h >>> 0;
      }

      function makeMathRng(seed) {
        let s = seed >>> 0;
        return () => {
          s ^= s << 13;
          s ^= s >>> 17;
          s ^= s << 5;
          return (s >>> 0) || 1;
        };
      }

      function mathRandInt(next, a, b) {
        const n = next();
        return a + (n % (b - a + 1));
      }

      function makeMathPuzzle(stage) {
        const answer = generateAnswerForStage(stage);
        const seed = mathSeedFromString(`${stageKey(stage)}:math`);
        const next = makeMathRng(seed);
        const pickIdx = mathRandInt(next, 0, Math.max(0, answer.length - 1));
        const digit = parseInt(answer[pickIdx], 10);

        const level = stage.kind === "daily" ? stage.id * 40 : stage.id;
        const tier = clamp(Math.floor((level - 1) / 120), 0, 6);
        const pat = next() % 3;

        for (let tries = 0; tries < 30; tries++) {
          if (pat === 0) {
            if (digit >= 2 && digit <= 8) {
              const a = mathRandInt(next, 1, digit - 1);
              const b = digit - a;
              return { digit, eq: `${a} + ${b} = ` };
            }
            if (digit === 9) return { digit, eq: `4 + 5 = ` };
            if (digit === 1) return { digit, eq: `7 - 6 = ` };
            if (digit === 0) return { digit, eq: `9 - 9 = ` };
          } else if (pat === 1) {
            const b = mathRandInt(next, 1, 6 + tier * 2);
            const a = digit + b;
            if (a > 0 && a <= 24) return { digit, eq: `${a} - ${b} = ` };
          } else {
            const a = mathRandInt(next, 6 + tier, 14 + tier * 2);
            const b = mathRandInt(next, 2, 9);
            const c = a + b - digit;
            if (c >= 1 && c <= 22) return { digit, eq: `(${a} + ${b}) - ${c} = ` };
          }
        }
        return { digit, eq: `8 - 4 = ` };
      }

      function openMathPuzzle() {
        if (!el.mathEq || !el.mathAnswer || !el.mathYesBtn || !el.mathCancelBtn || !el.mathNote) return;
        app.session.mathPuzzle = makeMathPuzzle(app.stage);
        el.mathEq.textContent = app.session.mathPuzzle.eq;
        el.mathNote.textContent = t("mathNote");
        el.mathAnswer.value = "";
        el.mathAnswer.placeholder = t("mathPlaceholder");
        el.mathYesBtn.textContent = t("mathYesBtn");
        el.mathCancelBtn.textContent = t("mathCancelBtn");
        openModal("math");
        requestAnimationFrame(() => el.mathAnswer && el.mathAnswer.focus());
      }

      function submitMathPuzzle() {
        if (!app.session || !app.session.mathPuzzle) return;
        if (!el.mathAnswer) return;
        const raw = (el.mathAnswer.value || "").trim();
        const n = parseInt(raw.replace(/[^\d]/g, ""), 10);
        if (!Number.isFinite(n) || n < 0 || n > 9) {
          if (el.mathNote) el.mathNote.textContent = t("mathEnterDigit");
          return;
        }

        const have = app.state.items && app.state.items.reveal2 ? app.state.items.reveal2 : 0;
        if (have <= 0) {
          closeHowTo();
          openShop();
          return;
        }

        app.state.items.reveal2 -= 1;
        saveState(app.state);
        app.session.usedAnyHint = true;
        app.session.usedPaidHint = true;

        const digit = app.session.mathPuzzle.digit;
        if (n === digit) {
          el.msg.textContent = t("mathCorrect", { digit });
        } else {
          el.msg.textContent = t("mathWrongUsed");
        }
        delete app.session.mathPuzzle;
        closeHowTo();
        updateShopUI();
      }

      function useOwnedFeatureOrOpenShop(id) {
        ensureItems();
        const inLevel = el.level && el.level.classList.contains("active") && app.stage && !app.session.over;
        if (!inLevel) {
          openShop();
          return;
        }

        const have = id === "reveal2" ? app.state.items.reveal2 : app.state.items.reveal1;
        if (have <= 0) {
          openShop();
          return;
        }

        if (id === "reveal2") {
          openMathPuzzle();
          return;
        }

        app.state.items.reveal1 -= 1;
        saveState(app.state);
        const ok = applyRevealOneNow();
        if (!ok) {
          app.state.items.reveal1 += 1;
          saveState(app.state);
          el.msg.textContent = t("hintFailed");
        }
        updateShopUI();
      }

      function openDiscord() {
        const userId = "632225768281341982";
        const handle = "@977u";
        const profileUrl = `https://discord.com/users/${userId}`;
        try {
          navigator.clipboard.writeText(profileUrl).catch(() => {});
        } catch {}
        enqueueToast({
          title: "Discord",
          body: `    : ${handle}`,
          autoMs: 3200,
          actions: [
            {
              label: " ",
              primary: true,
              onClick: () => {
                window.open(profileUrl, "_blank", "noopener,noreferrer");
              },
            },
            {
              label: " Discord",
              onClick: () => {
                window.open("https://discord.com/app", "_blank", "noopener,noreferrer");
              },
            },
          ],
        });
      }

      const onlineState = {
        open: false,
        mode: "",
        fee: 0,
        codeLen: 0,
        queueId: "",
        matchId: "",
        roomCode: "",
        selectKind: "normal",
        meEmail: "",
        meName: "",
        mePhoto: "",
        oppName: "",
        oppPhoto: "",
        turnEndAt: 0,
        barRafId: 0,
        endAnimKey: "",
        endCoinsSyncDone: false,
        autoReturnId: null,
        preEnterId: null,
        preEnterUntil: 0,
        preEnterMatchId: "",
        oppFlashKey: "",
        searchingStartedAt: 0,
        pollQueueId: null,
        pollQueueBusy: false,
        pollMatchId: null,
        pollMatchEvery: 0,
        pollRoomId: null,
        pollRoomBusy: false,
        spinId: null,
        coinsSyncId: null,
        coinsSyncBusy: false,
        hiddenForfeitId: null,
        lastMaskedAt: 0,
        busy: false,
        forfeitSent: false,
        stateFetchBusy: false,
        setupMyReady: false,
        setupOppReady: false,
        setupPendingUntil: 0,
        setupPendingValue: null,
        setupPendingMatchId: "",
        customFocused: false,
        serverOffsetMs: 0,
        propsPendingPickUntil: 0,
        propsPendingPickIndex: -1,
        propsMyCard: "",
        propsMyUsed: false,
        actionInFlight: {},
        actionCooldownUntil: {},
      };

      const ONLINE_TURN_MS = 30_000;

      function onlineCfg(mode) {
        if (mode === "easy") return { fee: 29, codeLen: 3 };
        if (mode === "medium") return { fee: 45, codeLen: 4 };
        return { fee: 89, codeLen: 5 };
      }

      function onlineCanRunAction(key) {
        const k = String(key || "");
        const now = Date.now();
        const inflight = onlineState.actionInFlight && typeof onlineState.actionInFlight === "object" ? onlineState.actionInFlight : {};
        const cooldown = onlineState.actionCooldownUntil && typeof onlineState.actionCooldownUntil === "object" ? onlineState.actionCooldownUntil : {};
        return !(inflight[k] === true) && !(typeof cooldown[k] === "number" && now < cooldown[k]);
      }

      async function onlineRunAction(key, fn, cooldownMs) {
        const k = String(key || "");
        const cdMs = Math.max(0, Math.floor(cooldownMs || 0));
        onlineState.actionInFlight = onlineState.actionInFlight && typeof onlineState.actionInFlight === "object" ? onlineState.actionInFlight : {};
        onlineState.actionCooldownUntil =
          onlineState.actionCooldownUntil && typeof onlineState.actionCooldownUntil === "object" ? onlineState.actionCooldownUntil : {};
        if (!onlineCanRunAction(k)) return;
        onlineState.actionInFlight[k] = true;
        onlineState.actionCooldownUntil[k] = Date.now() + (cdMs || 350);
        try {
          await fn();
        } finally {
          onlineState.actionInFlight[k] = false;
          onlineState.actionCooldownUntil[k] = Math.max(Number(onlineState.actionCooldownUntil[k] || 0), Date.now() + 120);
        }
      }

      function stopOnlineQueuePolling() {
        if (onlineState.pollQueueId) clearInterval(onlineState.pollQueueId);
        onlineState.pollQueueId = null;
        onlineState.pollQueueBusy = false;
        if (onlineState.spinId) clearInterval(onlineState.spinId);
        onlineState.spinId = null;
      }

      function stopOnlineRoomPolling() {
        if (onlineState.pollRoomId) clearInterval(onlineState.pollRoomId);
        onlineState.pollRoomId = null;
        onlineState.pollRoomBusy = false;
      }

      function stopOnlineMatchPolling() {
        if (onlineState.pollMatchId) clearInterval(onlineState.pollMatchId);
        onlineState.pollMatchId = null;
        onlineState.pollMatchEvery = 0;
        if (onlineState.barRafId) cancelAnimationFrame(onlineState.barRafId);
        onlineState.barRafId = 0;
      }

      function stopOnlineHiddenForfeitTimer() {
        if (onlineState.hiddenForfeitId) clearTimeout(onlineState.hiddenForfeitId);
        onlineState.hiddenForfeitId = null;
      }

      function stopOnlineAutoReturn() {
        if (onlineState.autoReturnId) clearTimeout(onlineState.autoReturnId);
        onlineState.autoReturnId = null;
      }

      function stopOnlinePreEnter() {
        if (onlineState.preEnterId) clearInterval(onlineState.preEnterId);
        onlineState.preEnterId = null;
        onlineState.preEnterUntil = 0;
        onlineState.preEnterMatchId = "";
      }

      async function onlinePreEnterMatch(matchId, mode, fee, codeLen, me, opponentFromJoin, kind) {
        const id = String(matchId || "").trim();
        if (!id) return;
        stopOnlineQueuePolling();
        stopOnlineRoomPolling();

        const meResolved = me || (await ensureMeLoaded());
        renderOnlineSearching(mode, meResolved || null, kind);
        const nameEl = document.getElementById("onlineSearchOppName");
        const countdownEl = document.getElementById("onlineFoundCountdown");
        const barEl = document.getElementById("onlineSearchBar");
        const oppAv = document.getElementById("onlineSearchOppAvatar");
        if (onlineState.spinId) clearInterval(onlineState.spinId);
        onlineState.spinId = null;

        let serverNowMs = 0;
        let turnStartedAtMs = 0;
        let opponent = opponentFromJoin && typeof opponentFromJoin === "object" ? opponentFromJoin : null;
        try {
          const t0 = Date.now();
          const r = await friendsJson(`/api/online/match/state?id=${encodeURIComponent(id)}`, { method: "GET" });
          const t1 = Date.now();
          const m = r && r.ok && r.data && r.data.match ? r.data.match : null;
          if (m) {
            if (!opponent && m.opponent) opponent = m.opponent;
            if (typeof m.kind === "string") kind = m.kind === "custom" ? "custom" : m.kind === "props" ? "props" : "normal";
            if (typeof m.serverNowMs === "number" && Number.isFinite(m.serverNowMs)) serverNowMs = Math.floor(m.serverNowMs);
            if (typeof m.turnStartedAtMs === "number" && Number.isFinite(m.turnStartedAtMs)) turnStartedAtMs = Math.floor(m.turnStartedAtMs);
            if (serverNowMs > 0 && turnStartedAtMs > 0) {
              const mid = Math.floor((t0 + t1) / 2);
              const offset = serverNowMs - mid;
              onlineState.preEnterUntil = Math.max(Date.now(), turnStartedAtMs - offset + 60);
            }
          }
        } catch {}

        const oppName =
          opponent && typeof opponent.firstName === "string" && String(opponent.firstName || "").trim() ? String(opponent.firstName).trim() : "";
        const oppPhoto = opponent && typeof opponent.photo === "string" ? opponent.photo : "";
        if (nameEl) nameEl.innerHTML = `${escapeHtml(oppName)}<span id="onlineSearchDots"></span>`;
        if (oppAv) onlineSetSearchAvatar(oppAv, oppPhoto, String(oppName || "O").slice(0, 1).toUpperCase());
        if (countdownEl) countdownEl.style.display = "";

        onlineState.preEnterMatchId = id;
        if (!onlineState.preEnterUntil || onlineState.preEnterUntil <= Date.now()) onlineState.preEnterUntil = Date.now() + 5000;
        if (onlineState.preEnterId) clearInterval(onlineState.preEnterId);
        onlineState.preEnterId = setInterval(() => {
          const curName = document.getElementById("onlineSearchOppName");
          const curBar = document.getElementById("onlineSearchBar");
          const curCountdown = document.getElementById("onlineFoundCountdown");
          if (!curName || !curBar) {
            stopOnlinePreEnter();
            return;
          }
          const rem = (onlineState.preEnterUntil || 0) - Date.now();
          if (rem <= 0) {
            stopOnlinePreEnter();
            try {
              closeHowTo();
            } catch {}
            startOnlineMatch(id, mode, fee, codeLen, meResolved, opponent, kind);
            return;
          }
          const sec = Math.max(1, Math.ceil(rem / 1000));
          if (curCountdown) curCountdown.textContent = `  ${sec}`;
          const pct = Math.min(100, Math.max(0, Math.floor((rem / 5000) * 100)));
          curBar.style.width = `${pct}%`;
        }, 110);
        {
          const rem0 = (onlineState.preEnterUntil || 0) - Date.now();
          const sec0 = Math.max(1, Math.ceil(rem0 / 1000));
          if (countdownEl) countdownEl.textContent = `  ${sec0}`;
        }
        if (barEl) barEl.style.width = `100%`;
      }

      function stopOnlineCoinsSync() {
        if (onlineState.coinsSyncId) clearInterval(onlineState.coinsSyncId);
        onlineState.coinsSyncId = null;
        onlineState.coinsSyncBusy = false;
      }

      async function onlineCoinsSyncOnce() {
        if (!cloud.enabled) return;
        if (onlineState.coinsSyncBusy) return;
        onlineState.coinsSyncBusy = true;
        try {
          const r = await friendsJson("/api/game-state", { method: "GET" });
          const s = r && r.ok && r.data && r.data.state && typeof r.data.state === "object" ? r.data.state : null;
          const coins = s && typeof s.coins === "number" && Number.isFinite(s.coins) ? Math.max(0, Math.floor(s.coins)) : null;
          if (typeof coins === "number") setCoinsTotal(coins, 0, true);
        } finally {
          onlineState.coinsSyncBusy = false;
        }
      }

      function startOnlineCoinsSync() {
        if (onlineState.coinsSyncId) return;
        onlineState.coinsSyncId = setInterval(() => {
          if (!onlineState.open) return;
          if (app.stage && app.stage.kind === "online" && onlineState.matchId) return;
          onlineCoinsSyncOnce();
        }, 2500);
        onlineCoinsSyncOnce();
      }

      function startOnlineMatchPolling(myEmail, fee, everyMs) {
        const ms = Math.max(180, Math.min(1500, Math.floor(everyMs || 0)));
        const effectiveMs = document.hidden ? Math.max(1000, ms) : ms;
        if (onlineState.pollMatchId && onlineState.pollMatchEvery === effectiveMs) return;
        if (onlineState.pollMatchId) clearInterval(onlineState.pollMatchId);
        onlineState.pollMatchEvery = effectiveMs;
        onlineState.pollMatchId = setInterval(async () => {
          if (!onlineState.matchId || !app.stage || app.stage.kind !== "online" || (app.session && app.session.over)) {
            stopOnlineMatchPolling();
            return;
          }
          await onlineFetchMatchStateOnce(myEmail, fee);
        }, effectiveMs);
      }

      function flashPlayerCard(card) {
        if (!card || !card.classList) return;
        card.classList.remove("flash");
        void card.offsetWidth;
        card.classList.add("flash");
        window.setTimeout(() => {
          try {
            card.classList.remove("flash");
          } catch {}
        }, 520);
      }

      function startOnlineTurnBarLoop() {
        if (onlineState.barRafId) return;
        const tick = () => {
          if (!onlineState.matchId || !app.stage || app.stage.kind !== "online" || (app.session && app.session.over)) {
            onlineState.barRafId = 0;
            return;
          }
          const endAt = typeof onlineState.turnEndAt === "number" ? onlineState.turnEndAt : 0;
          const now = Date.now();
          const left = endAt > 0 ? Math.max(0, endAt - now) : 0;
          const pct = endAt > 0 ? Math.min(100, Math.max(0, (left / ONLINE_TURN_MS) * 100)) : 0;
          if (el.onlineTurnBar) el.onlineTurnBar.style.width = `${pct}%`;
          onlineState.barRafId = requestAnimationFrame(tick);
        };
        onlineState.barRafId = requestAnimationFrame(tick);
      }

      function onlineRenderEndScreen(fee, winner, endedReason, forfeitedBy, solution) {
        if (!el.winBox || !el.winSub || !el.winTitle) return;
        const pot = Math.max(0, Math.floor(fee)) * 2;
        const myName = onlineState.meName || "";
        const myPhoto = onlineState.mePhoto || "";
        const oppName = onlineState.oppName || "";
        const oppPhoto = onlineState.oppPhoto || "";

        const winnerIsMe = winner === "me";
        const hasWinner = winner === "me" || winner === "them";
        const isDisabled = String(endedReason || "") === "disabled";
        const isForfeit = String(endedReason || "").startsWith("forfeit");

        const loserIsMe = hasWinner ? !winnerIsMe : false;
        const loserName = hasWinner ? (loserIsMe ? myName : oppName) : myName;
        const loserPhoto = hasWinner ? (loserIsMe ? myPhoto : oppPhoto) : myPhoto;
        const winnerName = hasWinner ? (winnerIsMe ? myName : oppName) : oppName;
        const winnerPhoto = hasWinner ? (winnerIsMe ? myPhoto : oppPhoto) : oppPhoto;

        el.winBox.classList.toggle("onlineWin", hasWinner && winnerIsMe && !isDisabled);
        el.winBox.classList.toggle("onlineLose", hasWinner && !winnerIsMe && !isDisabled);
        el.winTitle.textContent = isDisabled
          ? "  "
          : !hasWinner && isForfeit
            ? "  "
            : isForfeit && forfeitedBy === "them"
              ? " "
              : isForfeit && forfeitedBy === "me"
                ? ""
                : winnerIsMe
                  ? "!"
                  : "";

        const subLine =
          isDisabled
            ? "    ."
            : isForfeit
            ? forfeitedBy === "them"
              ? " "
              : forfeitedBy === "me"
                ? ""
                : ""
            : "";

        const sol = String(solution || "").trim();
        const solLine = sol
          ? `<div class="tiny" style="text-align:center">${escapeHtml(t("onlineSolutionLabel"))} <span class="maskM" dir="ltr" style="unicode-bidi:bidi-override">${escapeHtml(sol)}</span></div>`
          : ``;

        el.winSub.innerHTML = `<div class="onlineWrap">
          ${subLine ? `<div class="tiny">${escapeHtml(subLine)}</div>` : ``}
          ${solLine}
          <div class="onlineEndRow">
            <div class="onlineEndCard">
              <div id="onlineEndLoserAvatar" class="onlineAvatar">L</div>
              <div class="onlineEndMeta">
                <div class="onlineEndName">${escapeHtml(loserName)}</div>
                <div class="onlineEndTag"><span id="onlineLoserAmt" class="coinChip">${fee}</span></div>
              </div>
            </div>
            <div class="onlineEndBridge">
              <div class="onlineEndTag"> <span class="coinChip">${fee}</span> + <span class="coinChip">${fee}</span></div>
              <div class="onlineEndTag"> <span id="onlinePotAmt" class="coinChip">${pot}</span></div>
            </div>
            <div class="onlineEndCard">
              <div id="onlineEndWinnerAvatar" class="onlineAvatar">W</div>
              <div class="onlineEndMeta">
                <div class="onlineEndName">${escapeHtml(winnerName)}</div>
                <div class="onlineEndTag"><span id="onlineWinnerAmt" class="coinChip">${fee}</span></div>
              </div>
            </div>
          </div>
        </div>`;

        const loserAv = document.getElementById("onlineEndLoserAvatar");
        const winnerAv = document.getElementById("onlineEndWinnerAvatar");
        if (loserAv) setAvatarSquare(loserAv, loserPhoto, String(loserName || "L").slice(0, 1).toUpperCase());
        if (winnerAv) setAvatarSquare(winnerAv, winnerPhoto, String(winnerName || "W").slice(0, 1).toUpperCase());

        requestAnimationFrame(() => onlineAnimatePayout(fee, winner, endedReason));
      }

      function formatCoin(n) {
        return `${Math.max(0, Math.floor(n))}`;
      }

      function animateCoinCount(elm, from, to, ms) {
        if (!elm) return;
        const start = performance.now();
        const a = Math.max(0, Math.floor(from));
        const b = Math.max(0, Math.floor(to));
        const step = (t) => {
          const p = Math.min(1, Math.max(0, (t - start) / Math.max(1, ms)));
          const eased = 1 - Math.pow(1 - p, 3);
          const v = Math.round(a + (b - a) * eased);
          elm.textContent = formatCoin(v);
          if (p < 1) requestAnimationFrame(step);
        };
        requestAnimationFrame(step);
      }

      function onlineAnimatePayout(fee, winner, endedReason) {
        if (!el.winBox || !el.winBox.classList.contains("show")) return;
        if (String(endedReason || "") === "disabled") return;
        if (winner !== "me" && winner !== "them") return;
        const reduce = document.documentElement && document.documentElement.getAttribute("data-reduce-motion") === "1";
        const pot = Math.max(0, Math.floor(fee)) * 2;
        const key = `${onlineState.matchId}|${winner === "me" ? "W" : "L"}|${fee}`;
        if (onlineState.endAnimKey === key) return;
        onlineState.endAnimKey = key;

        const loserAmt = document.getElementById("onlineLoserAmt");
        const winnerAmt = document.getElementById("onlineWinnerAmt");
        const potAmt = document.getElementById("onlinePotAmt");
        if (!loserAmt || !winnerAmt || !potAmt) return;

        loserAmt.textContent = formatCoin(fee);
        winnerAmt.textContent = formatCoin(fee);
        potAmt.textContent = formatCoin(pot);
        if (reduce) {
          loserAmt.textContent = formatCoin(0);
          winnerAmt.textContent = formatCoin(pot);
          return;
        }

        const layer = document.createElement("div");
        layer.className = "coinFxLayer";
        document.body.appendChild(layer);

        const a = loserAmt.getBoundingClientRect();
        const b = winnerAmt.getBoundingClientRect();
        const sx = a.left + a.width / 2;
        const sy = a.top + a.height / 2;
        const ex = b.left + b.width / 2;
        const ey = b.top + b.height / 2;
        const dx = ex - sx;
        const dy = ey - sy;

        const coins = Math.min(14, Math.max(8, Math.floor(fee / 4)));
        const dur = 900;
        for (let i = 0; i < coins; i++) {
          const c = document.createElement("div");
          c.className = "flyCoin";
          c.textContent = "";
          c.style.left = `${sx - 9}px`;
          c.style.top = `${sy - 9}px`;
          layer.appendChild(c);

          const jitterX = (Math.random() - 0.5) * 24;
          const jitterY = (Math.random() - 0.5) * 24;
          const arc = -80 - Math.random() * 60;
          const delay = i * 24;

          c.animate(
            [
              { transform: "translate(0px,0px) scale(0.9)", opacity: 0.0 },
              { transform: `translate(${jitterX}px,${jitterY}px) scale(1.0)`, opacity: 1.0, offset: 0.15 },
              { transform: `translate(${dx * 0.55 + jitterX}px,${dy * 0.55 + arc}px) scale(1.15)`, opacity: 1.0, offset: 0.6 },
              { transform: `translate(${dx + jitterX}px,${dy + jitterY}px) scale(0.92)`, opacity: 0.0 },
            ],
            { duration: dur, delay, easing: "cubic-bezier(0.22, 1, 0.36, 1)", fill: "forwards" }
          );
        }

        animateCoinCount(loserAmt, fee, 0, dur + 200);
        animateCoinCount(winnerAmt, fee, pot, dur + 220);

        window.setTimeout(() => {
          try {
            layer.remove();
          } catch {}
        }, dur + coins * 24 + 200);
      }

      function onlineApplyMatchState(m, meEmail, fee) {
        if (!m) return;
        const meCard = el.onlineMeAvatar && el.onlineMeAvatar.closest ? el.onlineMeAvatar.closest(".onlinePlayerCard") : null;
        const oppCard = el.onlineOppAvatar && el.onlineOppAvatar.closest ? el.onlineOppAvatar.closest(".onlinePlayerCard") : null;
        if (m.opponent && typeof m.opponent === "object") {
          const prevKey = onlineState.oppFlashKey;
          const nextKey = String(m.opponent.id || "");
          onlineState.oppName = m.opponent.firstName || onlineState.oppName || "";
          onlineState.oppPhoto = m.opponent.photo || onlineState.oppPhoto || "";
          if (el.onlineOppName) el.onlineOppName.textContent = onlineState.oppName;
          if (el.onlineOppAvatar) setAvatarSquare(el.onlineOppAvatar, onlineState.oppPhoto, String((onlineState.oppName || "O")).slice(0, 1).toUpperCase());
          const oppLevel = typeof m.opponent.level === "number" ? m.opponent.level : null;
          if (el.onlineOppSub) el.onlineOppSub.textContent = oppLevel ? `LV ${oppLevel}  ${fee}` : `${fee}`;
          if (nextKey && nextKey !== prevKey) {
            onlineState.oppFlashKey = nextKey;
            if (oppCard) flashPlayerCard(oppCard);
          }
        }

        if (typeof m.myCoins === "number") {
          const pot = Math.max(0, Math.floor(fee)) * 2;
          const winner = m.winner === "me" || m.winner === "them" ? m.winner : null;
          const endedReason = typeof m.endedReason === "string" ? m.endedReason : "";
          const earnedDelta = winner === "me" && endedReason !== "disabled" ? pot : 0;
          setCoinsTotal(m.myCoins, earnedDelta, true);
        }

        let turn = m.turn;
        const timeLeftMs = typeof m.timeLeftMs === "number" ? Math.max(0, Math.floor(m.timeLeftMs)) : 0;
        const serverNowMs = typeof m.serverNowMs === "number" && Number.isFinite(m.serverNowMs) ? Math.floor(m.serverNowMs) : 0;
        const turnStartedAtMs = typeof m.turnStartedAtMs === "number" && Number.isFinite(m.turnStartedAtMs) ? Math.floor(m.turnStartedAtMs) : 0;
        const syncedStartAt = turnStartedAtMs > 0 ? turnStartedAtMs - (onlineState.serverOffsetMs || 0) : 0;
        const notStarted = turn !== "ended" && serverNowMs > 0 && turnStartedAtMs > serverNowMs + 120 && syncedStartAt > Date.now() + 60;
        if (notStarted && (turn === "me" || turn === "them")) turn = "setup";
        onlineState.turnEndAt = turn === "ended" || notStarted ? 0 : Date.now() + timeLeftMs;
        const pct = onlineState.turnEndAt ? Math.min(100, Math.max(0, Math.floor((timeLeftMs / ONLINE_TURN_MS) * 100))) : 0;
        if (el.onlineTurnBar) el.onlineTurnBar.style.width = `${pct}%`;
        if (el.onlineTurnText) {
          if (notStarted) {
            const rem = Math.max(0, syncedStartAt - Date.now());
            const sec = Math.max(1, Math.ceil(rem / 1000));
            el.onlineTurnText.textContent = `  ${sec}`;
          } else {
            const setupLabel = m.kind === "props" && m.phase === "cards" ? t("onlineTurnCards") : t("onlineTurnSetup");
            el.onlineTurnText.textContent = turn === "me" ? t("onlineTurnMe") : turn === "them" ? t("onlineTurnThem") : turn === "setup" ? setupLabel : t("onlineTurnEnded");
          }
        }
        if (meCard) meCard.classList.toggle("turnActive", turn === "me");
        if (oppCard) oppCard.classList.toggle("turnActive", turn === "them");
        if (turn === "me" || turn === "them") startOnlineTurnBarLoop();
        if (turn === "setup") startOnlineMatchPolling(meEmail, fee, 220);
        else startOnlineMatchPolling(meEmail, fee, 400);

        const myLevel = typeof m.myLevel === "number" ? m.myLevel : null;
        if (el.onlineMeSub) el.onlineMeSub.textContent = myLevel ? `LV ${myLevel}  ${fee}` : `${fee}`;

        const locked = turn !== "me";
        if (el.checkBtn) el.checkBtn.disabled = locked || onlineState.busy;
        for (const input of app.inputs) {
          input.disabled = locked;
          input.placeholder = locked ? "M" : "";
          if (locked) input.value = "";
        }

        if (Array.isArray(m.myHistory)) {
          const my = m.myHistory
            .filter((x) => x && typeof x === "object" && typeof x.guess === "string" && Array.isArray(x.result))
            .map((x) => ({ guess: x.guess, result: x.result }));
          app.history = my;
          app.attempts = my.length;
          if (el.attemptsNum) el.attemptsNum.textContent = String(app.attempts);
          renderHistory();
        }

        if (m.lastMasked && m.lastMasked.by && m.lastMasked.at && m.lastMasked.by !== meEmail) {
          if (m.lastMasked.at > onlineState.lastMaskedAt) {
            onlineState.lastMaskedAt = m.lastMasked.at;
            if (el.onlineOppLast) el.onlineOppLast.innerHTML = ` : <span class="maskM">${escapeHtml(m.lastMasked.value || "")}</span>`;
          }
        }

        if (m.kind === "custom" && m.phase === "setup") {
          const myReady = !!m.myReady;
          const oppReady = !!m.oppReady;
          const now = Date.now();
          let effectiveMyReady = myReady;
          if (onlineState.setupPendingMatchId === onlineState.matchId && now < (onlineState.setupPendingUntil || 0)) {
            if (typeof onlineState.setupPendingValue === "boolean") {
              if (myReady === onlineState.setupPendingValue) {
                onlineState.setupPendingUntil = 0;
                onlineState.setupPendingValue = null;
                onlineState.setupPendingMatchId = "";
              } else {
                effectiveMyReady = onlineState.setupPendingValue;
              }
            }
          }
          onlineState.setupMyReady = effectiveMyReady;
          onlineState.setupOppReady = oppReady;
          openOnlineSetupModal(m.codeLen, effectiveMyReady, oppReady);
        } else {
          onlineState.setupMyReady = false;
          onlineState.setupOppReady = false;
          onlineState.setupPendingUntil = 0;
          onlineState.setupPendingValue = null;
          onlineState.setupPendingMatchId = "";
          closeOnlineSetupModal();
          if (onlineState.selectKind === "custom" && !onlineState.customFocused) {
            onlineState.customFocused = true;
            requestAnimationFrame(() => {
              if (app.inputs && app.inputs[0]) app.inputs[0].focus();
            });
          }
        }

        if (m.kind === "props" && m.phase === "cards") {
          openOnlinePropsModal(Array.isArray(m.deck) ? m.deck : [], typeof m.myPick === "number" ? m.myPick : null, typeof m.oppPick === "number" ? m.oppPick : null);
        } else {
          closeOnlinePropsModal();
        }

        if (el.onlinePropsHud) {
          const myCard = typeof m.myCard === "string" ? String(m.myCard || "") : "";
          const myUsed = !!m.myUsed;
          onlineState.propsMyCard = myCard;
          onlineState.propsMyUsed = myUsed;
          if (m.kind === "props" && myCard) {
            el.onlinePropsHud.style.display = "";
            if (el.onlinePropsCard) el.onlinePropsCard.textContent = propsCardLabel(myCard);
            if (el.onlinePropsUseBtn) {
              el.onlinePropsUseBtn.style.display = myUsed ? "none" : "";
              el.onlinePropsUseBtn.disabled = myUsed || onlineState.busy || turn !== "me" || m.phase !== "play";
            }
          } else {
            el.onlinePropsHud.style.display = "none";
          }
        }

        if (turn === "ended") {
          stopOnlineMatchPolling();
          stopOnlineHiddenForfeitTimer();
          app.session.over = true;
          closeOnlineWithdrawModal();
          if (el.onlineSetupForfeitBtn) el.onlineSetupForfeitBtn.style.display = "none";
          if (el.backToMapBtn) el.backToMapBtn.disabled = true;
          if (!onlineState.endCoinsSyncDone) {
            onlineState.endCoinsSyncDone = true;
            setTimeout(() => {
              try {
                onlineFetchMatchStateOnce(onlineState.meEmail || "", onlineState.fee || 0);
              } catch {}
            }, 260);
          }
          const winner = m.winner === "me" || m.winner === "them" ? m.winner : null;
          const sol = typeof m.solution === "string" ? String(m.solution || "").trim() : "";
          if (sol && app.inputs && Array.isArray(app.inputs) && sol.length === app.inputs.length) {
            for (let i = 0; i < app.inputs.length; i++) {
              const input = app.inputs[i];
              if (!input) continue;
              input.value = sol[i] || "";
              input.disabled = true;
              const slot = input.parentElement;
              if (slot) {
                slot.classList.remove("bad", "warn");
                slot.classList.add("ok");
              }
            }
            if (el.checkBtn) el.checkBtn.disabled = true;
          }
          onlineRenderEndScreen(fee, winner, m.endedReason, m.forfeitedBy, typeof m.solution === "string" ? m.solution : "");
          if (el.nextBtn) {
            el.nextBtn.disabled = false;
            el.nextBtn.textContent = t("onlineBackBtn");
          }
          if (el.mapBtn2) el.mapBtn2.style.display = "none";
          if (el.shareBtn) el.shareBtn.style.display = "none";
          if (el.winBox) {
            el.winBox.classList.add("show");
            if (el.winBox.classList.contains("onlineWin")) {
              playWinSound();
              vibrate([0, 14, 24, 14]);
              triggerWinFx();
            } else if (el.winBox.classList.contains("onlineLose")) {
              playErrorSound();
              vibrate([0, 30, 40]);
            }
          }
          stopOnlineAutoReturn();
        }
      }

      async function onlineFetchMatchStateOnce(meEmail, fee) {
        const id = onlineState.matchId;
        if (!id) return;
        if (onlineState.stateFetchBusy) return;
        onlineState.stateFetchBusy = true;
        try {
          const t0 = Date.now();
          const r = await friendsJson(`/api/online/match/state?id=${encodeURIComponent(id)}`, { method: "GET" });
          const t1 = Date.now();
          if (!r.ok || !r.data || !r.data.match) return;
          if (onlineState.matchId !== id) return;
          if (!app.stage || app.stage.kind !== "online" || app.stage.matchId !== id) return;
          if (typeof r.data.match.serverNowMs === "number" && Number.isFinite(r.data.match.serverNowMs)) {
            const mid = Math.floor((t0 + t1) / 2);
            onlineState.serverOffsetMs = Math.floor(r.data.match.serverNowMs) - mid;
          }
          onlineApplyMatchState(r.data.match, meEmail, fee);
        } finally {
          onlineState.stateFetchBusy = false;
        }
      }

      function renderOnlineSelect() {
        if (!el.onlineContent) return;
        onlineState.open = true;
        startOnlineCoinsSync();
        stopOnlineAutoReturn();
        stopOnlinePreEnter();
        onlineState.queueId = "";
        onlineState.matchId = "";
        onlineState.roomCode = "";
        onlineState.busy = false;
        stopOnlineQueuePolling();
        stopOnlineRoomPolling();
        stopOnlineMatchPolling();
        stopOnlineHiddenForfeitTimer();
        closeOnlineSetupModal();
        closeOnlinePropsModal();
        closeOnlineWithdrawModal();

        if (!onlineFeature.enabled) {
          el.onlineContent.innerHTML = `<div class="onlineWrap">
            <div class="tiny">    .</div>
          </div>`;
          return;
        }

        const kind = onlineState.selectKind === "custom" ? "custom" : onlineState.selectKind === "props" ? "props" : "normal";
        const tab = (k, label) => `<button class="onlineTab ${k === kind ? "on" : ""}" type="button" data-online-kind="${escapeHtml(k)}">${escapeHtml(label)}</button>`;
        const tabsHtml = `<div class="onlineTabs">
          ${tab("normal", t("onlineModeNormal"))}
          ${tab("custom", t("onlineModeCustom"))}
          ${tab("props", t("onlineModeProps"))}
        </div>`;

        const card = (mode) => {
          const cfg = onlineCfg(mode);
          const title = mode === "easy" ? t("onlineDiffEasy") : mode === "medium" ? t("onlineDiffMedium") : t("onlineDiffHard");
          const sub = mode === "easy" ? t("onlineDiffEasySub") : mode === "medium" ? t("onlineDiffMediumSub") : t("onlineDiffHardSub");
          return `<button class="onlinePack" type="button" data-online-mode="${escapeHtml(mode)}" data-online-kind="${escapeHtml(kind)}" aria-label="${escapeHtml(title)}">
            <div class="t">${escapeHtml(title)}</div>
            <div class="sub">${escapeHtml(sub)}</div>
            <div class="price"><span class="coinChip">${cfg.fee}</span></div>
            <div class="cta">${escapeHtml(t("onlineCtaTapToStart"))}</div>
          </button>`;
        };

        el.onlineContent.innerHTML = `<div class="onlineWrap">
          ${tabsHtml}
          <div class="tiny">${escapeHtml(kind === "custom" ? t("onlineSelectHintCustom") : kind === "props" ? t("onlineSelectHintProps") : t("onlineSelectHintNormal"))}</div>
          <div class="onlinePacks">
            ${card("easy")}
            ${card("medium")}
            ${card("hard")}
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; margin-top:12px">
            <button id="roomCreateBtn" class="btn" type="button"> </button>
            <button id="roomJoinBtn" class="btn" type="button"> </button>
          </div>
        </div>`;

        const roomCreateBtn = document.getElementById("roomCreateBtn");
        if (roomCreateBtn) roomCreateBtn.addEventListener("click", () => renderRoomCreateSelect(kind));
        const roomJoinBtn = document.getElementById("roomJoinBtn");
        if (roomJoinBtn) roomJoinBtn.addEventListener("click", () => renderRoomJoin(kind));
      }

      function onlineSetSearchAvatar(elm, photo, letter) {
        if (!elm) return;
        setAvatarSquare(elm, photo, letter || "?");
      }

      function renderOnlineSearching(mode, me, kind) {
        if (!el.onlineContent) return;
        const cfg = onlineCfg(mode);
        onlineState.mode = mode;
        onlineState.fee = cfg.fee;
        onlineState.codeLen = cfg.codeLen;
        onlineState.searchingStartedAt = Date.now();
        startOnlineCoinsSync();
        const diff = mode === "easy" ? t("onlineDiffEasy") : mode === "medium" ? t("onlineDiffMedium") : t("onlineDiffHard");
        const kindLabel = kind === "custom" ? t("onlineModeCustom") : kind === "props" ? t("onlineModeProps") : t("onlineModeNormal");

        el.onlineContent.innerHTML = `<div class="onlineWrap">
          <div class="tiny">${escapeHtml(kindLabel)}  ${escapeHtml(diff)}  ${escapeHtml(String(cfg.codeLen))} </div>
          <div id="onlineFoundCountdown" class="onlineFoundCountdown" style="display:none"></div>
          <div class="onlineMatchRow">
            <div class="onlinePlayerCard">
              <div id="onlineSearchMeAvatar" class="onlineAvatar">P</div>
              <div class="onlineMeta">
                <div class="onlineName">${escapeHtml((me && me.firstName) || "")}</div>
                <div class="onlineTiny">${escapeHtml(cfg.fee)}</div>
              </div>
            </div>
            <div class="onlineVs">VS</div>
            <div class="onlinePlayerCard">
              <div id="onlineSearchOppAvatar" class="onlineAvatar">?</div>
              <div class="onlineMeta">
                <div id="onlineSearchOppName" class="onlineName">${escapeHtml(t("onlineSearchingForOpp"))}<span id="onlineSearchDots"></span></div>
              </div>
            </div>
          </div>
          <div class="onlineBar"><span id="onlineSearchBar"></span></div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end">
            <button id="onlineCancelBtn" class="btn" type="button"></button>
          </div>
        </div>`;

        const meAv = document.getElementById("onlineSearchMeAvatar");
        const oppAv = document.getElementById("onlineSearchOppAvatar");
        const dots = document.getElementById("onlineSearchDots");
        const bar = document.getElementById("onlineSearchBar");

        onlineSetSearchAvatar(meAv, me && me.photo ? me.photo : "", String((me && me.firstName) || "P").slice(0, 1).toUpperCase());
        onlineSetSearchAvatar(oppAv, "", "?");

        if (onlineState.spinId) clearInterval(onlineState.spinId);
        onlineState.spinId = setInterval(() => {
          const letter = String.fromCharCode(65 + Math.floor(Math.random() * 26));
          onlineSetSearchAvatar(oppAv, "", letter);
          const elapsed = Date.now() - onlineState.searchingStartedAt;
          const d = Math.floor(elapsed / 260) % 4;
          if (dots) dots.textContent = ".".repeat(d);
          const p = Math.min(100, Math.max(4, Math.floor((elapsed / 30_000) * 100)));
          if (bar) bar.style.width = `${p}%`;
        }, 320);

        const cancelBtn = document.getElementById("onlineCancelBtn");
        if (cancelBtn) {
          cancelBtn.addEventListener("click", async () => {
            await onlineRunAction(
              "queue_cancel",
              async () => {
                cancelBtn.disabled = true;
                if (!onlineState.queueId) {
                  renderOnlineSelect();
                  return;
                }
                stopOnlineQueuePolling();
                const r = await friendsJson("/api/online/queue/cancel", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ id: onlineState.queueId }),
                });
                if (r.ok && r.data && r.data.refunded) {
                  if (typeof r.data.coins === "number") setCoinsTotal(r.data.coins, 0, true);
                }
                renderOnlineSelect();
              },
              450
            );
          });
        }
      }

      function normalizeRoomCode(s) {
        return String(s || "")
          .trim()
          .toUpperCase()
          .replace(/[^A-Z0-9]/g, "")
          .slice(0, 10);
      }

      function renderRoomCreateSelect(kind) {
        if (!el.onlineContent) return;
        if (!cloud.enabled) {
          enqueueToast({ title: t("onlineBtn"), body: "  .", autoMs: 2400 });
          return;
        }
        if (!onlineFeature.enabled) {
          enqueueToast({ title: t("onlineBtn"), body: "  .", autoMs: 2400 });
          return;
        }

        stopOnlineQueuePolling();
        stopOnlineRoomPolling();
        onlineState.roomCode = "";
        startOnlineCoinsSync();

        const card = (mode, title, sub) => {
          const cfg = onlineCfg(mode);
          return `<button class="onlinePack" type="button" data-room-create-mode="${escapeHtml(mode)}" aria-label="${escapeHtml(title)}">
            <div class="t">${escapeHtml(title)}</div>
            <div class="sub">${escapeHtml(sub)}</div>
            <div class="price"><span class="coinChip">${cfg.fee}</span></div>
            <div class="cta"></div>
          </button>`;
        };

        el.onlineContent.innerHTML = `<div class="onlineWrap">
          <div class="tiny">  </div>
          <div class="onlinePacks">
            ${card("easy", "", "3 ")}
            ${card("medium", "", "4 ")}
            ${card("hard", "", "5 ")}
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; margin-top:12px">
            <button id="roomBackBtn" class="btn ghost" type="button"></button>
          </div>
        </div>`;

        const backBtn = document.getElementById("roomBackBtn");
        if (backBtn) backBtn.addEventListener("click", () => renderOnlineSelect());
        const packs = el.onlineContent.querySelectorAll('button[data-room-create-mode]');
        for (const p of packs) {
          p.addEventListener("click", () => {
            const mode = String(p.dataset.roomCreateMode || "").trim();
            if (!mode) return;
            onlineCreateRoom(mode, kind);
          });
        }
      }

      async function onlineCreateRoom(mode, kind) {
        await onlineRunAction(
          "create_room",
          async () => {
            fetchOnlineEnabledOnce(false).catch(() => {});
            if (onlineFeature.fetched && !onlineFeature.enabled) {
              enqueueToast({ title: t("onlineBtn"), body: "  .", autoMs: 2400 });
              renderOnlineSelect();
              return;
            }

            const r = await friendsJson("/api/online/room/create", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ mode, kind }),
            });
            if (!r.ok || !r.data) {
              const code = r.data && typeof r.data.error === "string" ? r.data.error : "server_error";
              if (code === "insufficient_coins") enqueueToast({ title: t("onlineBtn"), body: "  .", autoMs: 2600 });
              else if (code === "online_disabled") {
                onlineFeature.enabled = false;
                updateOnlineBtnUI();
                enqueueToast({ title: t("onlineBtn"), body: "  .", autoMs: 2600 });
              } else enqueueToast({ title: t("onlineBtn"), body: "  .", autoMs: 2600 });
              renderOnlineSelect();
              return;
            }

            const roomCode = normalizeRoomCode(r.data.code);
            const modeResolved = r.data && typeof r.data.mode === "string" ? String(r.data.mode).trim() : mode;
            const fee = typeof r.data.fee === "number" ? r.data.fee : onlineCfg(modeResolved).fee;
            const codeLen = typeof r.data.codeLen === "number" ? r.data.codeLen : onlineCfg(modeResolved).codeLen;
            const kindResolved =
              r.data && typeof r.data.kind === "string"
                ? String(r.data.kind).trim() === "custom"
                  ? "custom"
                  : String(r.data.kind).trim() === "props"
                    ? "props"
                    : "normal"
                : kind;
            if (typeof r.data.coins === "number") setCoinsTotal(r.data.coins, 0, true);
            if (!roomCode) {
              renderOnlineSelect();
              return;
            }
            onlineState.roomCode = roomCode;
            renderRoomWaiting(roomCode, modeResolved, fee, codeLen, kindResolved);
            startRoomPolling(roomCode);
          },
          450
        );
      }

      function renderRoomWaiting(roomCode, mode, fee, codeLen, kind) {
        if (!el.onlineContent) return;
        const diff = mode === "easy" ? t("onlineDiffEasy") : mode === "medium" ? t("onlineDiffMedium") : t("onlineDiffHard");
        const kindLabel = kind === "custom" ? t("onlineModeCustom") : kind === "props" ? t("onlineModeProps") : t("onlineModeNormal");
        el.onlineContent.innerHTML = `<div class="onlineWrap">
          <div class="tiny">  (${escapeHtml(kindLabel)}  ${escapeHtml(diff)}  ${escapeHtml(String(codeLen))}   <span class="coinChip">${fee}</span>)</div>
          <div class="onlineRoomBox">
            <div class="onlineRoomLabel"></div>
            <div class="onlineCode">${escapeHtml(roomCode)}</div>
            <div class="onlineRoomHint">     .</div>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; margin-top:12px">
            <button id="roomCancelBtn" class="btn" type="button"> </button>
            <button id="roomCopyBtn" class="btn primary" type="button"> </button>
          </div>
        </div>`;

        const cancelBtn = document.getElementById("roomCancelBtn");
        const copyBtn = document.getElementById("roomCopyBtn");
        if (copyBtn) {
          copyBtn.addEventListener("click", async () => {
            try {
              await navigator.clipboard.writeText(String(roomCode));
              enqueueToast({ title: "", body: "  .", autoMs: 1600 });
            } catch {}
          });
        }
        if (cancelBtn) {
          cancelBtn.addEventListener("click", async () => {
            await cancelRoom(roomCode);
          });
        }
      }

      async function cancelRoom(code) {
        await onlineRunAction(
          "cancel_room",
          async () => {
            const cancelBtn = document.getElementById("roomCancelBtn");
            if (cancelBtn) cancelBtn.disabled = true;
            stopOnlineRoomPolling();
            onlineState.roomCode = "";
            const r = await friendsJson("/api/online/room/cancel", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ code }),
            });
            if (r.ok && r.data && r.data.refunded && typeof r.data.coins === "number") setCoinsTotal(r.data.coins, 0, true);
            renderOnlineSelect();
          },
          450
        );
      }

      function startRoomPolling(code) {
        stopOnlineRoomPolling();
        const tick = async () => {
          if (onlineState.pollRoomBusy) return;
          onlineState.pollRoomBusy = true;
          try {
            const s = await friendsJson(`/api/online/room/status?code=${encodeURIComponent(code)}`, { method: "GET" });
            if (!s.ok || !s.data) return;
            if (s.data.status === "matched" && s.data.matchId) {
              stopOnlineRoomPolling();
              const me = await ensureMeLoaded();
              await onlinePreEnterMatch(s.data.matchId, s.data.mode, s.data.fee, s.data.codeLen, me, null, s.data.kind);
              return;
            }
            if (s.data.status === "cancelled") {
              stopOnlineRoomPolling();
              if (s.data.refunded && typeof s.data.coins === "number") setCoinsTotal(s.data.coins, 0, true);
              enqueueToast({ title: t("onlineBtn"), body: "  .", autoMs: 2200 });
              renderOnlineSelect();
            }
          } catch {
          } finally {
            onlineState.pollRoomBusy = false;
          }
        };
        tick();
        onlineState.pollRoomId = setInterval(tick, document.hidden ? 1000 : 300);
      }

      function renderRoomJoin(kind) {
        if (!el.onlineContent) return;
        if (!cloud.enabled) {
          enqueueToast({ title: t("onlineBtn"), body: "  .", autoMs: 2400 });
          return;
        }
        if (!onlineFeature.enabled) {
          enqueueToast({ title: t("onlineBtn"), body: "  .", autoMs: 2400 });
          return;
        }

        stopOnlineQueuePolling();
        stopOnlineRoomPolling();
        onlineState.roomCode = "";
        startOnlineCoinsSync();

        el.onlineContent.innerHTML = `<div class="onlineWrap">
          <div class="tiny">  </div>
          <div class="onlineRoomBox">
            <div class="onlineRoomLabel"> </div>
            <input id="roomCodeInput" class="roomInput" inputmode="text" autocomplete="off" placeholder="ABCD12" />
            <div class="onlineRoomHint">    .</div>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; margin-top:12px">
            <button id="roomBackBtn2" class="btn ghost" type="button"></button>
            <button id="roomJoinConfirmBtn" class="btn primary" type="button"></button>
          </div>
        </div>`;

        const inp = document.getElementById("roomCodeInput");
        if (inp) {
          inp.addEventListener("input", () => {
            inp.value = normalizeRoomCode(inp.value);
          });
          setTimeout(() => {
            try {
              inp.focus();
            } catch {}
          }, 50);
          inp.addEventListener("keydown", (e) => {
            if (e && e.key === "Enter") {
              e.preventDefault();
              joinRoomFromInput(kind);
            }
          });
        }

        const backBtn = document.getElementById("roomBackBtn2");
        if (backBtn) backBtn.addEventListener("click", () => renderOnlineSelect());
        const joinBtn = document.getElementById("roomJoinConfirmBtn");
        if (joinBtn) joinBtn.addEventListener("click", () => joinRoomFromInput(kind));
      }

      async function joinRoomFromInput(kind) {
        if (onlineState.busy) return;
        onlineState.busy = true;
        const joinBtn = document.getElementById("roomJoinConfirmBtn");
        if (joinBtn) joinBtn.disabled = true;
        const inp = document.getElementById("roomCodeInput");
        const code = normalizeRoomCode(inp && inp.value ? inp.value : "");
        try {
          if (!code) {
            enqueueToast({ title: t("onlineBtn"), body: "  .", autoMs: 2000 });
            return;
          }
          fetchOnlineEnabledOnce(false).catch(() => {});
          if (onlineFeature.fetched && !onlineFeature.enabled) {
            enqueueToast({ title: t("onlineBtn"), body: "  .", autoMs: 2400 });
            renderOnlineSelect();
            return;
          }
          const r = await friendsJson("/api/online/room/join", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ code, kind }),
          });
          if (!r.ok || !r.data) {
            const msg =
              r.data && r.data.error === "room_not_found"
                ? "    ."
                : r.data && r.data.error === "room_full"
                  ? " ."
                  : r.data && r.data.error === "cannot_join_own"
                    ? "   ."
                    : r.data && r.data.error === "room_kind_mismatch"
                      ? "  ."
                    : r.data && r.data.error === "insufficient_coins"
                      ? "  ."
                      : r.data && r.data.error === "online_disabled"
                        ? "  ."
                        : " .";
            enqueueToast({ title: t("onlineBtn"), body: msg, autoMs: 2600 });
            return;
          }
          const me = await ensureMeLoaded();
          if (typeof r.data.coins === "number") setCoinsTotal(r.data.coins, 0, true);
          stopOnlineQueuePolling();
          stopOnlineRoomPolling();
          await onlinePreEnterMatch(r.data.matchId, r.data.mode, r.data.fee, r.data.codeLen, me, r.data.opponent || null, r.data.kind || kind);
        } finally {
          onlineState.busy = false;
          if (joinBtn) joinBtn.disabled = false;
        }
      }

      async function onlineJoin(mode, kind) {
        await onlineRunAction(
          "queue_join",
          async () => {
            if (!cloud.enabled) {
              enqueueToast({ title: t("onlineBtn"), body: "  .", autoMs: 2400 });
              return;
            }
            fetchOnlineEnabledOnce(false).catch(() => {});
            if (onlineFeature.fetched && !onlineFeature.enabled) {
              enqueueToast({ title: t("onlineBtn"), body: "  .", autoMs: 2400 });
              renderOnlineSelect();
              return;
            }
            if (onlineState.busy) return;
            onlineState.busy = true;
            try {
              const mePromise = ensureMeLoaded();
              onlineState.selectKind = kind === "custom" ? "custom" : kind === "props" ? "props" : "normal";
              renderOnlineSearching(mode, friendsState.me || null, onlineState.selectKind);
              const r = await friendsJson("/api/online/queue/join", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ mode, kind: onlineState.selectKind }),
              });
              const me = await mePromise;
              if (!r.ok) {
                const code = r.data && typeof r.data.error === "string" ? r.data.error : "server_error";
                if (code === "online_disabled") {
                  onlineFeature.enabled = false;
                  updateOnlineBtnUI();
                  enqueueToast({ title: t("onlineBtn"), body: "  .", autoMs: 2600 });
                  renderOnlineSelect();
                  return;
                }
                if (code === "insufficient_coins") enqueueToast({ title: t("onlineBtn"), body: "  .", autoMs: 2600 });
                else if (r.status === 0) enqueueToast({ title: t("onlineBtn"), body: " .   .", autoMs: 2600 });
                else enqueueToast({ title: t("onlineBtn"), body: "  .", autoMs: 2600 });
                renderOnlineSelect();
                return;
              }
              if (!r.data) return;
              if (typeof r.data.coins === "number") setCoinsTotal(r.data.coins, 0, true);
              if (r.data.status === "matched" && r.data.matchId) {
                stopOnlineQueuePolling();
                await onlinePreEnterMatch(
                  r.data.matchId,
                  r.data.mode,
                  r.data.fee,
                  r.data.codeLen,
                  me,
                  r.data.opponent || null,
                  r.data.kind || onlineState.selectKind
                );
                return;
              }
              if (r.data.status === "waiting" && r.data.queueId) {
                onlineState.queueId = r.data.queueId;
                stopOnlineQueuePolling();
                const tick = async () => {
                  if (onlineState.pollQueueBusy) return;
                  onlineState.pollQueueBusy = true;
                  try {
                    const s = await friendsJson(`/api/online/queue/status?id=${encodeURIComponent(onlineState.queueId)}`, { method: "GET" });
                    if (!s.ok || !s.data) return;
                    if (s.data.status === "matched" && s.data.matchId) {
                      stopOnlineQueuePolling();
                      await onlinePreEnterMatch(s.data.matchId, s.data.mode, s.data.fee, s.data.codeLen, me, null, s.data.kind || onlineState.selectKind);
                    }
                    if (s.data.status === "cancelled") {
                      stopOnlineQueuePolling();
                      if (s.data.refunded && typeof s.data.coins === "number") setCoinsTotal(s.data.coins, 0, true);
                      renderOnlineSelect();
                    }
                  } catch {
                  } finally {
                    onlineState.pollQueueBusy = false;
                  }
                };
                tick();
                onlineState.pollQueueId = setInterval(tick, document.hidden ? 1000 : 300);
              }
            } finally {
              onlineState.busy = false;
            }
          },
          450
        );
      }

      async function startOnlineMatch(matchId, mode, fee, codeLen, me, opponentFromJoin, kind) {
        onlineState.matchId = matchId;
        onlineState.mode = mode;
        onlineState.fee = fee;
        onlineState.codeLen = codeLen;
        onlineState.lastMaskedAt = 0;
        onlineState.forfeitSent = false;
        onlineState.stateFetchBusy = false;
        onlineState.setupMyReady = false;
        onlineState.setupOppReady = false;
        onlineState.setupPendingUntil = 0;
        onlineState.setupPendingValue = null;
        onlineState.setupPendingMatchId = "";
        onlineState.endCoinsSyncDone = false;
        stopOnlinePreEnter();
        stopOnlineHiddenForfeitTimer();
        onlineState.selectKind = kind === "custom" ? "custom" : kind === "props" ? "props" : "normal";
        onlineState.customFocused = false;
        onlineState.oppFlashKey = "";
        onlineState.endAnimKey = "";
        onlineState.propsPendingPickUntil = 0;
        onlineState.propsPendingPickIndex = -1;
        onlineState.propsMyCard = "";
        onlineState.propsMyUsed = false;
        closeOnlinePropsModal();
        if (el.onlinePropsHud) el.onlinePropsHud.style.display = "none";
        if (el.onlineSetupForfeitBtn) el.onlineSetupForfeitBtn.style.display = "";

        onlineState.oppName = "";
        onlineState.oppPhoto = "";
        if (el.onlineOppName) el.onlineOppName.textContent = "";
        if (el.onlineOppSub) el.onlineOppSub.textContent = `${fee}`;
        if (el.onlineOppAvatar) setAvatarSquare(el.onlineOppAvatar, "", "?");

        if (el.onlineSetupInput) el.onlineSetupInput.value = "";
        if (el.onlineSetupStatus) el.onlineSetupStatus.innerHTML = "";
        if (el.onlineSetupDigits) el.onlineSetupDigits.innerHTML = "";

        if (onlineState.selectKind === "custom") {
          openOnlineSetupModal(codeLen, false, false);
        }

        openStage({ kind: "online", id: 0, matchId, mode, fee, codeLen });

        const myName = (me && me.firstName) || "";
        const myPhoto = me && typeof me.photo === "string" ? me.photo : "";
        const myEmail = (me && typeof me.email === "string" ? me.email : "") || "";
        onlineState.meName = myName;
        onlineState.mePhoto = myPhoto;
        onlineState.meEmail = myEmail;
        if (el.onlineMeName) el.onlineMeName.textContent = myName;
        if (el.onlineMeSub) el.onlineMeSub.textContent = `${fee}`;
        if (el.onlineMeAvatar) setAvatarSquare(el.onlineMeAvatar, myPhoto, String(myName).slice(0, 1).toUpperCase());

        const opp = opponentFromJoin;
        if (opp && el.onlineOppName) el.onlineOppName.textContent = opp.firstName || "";
        if (opp && el.onlineOppSub) el.onlineOppSub.textContent = `${fee}`;
        if (opp && el.onlineOppAvatar) setAvatarSquare(el.onlineOppAvatar, opp.photo || "", String((opp.firstName || "O")).slice(0, 1).toUpperCase());
        onlineState.oppName = opp && typeof opp.firstName === "string" ? opp.firstName : onlineState.oppName;
        onlineState.oppPhoto = opp && typeof opp.photo === "string" ? opp.photo : onlineState.oppPhoto;

        stopOnlineMatchPolling();
        await onlineFetchMatchStateOnce(myEmail, fee);
        startOnlineMatchPolling(myEmail, fee, 450);
        if (onlineState.selectKind !== "custom") {
          requestAnimationFrame(() => {
            if (app.inputs && app.inputs[0]) app.inputs[0].focus();
          });
        }
      }

      async function onlineSubmitGuess(guess) {
        if (!app.stage || app.stage.kind !== "online") return;
        if (onlineState.busy) return;
        onlineState.busy = true;
        try {
          if (el.checkBtn) el.checkBtn.disabled = true;
          const r = await friendsJson("/api/online/match/guess", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: app.stage.matchId, guess }),
          });
          if (!r.ok || !r.data) {
            const code = r.data && typeof r.data.error === "string" ? r.data.error : "";
            if (code === "online_disabled") {
              onlineFeature.enabled = false;
              updateOnlineBtnUI();
              enqueueToast({ title: t("onlineBtn"), body: "  .", autoMs: 2400 });
              await onlineFetchMatchStateOnce(onlineState.meEmail || "", onlineState.fee || 0);
              return;
            }
            if (code === "not_ready") {
              enqueueToast({ title: t("onlineBtn"), body: onlineState.selectKind === "props" ? t("onlineTurnCards") : t("onlineTurnSetup"), autoMs: 2200 });
              await onlineFetchMatchStateOnce(onlineState.meEmail || "", onlineState.fee || 0);
              return;
            }
            if (code === "not_your_turn") {
              el.msg.textContent = " .";
              return;
            }
            el.msg.textContent = "  .";
            return;
          }
          if (Array.isArray(r.data.result)) {
            const result = r.data.result;
            app.attempts += 1;
            if (el.attemptsNum) el.attemptsNum.textContent = String(app.attempts);
            el.msg.textContent = "";
            app.history.push({ guess, result });
            renderHistory();
            for (let i = 0; i < result.length; i++) {
              const slot = app.inputs[i] && app.inputs[i].parentElement;
              if (!slot) continue;
              slot.classList.remove("ok", "bad", "warn");
              if (result[i] !== "mask") slot.classList.add(result[i]);
            }
          }
          if (r.data && r.data.doubleOrNothing) {
            enqueueToast({ title: "Double or nothing", body: " !  .", autoMs: 2400 });
          }
          clearGuessOnly();
          await onlineFetchMatchStateOnce(onlineState.meEmail || "", onlineState.fee || 0);
        } finally {
          onlineState.busy = false;
        }
      }

      function onlineReturnToModeSelect() {
        stopOnlineAutoReturn();
        stopOnlinePreEnter();
        stopOnlineMatchPolling();
        stopOnlineQueuePolling();
        stopOnlineRoomPolling();
        stopOnlineHiddenForfeitTimer();
        closeOnlineSetupModal();
        closeOnlinePropsModal();
        closeOnlineWithdrawModal();
        if (el.winBox) el.winBox.classList.remove("show", "onlineWin", "onlineLose");
        if (el.mapBtn2) el.mapBtn2.style.display = "";
        if (el.shareBtn) el.shareBtn.style.display = "";
        goHome();
        renderOnlineSelect();
        openModal("online");
      }

      async function onlineExitMatch() {
        await onlineRunAction(
          "exit_match",
          async () => {
            if (!app.stage || app.stage.kind !== "online") return;
            stopOnlineAutoReturn();
            stopOnlinePreEnter();
            stopOnlineMatchPolling();
            stopOnlineQueuePolling();
            stopOnlineRoomPolling();
            stopOnlineHiddenForfeitTimer();
            const matchId = app.stage.matchId;
            if (matchId && !onlineState.forfeitSent) {
              onlineState.forfeitSent = true;
              await friendsJson("/api/online/match/forfeit", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id: matchId, intent: "withdraw" }),
              });
            }
            onlineReturnToModeSelect();
          },
          600
        );
      }

      function onlineDisconnectBestEffort() {
        if (!cloud.enabled) return;
        if (!app.stage || app.stage.kind !== "online") return;
        if (app.session && app.session.over) return;
        const id = app.stage.matchId;
        if (!id) return;
        try {
          fetch("/api/online/match/disconnect", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id }),
            keepalive: true,
            credentials: "include",
            cache: "no-store",
          });
        } catch {}
      }

      function onlineConnectBestEffort() {
        if (!cloud.enabled) return;
        if (!app.stage || app.stage.kind !== "online") return;
        const id = app.stage.matchId;
        if (!id) return;
        try {
          fetch("/api/online/match/connect", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id }),
            credentials: "include",
            cache: "no-store",
          }).catch(() => {});
        } catch {}
      }

      el.startBtn.addEventListener("click", () => goMap());
      if (el.onlineContent) {
        el.onlineContent.addEventListener("click", (e) => {
          const tabBtn = e && e.target && e.target.closest ? e.target.closest("button[data-online-kind]") : null;
          if (tabBtn && !tabBtn.dataset.onlineMode) {
            const k = String(tabBtn.dataset.onlineKind || "").trim();
            onlineState.selectKind = k === "custom" ? "custom" : k === "props" ? "props" : "normal";
            renderOnlineSelect();
            return;
          }
          const btn = e && e.target && e.target.closest ? e.target.closest("button[data-online-mode]") : null;
          if (!btn) return;
          const mode = String(btn.dataset.onlineMode || "").trim();
          if (!mode) return;
          const k = String(btn.dataset.onlineKind || "").trim();
          const kind = k === "custom" ? "custom" : k === "props" ? "props" : "normal";
          onlineJoin(mode, kind);
        });
      }
      if (el.onlineBtn) {
        updateOnlineBtnUI();
        el.onlineBtn.addEventListener("click", () => {
          if (!cloud.enabled) {
            enqueueToast({ title: t("onlineBtn"), body: "  .", autoMs: 2400 });
            return;
          }
          fetchOnlineEnabledOnce(false).catch(() => {});
          if (onlineFeature.fetched && !onlineFeature.enabled) {
            enqueueToast({ title: t("onlineBtn"), body: "  .", autoMs: 2400 });
            return;
          }
          renderOnlineSelect();
          openModal("online");
        });
      }
      el.dailyBtn.addEventListener("click", () => openDaily());
      el.dailyBtn2.addEventListener("click", () => openDaily());
      el.howBtn.addEventListener("click", () => openHowTo());
      if (el.assistBtn) el.assistBtn.addEventListener("click", () => openModal("assist"));
      if (el.logoutBtn) {
        el.logoutBtn.style.display = "";
        el.logoutBtn.addEventListener("click", () => signOutFromGame());
      }
      if (el.discordBtn) {
        el.discordBtn.style.display = "";
        el.discordBtn.addEventListener("click", () => openDiscord());
      }
      if (el.homeFeedbackBtn) el.homeFeedbackBtn.addEventListener("click", () => openFeedbackModal());
      if (el.homePolicyBtn) el.homePolicyBtn.addEventListener("click", () => openPolicyModal());
      if (el.homePrivacyBtn) el.homePrivacyBtn.addEventListener("click", () => openPrivacyModal());
      el.backToMapBtn.addEventListener("click", () => {
        if (app.stage && app.stage.kind === "online") {
          if (app.session && app.session.over) return;
          openOnlineWithdrawModal();
          return;
        }
        goMap();
      });
      el.mapBtn2.addEventListener("click", () => goMap());
      el.checkBtn.addEventListener("click", () => check());
      el.hintBtn.addEventListener("click", () => useHint());
      el.clearBtn.addEventListener("click", () => clearSlots());
      el.retryBtn.addEventListener("click", () => openStage({ ...app.stage }));
      el.shareBtn.addEventListener("click", () => shareResult());
      window.addEventListener("pagehide", () => onlineDisconnectBestEffort());
      document.addEventListener("visibilitychange", () => {
        if (document.hidden) onlineDisconnectBestEffort();
        else onlineConnectBestEffort();
      });

      el.goStageBtn.addEventListener("click", () => {
        const n = parseInt((el.stageSearch.value || "").replace(/[^\d]/g, ""), 10);
        if (!Number.isFinite(n)) return;
        goToStageNumber(n);
      });
      el.stageSearch.addEventListener("keydown", (e) => {
        if (e.key !== "Enter") return;
        const n = parseInt((el.stageSearch.value || "").replace(/[^\d]/g, ""), 10);
        if (!Number.isFinite(n)) return;
        goToStageNumber(n);
      });

      el.nextBtn.addEventListener("click", () => {
        if (app.stage.kind === "online") {
          onlineReturnToModeSelect();
          return;
        }
        if (app.stage.kind !== "level") {
          goMap();
          return;
        }
        if (app.stage.id >= TOTAL_LEVELS) return;
        const next = app.stage.id + 1;
        if (next > app.state.unlocked) goMap();
        else openStage({ kind: "level", id: next });
      });

      el.settingsBtn.addEventListener("click", () => openSettings());
      if (el.tasksBtn) el.tasksBtn.addEventListener("click", () => openMissions());
      if (el.chatBtn) el.chatBtn.addEventListener("click", () => toggleChat());
      el.homeHeaderBtn.addEventListener("click", () => goHome());
      if (el.playerAvatar) el.playerAvatar.addEventListener("click", () => openProfile());
      if (el.profileDropClose) el.profileDropClose.addEventListener("click", () => closeProfileDrop());
      if (el.profileDropBackdrop) {
        el.profileDropBackdrop.addEventListener("click", (e) => {
          if (e.target === el.profileDropBackdrop) closeProfileDrop();
        });
      }

      setInterval(() => {
        const resetAt = app.state && app.state.missions && typeof app.state.missions.resetAt === "number" ? app.state.missions.resetAt : 0;
        if (resetAt && Date.now() >= resetAt) {
          initMissions();
          updateSettingsUI();
        }
      }, 60_000);

      const friendsUI = {
        panel: document.getElementById("friendsPanel"),
        close: document.getElementById("friendsCloseBtn"),
        btn: document.getElementById("friendsBtn"),
        meName: document.getElementById("friendsMeName"),
        meId: document.getElementById("friendsMeId"),
        meCopyIdBtn: document.getElementById("friendsMeCopyIdBtn"),
        meAvatar: document.getElementById("friendsMeAvatar"),
        photoInput: document.getElementById("friendsPhotoInput"),
        tabFriendsBtn: document.getElementById("friendsTabFriendsBtn"),
        tabGiftsBtn: document.getElementById("friendsTabGiftsBtn"),
        tabAddBtn: document.getElementById("friendsTabAddBtn"),
        tabFriends: document.getElementById("friendsTabFriends"),
        tabGifts: document.getElementById("friendsTabGifts"),
        tabAdd: document.getElementById("friendsTabAdd"),
        addInput: document.getElementById("friendIdInput"),
        addBtn: document.getElementById("friendAddBtn"),
        msg: document.getElementById("friendsMsg"),
        count: document.getElementById("friendsCount"),
        onlineCountText: document.getElementById("friendsOnlineCountText"),
        searchInput: document.getElementById("friendsSearchInput"),
        list: document.getElementById("friendsList"),
        giftsList: document.getElementById("friendsGiftsList"),
        actions: document.getElementById("friendsActions"),
      };
      const friendsState = {
        open: false,
        tab: "friends",
        me: null,
        friends: [],
        gifts: [],
        selectedId: "",
        detailsById: {},
        blockedIds: [],
        friendsSig: "",
        giftsSig: "",
        search: "",
        loadPromise: null,
        lastLoadAt: 0,
      };
      function readBlockedFriendIds() {
        const ui = readUiPrefs();
        const raw = ui && typeof ui === "object" ? ui.blockedFriendIds : null;
        const ids = Array.isArray(raw) ? raw : [];
        return Array.from(new Set(ids.map((x) => String(x || "").trim().toUpperCase()).filter(Boolean))).slice(0, 800);
      }
      function writeBlockedFriendIds(ids) {
        const list = Array.isArray(ids) ? ids : [];
        const next = Array.from(new Set(list.map((x) => String(x || "").trim().toUpperCase()).filter(Boolean))).slice(0, 800);
        writeUiPrefs({ blockedFriendIds: next });
        friendsState.blockedIds = next;
      }
      friendsState.blockedIds = readBlockedFriendIds();
      const chatUI = {
        panel: document.getElementById("chatPanel"),
        close: document.getElementById("chatCloseBtn"),
        searchInput: document.getElementById("chatSearchInput"),
        friendsList: document.getElementById("chatFriendsList"),
        peerName: document.getElementById("chatPeerName"),
        peerMeta: document.getElementById("chatPeerMeta"),
        messages: document.getElementById("chatMessages"),
        input: document.getElementById("chatInput"),
        sendBtn: document.getElementById("chatSendBtn"),
      };
      const chatState = {
        open: false,
        selectedId: "",
        search: "",
        threads: {},
        lastInboxAt: 0,
        unreadPeers: {},
        lastThreadPullAt: 0,
      };
      const toastUI = { host: document.getElementById("toastHost") };
      const toastState = { busy: false, queue: [], lastInboxAt: 0, lastGiftAt: 0, lastReqEventAt: 0 };
      const avatarViewerUI = {
        host: document.getElementById("avatarViewer"),
        backdrop: document.getElementById("avatarViewerBackdrop"),
        close: document.getElementById("avatarViewerClose"),
        box: document.getElementById("avatarViewerBox"),
      };
      const avatarViewerState = { open: false };

      function friendsCacheKey() {
        const email = cloud && typeof cloud.email === "string" ? cloud.email : "";
        return email ? `lockgame_friends_cache_v1:${email}` : `lockgame_friends_cache_v1:guest`;
      }

      function loadFriendsCache() {
        try {
          const raw = localStorage.getItem(friendsCacheKey());
          if (!raw) return false;
          const p = JSON.parse(raw);
          const at = p && typeof p.at === "number" ? p.at : 0;
          if (!at || Date.now() - at > 1000 * 60 * 60 * 6) return false;
          const friends = p && Array.isArray(p.friends) ? p.friends : [];
          const gifts = p && Array.isArray(p.gifts) ? p.gifts : [];
          const me = p && p.me && typeof p.me === "object" ? p.me : null;
          if (!friends.length && !gifts.length && !me) return false;
          if (!friendsState.friends.length && friends.length) friendsState.friends = friends;
          if (!friendsState.gifts.length && gifts.length) friendsState.gifts = gifts;
          if (!friendsState.me && me) friendsState.me = me;
          friendsState.friendsSig = typeof p.friendsSig === "string" ? p.friendsSig : friendsState.friendsSig || "";
          friendsState.giftsSig = typeof p.giftsSig === "string" ? p.giftsSig : friendsState.giftsSig || "";
          return true;
        } catch {
          return false;
        }
      }

      function saveFriendsCache() {
        if (!cloud.enabled) return;
        try {
          localStorage.setItem(
            friendsCacheKey(),
            JSON.stringify({
              at: Date.now(),
              me: friendsState.me,
              friends: friendsState.friends,
              gifts: friendsState.gifts,
              friendsSig: friendsState.friendsSig,
              giftsSig: friendsState.giftsSig,
            }),
          );
        } catch {}
      }

      function escapeHtml(s) {
        return String(s || "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function formatAgo(ms) {
        const t = Number(ms || 0);
        if (!Number.isFinite(t) || t <= 0) return " ";
        const diff = Math.max(0, Date.now() - t);
        const m = Math.floor(diff / 60000);
        if (m <= 0) return "";
        if (m < 60) {
          if (m === 1) return " ";
          if (m === 2) return " ";
          return ` ${m} `;
        }
        const h = Math.floor(diff / 3600000);
        if (h < 24) {
          if (h === 1) return " ";
          if (h === 2) return " ";
          return ` ${h} `;
        }
        const d = Math.floor(diff / 86400000);
        if (d === 1) return " ";
        if (d === 2) return " ";
        return ` ${d} `;
      }

      function formatHm(ms) {
        const t = Number(ms || 0);
        if (!Number.isFinite(t) || t <= 0) return "";
        try {
          return new Date(t).toLocaleTimeString("en-GB", { hour: "2-digit", minute: "2-digit", hour12: false });
        } catch {
          const d = new Date(t);
          const hh = String(d.getHours()).padStart(2, "0");
          const mm = String(d.getMinutes()).padStart(2, "0");
          return `${hh}:${mm}`;
        }
      }

      function isOnlineFromLastSeen(ms) {
        const t = Number(ms || 0);
        if (!Number.isFinite(t) || t <= 0) return false;
        return Date.now() - t <= 2 * 60 * 1000;
      }

      function setFriendsMsg(text) {
        if (!friendsUI.msg) return;
        friendsUI.msg.textContent = text || "";
      }

      async function friendsJson(url, init) {
        try {
          const cfg = init && typeof init === "object" ? init : {};
          const r = await fetch(url, { cache: "no-store", credentials: "include", ...cfg });
          const data = await r.json().catch(() => null);
          return { ok: r.ok, status: r.status, data };
        } catch {
          return { ok: false, status: 0, data: null };
        }
      }

      async function chatJson(url, init) {
        try {
          const r = await fetch(url, init);
          const data = await r.json().catch(() => null);
          return { ok: r.ok, status: r.status, data };
        } catch {
          return { ok: false, status: 0, data: null };
        }
      }

      function updateChatBadge() {
        if (!el.chatBtn) return;
        const u = chatState.unreadPeers && typeof chatState.unreadPeers === "object" ? chatState.unreadPeers : {};
        const has = Object.keys(u).some((k) => !!u[k]);
        el.chatBtn.classList.toggle("hasNotifyDot", has);
      }

      function hasClaimableMissions() {
        initMissions();
        for (const def of missionDefs()) {
          const done = missionProgress(def.id) >= def.target;
          const claimed = missionClaimed(def.id);
          if (done && !claimed) return true;
        }
        return false;
      }

      function updateTasksBadge() {
        if (!el.tasksBtn) return;
        const has = canClaimDailyReward() || hasClaimableMissions();
        el.tasksBtn.classList.toggle("hasNotifyDot", has);
      }

      async function ensureMeLoaded() {
        if (friendsState.me && typeof friendsState.me.id === "string") return friendsState.me;
        if (!cloud.enabled) return null;
        const me = await friendsJson("/api/me", { method: "GET" });
        if (!me.ok || !me.data) return null;
        friendsState.me = me.data;
        if (!app.state.createdAt && friendsState.me && typeof friendsState.me.createdAt === "string") {
          const ms = Date.parse(friendsState.me.createdAt);
          if (Number.isFinite(ms) && ms > 0) {
            app.state.createdAt = ms;
            saveStateSilent(app.state);
          }
        }
        return friendsState.me;
      }

      function readChatThread(id) {
        const t = chatState.threads && typeof chatState.threads === "object" ? chatState.threads : {};
        const raw = t[id];
        return Array.isArray(raw) ? raw : [];
      }

      function writeChatThread(id, messages) {
        if (!chatState.threads || typeof chatState.threads !== "object") chatState.threads = {};
        chatState.threads[id] = Array.isArray(messages) ? messages.slice(-220) : [];
      }

      async function loadChatThread(id) {
        if (!cloud.enabled) return;
        const r = await chatJson(`/api/chat/thread?with=${encodeURIComponent(String(id || ""))}`, { method: "GET" });
        if (!r.ok) return;
        const messages = r.data && Array.isArray(r.data.messages) ? r.data.messages : [];
        writeChatThread(id, messages);
      }

      async function markChatRead(withId) {
        const id = String(withId || "").trim();
        if (!cloud.enabled || !id) return;
        await ensureMeLoaded();
        const r = await chatJson("/api/chat/read", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ withId: id }),
        });
        if (!r.ok) return;
        if (!chatState.unreadPeers || typeof chatState.unreadPeers !== "object") chatState.unreadPeers = {};
        chatState.unreadPeers[id] = false;
        updateChatBadge();
      }

      function renderChatMessages() {
        if (!chatUI.messages) return;
        const myId = friendsState.me && typeof friendsState.me.id === "string" ? friendsState.me.id : "";
        const peerId = chatState.selectedId;
        if (!peerId) {
          chatUI.messages.innerHTML = `<div class="friendsTiny">   .</div>`;
          return;
        }
        const msgs = readChatThread(peerId);
        if (!msgs.length) {
          chatUI.messages.innerHTML = `<div class="friendsTiny">  .</div>`;
          return;
        }
        chatUI.messages.innerHTML = msgs
          .map((m) => {
            const fromId = m && typeof m.fromId === "string" ? m.fromId : "";
            const text = m && typeof m.text === "string" ? m.text : "";
            const createdAt = m && typeof m.createdAt === "number" ? m.createdAt : 0;
            const pending = !!(m && typeof m === "object" && m.pending);
            const deliveredAt = m && typeof m.deliveredAt === "number" ? m.deliveredAt : 0;
            const readAt = m && typeof m.readAt === "number" ? m.readAt : 0;
            const mine = myId && fromId === myId;
            const status = pending ? "..." : readAt ? " " : deliveredAt || createdAt ? " " : "";
            return `<div class="chatMsgRow ${mine ? "me" : "them"}">
              <div class="chatBubble ${mine ? "me" : ""}">
                <div>${escapeHtml(text)}</div>
                <div class="chatMetaLine">
                  <span>${escapeHtml(formatHm(createdAt))}</span>
                  ${mine ? `<span class="chatStatus">${escapeHtml(status)}</span>` : ""}
                </div>
              </div>
            </div>`;
          })
          .join("");
        chatUI.messages.scrollTop = chatUI.messages.scrollHeight;
      }

      function makeClientMsgId() {
        try {
          const a = new Uint8Array(16);
          crypto.getRandomValues(a);
          const h = [...a].map((x) => x.toString(16).padStart(2, "0")).join("");
          return `c_${h}`;
        } catch {
          return `c_${Date.now()}_${Math.random().toString(16).slice(2)}`;
        }
      }

      async function sendChatMessage() {
        const peerId = chatState.selectedId;
        if (!peerId) return;
        const input = chatUI.input;
        const text = input && typeof input.value === "string" ? input.value.replace(/\s+/g, " ").trim() : "";
        if (!text) return;
        const myId = friendsState.me && typeof friendsState.me.id === "string" ? friendsState.me.id : "";
        const clientId = makeClientMsgId();
        const now = Date.now();
        const optimistic = { id: clientId, fromId: myId, toId: peerId, text, createdAt: now, pending: true };
        if (chatUI.input) chatUI.input.value = "";
        writeChatThread(peerId, [...readChatThread(peerId), optimistic]);
        renderChatMessages();

        const r = await chatJson("/api/chat/send", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ toId: peerId, text, clientId }),
        });
        if (!r.ok) {
          if (r.status === 403 && r.data && r.data.error === "muted" && typeof r.data.mutedUntilMs === "number") {
            const ms = Math.max(0, Math.floor(r.data.mutedUntilMs - Date.now()));
            const m = Math.floor(ms / 60000);
            const s = Math.floor((ms % 60000) / 1000);
            enqueueToast({ title: "", body: `   ${m} ${s}.`, autoMs: 2600 });
          } else {
            enqueueToast({ title: "", body: (r.data && r.data.error) || " .", autoMs: 2200 });
          }
          const cur = readChatThread(peerId).filter((m) => !(m && typeof m === "object" && m.id === clientId));
          writeChatThread(peerId, cur);
          renderChatMessages();
        } else {
          const msg = r.data && r.data.msg ? r.data.msg : null;
          if (msg) {
            const current = readChatThread(peerId);
            const next = current.map((m) => {
              if (m && typeof m === "object" && m.id === clientId) return msg;
              return m;
            });
            writeChatThread(peerId, next);
            renderChatMessages();
          } else {
            loadChatThread(peerId)
              .then(() => renderChatMessages())
              .catch(() => {});
          }
        }
        kickFastSync();
        if (chatUI.input) chatUI.input.focus();
      }

      async function pollChatInbox() {
        if (!cloud.enabled) return;
        await ensureMeLoaded();
        const since = chatState.lastInboxAt || 0;
        const r = await chatJson(`/api/chat/inbox?since=${encodeURIComponent(String(since))}`, { method: "GET" });
        if (!r.ok || !r.data || !Array.isArray(r.data.messages)) return;
        const items = r.data.messages;
        let maxAt = since;
        const myId = friendsState.me && typeof friendsState.me.id === "string" ? friendsState.me.id : "";
        let touchedSelected = false;
        for (const m of items) {
          const createdAt = m && typeof m.createdAt === "number" ? m.createdAt : 0;
          const fromId = m && typeof m.fromId === "string" ? m.fromId : "";
          const toId = m && typeof m.toId === "string" ? m.toId : "";
          if (createdAt > maxAt) maxAt = createdAt;
          const peerId = myId && fromId === myId ? toId : fromId;
          if (!peerId) continue;
          const current = readChatThread(peerId);
          const mid = m && typeof m.id === "string" ? m.id : "";
          if (!mid) continue;
          const exists = current.some((x) => x && typeof x === "object" && typeof x.id === "string" && x.id === mid);
          if (exists) continue;
          writeChatThread(peerId, [...current, m]);
          const incoming = myId && fromId && fromId !== myId;
          if (incoming && (!chatState.open || chatState.selectedId !== peerId)) {
            if (!chatState.unreadPeers || typeof chatState.unreadPeers !== "object") chatState.unreadPeers = {};
            chatState.unreadPeers[peerId] = true;
          }
          if (incoming && chatState.open && chatState.selectedId === peerId) touchedSelected = true;
        }
        chatState.lastInboxAt = maxAt;
        updateChatBadge();
        if (chatState.open) renderChatMessages();
        if (touchedSelected) markChatRead(chatState.selectedId).catch(() => {});
      }

      async function copyToClipboard(text) {
        const s = String(text || "");
        if (!s) return false;
        try {
          if (navigator && navigator.clipboard && typeof navigator.clipboard.writeText === "function") {
            await navigator.clipboard.writeText(s);
            return true;
          }
        } catch {}
        try {
          const ta = document.createElement("textarea");
          ta.value = s;
          ta.setAttribute("readonly", "true");
          ta.style.position = "fixed";
          ta.style.opacity = "0";
          ta.style.left = "-9999px";
          document.body.appendChild(ta);
          ta.select();
          const ok = document.execCommand("copy");
          ta.remove();
          return !!ok;
        } catch {
          return false;
        }
      }

      function openAvatarViewer(photo, fallbackLetter) {
        if (!avatarViewerUI.host || !avatarViewerUI.box) return;
        const letter = (fallbackLetter || "").slice(0, 1).toUpperCase();
        setAvatarSquare(avatarViewerUI.box, photo || "", letter);
        avatarViewerUI.host.classList.add("open");
        avatarViewerUI.host.setAttribute("aria-hidden", "false");
        avatarViewerState.open = true;
      }
      function closeAvatarViewer() {
        if (!avatarViewerUI.host) return;
        avatarViewerUI.host.classList.remove("open");
        avatarViewerUI.host.setAttribute("aria-hidden", "true");
        avatarViewerState.open = false;
      }

      function setAvatarSquare(elm, photo, fallbackLetter) {
        if (!elm) return;
        const p = typeof photo === "string" ? photo.trim() : "";
        const letter = (fallbackLetter || "").slice(0, 1).toUpperCase();
        const key = p && /^data:image\/(png|jpeg|webp);base64,/i.test(p) ? `img:${p}` : `t:${letter}`;
        if (elm.dataset && elm.dataset.avatarKey === key) return;
        if (elm.dataset) elm.dataset.avatarKey = key;
        elm.textContent = "";
        while (elm.firstChild) elm.removeChild(elm.firstChild);
        if (p && /^data:image\/(png|jpeg|webp);base64,/i.test(p)) {
          const img = document.createElement("img");
          img.alt = "";
          img.decoding = "async";
          img.loading = "lazy";
          img.src = p;
          elm.appendChild(img);
          return;
        }
        elm.textContent = letter;
      }

      function loadImageFromFile(file) {
        return new Promise((resolve, reject) => {
          const url = URL.createObjectURL(file);
          const img = new Image();
          img.onload = () => {
            URL.revokeObjectURL(url);
            resolve(img);
          };
          img.onerror = () => {
            URL.revokeObjectURL(url);
            reject(new Error("image_load_failed"));
          };
          img.src = url;
        });
      }

      async function fileToSquareDataUrl(file) {
        const img = await loadImageFromFile(file);
        const w = img.naturalWidth || img.width || 0;
        const h = img.naturalHeight || img.height || 0;
        if (!w || !h) throw new Error("bad_image");
        const crop = Math.min(w, h);
        const sx = Math.floor((w - crop) / 2);
        const sy = Math.floor((h - crop) / 2);
        const sizes = [256, 192, 160, 128];
        for (const size of sizes) {
          const canvas = document.createElement("canvas");
          canvas.width = size;
          canvas.height = size;
          const ctx = canvas.getContext("2d");
          if (!ctx) continue;
          ctx.drawImage(img, sx, sy, crop, crop, 0, 0, size, size);
          let out = "";
          try {
            out = canvas.toDataURL("image/webp", 0.86);
          } catch {
            out = "";
          }
          if (!out || out.length > 150000) {
            try {
              out = canvas.toDataURL("image/jpeg", 0.86);
            } catch {
              out = "";
            }
          }
          if (out && out.length < 150000) return out;
        }
        throw new Error("too_large");
      }

      async function handleMePhotoPick(file) {
        if (!cloud.enabled) {
          enqueueToast({ title: " ", body: "  .", autoMs: 2400 });
          return;
        }
        if (!file || !file.type || !String(file.type).startsWith("image/")) {
          enqueueToast({ title: " ", body: "  .", autoMs: 2400 });
          return;
        }
        try {
          const dataUrl = await fileToSquareDataUrl(file);
          app.state.photo = dataUrl;
          saveState(app.state);
          const letter = (friendsState.me && friendsState.me.firstName ? String(friendsState.me.firstName) : "P").trim().slice(0, 1).toUpperCase() || "P";
          setAvatarSquare(friendsUI.meAvatar, dataUrl, letter);
          enqueueToast({ title: "", body: "  .", autoMs: 1800 });
          if (friendsState.open) loadFriendsData().catch(() => {});
        } catch {
          enqueueToast({ title: "", body: "  .", autoMs: 2400 });
        }
      }

      function toastOnce(key, ttlMs) {
        const k = `${storageKey}:toast:${key}`;
        const now = Date.now();
        const last = Math.max(0, Math.floor(parseInt(String(localStorage.getItem(k) || "0"), 10) || 0));
        const ttl = typeof ttlMs === "number" && Number.isFinite(ttlMs) ? Math.max(0, Math.floor(ttlMs)) : 0;
        if (last && (!ttl || now - last < ttl)) return false;
        localStorage.setItem(k, String(now));
        return true;
      }

      function toastCursorKey() {
        return `${storageKey}:toast_cursors_v1`;
      }

      function loadToastCursors() {
        try {
          const raw = localStorage.getItem(toastCursorKey());
          if (!raw) return;
          const p = JSON.parse(raw);
          const inbox = p && typeof p.lastInboxAt === "number" && Number.isFinite(p.lastInboxAt) ? Math.max(0, Math.floor(p.lastInboxAt)) : 0;
          const gifts = p && typeof p.lastGiftAt === "number" && Number.isFinite(p.lastGiftAt) ? Math.max(0, Math.floor(p.lastGiftAt)) : 0;
          const req = p && typeof p.lastReqEventAt === "number" && Number.isFinite(p.lastReqEventAt) ? Math.max(0, Math.floor(p.lastReqEventAt)) : 0;
          toastState.lastInboxAt = inbox;
          toastState.lastGiftAt = gifts;
          toastState.lastReqEventAt = req;
        } catch {}
      }

      function saveToastCursors() {
        try {
          localStorage.setItem(
            toastCursorKey(),
            JSON.stringify({
              at: Date.now(),
              lastInboxAt: toastState.lastInboxAt || 0,
              lastGiftAt: toastState.lastGiftAt || 0,
              lastReqEventAt: toastState.lastReqEventAt || 0,
            })
          );
        } catch {}
      }

      function enqueueToast(item) {
        try {
          const title = item && typeof item.title === "string" ? item.title : "";
          if (/(^|\s)(||Error|Failed)(\s|$)/i.test(title)) {
            playErrorSound();
            vibrate([0, 26, 40]);
          }
        } catch {}
        toastState.queue.push(item);
        if (!toastState.busy) showNextToast();
      }

      function showNextToast() {
        if (!toastUI.host) return;
        if (toastState.busy) return;
        const next = toastState.queue.shift();
        if (!next) return;
        toastState.busy = true;

        const card = document.createElement("div");
        card.className = "toastCard";
        const title = document.createElement("div");
        title.className = "toastTitle";
        title.textContent = next.title || "";
        const body = document.createElement("div");
        body.className = "toastBody";
        body.textContent = next.body || "";
        const actions = document.createElement("div");
        actions.className = "toastActions";

        const closeBtn = document.createElement("button");
        closeBtn.className = "btn";
        closeBtn.type = "button";
        closeBtn.textContent = "";
        closeBtn.addEventListener("click", () => {
          card.remove();
          toastState.busy = false;
          showNextToast();
        });

        if (Array.isArray(next.actions) && next.actions.length) {
          for (const a of next.actions) {
            const b = document.createElement("button");
            b.className = a.primary ? "btn primary" : a.danger ? "btn danger" : "btn";
            b.type = "button";
            b.textContent = a.label || "";
            b.disabled = !!a.disabled;
            b.addEventListener("click", async () => {
              try {
                if (typeof a.onClick === "function") await a.onClick();
              } finally {
                card.remove();
                toastState.busy = false;
                showNextToast();
              }
            });
            actions.appendChild(b);
          }
        }
        actions.appendChild(closeBtn);

        card.appendChild(title);
        card.appendChild(body);
        card.appendChild(actions);
        toastUI.host.appendChild(card);
        requestAnimationFrame(() => card.classList.add("show"));

        const autoMs = next.autoMs && Number.isFinite(next.autoMs) ? Math.max(1200, Math.floor(next.autoMs)) : 0;
        if (autoMs && (!next.actions || !next.actions.length)) {
          setTimeout(() => {
            if (!card.isConnected) return;
            card.remove();
            toastState.busy = false;
            showNextToast();
          }, autoMs);
        }
      }

      async function pollFriendInbox() {
        if (!cloud.enabled) return;
        const since = toastState.lastInboxAt || 0;
        const r = await friendsJson(`/api/friends/requests/inbox?since=${encodeURIComponent(String(since))}`, { method: "GET" });
        if (!r.ok || !r.data || !Array.isArray(r.data.requests)) return;
        const items = r.data.requests;
        let maxAt = since;
        for (const req of items) {
          const requestId = req && typeof req.requestId === "string" ? req.requestId : "";
          const fromName = req && typeof req.fromName === "string" ? req.fromName : "Player";
          const fromId = req && typeof req.fromId === "string" ? req.fromId : "";
          const createdAt = req && typeof req.createdAt === "number" ? req.createdAt : 0;
          if (createdAt > maxAt) maxAt = createdAt;
          if (!requestId) continue;
          if (!toastOnce(`fr_inbox:${requestId}`, 0)) continue;

          enqueueToast({
            title: " ",
            body: `${fromName}${fromId ? ` (${fromId})` : ""} .`,
            actions: [
              {
                label: "",
                primary: true,
                onClick: async () => {
                  const rr = await friendsJson("/api/friends/requests/respond", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ requestId, action: "accept" }),
                  });
                  if (!rr.ok) {
                    enqueueToast({ title: "", body: (rr.data && rr.data.error) || "  .", autoMs: 2200 });
                    return;
                  }
                  enqueueToast({ title: "", body: "  .", autoMs: 1800 });
                  await loadFriendsData(true);
                },
              },
              {
                label: "",
                danger: true,
                onClick: async () => {
                  const rr = await friendsJson("/api/friends/requests/respond", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ requestId, action: "decline" }),
                  });
                  if (!rr.ok) {
                    enqueueToast({ title: "", body: (rr.data && rr.data.error) || "  .", autoMs: 2200 });
                    return;
                  }
                  enqueueToast({ title: "", body: "  .", autoMs: 1800 });
                  await loadFriendsData(true);
                },
              },
            ],
          });
        }
        toastState.lastInboxAt = maxAt;
        saveToastCursors();
      }

      async function pollFriendRequestEvents() {
        if (!cloud.enabled) return;
        const since = toastState.lastReqEventAt || 0;
        const r = await friendsJson(`/api/friends/requests/events?since=${encodeURIComponent(String(since))}`, { method: "GET" });
        if (!r.ok || !r.data || !Array.isArray(r.data.events)) return;
        const items = r.data.events;
        let maxAt = since;
        for (const ev of items) {
          const action = ev && typeof ev.action === "string" ? ev.action : "";
          const fromName = ev && typeof ev.fromName === "string" ? ev.fromName : "Player";
          const fromId = ev && typeof ev.fromId === "string" ? ev.fromId : "";
          const createdAt = ev && typeof ev.createdAt === "number" ? ev.createdAt : 0;
          if (createdAt > maxAt) maxAt = createdAt;
          const key = `fr_evt:${createdAt}:${action}:${fromId || fromName}`;
          if (!action) continue;
          if (!toastOnce(key, 0)) continue;

          if (action === "accepted") {
            enqueueToast({ title: "  ", body: `${fromName}${fromId ? ` (${fromId})` : ""}   .`, autoMs: 2400 });
            loadFriendsData().catch(() => {});
          } else if (action === "declined") {
            enqueueToast({ title: "  ", body: `${fromName}${fromId ? ` (${fromId})` : ""}   .`, autoMs: 2400 });
          }
        }
        toastState.lastReqEventAt = maxAt;
        saveToastCursors();
      }

      async function pollGiftEvents() {
        if (!cloud.enabled) return;
        const since = toastState.lastGiftAt || 0;
        const r = await friendsJson(`/api/friends/gifts?since=${encodeURIComponent(String(since))}`, { method: "GET" });
        if (!r.ok || !r.data || !Array.isArray(r.data.gifts)) return;
        const items = r.data.gifts;
        let maxAt = since;
        let touched = false;
        for (const g of items) {
          const fromName = g && typeof g.fromName === "string" ? g.fromName : "Player";
          const fromId = g && typeof g.fromId === "string" ? g.fromId : "";
          const coins = g && typeof g.coins === "number" ? g.coins : 0;
          const createdAt = g && typeof g.createdAt === "string" ? Date.parse(g.createdAt) : 0;
          if (createdAt > maxAt) maxAt = createdAt;
          const key = `gift:${createdAt}:${fromId || fromName}:${coins}`;
          if (!toastOnce(key, 0)) continue;
          touched = true;
          enqueueToast({
            title: " ",
            body: `${fromName}${fromId ? ` (${fromId})` : ""}   +${coins}`,
            autoMs: 2600,
          });
        }
        toastState.lastGiftAt = maxAt;
        saveToastCursors();
        if (touched) {
          const existing = Array.isArray(friendsState.gifts) ? friendsState.gifts : [];
          const seen = new Set(existing.map((x) => `${String(x.createdAt || "")}:${String(x.fromId || "")}:${Number(x.coins || 0)}`));
          const next = existing.slice();
          for (const g of items) {
            const k = `${String(g.createdAt || "")}:${String(g.fromId || "")}:${Number(g.coins || 0)}`;
            if (seen.has(k)) continue;
            seen.add(k);
            next.unshift(g);
          }
          friendsState.gifts = next.slice(0, 120);
          friendsState.giftsSig = friendsState.gifts
            .map((g) => {
              const createdAtRaw =
                g && typeof g.createdAt === "string" ? Date.parse(g.createdAt) : Number(g && g.createdAt ? g.createdAt : 0);
              const createdAt = Math.floor(Number.isFinite(createdAtRaw) ? createdAtRaw : 0);
              const fromName = String(g.fromName || "");
              const coins = Math.floor(Number(g.coins || 0) || 0);
              return `${createdAt}:${fromName}:${coins}`;
            })
            .join("|");
          saveFriendsCache();
          if (friendsState.open && friendsState.tab === "gifts") renderFriends();
        }
      }

      async function pollRemoteStateLight() {
        if (!cloud.enabled) return;
        if (document.hidden) return;
        const remote = await cloudGet();
        if (!remote) return;

        const screen = document.body && document.body.dataset ? document.body.dataset.screen || "home" : "home";
        if (screen === "level") {
          let changed = false;
          if (typeof remote.coins === "number" && remote.coins !== app.state.coins) {
            setCoinsTotal(remote.coins, null, true);
            changed = true;
          }
          if (typeof remote.hintTokens === "number" && remote.hintTokens !== app.state.hintTokens) {
            app.state.hintTokens = remote.hintTokens;
            changed = true;
          }
          if (typeof remote.displayName === "string" && remote.displayName !== app.state.displayName) {
            app.state.displayName = remote.displayName;
            changed = true;
            updateUserCenter();
          }
          if (typeof remote.photo === "string" && remote.photo !== app.state.photo) {
            app.state.photo = remote.photo;
            changed = true;
            if (friendsUI.meAvatar) {
              const name = firstNameFromDisplayName(String(app.state.displayName || "")) || "P";
              const a = String(name).trim().slice(0, 1).toUpperCase() || "P";
              setAvatarSquare(friendsUI.meAvatar, app.state.photo, a);
            }
          }
          if (remote.nameChange && typeof remote.nameChange === "object") {
            const rCredits = typeof remote.nameChange.credits === "number" ? Math.max(0, Math.floor(remote.nameChange.credits)) : 0;
            const rFreeUsed = !!remote.nameChange.freeUsed;
            app.state.nameChange = app.state.nameChange && typeof app.state.nameChange === "object" ? app.state.nameChange : { freeUsed: false, credits: 0 };
            if (app.state.nameChange.credits !== rCredits || !!app.state.nameChange.freeUsed !== rFreeUsed) {
              app.state.nameChange.credits = rCredits;
              app.state.nameChange.freeUsed = rFreeUsed;
              changed = true;
            }
          }

          if (changed) {
            saveStateSilent(app.state);
            updateSettingsUI();
            updateShopUI();
          }
          return;
        }

        const remoteTs = typeof remote.lastWriteAt === "number" && Number.isFinite(remote.lastWriteAt) ? remote.lastWriteAt : 0;
        const localTs = typeof app.state.lastWriteAt === "number" && Number.isFinite(app.state.lastWriteAt) ? app.state.lastWriteAt : 0;
        if (remoteTs && remoteTs <= localTs) return;

        app.state = remote;

        saveStateSilent(app.state);
        applyTheme(app.state.theme || "crimson");
        applyLanguage(app.state.lang || "ar");
        updateCoinsUI();
        updateUserCenter();
        updateDailyUI();
        updateSettingsUI();
        updateShopUI();
        renderMap();
      }

      let livePollId = null;
      let lastFriendsPullAt = 0;
      let lastPresenceAt = 0;
      let lastOnlineCountAt = 0;
      let lastRemoteStateAt = 0;
      let lastChatInboxAt = 0;
      let lastFriendInboxAt = 0;
      let lastFriendReqAt = 0;
      let lastGiftAt = 0;
      let lastOnlineEnabledAt = 0;
      let lastUiPulseAt = 0;
      async function presencePing() {
        if (!cloud.enabled) return;
        if (document.hidden) return;
        const now = Date.now();
        app.state.lastSeenAt = now;
        saveStateSilent(app.state);
        try {
          await fetch("/api/presence/ping", { method: "POST", cache: "no-store", credentials: "include" });
        } catch {}
      }
      async function pollOnlineCount() {
        if (!cloud.enabled || !el.onlineCountText) return;
        if (document.hidden) return;
        try {
          const r = await fetch("/api/presence/online-count", { method: "GET", cache: "no-store", credentials: "include" });
          const d = await r.json().catch(() => null);
          const n = d && typeof d.count === "number" && Number.isFinite(d.count) ? Math.max(0, Math.floor(d.count)) : 0;
          setTextIfChanged(el.onlineCountText, String(n));
        } catch {}
      }
      function stopLivePolling() {
        if (livePollId) clearInterval(livePollId);
        livePollId = null;
      }
      function startLivePolling() {
        if (livePollId) return;
        if (!cloud.enabled) return;
        livePollId = setInterval(() => {
          if (!cloud.enabled) {
            stopLivePolling();
            return;
          }
          if (document.hidden) return;
          const now = Date.now();
          if (now - lastOnlineEnabledAt > 30000) {
            lastOnlineEnabledAt = now;
            fetchOnlineEnabledOnce(false).catch(() => {});
          }
          if (now - lastFriendInboxAt > 7000) {
            lastFriendInboxAt = now;
            pollFriendInbox().catch(() => {});
          }
          if (now - lastFriendReqAt > 8000) {
            lastFriendReqAt = now;
            pollFriendRequestEvents().catch(() => {});
          }
          if (now - lastGiftAt > 8000) {
            lastGiftAt = now;
            pollGiftEvents().catch(() => {});
          }
          const chatEvery = chatState.open ? 2500 : 9000;
          if (now - lastChatInboxAt > chatEvery) {
            lastChatInboxAt = now;
            pollChatInbox().catch(() => {});
          }
          if (now - lastRemoteStateAt > 15000) {
            lastRemoteStateAt = now;
            pollRemoteStateLight().catch(() => {});
          }
          if (now - lastPresenceAt > 25000) {
            lastPresenceAt = now;
            presencePing().catch(() => {});
          }
          if (now - lastOnlineCountAt > 15000) {
            lastOnlineCountAt = now;
            pollOnlineCount().catch(() => {});
          }
          if (chatState.open && chatState.selectedId && now - (chatState.lastThreadPullAt || 0) > 2000) {
            chatState.lastThreadPullAt = now;
            loadChatThread(chatState.selectedId)
              .then(() => renderChatMessages())
              .catch(() => {});
          }
          if ((friendsState.open || chatState.open) && now - lastFriendsPullAt > 5200) {
            lastFriendsPullAt = now;
            loadFriendsData().catch(() => {});
          }
          if (now - lastUiPulseAt > 4500) {
            lastUiPulseAt = now;
            updateTasksBadge();
            updateProfileUI();
          }
        }, 2500);
      }

      let fastSyncT = null;
      let lastFastSyncAt = 0;
      function kickFastSync() {
        if (!cloud.enabled) return;
        const now = Date.now();
        if (now - lastFastSyncAt < 350) return;
        lastFastSyncAt = now;
        clearTimeout(fastSyncT);
        fastSyncT = setTimeout(() => {
          pollChatInbox().catch(() => {});
          pollGiftEvents().catch(() => {});
          pollFriendInbox().catch(() => {});
          pollFriendRequestEvents().catch(() => {});
          pollRemoteStateLight().catch(() => {});
          if (friendsState.open || chatState.open) loadFriendsData(true).catch(() => {});
          if (chatState.open && chatState.selectedId) {
            loadChatThread(chatState.selectedId)
              .then(() => renderChatMessages())
              .catch(() => {});
          }
        }, 50);
      }

      function setTab(next) {
        friendsState.tab = next;
        const friendsActive = next === "friends";
        const giftsActive = next === "gifts";
        const addActive = next === "add";
        if (friendsUI.tabFriendsBtn) friendsUI.tabFriendsBtn.classList.toggle("active", friendsActive);
        if (friendsUI.tabGiftsBtn) friendsUI.tabGiftsBtn.classList.toggle("active", giftsActive);
        if (friendsUI.tabAddBtn) friendsUI.tabAddBtn.classList.toggle("active", addActive);
        if (friendsUI.tabFriends) friendsUI.tabFriends.style.display = friendsActive ? "" : "none";
        if (friendsUI.tabGifts) friendsUI.tabGifts.style.display = giftsActive ? "" : "none";
        if (friendsUI.tabAdd) friendsUI.tabAdd.style.display = addActive ? "" : "none";
      }

      function renderFriends() {
        setTab(friendsState.tab || "friends");
        if (friendsState.tab === "gifts") {
          if (!friendsUI.giftsList) return;
          const gifts = Array.isArray(friendsState.gifts) ? friendsState.gifts : [];
          if (!gifts.length) {
            if (friendsState.loadPromise) {
              friendsUI.giftsList.innerHTML = new Array(5).fill(0).map(() => `<div class="skRow"><div class="skLine lg"></div><div class="skLine sm"></div></div>`).join("");
            } else {
              friendsUI.giftsList.innerHTML = `<div class="emptyCard"><div class="t">  </div><div class="tiny">      .</div></div>`;
            }
            return;
          }
          friendsUI.giftsList.innerHTML = gifts
            .map((g) => {
              const when = g.createdAt ? new Date(g.createdAt).toLocaleString() : "";
              const coins = typeof g.coins === "number" ? g.coins : 0;
              return `<div class="giftRow">
                <div class="friendMeta">
                  <div class="name">${escapeHtml(g.fromName || "Player")}</div>
                  <div class="id">+${escapeHtml(coins)}</div>
                </div>
                <div class="friendsTiny" style="margin-top:4px">${escapeHtml(when)}</div>
              </div>`;
            })
            .join("");
          return;
        }

        if (friendsState.tab === "add") {
          return;
        }

        if (!friendsUI.list || !friendsUI.count) return;
        const list = Array.isArray(friendsState.friends) ? friendsState.friends : [];
        const blocked = new Set(Array.isArray(friendsState.blockedIds) ? friendsState.blockedIds : []);
        const visibleList = blocked.size ? list.filter((f) => f && typeof f.id === "string" && !blocked.has(f.id)) : list;
        if (friendsUI.onlineCountText) {
          const onlineN = visibleList.reduce((acc, f) => {
            const lastSeenAt = typeof f.lastSeenAt === "number" ? f.lastSeenAt : Date.parse(String(f.updatedAt || "")) || 0;
            const online = typeof f.online === "boolean" ? f.online : isOnlineFromLastSeen(lastSeenAt);
            return acc + (online ? 1 : 0);
          }, 0);
          friendsUI.onlineCountText.textContent = String(onlineN);
        }
        const q = String(friendsState.search || "").trim().toLowerCase();
        const filtered = q
          ? visibleList.filter((f) => {
              const name = String(f && f.firstName ? f.firstName : "").toLowerCase();
              const id = String(f && f.id ? f.id : "").toLowerCase();
              return name.includes(q) || id.includes(q);
            })
          : visibleList;
        friendsUI.count.textContent = filtered.length ? (q ? `${filtered.length} / ${visibleList.length}` : `${filtered.length} `) : "";

        if (!visibleList.length) {
          if (friendsState.loadPromise) {
            friendsUI.list.innerHTML = new Array(7).fill(0).map(() => `<div class="skRow"><div class="skLine lg"></div><div class="skLine sm"></div></div>`).join("");
          } else if (!cloud.enabled) {
            friendsUI.list.innerHTML = `<div class="emptyCard"><div class="t"> </div><div class="tiny">      .</div></div>`;
          } else {
            const myId = friendsState.me && typeof friendsState.me.id === "string" ? friendsState.me.id : "";
            friendsUI.list.innerHTML = `<div class="emptyCard">
              <div class="t">  </div>
              <div class="tiny"> ID       ID  .</div>
              ${myId ? `<div class="friendsTiny">ID  : <span style="font-weight:900; letter-spacing:0.8px">${escapeHtml(myId)}</span></div>` : ``}
              <div class="ctaRow">
                <button type="button" class="btn primary" data-action="friends-add"> </button>
              </div>
            </div>`;
          }
          if (friendsUI.actions) friendsUI.actions.style.display = "none";
          friendsUI.count.textContent = "";
          return;
        }

        friendsUI.list.innerHTML = filtered
          .map((f) => {
            const active = friendsState.selectedId && friendsState.selectedId === f.id ? " active" : "";
            const fid = String(f.id || "").trim();
            const lastSeenAt = typeof f.lastSeenAt === "number" ? f.lastSeenAt : Date.parse(String(f.updatedAt || "")) || 0;
            const online = typeof f.online === "boolean" ? f.online : isOnlineFromLastSeen(lastSeenAt);
            const dot = online ? "presenceDot on" : "presenceDot";
            const letter = String(f.firstName || "P")
              .trim()
              .slice(0, 1)
              .toUpperCase();
            const photo = f && typeof f.photo === "string" && /^data:image\/(png|jpeg|webp);base64,/i.test(f.photo) ? f.photo : "";
            const avatar = photo ? `<img alt="" loading="lazy" decoding="async" src="${escapeHtml(photo)}" />` : escapeHtml(letter || "P");
            return `<button type="button" class="friendRow${active}" data-id="${escapeHtml(f.id)}">
              <div class="friendMeta">
                <div class="name">
                  <div class="friendLine">
                    <div class="avatarMini">${avatar}</div>
                    <div class="friendText">
                      <div class="friendNameRow"><span class="${dot}"></span><span class="friendNameText">${escapeHtml(f.firstName || "Player")}</span><span class="friendsTiny" style="margin-inline-start:8px">LV ${escapeHtml(String(typeof f.level === "number" ? Math.max(1, Math.floor(f.level)) : 1))}</span></div>
                      <div class="friendsTiny">  : ${escapeHtml(formatAgo(lastSeenAt))}</div>
                    </div>
                  </div>
                </div>
                <div class="id idWithCopy">
                  <span>${escapeHtml(fid)}</span>
                  <span class="copyBtn copyBtnInline" data-copy="${escapeHtml(fid)}" title=""></span>
                </div>
              </div>
            </button>`;
          })
          .join("");

        if (!friendsUI.actions) return;
        if (!friendsState.selectedId || blocked.has(friendsState.selectedId)) {
          if (blocked.has(friendsState.selectedId)) friendsState.selectedId = "";
          friendsUI.actions.style.display = "none";
          return;
        }

        const sel = visibleList.find((x) => x.id === friendsState.selectedId);
        const canGift = !!(sel && sel.canGift);
        const giftAvailableAt = sel && sel.giftAvailableAt ? Number(sel.giftAvailableAt) : 0;
        const giftNote =
          !canGift && giftAvailableAt
            ? `<div class="friendsTiny">  : ${escapeHtml(new Date(giftAvailableAt).toLocaleString())}</div>`
            : "";
        const friendAvatarLetter = sel && sel.firstName ? String(sel.firstName).trim().slice(0, 1).toUpperCase() : "P";
        const friendPhoto = sel && typeof sel.photo === "string" && /^data:image\/(png|jpeg|webp);base64,/i.test(sel.photo) ? sel.photo : "";
        const friendAvatarHtml = friendPhoto ? `<img alt="" loading="lazy" decoding="async" src="${escapeHtml(friendPhoto)}" />` : escapeHtml(friendAvatarLetter);

        friendsUI.actions.innerHTML = `
          <div class="friendsActionRow">
            <button id="friendsGiftBtn" class="btn ${canGift ? "primary" : ""}" type="button" ${canGift ? "" : "disabled"}></button>
            <button id="friendsRemoveBtn" class="btn danger" type="button">/</button>
            <button id="friendsDetailsBtn" class="btn" type="button"> </button>
            <button id="friendsReportBtn" class="btn" type="button"></button>
            <div class="avatarSquare friendsFriendAvatar">${friendAvatarHtml}</div>
          </div>
          ${giftNote}
        `;
        friendsUI.actions.style.display = "";
      }

      async function loadFriendsData(force) {
        const now = Date.now();
        if (!force && friendsState.lastLoadAt && now - friendsState.lastLoadAt < 1200) return;
        if (friendsState.loadPromise) return friendsState.loadPromise;
        friendsState.lastLoadAt = now;

        const p = (async () => {
          if (!cloud.enabled) {
            setFriendsMsg("  .");
            friendsState.me = null;
            friendsState.friends = [];
            friendsState.gifts = [];
            friendsState.selectedId = "";
            friendsState.detailsById = {};
            renderFriends();
            return;
          }

          if (!friendsState.friends.length && friendsState.open) setFriendsMsg(" ...");

          const meData = await ensureMeLoaded().catch(() => null);
          if (!meData) {
            setFriendsMsg("  .");
            friendsState.me = null;
            friendsState.friends = [];
            friendsState.gifts = [];
            friendsState.selectedId = "";
            friendsState.detailsById = {};
            renderFriends();
            return;
          }

          friendsState.me = meData;
          if (friendsUI.meName) friendsUI.meName.textContent = friendsState.me.firstName || "";
          if (friendsUI.meId) friendsUI.meId.textContent = friendsState.me.id || "";
          if (friendsUI.meAvatar) {
            const a = String(friendsState.me.firstName || "P").trim().slice(0, 1).toUpperCase() || "P";
            const p = friendsState.me && typeof friendsState.me.photo === "string" ? friendsState.me.photo : app.state.photo || "";
            setAvatarSquare(friendsUI.meAvatar, p, a);
          }

          const [list, gifts] = await Promise.all([
            friendsJson("/api/friends/list", { method: "GET" }),
            friendsJson("/api/friends/gifts", { method: "GET" }),
          ]);
        const nextFriends = list.ok && list.data && Array.isArray(list.data.friends) ? list.data.friends : [];
        const nextGifts = gifts.ok && gifts.data && Array.isArray(gifts.data.gifts) ? gifts.data.gifts : [];

        const nextFriendsSig = nextFriends
          .map((f) => {
            const id = String(f.id || "");
            const name = String(f.firstName || "");
            const photoLen = String(f.photo || "").length;
            const canGift = f.canGift ? 1 : 0;
            const availAt = Math.floor(Number(f.giftAvailableAt || 0) || 0);
            const lastSeenAt = Math.floor(Number(f.lastSeenAt || 0) || 0);
            const online = f.online ? 1 : 0;
            return `${id}:${name}:${photoLen}:${canGift}:${availAt}:${lastSeenAt}:${online}`;
          })
          .join("|");
        const nextGiftsSig = nextGifts
          .map((g) => {
            const createdAtRaw = g && typeof g.createdAt === "string" ? Date.parse(g.createdAt) : Number(g && g.createdAt ? g.createdAt : 0);
            const createdAt = Math.floor(Number.isFinite(createdAtRaw) ? createdAtRaw : 0);
            const fromName = String(g.fromName || "");
            const coins = Math.floor(Number(g.coins || 0) || 0);
            return `${createdAt}:${fromName}:${coins}`;
          })
          .join("|");

        const prevFriendsSig = friendsState.friendsSig || "";
        const prevGiftsSig = friendsState.giftsSig || "";
        friendsState.friendsSig = nextFriendsSig;
        friendsState.giftsSig = nextGiftsSig;
        friendsState.friends = nextFriends;
        friendsState.gifts = nextGifts;

        const selectedMissing = friendsState.selectedId && !friendsState.friends.some((x) => x.id === friendsState.selectedId);
        if (selectedMissing) {
          friendsState.selectedId = "";
          friendsState.detailsById = {};
        }
        const shouldRerender = selectedMissing || nextFriendsSig !== prevFriendsSig || nextGiftsSig !== prevGiftsSig;
        if (shouldRerender) renderFriends();
        if (chatState.open && shouldRerender) renderChat();
          if (friendsState.open) setFriendsMsg("");
          saveFriendsCache();
        })();

        friendsState.loadPromise = p;
        try {
          await p;
        } finally {
          friendsState.loadPromise = null;
        }
      }

      function openFriends() {
        friendsState.open = true;
        friendsState.tab = friendsState.tab || "friends";
        if (friendsUI.panel) friendsUI.panel.classList.add("open");
        loadFriendsCache();
        renderFriends();
        loadFriendsData(true).catch(() => {});
      }
      function closeFriends() {
        friendsState.open = false;
        if (friendsUI.panel) friendsUI.panel.classList.remove("open");
      }
      function toggleFriends() {
        if (friendsState.open) closeFriends();
        else openFriends();
      }

      function renderChat() {
        if (!chatUI.friendsList) return;
        const list = Array.isArray(friendsState.friends) ? friendsState.friends : [];
        const q = String(chatState.search || "").trim().toLowerCase();
        const filtered = q
          ? list.filter((f) => {
              const name = String(f && f.firstName ? f.firstName : "").toLowerCase();
              const id = String(f && f.id ? f.id : "").toLowerCase();
              return name.includes(q) || id.includes(q);
            })
          : list;

        if (!filtered.length) {
          if (friendsState.loadPromise) {
            chatUI.friendsList.innerHTML = new Array(6).fill(0).map(() => `<div class="skRow"><div class="skLine lg"></div><div class="skLine sm"></div></div>`).join("");
          } else if (!cloud.enabled) {
            chatUI.friendsList.innerHTML = `<div class="emptyCard"><div class="t"> </div><div class="tiny">    .</div></div>`;
          } else {
            chatUI.friendsList.innerHTML = `<div class="emptyCard"><div class="t">  </div><div class="tiny">     .</div><div class="ctaRow"><button type="button" class="btn primary" data-action="friends-add"> </button></div></div>`;
          }
        } else {
          chatUI.friendsList.innerHTML = filtered
            .map((f) => {
              const active = chatState.selectedId && chatState.selectedId === f.id ? " active" : "";
              const lastSeenAt = typeof f.lastSeenAt === "number" ? f.lastSeenAt : Date.parse(String(f.updatedAt || "")) || 0;
              const online = typeof f.online === "boolean" ? f.online : isOnlineFromLastSeen(lastSeenAt);
              const dot = online ? "presenceDot on" : "presenceDot";
              const letter = String(f.firstName || "P")
                .trim()
                .slice(0, 1)
                .toUpperCase();
              const photo = f && typeof f.photo === "string" && /^data:image\/(png|jpeg|webp);base64,/i.test(f.photo) ? f.photo : "";
              const avatar = photo ? `<img alt="" loading="lazy" decoding="async" src="${escapeHtml(photo)}" />` : escapeHtml(letter || "P");
              return `<button type="button" class="chatFriendRow${active}" data-id="${escapeHtml(f.id)}">
                <div class="friendLine">
                  <div class="avatarMini">${avatar}</div>
                  <div class="friendText">
                    <div class="friendNameRow"><span class="${dot}"></span><span class="friendNameText">${escapeHtml(f.firstName || "Player")}</span></div>
                    <div class="friendsTiny">  : ${escapeHtml(formatAgo(lastSeenAt))}</div>
                  </div>
                </div>
              </button>`;
            })
            .join("");
        }

        const sel = chatState.selectedId ? list.find((x) => x.id === chatState.selectedId) : null;
        if (chatUI.peerName) chatUI.peerName.textContent = sel ? String(sel.firstName || "Player") : " ";
        if (chatUI.peerMeta) {
          if (!sel) chatUI.peerMeta.textContent = "";
          else {
            const lastSeenAt = typeof sel.lastSeenAt === "number" ? sel.lastSeenAt : Date.parse(String(sel.updatedAt || "")) || 0;
            const online = typeof sel.online === "boolean" ? sel.online : isOnlineFromLastSeen(lastSeenAt);
            chatUI.peerMeta.textContent = online ? " " : ` : ${formatAgo(lastSeenAt)}`;
          }
        }
        const hasPeer = !!sel;
        if (chatUI.input) chatUI.input.disabled = !hasPeer;
        if (chatUI.sendBtn) chatUI.sendBtn.disabled = !hasPeer;
        renderChatMessages();
      }

      function openChat() {
        chatState.open = true;
        if (chatUI.panel) {
          chatUI.panel.classList.add("open");
          chatUI.panel.setAttribute("aria-hidden", "false");
        }
        ensureMeLoaded().catch(() => {});
        updateChatBadge();
        loadFriendsCache();
        pollChatInbox().catch(() => {});
        loadFriendsData(true).catch(() => {});
        renderChat();
      }
      function closeChat() {
        chatState.open = false;
        if (chatUI.panel) {
          chatUI.panel.classList.remove("open");
          chatUI.panel.setAttribute("aria-hidden", "true");
        }
      }
      function toggleChat() {
        if (chatState.open) closeChat();
        else openChat();
      }

      if (friendsUI.btn) friendsUI.btn.addEventListener("click", () => toggleFriends());
      if (friendsUI.close) friendsUI.close.addEventListener("click", () => closeFriends());
      if (friendsUI.searchInput) {
        friendsUI.searchInput.addEventListener("input", (e) => {
          const v = e && e.target && typeof e.target.value === "string" ? e.target.value : "";
          friendsState.search = v;
          renderFriends();
        });
      }
      document.addEventListener("click", (e) => {
        const btn = e && e.target && e.target.closest ? e.target.closest('[data-action="friends-add"]') : null;
        if (!btn) return;
        if (!friendsState.open) openFriends();
        friendsState.tab = "add";
        renderFriends();
        if (friendsUI.addInput) friendsUI.addInput.focus();
      });
      if (friendsUI.photoInput) {
        friendsUI.photoInput.addEventListener("change", async (e) => {
          const input = e.target;
          const file = input && input.files && input.files[0] ? input.files[0] : null;
          if (input) input.value = "";
          if (!file) return;
          await handleMePhotoPick(file);
        });
      }
      if (chatUI.close) chatUI.close.addEventListener("click", () => closeChat());
      if (chatUI.sendBtn) chatUI.sendBtn.addEventListener("click", () => sendChatMessage().catch(() => {}));
      if (chatUI.input) {
        chatUI.input.addEventListener("keydown", (e) => {
          if (e.key !== "Enter") return;
          e.preventDefault();
          sendChatMessage().catch(() => {});
        });
      }
      if (chatUI.searchInput) {
        chatUI.searchInput.addEventListener("input", (e) => {
          const v = e && e.target && typeof e.target.value === "string" ? e.target.value : "";
          chatState.search = v;
          renderChat();
        });
      }
      if (chatUI.friendsList) {
        chatUI.friendsList.addEventListener("click", (e) => {
          const btn = e.target && e.target.closest ? e.target.closest("button.chatFriendRow") : null;
          if (!btn) return;
          const id = btn.getAttribute("data-id") || "";
          chatState.selectedId = id;
          renderChat();
          renderChatMessages();
          if (chatUI.input) chatUI.input.disabled = false;
          if (chatUI.sendBtn) chatUI.sendBtn.disabled = false;
          loadChatThread(id)
            .then(() => {
              renderChatMessages();
              markChatRead(id).catch(() => {});
              if (chatUI.input) chatUI.input.focus();
            })
            .catch(() => {});
        });
      }
      if (friendsUI.meCopyIdBtn) {
        friendsUI.meCopyIdBtn.addEventListener("click", async () => {
          const id = friendsUI.meId ? String(friendsUI.meId.textContent || "").trim() : "";
          const ok = await copyToClipboard(id);
          if (ok) enqueueToast({ title: " ", body: id, autoMs: 1400 });
          else enqueueToast({ title: "", body: " .", autoMs: 1600 });
        });
      }
      if (friendsUI.meAvatar) {
        friendsUI.meAvatar.addEventListener("click", () => {
          const name = (friendsState.me && friendsState.me.firstName ? String(friendsState.me.firstName) : "P").trim();
          const letter = name.slice(0, 1).toUpperCase() || "P";
          const photo = app && app.state && typeof app.state.photo === "string" ? app.state.photo : "";
          openAvatarViewer(photo, letter);
        });
      }
      if (avatarViewerUI.backdrop) avatarViewerUI.backdrop.addEventListener("click", () => closeAvatarViewer());
      if (avatarViewerUI.close) avatarViewerUI.close.addEventListener("click", () => closeAvatarViewer());
      if (friendsUI.tabFriendsBtn) friendsUI.tabFriendsBtn.addEventListener("click", () => {
        friendsState.tab = "friends";
        renderFriends();
      });
      if (friendsUI.tabGiftsBtn) friendsUI.tabGiftsBtn.addEventListener("click", () => {
        friendsState.tab = "gifts";
        renderFriends();
      });
      if (friendsUI.tabAddBtn) friendsUI.tabAddBtn.addEventListener("click", () => {
        friendsState.tab = "add";
        renderFriends();
      });
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && avatarViewerState.open) {
          closeAvatarViewer();
          return;
        }
        if (e.key === "Escape" && el.onlineWithdrawBackdrop && el.onlineWithdrawBackdrop.classList.contains("show")) {
          closeOnlineWithdrawModal();
          return;
        }
        if (e.key === "Escape" && el.friendRemoveBlockBackdrop && el.friendRemoveBlockBackdrop.classList.contains("show")) {
          closeFriendRemoveBlockModal();
          return;
        }
        if (e.key === "Escape" && el.friendDetailsBackdrop && el.friendDetailsBackdrop.classList.contains("show")) {
          closeFriendDetailsModal();
          return;
        }
        if (e.key === "Escape" && el.reportBackdrop && el.reportBackdrop.classList.contains("show")) {
          closeReportModal();
          return;
        }
        if (e.key === "Escape" && el.feedbackBackdrop && el.feedbackBackdrop.classList.contains("show")) {
          closeFeedbackModal();
          return;
        }
        if (e.key === "Escape" && el.policyBackdrop && el.policyBackdrop.classList.contains("show")) {
          closePolicyModal();
          return;
        }
        if (e.key === "Escape" && el.privacyBackdrop && el.privacyBackdrop.classList.contains("show")) {
          closePrivacyModal();
          return;
        }
        if (e.key === "Escape" && el.onlineSetupBackdrop && el.onlineSetupBackdrop.classList.contains("show")) {
          closeOnlineSetupModal();
          return;
        }
        if (e.key === "Escape" && el.onlinePropsBackdrop && el.onlinePropsBackdrop.classList.contains("show")) {
          closeOnlinePropsModal();
          return;
        }
        if (e.key === "Escape" && el.profileDropBackdrop && el.profileDropBackdrop.classList.contains("show")) {
          closeProfileDrop();
          return;
        }
        if (e.key === "Escape" && chatState.open) {
          closeChat();
          return;
        }
        if (e.key === "Escape" && friendsState.open) closeFriends();
      });

      if (friendsUI.list) {
        friendsUI.list.addEventListener("click", (e) => {
          const copyEl = e.target && e.target.closest ? e.target.closest(".copyBtn[data-copy]") : null;
          if (copyEl) {
            e.preventDefault();
            e.stopPropagation();
            const txt = copyEl.getAttribute("data-copy") || "";
            copyToClipboard(txt)
              .then((ok) => {
                if (ok) enqueueToast({ title: " ", body: txt, autoMs: 1400 });
                else enqueueToast({ title: "", body: " .", autoMs: 1600 });
              })
              .catch(() => enqueueToast({ title: "", body: " .", autoMs: 1600 }));
            return;
          }
          const btn = e.target && e.target.closest ? e.target.closest("button.friendRow") : null;
          if (!btn) return;
          const id = btn.getAttribute("data-id") || "";
          friendsState.selectedId = id;
          renderFriends();
        });
      }

      function renderFriendDetailsBody(details) {
        if (!details || typeof details !== "object") return "";
        const s = details.stats || {};
        const wins = typeof s.wins === "number" ? s.wins : 0;
        const winStreak = typeof s.winStreak === "number" ? s.winStreak : 0;
        const bestWinStreak = typeof s.bestWinStreak === "number" ? s.bestWinStreak : 0;
        const streakNoHint = typeof s.streak === "number" ? s.streak : 0;
        const completed = typeof s.completed === "number" ? s.completed : 0;
        const unlocked = typeof s.unlocked === "number" ? s.unlocked : 1;
        const coinsEarnedTotal = typeof details.coinsEarnedTotal === "number" ? Math.max(0, Math.floor(details.coinsEarnedTotal)) : 0;
        const coinsPeak = typeof details.coinsPeak === "number" ? Math.max(0, Math.floor(details.coinsPeak)) : 0;
        const lv = typeof details.level === "number" ? Math.max(1, Math.floor(details.level)) : 1;
        const createdAt = details.createdAt ? new Date(details.createdAt).toLocaleDateString() : "";
        const winsNormal = typeof s.winsNormal === "number" ? s.winsNormal : 0;
        const winsTimed = typeof s.winsTimed === "number" ? s.winsTimed : 0;
        const winsLimited = typeof s.winsLimited === "number" ? s.winsLimited : 0;
        const winsDaily = typeof s.winsDaily === "number" ? s.winsDaily : 0;
        const winsOnline = typeof s.winsOnline === "number" ? s.winsOnline : 0;
        const winsOnlineEasy = typeof s.winsOnlineEasy === "number" ? s.winsOnlineEasy : 0;
        const winsOnlineMedium = typeof s.winsOnlineMedium === "number" ? s.winsOnlineMedium : 0;
        const winsOnlineHard = typeof s.winsOnlineHard === "number" ? s.winsOnlineHard : 0;
        const name = String(details.firstName || "Player");
        const id = String(details.id || "");
        return `
          <div style="display:flex; gap:12px; align-items:center">
            <div id="friendDetailsAvatarBox" class="avatarSquare" style="width:64px; height:64px; border-radius:18px"></div>
            <div style="flex:1; min-width:0">
              <div class="profileNameRow" style="justify-content:space-between">
                <div class="profileName">${escapeHtml(name)}</div>
                <div class="friendsTiny">LV ${escapeHtml(String(lv))}</div>
              </div>
              <div class="profileLine"><span class="profileK">ID</span> <span class="profileV">${escapeHtml(id)}</span></div>
              <div class="profileLine"><span class="profileK"> </span> <span class="profileV">${escapeHtml(createdAt)}</span></div>
            </div>
          </div>
          <div class="profileGrid" style="margin-top:12px">
            <div class="profileCard"><div class="k">  </div><div class="v">${escapeHtml(String(coinsEarnedTotal))}</div></div>
            <div class="profileCard"><div class="k">   </div><div class="v">${escapeHtml(String(coinsPeak))}</div></div>
            <div class="profileCard"><div class="k"></div><div class="v">${escapeHtml(String(wins))}</div></div>
            <div class="profileCard"><div class="k"> </div><div class="v">${escapeHtml(String(winStreak))}</div></div>
            <div class="profileCard"><div class="k">  </div><div class="v">${escapeHtml(String(bestWinStreak))}</div></div>
            <div class="profileCard"><div class="k">  </div><div class="v">${escapeHtml(String(streakNoHint))}</div></div>
            <div class="profileCard"><div class="k"></div><div class="v">${escapeHtml(String(completed))}</div></div>
            <div class="profileCard"><div class="k"></div><div class="v">${escapeHtml(String(unlocked))}</div></div>
            <div class="profileCard wide">
              <div class="k">  </div>
              <div class="profileSplit">
                <div><div class="k"></div><div class="v">${escapeHtml(String(winsNormal))}</div></div>
                <div><div class="k"></div><div class="v">${escapeHtml(String(winsTimed))}</div></div>
                <div><div class="k"></div><div class="v">${escapeHtml(String(winsLimited))}</div></div>
                <div><div class="k"></div><div class="v">${escapeHtml(String(winsDaily))}</div></div>
                <div><div class="k"></div><div class="v">${escapeHtml(String(winsOnline))}</div></div>
              </div>
            </div>
            <div class="profileCard wide">
              <div class="k">  </div>
              <div class="profileSplit">
                <div><div class="k"></div><div class="v">${escapeHtml(String(winsOnlineEasy))}</div></div>
                <div><div class="k"></div><div class="v">${escapeHtml(String(winsOnlineMedium))}</div></div>
                <div><div class="k"></div><div class="v">${escapeHtml(String(winsOnlineHard))}</div></div>
              </div>
            </div>
          </div>
        `;
      }

      function openFriendDetailsModal(details) {
        if (!el.friendDetailsBackdrop || !el.friendDetailsBody) return;
        const name = details && details.firstName ? String(details.firstName) : "Player";
        if (el.friendDetailsTitle) el.friendDetailsTitle.textContent = `   ${name}`;
        el.friendDetailsBody.innerHTML = renderFriendDetailsBody(details);
        const avBox = el.friendDetailsBody.querySelector ? el.friendDetailsBody.querySelector("#friendDetailsAvatarBox") : null;
        if (avBox) {
          const letter = String(name || "P").trim().slice(0, 1).toUpperCase() || "P";
          const photo = details && typeof details.photo === "string" ? details.photo : "";
          setAvatarSquare(avBox, photo, letter);
        }
        el.friendDetailsBackdrop.classList.add("show");
        el.friendDetailsBackdrop.setAttribute("aria-hidden", "false");
      }

      function closeFriendDetailsModal() {
        if (!el.friendDetailsBackdrop || !el.friendDetailsBody) return;
        el.friendDetailsBackdrop.classList.remove("show");
        el.friendDetailsBackdrop.setAttribute("aria-hidden", "true");
        el.friendDetailsBody.innerHTML = "";
      }

      function openReportModal(target) {
        if (!el.reportBackdrop || !el.reportText) return;
        const id = target && typeof target.id === "string" ? target.id : "";
        const name = target && typeof target.name === "string" ? target.name : "";
        if (!id) return;
        el.reportBackdrop.dataset.targetId = id;
        el.reportBackdrop.dataset.targetName = name;
        if (el.reportTitle) el.reportTitle.textContent = name ? `${t("reportTitle")}  ${name}` : t("reportTitle");
        if (el.reportTypeValue && typeof el.reportTypeValue.value === "string") {
          el.reportTypeValue.value = el.reportTypeValue.value || (currentLang() === "en" ? "Cheating" : "");
        }
        syncReportTypeUI();
        el.reportText.value = "";
        el.reportBackdrop.classList.add("show");
        el.reportBackdrop.setAttribute("aria-hidden", "false");
        setTimeout(() => el.reportText && el.reportText.focus && el.reportText.focus(), 0);
      }

      function closeReportModal() {
        if (!el.reportBackdrop) return;
        el.reportBackdrop.classList.remove("show");
        el.reportBackdrop.setAttribute("aria-hidden", "true");
        el.reportBackdrop.dataset.targetId = "";
        el.reportBackdrop.dataset.targetName = "";
        if (el.reportText) el.reportText.value = "";
      }

      async function submitReport() {
        const targetId = el.reportBackdrop ? String(el.reportBackdrop.dataset.targetId || "") : "";
        if (!targetId) return;
        const type = el.reportTypeValue && typeof el.reportTypeValue.value === "string" ? String(el.reportTypeValue.value).trim() : "";
        const msg = el.reportText ? String(el.reportText.value || "").replace(/\s+/g, " ").trim() : "";
        if (!type || msg.length < 3) {
          enqueueToast({ title: t("reportTitle"), body: currentLang() === "en" ? "Write more details." : "  .", autoMs: 2200 });
          return;
        }
        const r = await friendsJson("/api/report-player", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ targetId, reason: type, details: msg }),
        });
        if (r.ok) {
          closeReportModal();
          enqueueToast({ title: t("reportTitle"), body: currentLang() === "en" ? "Report sent." : "  .", autoMs: 2200 });
          return;
        }
        if (r.status === 401) {
          enqueueToast({ title: t("reportTitle"), body: currentLang() === "en" ? "Please sign in first." : "  .", autoMs: 2400 });
          return;
        }
        enqueueToast({ title: t("reportTitle"), body: (r.data && r.data.error) || (currentLang() === "en" ? "Failed." : " ."), autoMs: 2400 });
      }

      function openFeedbackModal() {
        if (!el.feedbackBackdrop || !el.feedbackText) return;
        if (el.feedbackTitle) el.feedbackTitle.textContent = t("feedbackTitle");
        el.feedbackText.value = "";
        el.feedbackBackdrop.classList.add("show");
        el.feedbackBackdrop.setAttribute("aria-hidden", "false");
        setTimeout(() => el.feedbackText && el.feedbackText.focus && el.feedbackText.focus(), 0);
      }

      function closeFeedbackModal() {
        if (!el.feedbackBackdrop) return;
        el.feedbackBackdrop.classList.remove("show");
        el.feedbackBackdrop.setAttribute("aria-hidden", "true");
        if (el.feedbackText) el.feedbackText.value = "";
      }

      async function submitFeedback() {
        const msg = el.feedbackText ? String(el.feedbackText.value || "").replace(/\s+/g, " ").trim() : "";
        if (msg.length < 3) {
          enqueueToast({ title: t("feedbackTitle"), body: currentLang() === "en" ? "Write more details." : "  .", autoMs: 2200 });
          return;
        }
        const page = `${location.pathname}${location.search}${location.hash}`;
        const r = await friendsJson("/api/feedback", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: msg, page }),
        });
        if (r.ok) {
          closeFeedbackModal();
          enqueueToast({ title: t("feedbackTitle"), body: currentLang() === "en" ? "Sent. Thanks!" : " . !", autoMs: 2200 });
          return;
        }
        enqueueToast({ title: t("feedbackTitle"), body: (r.data && r.data.error) || (currentLang() === "en" ? "Failed." : " ."), autoMs: 2400 });
      }

      function openPolicyModal() {
        if (!el.policyBackdrop) return;
        if (el.policyTitle) el.policyTitle.textContent = t("policyTitle");
        if (el.policyBody) el.policyBody.innerHTML = t("policyBodyHtml");
        el.policyBackdrop.classList.add("show");
        el.policyBackdrop.setAttribute("aria-hidden", "false");
      }

      function closePolicyModal() {
        if (!el.policyBackdrop) return;
        el.policyBackdrop.classList.remove("show");
        el.policyBackdrop.setAttribute("aria-hidden", "true");
      }

      function openPrivacyModal() {
        if (!el.privacyBackdrop) return;
        if (el.privacyTitle) el.privacyTitle.textContent = t("privacyTitle");
        if (el.privacyBody) el.privacyBody.innerHTML = t("privacyBodyHtml");
        el.privacyBackdrop.classList.add("show");
        el.privacyBackdrop.setAttribute("aria-hidden", "false");
      }

      function closePrivacyModal() {
        if (!el.privacyBackdrop) return;
        el.privacyBackdrop.classList.remove("show");
        el.privacyBackdrop.setAttribute("aria-hidden", "true");
      }

      function openOnlineSetupModal(codeLen, myReady, oppReady) {
        if (!el.onlineSetupBackdrop) return;
        if (el.onlineSetupTitle) el.onlineSetupTitle.textContent = t("onlineSetupTitle");
        if (el.onlineSetupHint) el.onlineSetupHint.textContent = t("onlineSetupHint").replace("{n}", String(codeLen || ""));
        const len = Math.max(1, Math.floor(codeLen || 0));
        if (el.onlineSetupInput) {
          el.onlineSetupInput.maxLength = len;
          el.onlineSetupInput.value = String(el.onlineSetupInput.value || "").replace(/[^\d]/g, "").slice(0, len);
          el.onlineSetupInput.placeholder = t("onlineSetupPlaceholder").replace("{n}", String(codeLen || ""));
          el.onlineSetupInput.disabled = !!myReady;
        }
        if (el.onlineSetupDigits) {
          const v = el.onlineSetupInput ? String(el.onlineSetupInput.value || "") : "";
          const dots = Array.from({ length: len })
            .map((_, i) => {
              const d = v[i] ? escapeHtml(v[i]) : "";
              return `<div class="setupDot ${d ? "filled" : ""}">${d}</div>`;
            })
            .join("");
          el.onlineSetupDigits.innerHTML = dots;
          el.onlineSetupDigits.setAttribute("aria-label", t("onlineSetupHint").replace("{n}", String(codeLen || "")));
          el.onlineSetupDigits.tabIndex = myReady ? -1 : 0;
        }
        if (el.onlineSetupReadyBtn) {
          el.onlineSetupReadyBtn.textContent = myReady ? t("onlineSetupCancelReadyBtn") : t("onlineSetupReadyBtn");
          el.onlineSetupReadyBtn.disabled = false;
        }
        if (el.onlineSetupForfeitBtn) {
          el.onlineSetupForfeitBtn.textContent = t("onlineSetupForfeitBtn");
          el.onlineSetupForfeitBtn.style.display = app.session && app.session.over ? "none" : "";
        }
        if (el.onlineSetupStatus) {
          const meLabel = myReady ? t("onlineSetupMeReady") : t("onlineSetupMeNotReady");
          const oppLabel = oppReady ? t("onlineSetupOppReady") : t("onlineSetupOppNotReady");
          const meTag = `<span class="setupStatusTag ${myReady ? "ok" : ""}">${myReady ? `<span class="setupCheck"></span>` : ""}${escapeHtml(meLabel)}</span>`;
          const oppTag = `<span class="setupStatusTag ${oppReady ? "ok" : ""}">${oppReady ? `<span class="setupCheck"></span>` : ""}${escapeHtml(oppLabel)}</span>`;
          el.onlineSetupStatus.innerHTML = `${meTag}${oppTag}`;
        }
        el.onlineSetupBackdrop.classList.add("show");
        el.onlineSetupBackdrop.setAttribute("aria-hidden", "false");
        if (el.onlineSetupInput && !myReady) el.onlineSetupInput.focus();
      }

      function closeOnlineSetupModal() {
        if (!el.onlineSetupBackdrop) return;
        el.onlineSetupBackdrop.classList.remove("show");
        el.onlineSetupBackdrop.setAttribute("aria-hidden", "true");
        if (el.onlineSetupStatus) el.onlineSetupStatus.innerHTML = "";
        if (el.onlineSetupDigits) el.onlineSetupDigits.innerHTML = "";
      }

      function propsCardLabel(card) {
        const c = String(card || "");
        if (c === "skip_turn") return "     ";
        if (c === "double_or_nothing") return "Double or nothing";
        if (c === "reverse_digits") return " ";
        if (c === "hide_colors") return "   ";
        return "";
      }

      function renderOnlinePropsCards(deck, myPick, oppPick) {
        if (!el.onlinePropsCards) return;
        const now = Date.now();
        const pending = onlineState.matchId && now < (onlineState.propsPendingPickUntil || 0);
        const revealOpp = oppPick !== null && oppPick !== undefined && oppPick !== "" && myPick !== null && myPick !== undefined && myPick !== "";
        const myPickN = typeof myPick === "number" ? myPick : myPick === null ? null : null;
        const oppPickN = typeof oppPick === "number" ? oppPick : oppPick === null ? null : null;

        el.onlinePropsCards.innerHTML = "";
        for (let i = 0; i < 5; i++) {
          const btn = document.createElement("button");
          btn.className = "propsCardBtn";
          btn.type = "button";
          btn.disabled = pending || myPickN !== null;
          btn.dataset.index = String(i);
          const flipped = myPickN === i || (revealOpp && oppPickN === i);
          const label = propsCardLabel(deck && deck[i] ? deck[i] : "");
          btn.innerHTML = `
            <div class="propsCard ${flipped ? "flipped" : ""}">
              <div class="propsFace back">
                <span class="propsLogo">ML</span>
              </div>
              <div class="propsFace front"><span class="propsText">${escapeHtml(label)}</span></div>
            </div>
          `;
          btn.addEventListener("click", () => submitOnlinePropsPick(i));
          el.onlinePropsCards.appendChild(btn);
        }
      }

      function openOnlinePropsModal(deck, myPick, oppPick) {
        if (!el.onlinePropsBackdrop) return;
        renderOnlinePropsCards(deck, myPick, oppPick);
        if (el.onlinePropsStatus) {
          const mePicked = typeof myPick === "number";
          const oppPicked = typeof oppPick === "number";
          el.onlinePropsStatus.textContent = mePicked ? (oppPicked ? "  ." : " ...") : "   .";
        }
        el.onlinePropsBackdrop.classList.add("show");
        el.onlinePropsBackdrop.setAttribute("aria-hidden", "false");
      }

      function closeOnlinePropsModal() {
        if (!el.onlinePropsBackdrop) return;
        el.onlinePropsBackdrop.classList.remove("show");
        el.onlinePropsBackdrop.setAttribute("aria-hidden", "true");
        if (el.onlinePropsCards) el.onlinePropsCards.innerHTML = "";
        if (el.onlinePropsStatus) el.onlinePropsStatus.textContent = "";
      }

      async function submitOnlinePropsPick(index) {
        if (!cloud.enabled) return;
        if (!app.stage || app.stage.kind !== "online") return;
        const id = app.stage.matchId;
        if (!id) return;
        if (onlineState.propsPendingPickUntil && Date.now() < onlineState.propsPendingPickUntil) return;
        onlineState.propsPendingPickUntil = Date.now() + 1800;
        onlineState.propsPendingPickIndex = index;
        try {
          const r = await friendsJson("/api/online/match/props", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id, action: "pick", index }),
          });
          if (!r.ok) {
            onlineState.propsPendingPickUntil = 0;
            onlineState.propsPendingPickIndex = -1;
            enqueueToast({ title: t("onlineBtn"), body: r.status === 0 ? " .   ." : "  .", autoMs: 2400 });
            return;
          }
          await onlineFetchMatchStateOnce(onlineState.meEmail || "", onlineState.fee || 0);
        } catch {
          onlineState.propsPendingPickUntil = 0;
          onlineState.propsPendingPickIndex = -1;
        }
      }

      async function submitOnlinePropsUse() {
        if (!cloud.enabled) return;
        if (!app.stage || app.stage.kind !== "online") return;
        if (app.session && app.session.over) return;
        const id = app.stage.matchId;
        if (!id) return;
        if (el.onlinePropsUseBtn) el.onlinePropsUseBtn.disabled = true;
        try {
          const r = await friendsJson("/api/online/match/props", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id, action: "use" }),
          });
          if (!r.ok) {
            enqueueToast({ title: t("onlineBtn"), body: "  .", autoMs: 2200 });
          } else if (r.data && typeof r.data.card === "string") {
            enqueueToast({ title: "", body: ` : ${propsCardLabel(r.data.card)}`, autoMs: 2400 });
          }
          await onlineFetchMatchStateOnce(onlineState.meEmail || "", onlineState.fee || 0);
        } finally {
          if (el.onlinePropsUseBtn) el.onlinePropsUseBtn.disabled = false;
        }
      }

      async function submitOnlineSetupToggleReady() {
        if (!cloud.enabled) return;
        if (!app.stage || app.stage.kind !== "online") return;
        const id = app.stage.matchId;
        if (!id) return;
        const len = Math.max(1, Math.floor(app.stage.codeLen || 0));
        const isReady = !!onlineState.setupMyReady;
        const secret = el.onlineSetupInput ? String(el.onlineSetupInput.value || "").replace(/[^\d]/g, "").slice(0, len) : "";
        if (!isReady && (!secret || secret.length !== len)) {
          enqueueToast({ title: t("onlineSetupTitle"), body: t("onlineSetupBadSecret").replace("{n}", String(len)), autoMs: 2400 });
          return;
        }
        const nextReady = !isReady;
        onlineState.setupMyReady = nextReady;
        onlineState.setupPendingUntil = Date.now() + 1600;
        onlineState.setupPendingValue = nextReady;
        onlineState.setupPendingMatchId = id;
        openOnlineSetupModal(len, nextReady, onlineState.setupOppReady);
        if (el.onlineSetupReadyBtn) el.onlineSetupReadyBtn.disabled = true;
        const r = await friendsJson("/api/online/match/setup", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(isReady ? { id, ready: false } : { id, secret, ready: true }),
        });
        if (!r.ok) {
          onlineState.setupMyReady = isReady;
          onlineState.setupPendingUntil = 0;
          onlineState.setupPendingValue = null;
          onlineState.setupPendingMatchId = "";
          openOnlineSetupModal(len, isReady, onlineState.setupOppReady);
          if (el.onlineSetupReadyBtn) el.onlineSetupReadyBtn.disabled = false;
          enqueueToast({
            title: t("onlineSetupTitle"),
            body: r.status === 0 ? " .   ." : t("onlineSetupFailed"),
            autoMs: 2400,
          });
          return;
        }
        await onlineFetchMatchStateOnce(onlineState.meEmail || "", onlineState.fee || 0);
        setTimeout(() => {
          try {
            onlineFetchMatchStateOnce(onlineState.meEmail || "", onlineState.fee || 0);
          } catch {}
        }, 280);
      }

      function openFriendRemoveBlockModal(id) {
        if (!el.friendRemoveBlockBackdrop) return;
        el.friendRemoveBlockBackdrop.dataset.id = String(id || "");
        el.friendRemoveBlockBackdrop.classList.add("show");
        el.friendRemoveBlockBackdrop.setAttribute("aria-hidden", "false");
      }

      function closeFriendRemoveBlockModal() {
        if (!el.friendRemoveBlockBackdrop) return;
        el.friendRemoveBlockBackdrop.classList.remove("show");
        el.friendRemoveBlockBackdrop.setAttribute("aria-hidden", "true");
        el.friendRemoveBlockBackdrop.dataset.id = "";
      }

      function openOnlineWithdrawModal() {
        if (!el.onlineWithdrawBackdrop) return;
        if (!app.stage || app.stage.kind !== "online") return;
        if (app.session && app.session.over) return;
        el.onlineWithdrawBackdrop.classList.add("show");
        el.onlineWithdrawBackdrop.setAttribute("aria-hidden", "false");
      }

      function closeOnlineWithdrawModal() {
        if (!el.onlineWithdrawBackdrop) return;
        el.onlineWithdrawBackdrop.classList.remove("show");
        el.onlineWithdrawBackdrop.setAttribute("aria-hidden", "true");
      }

      if (friendsUI.actions) {
        friendsUI.actions.addEventListener("click", async (e) => {
          const av = e.target && e.target.closest ? e.target.closest(".friendsFriendAvatar") : null;
          if (av) {
            const list = Array.isArray(friendsState.friends) ? friendsState.friends : [];
            const sel = friendsState.selectedId ? list.find((x) => x.id === friendsState.selectedId) : null;
            const letter = sel && sel.firstName ? String(sel.firstName).trim().slice(0, 1).toUpperCase() : "P";
            const photo = sel && typeof sel.photo === "string" ? sel.photo : "";
            openAvatarViewer(photo, letter);
            return;
          }
          const t = e.target && e.target.closest ? e.target.closest("button") : null;
          if (!t) return;
          const id = friendsState.selectedId;
          if (!id) return;

          if (t.id === "friendsDetailsBtn") {
            setFriendsMsg("");
            const cached = friendsState.detailsById && typeof friendsState.detailsById === "object" ? friendsState.detailsById[id] : null;
            if (cached && cached.id) {
              openFriendDetailsModal(cached);
              return;
            }
            const r = await friendsJson(`/api/friends/player?id=${encodeURIComponent(id)}`, { method: "GET" });
            if (r.ok && r.data && r.data.id) {
              friendsState.detailsById[id] = r.data;
              openFriendDetailsModal(r.data);
            } else {
              setFriendsMsg((r.data && r.data.error) || "  .");
            }
            return;
          }

          if (t.id === "friendsReportBtn") {
            const list = Array.isArray(friendsState.friends) ? friendsState.friends : [];
            const sel = list.find((x) => x && x.id === id);
            const name = sel && sel.firstName ? String(sel.firstName) : "Player";
            openReportModal({ id, name });
            return;
          }

          if (t.id === "friendsRemoveBtn") {
            openFriendRemoveBlockModal(id);
            return;
          }

          if (t.id === "friendsGiftBtn") {
            setFriendsMsg("");
            const r = await friendsJson("/api/friends/gift", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ id }),
            });
            if (r.ok) {
              setFriendsMsg(" .      24 .");
              if (r.data && r.data.nextAvailableAt) {
                const nextAt = Math.max(0, Math.floor(parseInt(String(r.data.nextAvailableAt), 10) || 0));
                friendsState.friends = Array.isArray(friendsState.friends)
                  ? friendsState.friends.map((f) => (f.id === id ? { ...f, canGift: false, giftAvailableAt: nextAt } : f))
                  : friendsState.friends;
                renderFriends();
              }
              await loadFriendsData();
              return;
            }
            if (r.status === 429 && r.data && r.data.availableAt) {
              const ms = Math.max(0, Math.floor(r.data.availableAt - Date.now()));
              const h = Math.floor(ms / 3600000);
              const m = Math.floor((ms % 3600000) / 60000);
              setFriendsMsg(`   ${h} ${m}.`);
              return;
            }
            setFriendsMsg((r.data && r.data.error) || " .");
            return;
          }
        });
      }

      if (el.friendDetailsClose) el.friendDetailsClose.addEventListener("click", () => closeFriendDetailsModal());
      if (el.friendDetailsBackdrop)
        el.friendDetailsBackdrop.addEventListener("click", (e) => {
          if (e.target === el.friendDetailsBackdrop) closeFriendDetailsModal();
        });

      if (el.reportCloseBtn) el.reportCloseBtn.addEventListener("click", () => closeReportModal());
      if (el.reportCancelBtn) el.reportCancelBtn.addEventListener("click", () => closeReportModal());
      if (el.reportSendBtn) el.reportSendBtn.addEventListener("click", () => submitReport());
      if (el.reportTypeBtn) el.reportTypeBtn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        toggleReportTypeMenu();
      });
      if (el.reportTypeMenu) el.reportTypeMenu.addEventListener("click", (e) => {
        const t = e.target;
        const b = t && t.closest ? t.closest("[data-value]") : null;
        if (!b) return;
        const v = String(b.getAttribute("data-value") || "");
        if (el.reportTypeValue) el.reportTypeValue.value = v;
        syncReportTypeUI();
        closeReportTypeMenu();
      });
      document.addEventListener("click", (e) => {
        if (!el.reportTypeWrap || !el.reportTypeMenu) return;
        const target = e.target;
        if (!target || !target.closest) return;
        if (target.closest("#reportTypeWrap")) return;
        closeReportTypeMenu();
      });
      if (el.reportBackdrop)
        el.reportBackdrop.addEventListener("click", (e) => {
          if (e.target === el.reportBackdrop) closeReportModal();
        });

      if (el.feedbackCloseBtn) el.feedbackCloseBtn.addEventListener("click", () => closeFeedbackModal());
      if (el.feedbackCancelBtn) el.feedbackCancelBtn.addEventListener("click", () => closeFeedbackModal());
      if (el.feedbackSendBtn) el.feedbackSendBtn.addEventListener("click", () => submitFeedback());
      if (el.feedbackBackdrop)
        el.feedbackBackdrop.addEventListener("click", (e) => {
          if (e.target === el.feedbackBackdrop) closeFeedbackModal();
        });

      if (el.policyCloseBtn) el.policyCloseBtn.addEventListener("click", () => closePolicyModal());
      if (el.policyBackdrop)
        el.policyBackdrop.addEventListener("click", (e) => {
          if (e.target === el.policyBackdrop) closePolicyModal();
        });

      if (el.privacyCloseBtn) el.privacyCloseBtn.addEventListener("click", () => closePrivacyModal());
      if (el.privacyBackdrop)
        el.privacyBackdrop.addEventListener("click", (e) => {
          if (e.target === el.privacyBackdrop) closePrivacyModal();
        });

      if (el.onlineSetupCloseBtn) el.onlineSetupCloseBtn.addEventListener("click", () => closeOnlineSetupModal());
      if (el.onlinePropsCloseBtn) el.onlinePropsCloseBtn.addEventListener("click", () => closeOnlinePropsModal());
      if (el.onlinePropsBackdrop)
        el.onlinePropsBackdrop.addEventListener("click", (e) => {
          if (e.target === el.onlinePropsBackdrop) closeOnlinePropsModal();
        });
      if (el.onlineSetupForfeitBtn)
        el.onlineSetupForfeitBtn.addEventListener("click", () => {
          if (app.session && app.session.over) return;
          closeOnlineSetupModal();
          openOnlineWithdrawModal();
        });
      if (el.onlineSetupReadyBtn) el.onlineSetupReadyBtn.addEventListener("click", () => submitOnlineSetupToggleReady());
      if (el.onlineSetupDigits && el.onlineSetupInput) {
        el.onlineSetupDigits.addEventListener("click", () => {
          if (el.onlineSetupInput.disabled) return;
          try {
            el.onlineSetupInput.focus();
          } catch {}
        });
        el.onlineSetupDigits.addEventListener("keydown", (e) => {
          if (!e || (e.key !== "Enter" && e.key !== " ")) return;
          e.preventDefault();
          if (el.onlineSetupInput.disabled) return;
          try {
            el.onlineSetupInput.focus();
          } catch {}
        });
        el.onlineSetupInput.addEventListener("input", () => {
          const len = Math.max(1, Math.floor((app.stage && app.stage.kind === "online" ? app.stage.codeLen : 0) || el.onlineSetupInput.maxLength || 0));
          el.onlineSetupInput.value = String(el.onlineSetupInput.value || "").replace(/[^\d]/g, "").slice(0, len);
          const v = String(el.onlineSetupInput.value || "");
          const dots = Array.from({ length: len })
            .map((_, i) => {
              const d = v[i] ? escapeHtml(v[i]) : "";
              return `<div class="setupDot ${d ? "filled" : ""}">${d}</div>`;
            })
            .join("");
          el.onlineSetupDigits.innerHTML = dots;
        });
      }
      if (el.onlineSetupBackdrop)
        el.onlineSetupBackdrop.addEventListener("click", (e) => {
          if (e.target === el.onlineSetupBackdrop) closeOnlineSetupModal();
        });

      if (el.friendRemoveBlockBackdrop)
        el.friendRemoveBlockBackdrop.addEventListener("click", (e) => {
          if (e.target === el.friendRemoveBlockBackdrop) closeFriendRemoveBlockModal();
        });
      if (el.friendConfirmRemoveBtn)
        el.friendConfirmRemoveBtn.addEventListener("click", async () => {
          const id = el.friendRemoveBlockBackdrop ? String(el.friendRemoveBlockBackdrop.dataset.id || "") : "";
          if (!id) return;
          closeFriendRemoveBlockModal();
          setFriendsMsg("");
          const r = await friendsJson(`/api/friends/remove?id=${encodeURIComponent(id)}`, { method: "DELETE" });
          if (!r.ok) setFriendsMsg((r.data && r.data.error) || "  .");
          await loadFriendsData(true);
        });
      if (el.friendConfirmBlockBtn)
        el.friendConfirmBlockBtn.addEventListener("click", async () => {
          const id = el.friendRemoveBlockBackdrop ? String(el.friendRemoveBlockBackdrop.dataset.id || "") : "";
          if (!id) return;
          closeFriendRemoveBlockModal();
          setFriendsMsg("");
          await friendsJson(`/api/friends/remove?id=${encodeURIComponent(id)}`, { method: "DELETE" });
          writeBlockedFriendIds((friendsState.blockedIds || []).concat([id]));
          friendsState.selectedId = "";
          closeFriendDetailsModal();
          renderFriends();
          await loadFriendsData(true);
        });

      if (el.onlineWithdrawBackdrop)
        el.onlineWithdrawBackdrop.addEventListener("click", (e) => {
          if (e.target === el.onlineWithdrawBackdrop) closeOnlineWithdrawModal();
        });
      if (el.onlineWithdrawNoBtn) el.onlineWithdrawNoBtn.addEventListener("click", () => closeOnlineWithdrawModal());
      if (el.onlineWithdrawYesBtn)
        el.onlineWithdrawYesBtn.addEventListener("click", () => {
          closeOnlineWithdrawModal();
          if (app.session && app.session.over) return;
          if (app.stage && app.stage.kind === "online") onlineExitMatch();
        });
      if (el.onlinePropsUseBtn) el.onlinePropsUseBtn.addEventListener("click", () => submitOnlinePropsUse());

      if (friendsUI.addBtn && friendsUI.addInput) {
        friendsUI.addBtn.addEventListener("click", async () => {
          const id = String(friendsUI.addInput.value || "").trim().toUpperCase();
          if (!id) return;
          setFriendsMsg("");
          const r = await friendsJson("/api/friends/request", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id }),
          });
          if (!r.ok) {
            setFriendsMsg((r.data && r.data.error) || "  .");
            return;
          }
          friendsUI.addInput.value = "";
          await loadFriendsData();
          if (r.data && r.data.accepted) setFriendsMsg("    .");
          else if (r.data && r.data.alreadyFriends) setFriendsMsg("  .");
          else setFriendsMsg("   .");
        });
      }

      el.motionBtn.addEventListener("click", () => toggleMotion());
      if (el.soundBtn) el.soundBtn.addEventListener("click", () => toggleSound());
      if (el.hapticsBtn) el.hapticsBtn.addEventListener("click", () => toggleHaptics());
      el.shapeBtn.addEventListener("click", () => cycleShape());
      el.modeBtn.addEventListener("click", () => cycleMode());
      if (el.changeNameBtn) el.changeNameBtn.addEventListener("click", () => openNameModal());
      if (el.nameCancelBtn) el.nameCancelBtn.addEventListener("click", () => closeHowTo());
      if (el.nameSaveBtn) el.nameSaveBtn.addEventListener("click", () => saveNameFromModal());
      if (el.nameInput) {
        el.nameInput.addEventListener("keydown", (e) => {
          if (e.key !== "Enter") return;
          saveNameFromModal();
        });
      }
      if (el.coinsBadge) el.coinsBadge.addEventListener("click", () => openShop());
      if (el.levelFeatReveal1Btn) el.levelFeatReveal1Btn.addEventListener("click", () => useOwnedFeatureOrOpenShop("reveal1"));
      if (el.levelFeatReveal2Btn) el.levelFeatReveal2Btn.addEventListener("click", () => useOwnedFeatureOrOpenShop("reveal2"));
      if (el.buyCircleBtn) el.buyCircleBtn.addEventListener("click", () => buyCircle());
      if (el.buySquareBtn) el.buySquareBtn.addEventListener("click", () => buySquare());
      if (el.buyPack099Btn) el.buyPack099Btn.addEventListener("click", () => startCheckout("pack_099"));
      if (el.buyPack299Btn) el.buyPack299Btn.addEventListener("click", () => startCheckout("pack_299"));
      if (el.buyPack499Btn) el.buyPack499Btn.addEventListener("click", () => startCheckout("pack_499"));
      if (el.buyPack999Btn) el.buyPack999Btn.addEventListener("click", () => startCheckout("pack_999"));
      if (el.buyPack1999Btn) el.buyPack1999Btn.addEventListener("click", () => startCheckout("pack_1999"));
      if (el.buyNameChangeBtn) el.buyNameChangeBtn.addEventListener("click", () => startCheckout("name_499"));
      if (el.buyHintTokenBtn) el.buyHintTokenBtn.addEventListener("click", () => buyHintToken());
      if (el.buyHintPack10Btn) el.buyHintPack10Btn.addEventListener("click", () => buyHintPack(10, 39));
      if (el.buyHintPack25Btn) el.buyHintPack25Btn.addEventListener("click", () => buyHintPack(25, 89));
      if (el.buyUseReveal1Btn) el.buyUseReveal1Btn.addEventListener("click", () => useOrBuyFeature("reveal1"));
      if (el.buyUseReveal2Btn) el.buyUseReveal2Btn.addEventListener("click", () => useOrBuyFeature("reveal2"));
      if (el.mathYesBtn) el.mathYesBtn.addEventListener("click", () => submitMathPuzzle());
      if (el.mathCancelBtn) el.mathCancelBtn.addEventListener("click", () => closeHowTo());
      if (el.mathAnswer) {
        el.mathAnswer.addEventListener("keydown", (e) => {
          if (e.key !== "Enter") return;
          submitMathPuzzle();
        });
      }
      if (el.assistContent) {
        el.assistContent.addEventListener("click", (e) => {
          const btn = e.target && e.target.closest ? e.target.closest("button") : null;
          if (!btn) return;
          const id = btn.id || "";
          if (id === "hintBtn" || id === "levelFeatReveal1Btn" || id === "levelFeatReveal2Btn") {
            setTimeout(() => {
              if (el.modalBackdrop && el.modalBackdrop.dataset.mode === "assist") closeHowTo();
            }, 0);
          }
        });
      }
      if (el.claimDailyRewardBtn) el.claimDailyRewardBtn.addEventListener("click", () => claimDailyReward());
      if (el.missionsList) {
        el.missionsList.addEventListener("click", (e) => {
          const btn = e.target && e.target.closest ? e.target.closest("button[data-mission]") : null;
          if (!btn) return;
          const id = btn.getAttribute("data-mission") || "";
          if (!id) return;
          claimMission(id);
        });
      }

      el.themeBtn.addEventListener("click", () => {
        const next = "crimson";
        applyTheme(next);
        app.state.theme = next;
        saveState(app.state);
        updateThemeBtn();
        buildBgPattern();
      });
      el.langBtn.addEventListener("click", () => {
        applyLanguage(currentLang() === "en" ? "ar" : "en");
      });

      if (el.exportBtn && !el.exportBtn.disabled) {
        el.exportBtn.addEventListener("click", async () => {
          const code = exportTransferCode();
          try {
            if (navigator.clipboard && navigator.clipboard.writeText) await navigator.clipboard.writeText(code);
            else window.prompt("Copy", code);
            el.msg.textContent = t("copied");
          } catch {
            window.prompt("Copy", code);
            el.msg.textContent = t("copied");
          }
        });
      }
      if (el.importBtn && !el.importBtn.disabled) {
        el.importBtn.addEventListener("click", () => {
          const code = window.prompt(t("importPrompt"), "");
          if (!code) return;
          const ok = importTransferCode(String(code).trim());
          el.msg.textContent = ok ? t("imported") : t("importBad");
        });
      }

      el.closeModalBtn.addEventListener("click", () => closeHowTo());
      el.modalBackdrop.addEventListener("click", (e) => {
        if (e.target === el.modalBackdrop) closeHowTo();
      });
      document.addEventListener("keydown", (e) => {
        if (e.key !== "Escape") return;
        if (el.modalBackdrop.classList.contains("show")) closeHowTo();
      });

      let bgResizeT = null;
      window.addEventListener("resize", () => {
        clearTimeout(bgResizeT);
        bgResizeT = setTimeout(() => buildBgPattern(), 180);
        if (el.profileDropBackdrop && el.profileDropBackdrop.classList.contains("show")) updateProfileDropPosition();
      });
      window.addEventListener("focus", () => {
        if (cloud.enabled) startLivePolling();
        kickFastSync();
      });
      document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "visible") {
          if (cloud.enabled) startLivePolling();
          kickFastSync();
        } else {
          stopLivePolling();
          flushCloudNow();
        }
      });
      window.addEventListener("pagehide", () => flushCloudNow());

      (async function bootstrap() {
        try {
          const lastEmail = String(localStorage.getItem("lockgame_last_email_v1") || "").trim();
          if (lastEmail) setStorageKeyForEmail(lastEmail);
        } catch {}
        app.state = loadState();
        const initialTheme = "crimson";
        if (app.state.theme !== initialTheme) {
          app.state.theme = initialTheme;
          saveStateSilent(app.state);
        }

        applyTheme(initialTheme);
        applyLanguage(app.state.lang || "ar");
        applyReduceMotion();
        applyLockShape();
        updateCoinsUI();
        updateSettingsUI();
        document.addEventListener(
          "click",
          (e) => {
            const t = e && e.target && e.target.closest ? e.target.closest("button") : null;
            if (!t || t.disabled) return;
            playClickSound();
          },
          { capture: true }
        );
        enableMapControls();
        consumeCheckoutReturn();
        const initialScreen = app.state.lastScreen === "map" || app.state.lastScreen === "level" ? app.state.lastScreen : "home";
        if (initialScreen === "level" && app.state.lastStage && typeof app.state.lastStage === "object") {
          const kind = app.state.lastStage.kind === "daily" ? "daily" : "level";
          const idRaw = typeof app.state.lastStage.id === "number" && Number.isFinite(app.state.lastStage.id) ? app.state.lastStage.id : 1;
          const id = clamp(Math.floor(idRaw), 1, TOTAL_LEVELS);
          if (kind === "level") {
            if (id <= (app.state.unlocked || 1)) openStage({ kind, id });
            else goMap();
          } else {
            const dailyIdRaw = app.state.dailyChallenge && typeof app.state.dailyChallenge.id === "number" ? app.state.dailyChallenge.id : id;
            const dailyId = Math.max(1, Math.floor(dailyIdRaw));
            openStage({ kind: "daily", id: dailyId });
          }
        } else if (initialScreen === "map") {
          goMap();
        } else {
          goHome();
        }
        delete document.documentElement.dataset.booting;
        delete document.documentElement.dataset.bootScreen;
        setTimeout(() => {
          buildBgPattern();
          if (initialScreen !== "level") renderMap();
        }, 0);
        updateDailyUI();
        setInterval(() => {
          if (!document.hidden) updateDailyUI();
        }, 2000);

        const u = await fetchSessionUser();
        if (u) {
          cloud.enabled = true;
          cloud.email = u.email;
          const prevKey = storageKey;
          setStorageKeyForEmail(u.email);
          try {
            localStorage.setItem("lockgame_last_email_v1", u.email);
          } catch {}
          loadFriendsCache();
          loadToastCursors();
          if (prevKey !== storageKey) {
            app.state = loadState();
            updateUserCenter();
            updateCoinsUI();
            updateSettingsUI();
          }
        }

        if (u && u.name && !String(app.state.displayName || "").trim()) {
          app.state.displayName = u.name;
          saveStateSilent(app.state);
        }
        updateUserCenter();
        if (cloud.enabled) pollOnlineCount().catch(() => {});

        const remote = await cloudGet();
        if (remote) {
          const localTs = app.state.lastWriteAt || 0;
          const remoteTs = remote.lastWriteAt || 0;
          const localDefaultish = isDefaultishState(app.state);
          const remoteDefaultish = isDefaultishState(remote);
          if (
            !remoteDefaultish &&
            (localDefaultish || remoteTs > localTs || (remoteTs === localTs && remoteTs === 0))
          ) {
            app.state = remote;
            saveStateSilent(app.state);
          } else if (remoteDefaultish && !localDefaultish) {
            cloudPut(app.state).catch(() => {});
          } else {
            cloudPut(app.state).catch(() => {});
          }
        } else if (cloud.enabled) {
          cloudPut(app.state).catch(() => {});
        }

        if (u && u.email && !String(app.state.displayName || "").trim()) {
          const local = String(u.email || "").split("@")[0] || "";
          const cleaned = local.replace(/[^a-zA-Z0-9_ .-]+/g, " ").trim();
          const token = cleaned.split(/[\s._-]+/g).filter(Boolean)[0] || local;
          app.state.displayName = (token.slice(0, 1).toUpperCase() + token.slice(1)).trim().slice(0, 18);
          saveStateSilent(app.state);
          if (cloud.enabled) cloudPut(app.state).catch(() => {});
        }

        if (!app.state.createdAt) {
          app.state.createdAt = app.state.lastWriteAt || Date.now();
          saveStateSilent(app.state);
        }
        if (!app.state.coinsEarnedTotal && (app.state.coins || 0) > 0) {
          app.state.coinsEarnedTotal = app.state.coins || 0;
          saveStateSilent(app.state);
        }
        if (!app.state.coinsPeak && (app.state.coins || 0) > 0) {
          app.state.coinsPeak = app.state.coins || 0;
          saveStateSilent(app.state);
        }

        if (cloud.enabled) ensureCountryCode().catch(() => {});
        updateUserCenter();
        updateCoinsUI();
        updateSettingsUI();
        renderMap();
        updateDailyUI();
        if (cloud.enabled) {
          fetchOnlineEnabledOnce(true).catch(() => {});
          startLivePolling();
          kickFastSync();
          setTimeout(() => loadFriendsData(true).catch(() => {}), 400);
        }
      })();
    </script>
  </body>
</html>
